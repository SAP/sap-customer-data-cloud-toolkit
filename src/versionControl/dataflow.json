{
  "callId": "40ce9ba520c9453a98b55220910ec146",
  "context": "{\"id\":\"dataflows_search\",\"targetApiKey\":\"4_6Tv6z8O6NmUO_BZoHcXIRw\"}",
  "errorCode": 0,
  "apiVersion": 2,
  "statusCode": 200,
  "statusReason": "OK",
  "time": "2024-10-17T14:26:55.062Z",
  "resultCount": 10,
  "totalCount": 10,
  "result": [
    {
      "apiKey": "4_6Tv6z8O6NmUO_BZoHcXIRw",
      "siteId": 435061734600,
      "id": "83ec0f85760141e8944bfa74966f786d",
      "name": "Krux_Dataflow",
      "status": "published",
      "description": "account > rename > krux > lzo > s3",
      "steps": [
        {
          "id": "account",
          "type": "datasource.read.gigya.account",
          "params": {
            "select": "UID,profile.gender,profile.age",
            "from": "accounts",
            "deltaField": "lastUpdatedTimestamp",
            "keepFieldNamesWithDotAsIs": false,
            "batchSize": 300,
            "maxConcurrency": 1
          },
          "next": ["rename"]
        },
        {
          "id": "rename",
          "type": "field.rename",
          "params": {
            "fields": [
              {
                "sourceField": "UID",
                "targetField": "id"
              },
              {
                "sourceField": "profile.gender",
                "targetField": "g_gender"
              },
              {
                "sourceField": "profile.age",
                "targetField": "g_age"
              },
              {
                "sourceField": "profile.likes",
                "targetField": "likes"
              }
            ]
          },
          "next": ["krux"]
        },
        {
          "id": "krux",
          "type": "file.format.krux",
          "params": {
            "fileName": "Gigya_Krux_M6.csv",
            "createEmptyFile": true,
            "quoteFields": false,
            "separator": ";"
          },
          "next": ["lzo"]
        },
        {
          "id": "lzo",
          "type": "file.compress.lzo",
          "params": {
            "createIndexFile": true
          },
          "next": ["s3"]
        },
        {
          "id": "s3",
          "type": "datasource.write.amazon.s3",
          "params": {
            "bucketName": "...",
            "accessKey": "...",
            "secretKey": "********",
            "objectKeyPrefix": "...",
            "region": "not specified"
          }
        }
      ],
      "version": 1,
      "createTime": "2023-04-21T10:28:31.777Z",
      "updateTime": "2023-04-21T10:28:31.777Z",
      "updatedByEmail": "g.lopes@sap.com"
    },
    {
      "apiKey": "4_6Tv6z8O6NmUO_BZoHcXIRw",
      "siteId": 435061734600,
      "id": "5e14ee0b96264f2c812e0c255c7f4e55",
      "name": "Import Lite Accounts from SFTP",
      "status": "published",
      "description": "sftp > parse > injectJobId > importLiteAccount > format > sftp",
      "steps": [
        {
          "id": "Read files from SFTP",
          "type": "datasource.read.sftp",
          "params": {
            "host": "...",
            "username": "...",
            "password": "********",
            "fileNameRegex": ".*.json",
            "port": 22,
            "sortOrder": "ASC",
            "sortBy": "time",
            "timeout": 60
          },
          "next": ["parse JSON"]
        },
        {
          "id": "parse JSON",
          "type": "file.parse.json",
          "params": {
            "addFilename": false
          },
          "next": ["sharedvariable"]
        },
        {
          "id": "Import Lite Account",
          "type": "datasource.write.gigya.generic",
          "params": {
            "apiMethod": "accounts.importLiteAccount",
            "maxConnections": 20,
            "apiParams": [
              {
                "sourceField": "profile",
                "paramName": "profile",
                "value": ""
              },
              {
                "sourceField": "data",
                "paramName": "data",
                "value": ""
              },
              {
                "sourceField": "email",
                "paramName": "email",
                "value": ""
              }
            ],
            "addResponse": false
          },
          "next": [],
          "error": ["Format Error File"]
        },
        {
          "id": "Format Error File",
          "type": "file.format.json",
          "params": {
            "fileName": "import_lite_accounts_errors_${now}.json",
            "maxFileSize": 5000,
            "createEmptyFile": false
          },
          "next": ["Save errors to SFTP"]
        },
        {
          "id": "Save errors to SFTP",
          "type": "datasource.write.sftp",
          "params": {
            "host": "...",
            "username": "...",
            "password": "********",
            "port": 22,
            "remotePath": "errors",
            "temporaryUploadExtension": true,
            "timeout": 60
          }
        },
        {
          "id": "sharedvariable",
          "type": "datasource.read.sharedvariable",
          "next": ["Import Lite Account"]
        }
      ],
      "version": 1,
      "createTime": "2023-05-30T16:16:03.733Z",
      "updateTime": "2023-05-30T16:16:03.733Z",
      "updatedByEmail": "g.lopes@sap.com"
    },
    {
      "apiKey": "4_6Tv6z8O6NmUO_BZoHcXIRw",
      "siteId": 435061734600,
      "id": "dbfbabf8452c40fa867f485efd5468ca",
      "name": "TESTING DATAFLOW",
      "status": "published",
      "description": "account > rename > dsv > gzip > sftp",
      "steps": [
        {
          "id": "account",
          "type": "datasource.read.gigya.account",
          "params": {
            "select": "profile.email,profile.lastName,profile.firstName,profile.gender,profile.birthDay,profile.birthMonth,profile.birthYear,profile.address,profile.zip,profile.city,profile.state,profile.country,profile.phones.number,profile.nickname",
            "from": "accounts",
            "deltaField": "lastUpdatedTimestamp",
            "keepFieldNamesWithDotAsIs": false,
            "batchSize": 300,
            "maxConcurrency": 1
          },
          "next": ["rename"]
        },
        {
          "id": "rename",
          "type": "field.rename",
          "params": {
            "fields": [
              {
                "sourceField": "profile.email",
                "targetField": "MAIL"
              },
              {
                "sourceField": "profile.lastName",
                "targetField": "NAME"
              },
              {
                "sourceField": "profile.firstName",
                "targetField": "FIRSTNAME"
              },
              {
                "sourceField": "profile.gender",
                "targetField": "GENDER"
              },
              {
                "sourceField": "profile.birthDay",
                "targetField": "BIRTH_DAY"
              },
              {
                "sourceField": "profile.birthMonth",
                "targetField": "BIRTH_MONTH"
              },
              {
                "sourceField": "profile.birthYear",
                "targetField": "BIRTH_YEAR"
              },
              {
                "sourceField": "profile.address",
                "targetField": "STREET"
              },
              {
                "sourceField": "profile.zip",
                "targetField": "POSTALCODE"
              },
              {
                "sourceField": "profile.city",
                "targetField": "CITY"
              },
              {
                "sourceField": "profile.state",
                "targetField": "PROVINCE"
              },
              {
                "sourceField": "profile.country",
                "targetField": "COUNTRY"
              },
              {
                "sourceField": "profile.phones",
                "targetField": "PHONE"
              },
              {
                "sourceField": "profile.nickname",
                "targetField": "USERNAME"
              }
            ]
          },
          "next": ["remove"]
        },
        {
          "id": "remove",
          "type": "field.remove",
          "params": {
            "fields": ["profile"]
          },
          "next": ["dsv"]
        },
        {
          "id": "dsv",
          "type": "file.format.dsv",
          "params": {
            "fileName": "GIGYA_TO_SFTP_${now}.csv",
            "columnSeparator": ",",
            "escapeCharacter": "\"",
            "quoteFields": true,
            "maxFileSize": 5000,
            "writeHeader": true,
            "dsvFormatVersion": "Legacy",
            "lineEnd": "\n",
            "createEmptyFile": false
          },
          "next": ["gzip"]
        },
        {
          "id": "gzip",
          "type": "file.compress.gzip",
          "next": ["sftp"]
        },
        {
          "id": "sftp",
          "type": "datasource.write.sftp",
          "params": {
            "host": "...",
            "username": "...",
            "password": "********",
            "remotePath": "GigyaDaily",
            "port": 22,
            "timeout": 60,
            "temporaryUploadExtension": false
          }
        }
      ],
      "version": 2,
      "createTime": "2023-04-17T16:09:42.745Z",
      "updateTime": "2023-04-18T13:57:22.702Z",
      "updatedByEmail": "g.lopes@sap.com"
    },
    {
      "apiKey": "4_6Tv6z8O6NmUO_BZoHcXIRw",
      "siteId": 435061734600,
      "id": "3d7f9654342d43888ef711e0654d4e16",
      "name": "<${{Testing}}$>",
      "status": "published",
      "description": "{{DESCRIPTION}}",
      "steps": [
        {
          "id": "Read files from SFTP",
          "type": "datasource.read.sftp",
          "params": {
            "host": "...",
            "username": "<${{name}}$>",
            "password": "********",
            "fileNameRegex": ".*.json",
            "port": 22,
            "sortOrder": "ASC",
            "sortBy": "time",
            "timeout": 60
          },
          "next": ["parse JSON"]
        },
        {
          "id": "parse JSON",
          "type": "file.parse.json",
          "params": {
            "addFilename": false
          },
          "next": ["sharedvariable"]
        },
        {
          "id": "Import Lite Account",
          "type": "datasource.write.gigya.generic",
          "params": {
            "apiMethod": "accounts.importLiteAccount",
            "maxConnections": 20,
            "apiParams": [
              {
                "sourceField": "profile",
                "paramName": "profile",
                "value": ""
              },
              {
                "sourceField": "data",
                "paramName": "data",
                "value": ""
              },
              {
                "sourceField": "email",
                "paramName": "email",
                "value": ""
              }
            ],
            "addResponse": false
          },
          "next": [],
          "error": ["Format Error File"]
        },
        {
          "id": "Format Error File",
          "type": "file.format.json",
          "params": {
            "fileName": "import_lite_accounts_errors_${now}.json",
            "maxFileSize": 5000,
            "createEmptyFile": false
          },
          "next": ["Save errors to SFTP"]
        },
        {
          "id": "Save errors to SFTP",
          "type": "datasource.write.sftp",
          "params": {
            "host": "...",
            "username": "...",
            "password": "********",
            "port": 22,
            "remotePath": "errors",
            "temporaryUploadExtension": true,
            "timeout": 60
          }
        },
        {
          "id": "sharedvariable",
          "type": "datasource.read.sharedvariable",
          "next": ["Import Lite Account"]
        }
      ],
      "version": 3,
      "createTime": "2024-03-12T12:08:42.812Z",
      "updateTime": "2024-03-12T13:00:22.981Z",
      "updatedByEmail": "g.lopes@sap.com"
    },
    {
      "apiKey": "4_6Tv6z8O6NmUO_BZoHcXIRw",
      "siteId": 435061734600,
      "id": "f1d41954122542128218c60b25c00ea4",
      "name": "[FULL ACCOUNTS] - Import from DQV (BLOB STORAGE)",
      "status": "published",
      "description": "[FULL ACCOUNTS] - Import from DQV (BLOB STORAGE)",
      "steps": [
        {
          "id": "10B. Remove Fields",
          "type": "field.remove",
          "params": {
            "fields": [
              "_loginIDs",
              "_emails",
              "_identities",
              "_phoneNumber",
              "profile._email",
              "password",
              "_response",
              "query",
              "data._areaOfInterest",
              "data._child",
              "data._pet",
              "data._externalApplication",
              "_lastUpdated",
              "data._initialAppSourceCode",
              "isRegistered",
              "lastUpdated",
              "identities",
              "loginIDs",
              "_subscriptions"
            ]
          },
          "next": ["11C. Update Account"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": " 7A. Perform Merge Logic",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgewogICAgY29uc3QgY2hlY2tMYXN0VXBkYXRlZCA9IGZhbHNlOwogICAgY29uc3QgbWVyZ2VDaGlsZCA9IHRydWU7CiAgICBjb25zdCBtZXJnZVBldCA9IHRydWU7CiAgICBjb25zdCBtZXJnZUV4dGVybmFsQXBwbGljYXRpb24gPSB0cnVlOwogICAgCiAgICBpZihjaGVja0xhc3RVcGRhdGVkICYmIHJlY29yZC5sYXN0VXBkYXRlZCA+IHJlY29yZC5fbGFzdFVwZGF0ZWQpICByZXR1cm47CiAgICAKICAgIC8vV2UgdXBkYXRlIGluaXRpYWxBcHBTb3VyY2VDb2RlIG9ubHkgaWYgaXQgZG9lc24ndCBleGlzdCBpbiB0aGUgc3lzdGVtCiAgICBpZihyZWNvcmQuZGF0YSAmJiByZWNvcmQuZGF0YS5faW5pdGlhbEFwcFNvdXJjZUNvZGUgJiYgIXJlY29yZC5kYXRhLmluaXRpYWxBcHBTb3VyY2VDb2RlKSByZWNvcmQuZGF0YS5pbml0aWFsQXBwU291cmNlQ29kZSA9IHJlY29yZC5kYXRhLl9pbml0aWFsQXBwU291cmNlQ29kZTsKICAgIAogICAgLy9QaG9uZU51bWJlciBsb2dpYwogICAgaWYocmVjb3JkLnByb2ZpbGUuX2VtYWlsKSB7CiAgICAgICAgaWYocmVjb3JkLnByb2ZpbGUuX2VtYWlsLmluZGV4T2YoInJhbmRvbWVtYWlsLm5lc3RsZS5jb20iKSA9PSAtMSAmJiAoIXJlY29yZC5wcm9maWxlLmVtYWlsIHx8IHJlY29yZC5wcm9maWxlLmVtYWlsLmluZGV4T2YoInJhbmRvbWVtYWlsLm5lc3RsZS5jb20iKSA+IC0xKSkgewogICAgICAgICAgICBpZihyZWNvcmQucHJvZmlsZS5fZW1haWwpIHJlY29yZC5wcm9maWxlLmVtYWlsID0gcmVjb3JkLnByb2ZpbGUuX2VtYWlsOwogICAgICAgICAgICBpZiggcmVjb3JkLl9sb2dpbklEcykgcmVjb3JkLmxvZ2luSURzID0gcmVjb3JkLl9sb2dpbklEczsKICAgICAgICAgICAgaWYocmVjb3JkLl9lbWFpbHMpIHJlY29yZC5lbWFpbHMgPSByZWNvcmQuX2VtYWlsczsKICAgICAgICAgICAgaWYgKHJlY29yZC5faWRlbnRpdGllcykgewogICAgICAgICAgICAgICAgcmVjb3JkLmlkZW50aXRpZXMgPSByZWNvcmQuX2lkZW50aXRpZXM7CiAgICAgICAgICAgICAgICByZWNvcmQuX2lkZW50aXRpZXMgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWNvcmQuaXNSZWdpc3RlcmVkID0gdHJ1ZTsgLy9IYXJkY29kZSBpc1JlZ2lzdGVyZWQgYXMgdHJ1ZS4KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmIChyZWNvcmQuX3Bob25lTnVtYmVyICYmICFyZWNvcmQucHJvZmlsZS5lbWFpbCkgewogICAgICAgICAgICByZWNvcmQucHJvZmlsZS5lbWFpbCA9IHJlY29yZC5VSUQrIkByYW5kb21lbWFpbC5uZXN0bGUuY29tIjsKICAgICAgICAgICAgcmVjb3JkLmxvZ2luSURzID0ge307CiAgICAgICAgICAgIHJlY29yZC5sb2dpbklEcy51bnZlcmlmaWVkRW1haWxzID0gW3JlY29yZC5VSUQrIkByYW5kb21lbWFpbC5uZXN0bGUuY29tIl07CiAgICAgICAgICAgIHJlY29yZC5lbWFpbHMgPSB7fTsKICAgICAgICAgICAgcmVjb3JkLmVtYWlscy51bnZlcmlmaWVkID0gW3JlY29yZC5VSUQrIkByYW5kb21lbWFpbC5uZXN0bGUuY29tIl07CiAgICAgICAgICAgIGlmKHJlY29yZC5faWRlbnRpdGllcykgewogICAgICAgICAgICAgICAgdmFyIG5ld2lkZW50aXRpZXMgPSBbXTsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSBpbiByZWNvcmQuX2lkZW50aXRpZXMpIHsKICAgICAgICAgICAgICAgICAgICBpZihyZWNvcmQuX2lkZW50aXRpZXNbaV1bInByb3ZpZGVyIl0gJiYgcmVjb3JkLl9pZGVudGl0aWVzWzBdWyJwcm92aWRlciJdID09ICJzaXRlIikgewogICAgICAgICAgICAgICAgICAgICAgICByZWNvcmQuX2lkZW50aXRpZXNbaV1bImVtYWlsIl0gPSByZWNvcmQuVUlEKyJAcmFuZG9tZW1haWwubmVzdGxlLmNvbSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG5ld2lkZW50aXRpZXMucHVzaChyZWNvcmQuX2lkZW50aXRpZXNbaV0pCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZWNvcmQuaWRlbnRpdGllcyA9IG5ld2lkZW50aXRpZXM7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIC8vRG9uJ3QgY2hhbmdlIHRoZSBwaG9uZW51bWJlciBzdG9yZWQgaW4gdGhlIHN5c3RlbQogICAgaWYoIXJlY29yZC5waG9uZU51bWJlciAmJiByZWNvcmQuX3Bob25lTnVtYmVyKSByZWNvcmQucGhvbmVOdW1iZXIgPSByZWNvcmQuX3Bob25lTnVtYmVyOwogICAgCiAgICBjb25zdCBtYXRjaGluZ0NvbmRpdGlvbkV4dGVybmFsQXBwbGljYXRpb24gPSBbImFwcGxpY2F0aW9uQ29kZSJdOwoKICAgIGNvbnN0IHN0cmF0ZWd5Q2hvb3NlbiA9ICJ7e01FUkdFX1NUUkFURUdZfX0iOwogICAgCiAgICAvL0FwcGx5IGN1c3RvbSBsb2dpYyBmb3IgRXh0ZXJuYWxBcHBsaWNhdGlvbgogICAgaWYgKG1lcmdlRXh0ZXJuYWxBcHBsaWNhdGlvbikgewogICAgICAgIGlmIChyZWNvcmQuZGF0YS5fZXh0ZXJuYWxBcHBsaWNhdGlvbiAmJiAhcmVjb3JkLmRhdGEuZXh0ZXJuYWxBcHBsaWNhdGlvbikgewogICAgICAgICAgICBpZiAocmVjb3JkLmRhdGEuX2V4dGVybmFsQXBwbGljYXRpb24ubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgICAgICByZWNvcmQuZGF0YS5leHRlcm5hbEFwcGxpY2F0aW9uID0gcmVjb3JkLmRhdGEuX2V4dGVybmFsQXBwbGljYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHJlY29yZC5kYXRhLmV4dGVybmFsQXBwbGljYXRpb24gJiYgcmVjb3JkLmRhdGEuX2V4dGVybmFsQXBwbGljYXRpb24pIHsKICAgICAgICAgICAgc3dpdGNoIChyZWNvcmQuZGF0YS5leHRlcm5hbEFwcGxpY2F0aW9uLmxlbmd0aCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuZGF0YS5fZXh0ZXJuYWxBcHBsaWNhdGlvbi5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkLmRhdGEuZXh0ZXJuYWxBcHBsaWNhdGlvbiA9IHJlY29yZC5kYXRhLl9leHRlcm5hbEFwcGxpY2F0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlY29yZC5kYXRhLl9leHRlcm5hbEFwcGxpY2F0aW9uLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICByZWNvcmQuZGF0YS5leHRlcm5hbEFwcGxpY2F0aW9uID0gcHJvY2Vzc01lcmdlKHJlY29yZC5kYXRhLmV4dGVybmFsQXBwbGljYXRpb24sIHJlY29yZC5kYXRhLl9leHRlcm5hbEFwcGxpY2F0aW9uLCBtYXRjaGluZ0NvbmRpdGlvbkV4dGVybmFsQXBwbGljYXRpb24sIHN0cmF0ZWd5Q2hvb3NlbiwiZXh0ZXJuYWxBcHBsaWNhdGlvbiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLyBBcHBseSBtZXJnZSBsb2dpY3MKICAgIGlmICggbWVyZ2VDaGlsZCApIGNhbGxNZXJnZUxvZ2ljKCByZWNvcmQsICJjaGlsZCIsIHN0cmF0ZWd5Q2hvb3Nlbik7CiAgICBpZiAoIG1lcmdlUGV0ICkgY2FsbE1lcmdlTG9naWMoIHJlY29yZCwgInBldCIsIHN0cmF0ZWd5Q2hvb3Nlbik7CiAgICBpZiAoIG1lcmdlRXh0ZXJuYWxBcHBsaWNhdGlvbiApIGNhbGxNZXJnZUxvZ2ljKCByZWNvcmQsICJleHRlcm5hbEFwcGxpY2F0aW9uIiwgc3RyYXRlZ3lDaG9vc2VuICk7CiAgICAKICAgIGlmIChyZWNvcmQuX2Vycm9yRGV0YWlscyAmJiByZWNvcmQuX2Vycm9yRGV0YWlscy5sZW5ndGgpIHsKICAgICAgICBlcnJvci5hY2NlcHQocmVjb3JkLCByZWNvcmQpOwogICAgfSBlbHNlIHsKICAgICAgICByZWNvcmQuaWRlbnRpdGllcyA9IHJlY29yZC5faWRlbnRpdGllczsKICAgICAgICBpZiAocmVjb3JkLmlkZW50aXRpZXMgJiYgcmVjb3JkLmlkZW50aXRpZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlY29yZC5pZGVudGl0aWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICByZWNvcmQuaWRlbnRpdGllc1tpXS5lbWFpbCA9IGFzc2lnbklkZW50aXRpZXNQcm9wZXJ0eShyZWNvcmQuaWRlbnRpdGllc1tpXS5lbWFpbCwgcmVjb3JkLnByb2ZpbGUuZW1haWwpOwogICAgICAgICAgICAgICAgcmVjb3JkLmlkZW50aXRpZXNbaV0uZmlyc3ROYW1lID0gYXNzaWduSWRlbnRpdGllc1Byb3BlcnR5KHJlY29yZC5pZGVudGl0aWVzW2ldLmZpcnN0TmFtZSwgcmVjb3JkLnByb2ZpbGUuZmlyc3ROYW1lKTsKICAgICAgICAgICAgICAgIHJlY29yZC5pZGVudGl0aWVzW2ldLmxhc3ROYW1lID0gYXNzaWduSWRlbnRpdGllc1Byb3BlcnR5KHJlY29yZC5pZGVudGl0aWVzW2ldLmxhc3ROYW1lLCByZWNvcmQucHJvZmlsZS5sYXN0TmFtZSk7CiAgICAgICAgICAgICAgICByZWNvcmQuaWRlbnRpdGllc1tpXS5sb2NhbGUgPSBhc3NpZ25JZGVudGl0aWVzUHJvcGVydHkocmVjb3JkLmlkZW50aXRpZXNbaV0ubG9jYWxlLCByZWNvcmQucHJvZmlsZS5sb2NhbGUpOwogICAgICAgICAgICAgICAgcmVjb3JkLmlkZW50aXRpZXNbaV0uY2l0eSA9IGFzc2lnbklkZW50aXRpZXNQcm9wZXJ0eShyZWNvcmQuaWRlbnRpdGllc1tpXS5jaXR5LCByZWNvcmQucHJvZmlsZS5jaXR5KTsKICAgICAgICAgICAgICAgIHJlY29yZC5pZGVudGl0aWVzW2ldLmdlbmRlciA9IGFzc2lnbklkZW50aXRpZXNQcm9wZXJ0eShyZWNvcmQuaWRlbnRpdGllc1tpXS5nZW5kZXIsIHJlY29yZC5wcm9maWxlLmdlbmRlcik7CiAgICAgICAgICAgICAgICByZWNvcmQuaWRlbnRpdGllc1tpXS5jb3VudHJ5ID0gYXNzaWduSWRlbnRpdGllc1Byb3BlcnR5KHJlY29yZC5pZGVudGl0aWVzW2ldLmNvdW50cnksIHJlY29yZC5wcm9maWxlLmNvdW50cnkpOwogICAgICAgICAgICAgICAgcmVjb3JkLmlkZW50aXRpZXNbaV0uemlwID0gYXNzaWduSWRlbnRpdGllc1Byb3BlcnR5KHJlY29yZC5pZGVudGl0aWVzW2ldLnppcCwgcmVjb3JkLnByb2ZpbGUuemlwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAocmVjb3JkLnByZWZlcmVuY2VzKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiByZWNvcmQucHJlZmVyZW5jZXMpIHsKICAgICAgICAgICAgICAgIGlmIChrZXkgIT0gInRlcm1zIiAmJiBrZXkgIT0gInByaXZhY3kiKQogICAgICAgICAgICAgICAgICAgIHJlY29yZC5wcmVmZXJlbmNlc1trZXldLmN1c3RvbURhdGEgPSBudWxsOwogICAgICAgICAgICB9ICAgCiAgICAKICAgICAgICAgICAgaWYgKHJlY29yZC5wcmVmZXJlbmNlcy50ZXJtcykgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCB0ZXJtc0tleSBpbiByZWNvcmQucHJlZmVyZW5jZXMudGVybXMpIHsKICAgICAgICAgICAgICAgICAgICByZWNvcmQucHJlZmVyZW5jZXMudGVybXNbdGVybXNLZXldLmN1c3RvbURhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgfSAgICAgICAgCiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICBpZiAocmVjb3JkLnByZWZlcmVuY2VzLnByaXZhY3kpIHsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcHJpdmFjeUtleSBpbiByZWNvcmQucHJlZmVyZW5jZXMucHJpdmFjeSkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZC5wcmVmZXJlbmNlcy5wcml2YWN5W3ByaXZhY3lLZXldLmN1c3RvbURhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgfSAgICAgICAgCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gU3Vic2NyaXB0aW9uIGxvZ2ljCiAgICAgICAgcmVjb3JkLnN1YnNjcmlwdGlvbnMgPSB7fTsKICAgICAgICBpZiAocmVjb3JkLl9zdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICAgIGZvciAodmFyIHN1YktleSBpbiByZWNvcmQuX3N1YnNjcmlwdGlvbnMpIHsKICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbCkgewogICAgICAgICAgICAgICAgICAgIGlmICgidHJ1ZSIgPT0gInt7RE9VQkxFX09QVF9JTn19IikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4gJiYgcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uc3RhdHVzICYmIHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLnN0YXR1cyA9PT0gIkNvbmZpcm1lZCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZCA9IHByb2Nlc3NTdWJzY3JpcHRpb25zKHJlY29yZCwgc3ViS2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4gfHwgKHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLnN0YXR1cyAmJiByZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5zdGF0dXMgPT09ICJDb25maXJtZWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkID0gcHJvY2Vzc1N1YnNjcmlwdGlvbnMocmVjb3JkLCBzdWJLZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgCiAgICAgICAgcmV0dXJuIHJlY29yZDsgICAgICAgIAogICAgfQp9CgpmdW5jdGlvbiBwcm9jZXNzU3Vic2NyaXB0aW9ucyhyZWNvcmQsIHN1YktleSkgewogICAgcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XSA9IHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldOwogICAgCiAgICBpZiAocmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbikgewogICAgICAgIGxldCBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkID0gcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5kb2lDb25kaXRpb25hbGx5Q29uZmlybWVkOwogICAgICAgIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPSAoZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCAhPT0gbnVsbCAmJiBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgID8gdHlwZW9mIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPT09ICJib29sZWFuIiA/IGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgOiBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkID09ICJ0cnVlIgogICAgICAgICAgICA6IG51bGw7CgogICAgICAgIHN3aXRjaCAoZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCkgewogICAgICAgICAgICBjYXNlIHRydWU6CiAgICAgICAgICAgICAgICByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLmlzRXh0ZXJuYWxseVZlcmlmaWVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIGZhbHNlOgogICAgICAgICAgICAgICAgcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5pc0V4dGVybmFsbHlWZXJpZmllZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgbnVsbDoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBsZXQgb2JqZWN0ID0ge307CiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbikgewogICAgICAgICAgICBpZiAoa2V5ICE9PSAnZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCcpIHsKICAgICAgICAgICAgICAgIG9iamVjdFtrZXldID0gcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbltrZXldOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluID0gb2JqZWN0OwogICAgfQogICAgCiAgICAvL1NUQVJUIC0gTVNDTkQtMzkxNzIgLSBDaGFuZ2Ugb24gaW1wb3J0aW5nIHN1YnNjcmlwdGlvbnMgdG8gZXhpc3RpbmcgYWNjb3VudHMKICAgIGlmIChyZWNvcmQ/LnN1YnNjcmlwdGlvbnM/LltzdWJLZXldPy5lbWFpbD8ubGFzdFVwZGF0ZWRTdWJzY3JpcHRpb25TdGF0ZSAmJgogICAgaXNEYXRlSW5GdXR1cmUocmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5sYXN0VXBkYXRlZFN1YnNjcmlwdGlvblN0YXRlKSkgewogICAgICAgIGRlbGV0ZSByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmxhc3RVcGRhdGVkU3Vic2NyaXB0aW9uU3RhdGU7CiAgICB9CiAgICAvL0VORCAtIE1TQ05ELTM5MTcyIC0gQ2hhbmdlIG9uIGltcG9ydGluZyBzdWJzY3JpcHRpb25zIHRvIGV4aXN0aW5nIGFjY291bnRzCgogICAgcmV0dXJuIHJlY29yZDsKfQoKLy9TVEFSVCAtIE1TQ05ELTM5MTcyIC0gQ2hhbmdlIG9uIGltcG9ydGluZyBzdWJzY3JpcHRpb25zIHRvIGV4aXN0aW5nIGFjY291bnRzCmZ1bmN0aW9uIGlzRGF0ZUluRnV0dXJlKGRhdGVTdHJpbmcpIHsKICAvLyBQYXJzZSB0aGUgZ2l2ZW4gZGF0ZSBzdHJpbmcgaW50byBhIERhdGUgb2JqZWN0CiAgY29uc3QgZ2l2ZW5EYXRlID0gbmV3IERhdGUoZGF0ZVN0cmluZyk7CiAgCiAgLy8gR2V0IHRoZSBjdXJyZW50IGRhdGUgYW5kIHRpbWUKICBjb25zdCBjdXJyZW50RGF0ZSA9IG5ldyBEYXRlKCk7CiAgCiAgLy8gQ29tcGFyZSB0aGUgZ2l2ZW4gZGF0ZSB3aXRoIHRoZSBjdXJyZW50IGRhdGUKICByZXR1cm4gZ2l2ZW5EYXRlID4gY3VycmVudERhdGU7Cn0KLy9FTkQgLSBNU0NORC0zOTE3MiAtIENoYW5nZSBvbiBpbXBvcnRpbmcgc3Vic2NyaXB0aW9ucyB0byBleGlzdGluZyBhY2NvdW50cwoKZnVuY3Rpb24gZ2VuZXJhdGVVVUlEKCkgewogICBsZXQgZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICBjb25zdCB1dWlkID0gInh4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCIucmVwbGFjZSgvW3h5XS9nLCBmdW5jdGlvbihjKSB7CiAgICAgICBjb25zdCByID0gKGQgKyBNYXRoLnJhbmRvbSgpKjE2KSUxNiB8IDA7CiAgICAgICBkID0gTWF0aC5mbG9vcihkLzE2KTsKICAgICAgICAgICAgcmV0dXJuIChjPT0ieCIgPyByIDogKHImMHgzfDB4OCkpLnRvU3RyaW5nKDE2KTsKICAgIH0pOwogICAgcmV0dXJuIHV1aWQ7Cn0KCmZ1bmN0aW9uIGNhbGxNZXJnZUxvZ2ljKCByZWNvcmQsIHByb3BlcnR5TmFtZSwgc3RyYXRlZ3lDaG9vc2VuICkgewogICAgY29uc3QgX3Byb3BlcnR5TmFtZSA9ICJfIiArIHByb3BlcnR5TmFtZTsKICAgIGlmIChyZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXSAmJiAhcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXSkgewogICAgICAgIGlmIChyZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXS5sZW5ndGggIT09IDApIHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gPSByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXTsKICAgIH0gZWxzZSBpZiAocmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXSAmJiByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXSkgewogICAgICAgIGlmIChyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdLmxlbmd0aCA9PT0gMCAmJiByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXS5sZW5ndGggIT09IDApIHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gPSByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXTsgIAogICAgICAgIGVsc2UgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICBjb25zdCBtZXJnZVJlc3VsdCA9IHByb2Nlc3NNZXJnZShyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdLCByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXSwgc3RyYXRlZ3lDaG9vc2VuLCBwcm9wZXJ0eU5hbWUpOwogICAgICAgICAgICBpZiAodHlwZW9mIG1lcmdlUmVzdWx0ID09PSAnc3RyaW5nJykgcmVjb3JkLl9lcnJvckRldGFpbHMgPSBtZXJnZVJlc3VsdDsKICAgICAgICAgICAgZWxzZSByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gbWVyZ2VSZXN1bHQ7CiAgICAgICAgfQogICAgfQp9CgpmdW5jdGlvbiBjaGVja1VVSUQodXVpZCkgewogICAgY29uc3QgcmVnZXggPSAvXlswLTlhLWZdezh9LVswLTlhLWZdezR9LTRbMC05YS1mXXszfS1bODlhYl1bMC05YS1mXXszfS1bMC05YS1mXXsxMn0kL2k7CiAgICByZXR1cm4gcmVnZXgudGVzdCh1dWlkKTsKfQoKZnVuY3Rpb24gZ2VuZXJhdGVVVUlEYW5kVXBkYXRlRGF0ZSh0eXBlLCB0YXJnZXQsIGkpIHsKICAgIGlmICh0eXBlID09PSAiY2hpbGQiIHx8IHR5cGUgPT09ICJwZXQiKSB7CiAgICAgICAgaWYoIWNoZWNrVVVJRCh0YXJnZXRbaV0uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIpKXsKICAgICAgICAgICAgdGFyZ2V0W2ldLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyID0gZ2VuZXJhdGVVVUlEKCk7CiAgICAgICAgfQogICAgfQp9CgpmdW5jdGlvbiBwcm9jZXNzTWVyZ2UoZXhpc3RpbmdSZWNvcmRBcnJheSwgbmV3UmVjb3JkQXJyYXksIHN0cmF0ZWd5LCB0eXBlKSB7CiAgICBsZXQgcmVzdWx0ID0gW107CiAgICBsZXQgY2hlY2sgPSBmYWxzZTsKICAgIGlmICggc3RyYXRlZ3kgPT09ICJmdWxsUmVwbGFjZSIpIHsKICAgICAgICByZXN1bHQgPSBuZXdSZWNvcmRBcnJheTsKICAgICAgICBmb3IgKGNvbnN0IHggaW4gcmVzdWx0KSBnZW5lcmF0ZVVVSURhbmRVcGRhdGVEYXRlKHR5cGUsIHJlc3VsdCwgeCk7CiAgICB9IGVsc2UgewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGV4aXN0aW5nUmVjb3JkQXJyYXkpKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5LmZyb20oZXhpc3RpbmdSZWNvcmRBcnJheSk7CiAgICAgICAgICAgIGZvciAoY29uc3QgbSBpbiBuZXdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCBuIGluIGV4aXN0aW5nUmVjb3JkQXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgICAgICgodHlwZSA9PT0gImNoaWxkIiB8fCB0eXBlID09PSAicGV0IikgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1JlY29yZEFycmF5W21dLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbbl0uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1JlY29yZEFycmF5W21dLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyLnRvTG93ZXJDYXNlKCkgPT09IHJlc3VsdFtuXS5hcHBsaWNhdGlvbkludGVybmFsSWRlbnRpZmllci50b0xvd2VyQ2FzZSgpKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAodHlwZSA9PT0gImNoaWxkIiAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UmVjb3JkQXJyYXlbbV0uYmlydGhEYXRlICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbbl0uYmlydGhEYXRlID09PSBuZXdSZWNvcmRBcnJheVttXS5iaXJ0aERhdGUgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1JlY29yZEFycmF5W21dLmZpcnN0TmFtZSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0W25dLmZpcnN0TmFtZSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0W25dLmZpcnN0TmFtZS50b0xvd2VyQ2FzZSgpID09PSBuZXdSZWNvcmRBcnJheVttXS5maXJzdE5hbWUudG9Mb3dlckNhc2UoKSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHR5cGUgPT09ICJwZXQiICYmIG5ld1JlY29yZEFycmF5W21dLm5hbWUgJiYgcmVzdWx0W25dLm5hbWUgJiYgcmVzdWx0W25dLm5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmV3UmVjb3JkQXJyYXlbbV0ubmFtZS50b0xvd2VyQ2FzZSgpKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAodHlwZSA9PT0gImV4dGVybmFsQXBwbGljYXRpb24iICYmIG5ld1JlY29yZEFycmF5W21dLmFwcGxpY2F0aW9uQ29kZSAmJiByZXN1bHRbbl0uYXBwbGljYXRpb25Db2RlICYmIHJlc3VsdFtuXS5hcHBsaWNhdGlvbkNvZGUudG9Mb3dlckNhc2UoKSA9PT0gbmV3UmVjb3JkQXJyYXlbbV0uYXBwbGljYXRpb25Db2RlLnRvTG93ZXJDYXNlKCkpCiAgICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHN0cmF0ZWd5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAicmVwbGFjZVBhcnRpYWxseSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIGNvbnN0IGF0dHJOYW1lUmVwbGFjZSBpbiByZXN1bHRbbl0gKSByZXN1bHRbbl1bYXR0ck5hbWVSZXBsYWNlXSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIGNvbnN0IGF0dHJOYW1lTmV3UmVwbGFjZSBpbiBuZXdSZWNvcmRBcnJheVttXSkgcmVzdWx0W25dW2F0dHJOYW1lTmV3UmVwbGFjZV0gPSBuZXdSZWNvcmRBcnJheVttXVthdHRyTmFtZU5ld1JlcGxhY2VdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJtZXJnZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIGNvbnN0IGF0dHJOYW1lTWVyZ2UgaW4gbmV3UmVjb3JkQXJyYXlbbV0gKSByZXN1bHRbbl1bYXR0ck5hbWVNZXJnZV0gPSBuZXdSZWNvcmRBcnJheVttXVthdHRyTmFtZU1lcmdlXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJza2lwIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZW5lcmF0ZVVVSURhbmRVcGRhdGVEYXRlKHR5cGUsIHJlc3VsdCwgbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVjayA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFjaGVjayAmJiAodHlwZSA9PT0gImNoaWxkIiB8fCB0eXBlID09PSAicGV0IiB8fCB0eXBlID09PSAiZXh0ZXJuYWxBcHBsaWNhdGlvbiIpKSB7CiAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGVVVUlEYW5kVXBkYXRlRGF0ZSh0eXBlLCBuZXdSZWNvcmRBcnJheSwgbSk7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobmV3UmVjb3JkQXJyYXlbbV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hlY2sgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBgVGhlIGV4dGVybmFsQXBwbGljYXRpb24sIGNoaWxkIGFuZC9vciBwZXQgaXMgbm90IGFuIGFycmF5LmA7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKfQoKZnVuY3Rpb24gYXNzaWduSWRlbnRpdGllc1Byb3BlcnR5KGlkZW50aXR5UHJvcGVydHksIHByb2ZpbGVQcm9wZXJ0eSkgewogICAgaWYgKGlkZW50aXR5UHJvcGVydHkgJiYgaWRlbnRpdHlQcm9wZXJ0eS5sZW5ndGgpIHsKICAgICAgICBpZiAocHJvZmlsZVByb3BlcnR5ICYmIHByb2ZpbGVQcm9wZXJ0eS5sZW5ndGggJiYgaWRlbnRpdHlQcm9wZXJ0eSAhPT0gcHJvZmlsZVByb3BlcnR5KSByZXR1cm4gcHJvZmlsZVByb3BlcnR5OwogICAgICAgIGVsc2UgcmV0dXJuIGlkZW50aXR5UHJvcGVydHk7CiAgICB9CiAgICBlbHNlIHJldHVybiBwcm9maWxlUHJvcGVydHk7Cn0=",
            "notifyLastRecord": false,
            "ECMAScriptVersion": "12"
          },
          "next": ["7A bis. Perform Merge Logic Area of Interest"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "12B. Import Full Account Insert",
          "type": "datasource.write.gigya.importaccount",
          "params": {
            "importPolicy": "insert",
            "maxConnections": 10,
            "addResponse": false
          },
          "next": ["13. Take phone number for update"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "7B. Rename Fields To Merge",
          "type": "field.rename",
          "params": {
            "fields": [
              {
                "sourceField": "data.areaOfInterest",
                "targetField": "data._areaOfInterest"
              },
              {
                "sourceField": "data.pet",
                "targetField": "data._pet"
              },
              {
                "sourceField": "data.child",
                "targetField": "data._child"
              },
              {
                "sourceField": "data.externalApplication",
                "targetField": "data._externalApplication"
              },
              {
                "sourceField": "lastUpdated",
                "targetField": "_lastUpdated"
              },
              {
                "sourceField": "data.initialAppSourceCode",
                "targetField": "data._initialAppSourceCode"
              },
              {
                "sourceField": "identities",
                "targetField": "_identities"
              },
              {
                "sourceField": "subscriptions",
                "targetField": "_subscriptions"
              }
            ]
          },
          "next": ["8B. Existing Accounts", "8C. New Accounts"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "8A. New Accounts",
          "type": "datasource.lookup.gigya.account",
          "params": {
            "select": "UID",
            "handleFieldConflicts": "take_lookup",
            "mismatchBehavior": "process",
            "lookupFields": [
              {
                "sourceField": "_phoneNumber",
                "gigyaField": "phoneNumber"
              }
            ],
            "lookupFieldsOperator": "OR",
            "matchBehavior": "remove",
            "isCaseSensitive": false,
            "from": "accounts",
            "batchSize": 200,
            "maxConcurrency": 1,
            "multiMatchBehavior": "error"
          },
          "next": ["9A. Rename Fields"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "6A. Existing Accounts",
          "type": "datasource.lookup.gigya.account",
          "params": {
            "select": "UID,identities,data.areaOfInterest,data.pet,data.child,data.externalApplication,lastUpdated,data.initialAppSourceCode,phoneNumber,profile.email",
            "handleFieldConflicts": "take_lookup",
            "mismatchBehavior": "remove",
            "lookupFields": [
              {
                "sourceField": "_phoneNumber",
                "gigyaField": "phoneNumber"
              },
              {
                "sourceField": "profile._email",
                "gigyaField": "loginIDs.unverifiedEmails"
              },
              {
                "sourceField": "profile._email",
                "gigyaField": "loginIDs.emails"
              }
            ],
            "lookupFieldsOperator": "OR",
            "matchBehavior": "process",
            "isCaseSensitive": false,
            "from": "accounts",
            "batchSize": 200,
            "maxConcurrency": 1,
            "multiMatchBehavior": "error"
          },
          "next": [" 7A. Perform Merge Logic", "Prepare existent accounts to extract"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "9A. Rename Fields",
          "type": "field.rename",
          "params": {
            "fields": [
              {
                "sourceField": "data._areaOfInterest",
                "targetField": "data.areaOfInterest"
              },
              {
                "sourceField": "data._pet",
                "targetField": "data.pet"
              },
              {
                "sourceField": "data._child",
                "targetField": "data.child"
              },
              {
                "sourceField": "data._externalApplication",
                "targetField": "data.externalApplication"
              },
              {
                "sourceField": "_lastUpdated",
                "targetField": "lastUpdated"
              },
              {
                "sourceField": "data._initialAppSourceCode",
                "targetField": "data.initialAppSourceCode"
              },
              {
                "sourceField": "profile._email",
                "targetField": "profile.email"
              },
              {
                "sourceField": "_phoneNumber",
                "targetField": "phoneNumber"
              },
              {
                "sourceField": "_loginIDs",
                "targetField": "loginIDs"
              },
              {
                "sourceField": "_emails",
                "targetField": "emails"
              },
              {
                "sourceField": "_identities",
                "targetField": "identities"
              }
            ]
          },
          "next": ["10A. Set standard data"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "5. Generate UID and check lang",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7CiAgICByZWNvcmQuVUlEID0gJ3h4eHh4eHh4eHh4eDR4eHh5eHh4eHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beHldL2csIGZ1bmN0aW9uKGMpIHsKICAgICAgICB2YXIgciA9IE1hdGgucmFuZG9tKCkgKiAxNiB8IDAsIHYgPSBjID09ICd4JyA/IHIgOiAociAmIDB4MyB8IDB4OCk7CiAgICAgICAgcmV0dXJuIHYudG9TdHJpbmcoMTYpOwogICAgfSk7CiAgICBpZiAocmVjb3JkLnByZWZlcmVuY2VzICYmICFyZWNvcmQubGFuZykgewogICAgICAgIGlmIChyZWNvcmQucHJvZmlsZSAmJiByZWNvcmQucHJvZmlsZS5sb2NhbGUpIHsKICAgICAgICAgICAgcmVjb3JkLmxhbmcgPSByZWNvcmQucHJvZmlsZS5sb2NhbGU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICByZWNvcmQubGFuZyA9ICJlbiI7IAogICAgICAgIH0KICAgIH0KICAgIHJldHVybiByZWNvcmQ7Cn0=",
            "notifyLastRecord": false,
            "ECMAScriptVersion": "12"
          },
          "next": ["6A. PhoneNumber accounts", "6B. Email accounts"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "10A. Set standard data",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgDQogICAgaWYgKHJlY29yZC5waG9uZU51bWJlciAmJiAoIXJlY29yZC5wcm9maWxlLmVtYWlsIHx8IHJlY29yZC5wcm9maWxlLmVtYWlsLmluZGV4T2YoInJhbmRvbWVtYWlsLm5lc3RsZS5jb20iKSAhPSAtMSkpIHsNCiAgICAgICAgcmVjb3JkLnByb2ZpbGUuZW1haWwgPSByZWNvcmQuVUlEKyJAcmFuZG9tZW1haWwubmVzdGxlLmNvbSI7DQogICAgICAgIHJlY29yZC5sb2dpbklEcyA9IHt9Ow0KICAgICAgICByZWNvcmQubG9naW5JRHMudW52ZXJpZmllZEVtYWlscyA9IFtyZWNvcmQuVUlEKyJAcmFuZG9tZW1haWwubmVzdGxlLmNvbSJdOw0KICAgICAgICByZWNvcmQuZW1haWxzID0ge307DQogICAgICAgIHJlY29yZC5lbWFpbHMudW52ZXJpZmllZCA9IFtyZWNvcmQuVUlEKyJAcmFuZG9tZW1haWwubmVzdGxlLmNvbSJdOw0KICAgICAgICBpZihyZWNvcmQuaWRlbnRpdGllcykgew0KICAgICAgICAgICAgdmFyIG5ld2lkZW50aXRpZXMgPSBbXTsNCiAgICAgICAgICAgIGZvcih2YXIgaSBpbiByZWNvcmQuaWRlbnRpdGllcykgew0KICAgICAgICAgICAgICAgIGlmKHJlY29yZC5pZGVudGl0aWVzW2ldWyJwcm92aWRlciJdICYmIHJlY29yZC5pZGVudGl0aWVzWzBdWyJwcm92aWRlciJdID09ICJzaXRlIikgew0KICAgICAgICAgICAgICAgICAgICByZWNvcmQuaWRlbnRpdGllc1tpXVsiZW1haWwiXSA9IHJlY29yZC5VSUQrIkByYW5kb21lbWFpbC5uZXN0bGUuY29tIjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgbmV3aWRlbnRpdGllcy5wdXNoKHJlY29yZC5pZGVudGl0aWVzW2ldKQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmVjb3JkLmlkZW50aXRpZXMgPSBuZXdpZGVudGl0aWVzOw0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIC8vIHNldCBkYXRhLmNoaWxkW10uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXINCiAgICBpZiAocmVjb3JkLmRhdGEuY2hpbGQgJiYgcmVjb3JkLmRhdGEuY2hpbGQubGVuZ3RoID4gMCl7DQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgIHJlY29yZC5kYXRhLmNoaWxkLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBpZighY2hlY2tVVUlEKHJlY29yZC5kYXRhLmNoaWxkW2ldWyJhcHBsaWNhdGlvbkludGVybmFsSWRlbnRpZmllciJdKSl7DQogICAgICAgICAgICAgICAgcmVjb3JkLmRhdGEuY2hpbGRbaV1bImFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyIl0gPSBnZW5lcmF0ZVVVSUQoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICAgLy8gc2V0IGRhdGEucGV0W10uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXINCiAgICBpZiAocmVjb3JkLmRhdGEucGV0ICYmIHJlY29yZC5kYXRhLnBldC5sZW5ndGggPiAwKXsNCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAgcmVjb3JkLmRhdGEucGV0Lmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBpZighY2hlY2tVVUlEKHJlY29yZC5kYXRhLnBldFtpXVsiYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIiXSkpew0KICAgICAgICAgICAgICAgIHJlY29yZC5kYXRhLnBldFtpXVsiYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIiXSA9IGdlbmVyYXRlVVVJRCgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIGlmIChyZWNvcmQuX2lkZW50aXRpZXMgJiYgcmVjb3JkLl9pZGVudGl0aWVzLmxlbmd0aCA+IDApIHsNCiAgICAgICAgdmFyIGlkZW50aXRpZXMgPSBbXTsNCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWNvcmQuX2lkZW50aXRpZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIGZvciAodmFyIGtleVdvcmQgaW4gWyJlbWFpbCIsICJmaXJzdE5hbWUiLCAibGFzdE5hbWUiLCAibG9jYWxlIiwgImNpdHkiLCAiZ2VuZGVyIiwgImNvdW50cnkiLCAiemlwIl0pDQogICAgICAgICAgICAgICAgcmVjb3JkLl9pZGVudGl0aWVzW2ldW2tleVdvcmRdID0gYXNzaWduSWRlbnRpdGllc1Byb3BlcnR5KHJlY29yZC5faWRlbnRpdGllc1tpXVtrZXlXb3JkXSwgcmVjb3JkLnByb2ZpbGVba2V5V29yZF0pOw0KICAgICAgICAgICAgaWRlbnRpdGllcy5wdXNoKHJlY29yZC5faWRlbnRpdGllc1tpXSk7DQogICAgICAgIH0NCiAgICAgICAgcmVjb3JkLmlkZW50aXRpZXMgPSBpZGVudGl0aWVzOw0KICAgIH0gZWxzZSB7DQogICAgICAgIHJlY29yZC5pZGVudGl0aWVzID0gW107DQogICAgfQ0KICAgIA0KICAgIGlmIChyZWNvcmQucHJlZmVyZW5jZXMpIHsNCiAgICAgICAgDQogICAgICAgIGZvciAodmFyIGtleSBpbiByZWNvcmQucHJlZmVyZW5jZXMpIHsNCiAgICAgICAgICAgIGlmIChrZXkgIT0gInRlcm1zIiAmJiBrZXkgIT0gInByaXZhY3kiKQ0KICAgICAgICAgICAgICAgIHJlY29yZC5wcmVmZXJlbmNlc1trZXldLmN1c3RvbURhdGEgPSBudWxsOw0KICAgICAgICB9ICAgDQoNCiAgICAgICAgaWYgKHJlY29yZC5wcmVmZXJlbmNlcy50ZXJtcykgew0KICAgICAgICAgICAgZm9yICh2YXIgdGVybXNLZXkgaW4gcmVjb3JkLnByZWZlcmVuY2VzLnRlcm1zKSB7DQogICAgICAgICAgICAgICAgcmVjb3JkLnByZWZlcmVuY2VzLnRlcm1zW3Rlcm1zS2V5XS5jdXN0b21EYXRhID0gbnVsbDsNCiAgICAgICAgICAgIH0gICAgICAgIA0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKHJlY29yZC5wcmVmZXJlbmNlcy5wcml2YWN5KSB7DQogICAgICAgICAgICBmb3IgKHZhciBwcml2YWN5S2V5IGluIHJlY29yZC5wcmVmZXJlbmNlcy5wcml2YWN5KSB7DQogICAgICAgICAgICAgICAgcmVjb3JkLnByZWZlcmVuY2VzLnByaXZhY3lbcHJpdmFjeUtleV0uY3VzdG9tRGF0YSA9IG51bGw7DQogICAgICAgICAgICB9ICAgICAgICANCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICAvLyBTdWJzY3JpcHRpb24gbG9naWMNCiAgICByZWNvcmQuc3Vic2NyaXB0aW9ucyA9IHt9Ow0KICAgIGlmIChyZWNvcmQuX3N1YnNjcmlwdGlvbnMpIHsNCiAgICAgICAgZm9yICh2YXIgc3ViS2V5IGluIHJlY29yZC5fc3Vic2NyaXB0aW9ucykgew0KICAgICAgICAgICAgaWYgKHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsKSB7DQogICAgICAgICAgICAgICAgaWYgKCJ0cnVlIiA9PSAie3tET1VCTEVfT1BUX0lOfX0iKSB7DQogICAgICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbiAmJiByZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5zdGF0dXMgJiYgcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uc3RhdHVzID09PSAiQ29uZmlybWVkIikgew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkID0gcHJvY2Vzc1N1YnNjcmlwdGlvbnMocmVjb3JkLCBzdWJLZXkpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbiB8fCAocmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uc3RhdHVzICYmIHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLnN0YXR1cyA9PT0gIkNvbmZpcm1lZCIpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZWNvcmQgPSBwcm9jZXNzU3Vic2NyaXB0aW9ucyhyZWNvcmQsIHN1YktleSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgcmV0dXJuIHJlY29yZDsNCn0NCg0KZnVuY3Rpb24gcHJvY2Vzc1N1YnNjcmlwdGlvbnMocmVjb3JkLCBzdWJLZXkpIHsNCiAgICByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldID0gcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV07DQogICAgDQogICAgaWYgKHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4pIHsNCiAgICAgICAgdmFyIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPSByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLmRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQ7DQogICAgICAgIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPSAoZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCAhPT0gbnVsbCAmJiBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkICE9PSB1bmRlZmluZWQpDQogICAgICAgICAgICA/IHR5cGVvZiBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkID09PSAiYm9vbGVhbiIgPyBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkIDogZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCA9PSAidHJ1ZSINCiAgICAgICAgICAgIDogbnVsbDsNCg0KICAgICAgICBzd2l0Y2ggKGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQpIHsNCiAgICAgICAgICAgIGNhc2UgdHJ1ZToNCiAgICAgICAgICAgICAgICByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLmlzRXh0ZXJuYWxseVZlcmlmaWVkID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGNhc2UgZmFsc2U6DQogICAgICAgICAgICAgICAgcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5pc0V4dGVybmFsbHlWZXJpZmllZCA9IGZhbHNlOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgY2FzZSBudWxsOg0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICB2YXIgb2JqZWN0ID0ge307DQogICAgICAgIGZvciAodmFyIGtleSBpbiByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluKSB7DQogICAgICAgICAgICBpZiAoa2V5ICE9PSAnZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCcpIHsNCiAgICAgICAgICAgICAgICBvYmplY3Rba2V5XSA9IHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW5ba2V5XTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4gPSBvYmplY3Q7DQogICAgfQ0KICAgIA0KICAgIC8vU1RBUlQgLSBNU0NORC0zOTE3MiAtIENoYW5nZSBvbiBpbXBvcnRpbmcgc3Vic2NyaXB0aW9ucyB0byBleGlzdGluZyBhY2NvdW50cw0KICAgIGlmIChyZWNvcmQ/LnN1YnNjcmlwdGlvbnM/LltzdWJLZXldPy5lbWFpbD8ubGFzdFVwZGF0ZWRTdWJzY3JpcHRpb25TdGF0ZSAmJg0KICAgIGlzRGF0ZUluRnV0dXJlKHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwubGFzdFVwZGF0ZWRTdWJzY3JpcHRpb25TdGF0ZSkpIHsNCiAgICAgICAgZGVsZXRlIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwubGFzdFVwZGF0ZWRTdWJzY3JpcHRpb25TdGF0ZTsNCiAgICB9DQogICAgLy9FTkQgLSBNU0NORC0zOTE3MiAtIENoYW5nZSBvbiBpbXBvcnRpbmcgc3Vic2NyaXB0aW9ucyB0byBleGlzdGluZyBhY2NvdW50cw0KDQogICAgcmV0dXJuIHJlY29yZDsNCn0NCg0KLy9TVEFSVCAtIE1TQ05ELTM5MTcyIC0gQ2hhbmdlIG9uIGltcG9ydGluZyBzdWJzY3JpcHRpb25zIHRvIGV4aXN0aW5nIGFjY291bnRzDQpmdW5jdGlvbiBpc0RhdGVJbkZ1dHVyZShkYXRlU3RyaW5nKSB7DQogIC8vIFBhcnNlIHRoZSBnaXZlbiBkYXRlIHN0cmluZyBpbnRvIGEgRGF0ZSBvYmplY3QNCiAgY29uc3QgZ2l2ZW5EYXRlID0gbmV3IERhdGUoZGF0ZVN0cmluZyk7DQogIA0KICAvLyBHZXQgdGhlIGN1cnJlbnQgZGF0ZSBhbmQgdGltZQ0KICBjb25zdCBjdXJyZW50RGF0ZSA9IG5ldyBEYXRlKCk7DQogIA0KICAvLyBDb21wYXJlIHRoZSBnaXZlbiBkYXRlIHdpdGggdGhlIGN1cnJlbnQgZGF0ZQ0KICByZXR1cm4gZ2l2ZW5EYXRlID4gY3VycmVudERhdGU7DQp9DQovL0VORCAtIE1TQ05ELTM5MTcyIC0gQ2hhbmdlIG9uIGltcG9ydGluZyBzdWJzY3JpcHRpb25zIHRvIGV4aXN0aW5nIGFjY291bnRzDQoNCmZ1bmN0aW9uIGNoZWNrVVVJRCh1dWlkKSB7DQogICAgY29uc3QgcmVnZXggPSAvXlswLTlhLWZdezh9LVswLTlhLWZdezR9LTRbMC05YS1mXXszfS1bODlhYl1bMC05YS1mXXszfS1bMC05YS1mXXsxMn0kL2k7DQogICAgcmV0dXJuIHJlZ2V4LnRlc3QodXVpZCk7DQp9DQoNCmZ1bmN0aW9uIGdlbmVyYXRlVVVJRCgpIHsNCiAgIHZhciBkID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7DQogICB2YXIgdXVpZCA9ICJ4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgiLnJlcGxhY2UoL1t4eV0vZywgZnVuY3Rpb24oYykgew0KICAgICAgIHZhciByID0gKGQgKyBNYXRoLnJhbmRvbSgpKjE2KSUxNiB8IDA7DQogICAgICAgZCA9IE1hdGguZmxvb3IoZC8xNik7DQogICAgICAgICAgICByZXR1cm4gKGM9PSJ4IiA/IHIgOiAociYweDN8MHg4KSkudG9TdHJpbmcoMTYpOw0KICAgIH0pOw0KICAgIHJldHVybiB1dWlkOw0KfQ0KDQpmdW5jdGlvbiBhc3NpZ25JZGVudGl0aWVzUHJvcGVydHkoaWRlbnRpdHlQcm9wZXJ0eSwgcHJvZmlsZVByb3BlcnR5KSB7DQogICAgaWYgKGlkZW50aXR5UHJvcGVydHkgJiYgaWRlbnRpdHlQcm9wZXJ0eS5sZW5ndGgpIHsNCiAgICAgICAgaWYgKHByb2ZpbGVQcm9wZXJ0eSAmJiBwcm9maWxlUHJvcGVydHkubGVuZ3RoICYmIGlkZW50aXR5UHJvcGVydHkgIT09IHByb2ZpbGVQcm9wZXJ0eSkgcmV0dXJuIHByb2ZpbGVQcm9wZXJ0eTsNCiAgICAgICAgZWxzZSByZXR1cm4gaWRlbnRpdHlQcm9wZXJ0eTsNCiAgICB9IGVsc2UgcmV0dXJuIHByb2ZpbGVQcm9wZXJ0eTsNCn0=",
            "notifyLastRecord": false,
            "ECMAScriptVersion": "12"
          },
          "next": ["10A bis. Set standard Area of Interest"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "2. Decrypt PGP",
          "type": "file.decrypt.pgp",
          "params": {
            "pgpKey": "LS0tLS1CRUdJTiBQR1AgUFVCTElDIEtFWSBCTE9DSy0tLS0tCgptUUlOQkYwSG5iRUJFQUN5WHUrekJzanYveUlpNkFYSFBnL081b2VnRGVDTTRMaDMxY2xMMVhjK0J0dWFQb1B0CktVRHJLQXVhR1Q4cngzNGlzeExYdmJvSTVFRU96NTd5VEVxWDhMTHFadlY4U1ZFZUtVdzE1WVhKVkpFVDhFWXIKVTV0TmVvK0Zpajd1elEwWHV3a0JTOGpxMERGcFRUeXl1c3ZreHRtZWNnQW85a3FlQ0JmOEF3V0EwSXpiRmptTwpSbVBYSTBjYmMyWWplVXZ1WUkyOXVOa2hMbUM5VFVDcU9jMFlTaDJDWVZ6a3hBZjF5dGVOZ1BtQkVnRTBWNmFiCmlDMFhlSERBSTN0Z3ZxV2c0Nk8rWFNDTXZTclVndXV3aXRpbmtObXB5SWtadnFvWE9kUmtBN0hCcmc1VVRqVEMKOFM5L3lHMlF3anNvRUtRRmxhWHM2NzZJdTBwaTM2K1l0RHVuYnNITlZmbnEraSt5ZHFEcmlPRDZhRmpXNEFVYQp2NTNwOVJQQXEydDdCVnN0SklieHV2TWRRcDJJOEp0MW12NXFTeHJBOVZTeU9BMXFMcUl4NHd4T0t0RlhXZXJhCnFmVkRaV3RtS0NkQytPREpnbnVHMHdTRkQyRFY2WHN3YTNkdXJ4Sk5RaEZpc2JpTXJJTjZhc0dzSU5WUm9YNmEKd1hROEU2K2cyTjdKbitCeHpkNDllZ2h1Z3k2dHR4KzNjbTBJQ2lYVTVJRTZyZVdnNTVFU2cxdzQ4S3B1SmVtMwo2TWhUUEUwcksyY0c2em5FZUV0R0dFTzhxcXBtRDVjbmUzVzJRdGhJL3duVTR4aitpSXJaV0NSbCtYZkdlc2xYCjZkNDVMSTZBK3BpTGRkaVdUSWFZSzQ1OHVrVnFreTRRUm5SZVpqT3ZzbDY0bVlGdDFPYnlpSWhlc3dBUkFRQUIKdEIxRFNVRk5JRWx0Y0c5eWRDQThZMmxoYlVCdVpYTjBiR1V1WTI5dFBva0NUZ1FUQVFnQU9CWWhCQ2U3WkxlLwpxb2Qva2hYQUd5clJ3MnJFdzd6cUJRSmRCNTJ4QWhzREJRc0pDQWNDQmhVS0NRZ0xBZ1FXQWdNQkFoNEJBaGVBCkFBb0pFQ3JSdzJyRXc3enEwK0FQL1J0TldyR0xwK3BSV09IU1BNRlNoUUJBU1FZdUk5Sk5Sdk9vM3FhVnRpaTcKNHlvZzVKSVZ2M2VBS0tmVThhZjVPOEl6eXZKaWdoOEpTd1Blc2UzQldnT2M2amYrRStCZkdLa0ZBMGFyVFAvNgpLV0NGUzR0ZlA4VkpwVVBzVkUwbS9lanNRK0wzNW5hb0FUUnIrRmtKN0VBRldZVzhYT0xPOU94dGZDOVYyV3B0CkJQRDRmVUFXZXArQnB5ZTN3ZXBSVFNOelhHbkhKS0FjaEVCcUc1NjRTRmVCNWN2RXcydnE2RytNeTZ1MDdnRHMKZ1BUVzE4NnNrWkk2YkFOWEJucjVSaFg1YzBIRlRaNlZXTEJxYTI0U0pXNnVsemxmZWtpQlY3d0RDakxFbUljVQpId3JDSjhsSkh0dEcxT2JNYjBUT3pEb2I4anVSM1JWUFp0MzhXa3hwS0s1RmowbGlYeHgycWlacEtIN2RWYzRlCmZLNnZkWUJNcUZkL3B3SlpvOW12cHUwYTA1Nm9lMVhTcTRzbWxmalJ3WDhYMDRzb01USTEvbUxFK1c1aWJEREEKQ0tsQlNsSC9NZHdTTlQ1SXV4TzFxdUdjMjBKQ0x2WVF3OUhWVXNTMjV5NHhzNTZqa3U2MkVuZFJYZHFVM0FuSgp3TnBCOCtoNEVHVnFERmQybFVOV1hveUxZSk5IblcyUDZ6MlRyZ00wWWpqazRrTzQ2VWdzL1Zkcmd3czAzYUU3CjcwbDh3aHJLSm1GR1hJYWtJYk9qeENuRG4zaW5IV3ZGNUQ5dHkxanVkZ3dtY01rTE1OWnJ5SjEwbXRMWDlRbUkKVlRWekdRQ1RqL3laNmxGb1B5YkV0YTc3Z0N2ZlV6MEZYeEp6bzJCSjAycUdzSE1za3NJN2xqYmNSVE5IMVF6VAp1UUlOQkYwSG5iRUJFQURPVkVxeCtONWhNTHlpZEt3TjY3emN4SUVOalo2N0JPcjhOcjYydEFTY0Q2SnFMaTBvCml4b08zdUs0ZVI3YW9vWjVuMExER2hSNUVtQkZEdGVsY2VIR0dLYmFVcjRwNEt4NUdhKy8wWXlsN3lHZzNIMjEKMk1ub3lWS1NnUmVwMis3QVpPbHdWL1dablk1YmxmN0Jua21lSXowOTRodFE1T1BMa3NVUWZxZUZKemc1WmhUKwpSRzlOTUY1OE1xd2d1U3VldWVBa1JBc3NldncvSW9jbE05cHUyTEh3d0lmNHFKbG5iMEt6K3RQQjdqendPR2tCCjVOR2FIUXkvcjh2eTlIaThiSzNrWk8xK0FZcm5jdmdHSDJkUi9KRVlXU2MzWmlQZXQ2bDFWT3RPK3NlMVkzdjIKblQ1NW9UZDlRV2lkbFNPeGxiQStrckVtRDRuMUxIbHhPQit1MzRMQk1LLy9pWk1Hb0RpZUNTTHFSdlNONkRwZQo4d2J5SlQ4Mm9ITEtxN2lyYTNmeXA3blR0UUNneEdZMmVhUGU1NkVVc0FOakEvWjQyS3c4ZGRpeFFFR2paMHRrCkVXMEhNWVA2UjZlaFc4ODBFSjYxeWFhYXlJbE1zN0FEdlV4SjgzWmxReFhXVVdiMExweFRLRXdEemRlNkZxMEsKQUxzcXZOdGdhSXNXNzlYeVBRRkNqSnR6Y0JwUmJwQWo5bEl3UXU3L1lVM0E0TzBXWTBGYnNoQmxhaXlXMHI2cQo3cit2ZzE5OVovTld5SlhiUy9Ob01nZjdlSzdZL2JxOTA2VkFqVXBvUG1HdmRWMmFndzE1S29XaUZ2MU9NZi9vClVBS2tnN29ZcEdSVW9ybU9XcC8wYTUwemhpc1VCTjR0Qi9qZnkyNHJmVmR3ckRCeDNEbHNNRE90MVFBUkFRQUIKaVFJMkJCZ0JDQUFnRmlFRUo3dGt0NytxaDMrU0ZjQWJLdEhEYXNURHZPb0ZBbDBIbmJFQ0d3d0FDZ2tRS3RIRAphc1REdk9vak5SQUFpMWpzQWtheTA1eG51bU40b0J3TGpoczJUbEp6QjJqTEdmWVYvMzBQZHZWeTFrc1hHbmVaClV6a1ZRUGlqYWZlV3dGQTQwMzFSWG11b2lmczM5b0Zvek5yeXZYNTJ5WlV4a0hSMVRlbThNbzZCUmhYR2J5alcKNkZXMnJ1bFE5VUM0bEZzbUdzc2xQeGtnWVdOaE5nSlFFMTBJWHhkVGtWMnBjZndMNE9sK2YvWnpZVmV6WjliWgpqUHJxaExkcUwwWkJZV05CTnYxbVAyNlVmbTJkNnhwcGJxSGxabHplNEJVM1JwM0R2aWhzU2Frd0FiRnJQVVViClJ1dXJ1dHJ0K1pvMTY0M0VSWFo5eXpWQmZXWFU2UkU2QVVQL2RJZjlhdlV3REJpQllGc056UXlvZXovU213NzQKN0JqQU1pK1JSWDIzcCtpWVhzdm1yMjBFWGpmd3laRVhYcGVHNVhXYi9FeGNJbGIwN0hKNTl1ZHl5ODVPOFN1VgpXaWxNTFVaZUQvejhRZFhwMUdQMGI3L2dWbExCYjBTMEl5RmZwcjZJRlB5TU5pR3FOVGpqdVltV0FvODVNQzY4Cm9Bb2dCYUJHcGJmNk10TFMzMzcxcTNpR0NuTU9SaDJ6TWsvZDRLSkV5bkQ4Nm9qZHg0Z0V2R2dvK0g1M2d4ckkKOEp6MXZ5QXl5UzAzODc0M1RoVGFsck9yWVg5UnVxUWIySXVRRVh6YUhMUjdUYUxKbnRDdU5tQ00xTG5QUisxeApvSmpHSDhJOHdEdnkvS0tENjAyV2pyWjdJTnNHZzgrcndPeWxvTmcybXJ1U052VnVmaklFTDUzUnRBOHgreVlpCk1wakRLL2I4VmdYZHV6Myt2b2pka1FNeVJLM2NEYVJoV0hyS0JvVzNOVFk5Q251U2tJMWlvUUU9Cj1pMDlqCi0tLS0tRU5EIFBHUCBQVUJMSUMgS0VZIEJMT0NLLS0tLS0=",
            "pgpKey.importedPrivateKey": "LS0tLS1CRUdJTiBQR1AgUFJJVkFURSBLRVkgQkxPQ0stLS0tLQoKbFFjWUJGMEhuYkVCRUFDeVh1K3pCc2p2L3lJaTZBWEhQZy9PNW9lZ0RlQ000TGgzMWNsTDFYYytCdHVhUG9QdApLVURyS0F1YUdUOHJ4MzRpc3hMWHZib0k1RUVPejU3eVRFcVg4TExxWnZWOFNWRWVLVXcxNVlYSlZKRVQ4RVlyClU1dE5lbytGaWo3dXpRMFh1d2tCUzhqcTBERnBUVHl5dXN2a3h0bWVjZ0FvOWtxZUNCZjhBd1dBMEl6YkZqbU8KUm1QWEkwY2JjMllqZVV2dVlJMjl1TmtoTG1DOVRVQ3FPYzBZU2gyQ1lWemt4QWYxeXRlTmdQbUJFZ0UwVjZhYgppQzBYZUhEQUkzdGd2cVdnNDZPK1hTQ012U3JVZ3V1d2l0aW5rTm1weUlrWnZxb1hPZFJrQTdIQnJnNVVUalRDCjhTOS95RzJRd2pzb0VLUUZsYVhzNjc2SXUwcGkzNitZdER1bmJzSE5WZm5xK2kreWRxRHJpT0Q2YUZqVzRBVWEKdjUzcDlSUEFxMnQ3QlZzdEpJYnh1dk1kUXAySThKdDFtdjVxU3hyQTlWU3lPQTFxTHFJeDR3eE9LdEZYV2VyYQpxZlZEWld0bUtDZEMrT0RKZ251RzB3U0ZEMkRWNlhzd2EzZHVyeEpOUWhGaXNiaU1ySU42YXNHc0lOVlJvWDZhCndYUThFNitnMk43Sm4rQnh6ZDQ5ZWdodWd5NnR0eCszY20wSUNpWFU1SUU2cmVXZzU1RVNnMXc0OEtwdUplbTMKNk1oVFBFMHJLMmNHNnpuRWVFdEdHRU84cXFwbUQ1Y25lM1cyUXRoSS93blU0eGoraUlyWldDUmwrWGZHZXNsWAo2ZDQ1TEk2QStwaUxkZGlXVElhWUs0NTh1a1Zxa3k0UVJuUmVaak92c2w2NG1ZRnQxT2J5aUloZXN3QVJBUUFCCkFBLzhDMnpYcDF6UlpSeXZWK2kxdjEvaklsVVRnelhiQXNXOWV5RGgvbTREYjh2VS9YOGJTSWNpY0kyYTcwN0cKV1pjSWUzb3Q3dmRvOXZzcjRhSW5PUXp0b0QyR01FdlNWZTR2b3lJYnVXaTZGajNJOXl2UTlYaUFVNTVSOEIzOQpUdmdxYWx2aGIvTDdRUjNVZEdnWDhialRxT2xGeWpJeUtXMkdpbDNVQk12cXY5S3hSYktaa3RxV1l1ZzdFZS9sCkx4NHN0aGhRSysxWnJHMlhPN2psaktIRzJIM3kxWnJ5bU0xU1Z6VHhjL3BsYTVZMjBUUDdhTmlpK1c4T1d5TDEKV3YvZ2hicmZEbFA5RlphNUFNTmhZUk1HWFV3Q3dvUjZVbFdyVG5FMnExdFlqazB5LzIvQ1RiNzdmeEN4clVVMgpXeWdmRENQY1FoM2k1cDR4M2IzSE5uTDJUblZKOVpML2dhRXJRNUhGWDA5a2JPUzRSTWVQbzY3K1JLckowZ2F6CmZoYjdsNUlIdHdpajg1NVIxWWlyWGtQd0lxcEVIaXQ3Q2U1RWtRTEk4Nm42QnNJdHpnM3ZWKzcrTmFjS0RGRDQKK3BwTnhaYUYxdGFsWGo5N2NIS1hjOTNKNDhmc2NoYWNJekZVa2JLbjJZMGI0c2EvVWVMUHM4Y2drWkhuT3R3egppOEZ3M1o2RHVWSEdKbzdKdmJlMnFzdXdsQjFXZHprVUxEdzl5OUJvSjlTTTJhT1hsVWpQOFl6Um1ROVhkWXJQCmg0MGFuUURsN2lxT3RoNHVQSjgzZGI0ZHdPY1M1K0FGNTZlcitwZ3hpeE14ZzI1V1lEbWxMQXlHV2JqMDBXcGYKTndibDlwU3BRdmxvQnUwd1MrVlgwKzFqZEVlMVZ4SFF4bFNZenNReHJKTU9Xd1VJQU1pcEpqUjQxVXA1LzNGawpxc0hOS29BSndzakQ0TFpLeTRrWVJCUElHMXhDL3VtdlFFK3luL0VxczdvYm9raVU5aDBoWUJ5OXF5c2trK2pICldhZ0NTQjAyU0pNK25mSVcxazhVWTRnSHJBd3hJSC9BY1dtSUlLZmZYb1VzMENYMGhsdEUyTGxaS2pWd0hEdkoKbTJSbG8yeU5McHVtSkd0TCtGU3QveTVRTEY3VlNYck1HaDA1YVE1OGZORDFhcG5yKy9tekE1bkdIMFNUeEU5agorellpM3Axak91UkVUZmE1cWl6anJhNGZGVWlJeWFRdThpakRaUGNUUVBYTTBaK1pBMTJFUlFNbFBzK1ZZWlFECndkMXl2RUFmK0JsMG1KNFBzb2VKdHF3TElvZHFhV1lUS0VzeG5lbU43TTdMaDJzdWRsQ1c4MFh0a2owc3NZNmIKWXNmdUd0MElBT09RR1Jvai9zbFJ2ZzV2ODhUNElOMWtvRXI3OUZnWk1kb1VURS9vN2FjWjlMN0E1c25qdWp3UgpBM2dLNXpHelBPeVAxdW80ellEdWMycStBSjNQcXdoTDFleXNCWWNWVFg0Y3F1M3c3Qkk5VW5UbG9ObytHb3FyCi9JN3VCaThGNys1a2w3K3ovb3JwelAxc1RCdHNVRUs1V0YyVFdobnN2aGR4OVRWSDNZLzFuY3Y5dFdEWWVWR1gKZ0FTcUI3L2xCWkI5UmNkTDl4Y3haUU5ZeitoVFQyeEIvbDZXNDBSZHc0cUJ2UVNoV3NpcUFESEdsS1o3QysrSgpSZUhreU5iWFljUndhQnA2eExiS1NZeWM3WW5YMU03YUFMc3licGVpMkxDWHowNWNpWm9FNkl6UWRhamVEZlByCjNHK2Z3WXhUbU9yZ0pabmYwUUx1TUhWNFJFSzUzczhJQUs5cGNOQ09EODZxZGtrRmlGaWEwZ2tSZjRTTjBGK3IKZzJFT3F4UkJ5VlRoRzdUVTRVcEgrN0oySFlyV1ErVjg5b05oZjlIcTNKMXlEN1Z4Q2Q5UGRlVTBVTEJ3YTFEVQoyVGdHZ3kzVEgvcFQ5Zjl3MUpOd2lQZjZOODNUQTFGUG03R1hBVlhaMXRsYTZiMGE5T1NWSXQ0cVpMRXRIZnNpCllJN1pWSVFpL0ZiVXF2WnRBSzB6VnRZaFdUVDdPalVzQ2owbWNNNmJBRHhlZ1ZSRTNyTjJ0VGJxemRiR1U0ZTYKVmU2UDdWMmlUbUtkSWNBZVAzVFBZQzMyNEdCck1zUC8rdWZReWQ4RkY3U1paWlUrKzI0TUJRMlUwejBpdUxVbgo5WGRKZGR0dVVwUFZoeUdLc29XaVB3cTltK0ovMFRoaUxTOUJKdkJoa3M4K0ZTMVdIRjBtSU9hVW1MUWRRMGxCClRTQkpiWEJ2Y25RZ1BHTnBZVzFBYm1WemRHeGxMbU52YlQ2SkFrNEVFd0VJQURnV0lRUW51MlMzdjZxSGY1SVYKd0JzcTBjTnF4TU84NmdVQ1hRZWRzUUliQXdVTENRZ0hBZ1lWQ2drSUN3SUVGZ0lEQVFJZUFRSVhnQUFLQ1JBcQowY05xeE1PODZ0UGdELzBiVFZxeGk2ZnFVVmpoMGp6QlVvVUFRRWtHTGlQU1RVYnpxTjZtbGJZb3UrTXFJT1NTCkZiOTNnQ2luMVBHbitUdkNNOHJ5WW9JZkNVc0Qzckh0d1ZvRG5PbzMvaFBnWHhpcEJRTkdxMHovK2lsZ2hVdUwKWHovRlNhVkQ3RlJOSnYzbzdFUGk5K1oycUFFMGEvaFpDZXhBQlZtRnZGeml6dlRzYlh3dlZkbHFiUVR3K0gxQQpGbnFmZ2FjbnQ4SHFVVTBqYzF4cHh5U2dISVJBYWh1ZXVFaFhnZVhMeE1OcjZ1aHZqTXVydE80QTdJRDAxdGZPCnJKR1NPbXdEVndaNitVWVYrWE5CeFUyZWxWaXdhbXR1RWlWdXJwYzVYM3BJZ1ZlOEF3b3l4SmlIRkI4S3dpZkoKU1I3YlJ0VG16RzlFenN3NkcvSTdrZDBWVDJiZC9GcE1hU2l1Ulk5SllsOGNkcW9tYVNoKzNWWE9Ibnl1cjNXQQpUS2hYZjZjQ1dhUFpyNmJ0R3RPZXFIdFYwcXVMSnBYNDBjRi9GOU9MS0RFeU5mNWl4UGx1WW13d3dBaXBRVXBSCi96SGNFalUrU0xzVHRhcmhuTnRDUWk3MkVNUFIxVkxFdHVjdU1iT2VvNUx1dGhKM1VWM2FsTndKeWNEYVFmUG8KZUJCbGFneFhkcFZEVmw2TWkyQ1RSNTF0aitzOWs2NEROR0k0NU9KRHVPbElMUDFYYTRNTE5OMmhPKzlKZk1JYQp5aVpoUmx5R3BDR3pvOFFwdzU5NHB4MXJ4ZVEvYmN0WTduWU1KbkRKQ3pEV2E4aWRkSnJTMS9VSmlGVTFjeGtBCms0LzhtZXBSYUQ4bXhMV3UrNEFyMzFNOUJWOFNjNk5nU2ROcWhyQnpMSkxDTzVZMjNFVXpSOVVNMDUwSEdBUmQKQjUyeEFSQUF6bFJLc2ZqZVlUQzhvblNzRGV1ODNNU0JEWTJldXdUcS9EYSt0clFFbkEraWFpNHRLSXNhRHQ3aQp1SGtlMnFLR2VaOUN3eG9VZVJKZ1JRN1hwWEhoeGhpbTJsSytLZUNzZVJtdnY5R01wZThob054OXRkako2TWxTCmtvRVhxZHZ1d0dUcGNGZjFtWjJPVzVYK3daNUpuaU05UGVJYlVPVGp5NUxGRUg2bmhTYzRPV1lVL2tSdlRUQmUKZkRLc0lMa3Jucm5nSkVRTExIcjhQeUtISlRQYWJ0aXg4TUNIK0tpWloyOUNzL3JUd2U0ODhEaHBBZVRSbWgwTQp2Ni9MOHZSNHZHeXQ1R1R0ZmdHSzUzTDRCaDluVWZ5UkdGa25OMllqM3JlcGRWVHJUdnJIdFdONzlwMCtlYUUzCmZVRm9uWlVqc1pXd1BwS3hKZytKOVN4NWNUZ2ZydCtDd1RDdi80bVRCcUE0bmdraTZrYjBqZWc2WHZNRzhpVS8KTnFCeXlxdTRxMnQzOHFlNTA3VUFvTVJtTm5tajN1ZWhGTEFEWXdQMmVOaXNQSFhZc1VCQm8yZExaQkZ0QnpHRAora2Vub1Z2UE5CQ2V0Y21tbXNpSlRMT3dBNzFNU2ZOMlpVTVYxbEZtOUM2Y1V5aE1BODNYdWhhdENnQzdLcnpiCllHaUxGdS9WOGowQlFveWJjM0FhVVc2UUkvWlNNRUx1LzJGTndPRHRGbU5CVzdJUVpXb3NsdEsrcXU2L3I0TmYKZldmelZzaVYyMHZ6YURJSCszaXUyUDI2dmRPbFFJMUthRDVocjNWZG1vTU5lU3FGb2hiOVRqSC82RkFDcElPNgpHS1JrVktLNWpscWY5R3VkTTRZckZBVGVMUWY0Mzh0dUszMVhjS3d3Y2R3NWJEQXpyZFVBRVFFQUFRQVArUUVnCkhaNXJqcFZJb21oUXJaR0EzdTdXejN2d1RwdjYrQmsrU1paek1kQStDT1crVmRwZ3lBVFJab2wybzlNQXEvelgKV0xtaGNwMVZUQjJpZUtZb3ZydGttbUNMcndraHRqMUk4WE1JVDh1NXIzTXRiYVF4RkdaQXd3ZVA1WUx2bGRDUApSUGhTZHg3YnQyZU4xVVFWaHd2WmtTcU1NTDlnZ0kzNlVDODNMUWZLQ21HYko4NjhqN1lEMDR3ZEUzM3dSN1pFCkViY3NubUdGM2RTUXQyWlpFY1dnSVdTQVJ0QU9lV0NDaW5PVnJuL25OZktkYTlsZHFTMlJXcnAzb3hNUUs3NEsKbXk1TG5jdDdRZDFyMVM0V1N2VWVncFl0MFQwS2ZKRzN6UVM4ZFk2cWpyZTlqa2JDWXU3ZnBJQS9PK0R5eVZTZApQeCttdHljQXRSNTFDRWdxaDYrejV5WCt0dlJub1F5V2tBN0k1ZExEaHN0RW5McFozUW1Ec3V5WjVwZDRDS1BOClVacGU1di8wRDQ2dW1iQUliM1I1bEt2b1V2K1UwYVVXZDJJcDVEdER1VTd0OWk3L090a09RS2RKU25xSlJMOFkKd0VIWFdvcU1UVHA3U1dBMHo2Q29HSm43cDhHQ1RNUDdsQlUwWjdHUkFuaUljVVc5YnN4MkcvQUc4S29QVWF6eQpPUjVkVzFiUVpNY003S2xWRVVyZkowYzFCWGFGOVhkellFWW12QnFaYzUyR0Jrd0g1bFRKYkt2dWtLazF0MmVBClluWmJ3Rm9CeFQ1UVlSS3NTOFVsSWhFYnFkd1JicURwSk1oTzZwVEFFNFpLWEozUzR6cUJSN3NJN09KT0VNUC8KVGxiblZXeFN2cWVvdDdVYmpVQUFSSjgwcXA3b3dUT010cVdqcmxOcENBRGRnM2ExODVZejZMcGxYeWxlUG1KMApLWEEzQUtEcGtmV3hXcGpBRzhFaEtKYzcvNWdvZGtXZFdsUkR4eVpETEVEMGU2VG92MlN3bEdHeHlqUURjQXNNCkdxZ3hDd09QcWhsRjhLcjhxTkc5OEFNMllVd1ppVE5xalVRMEdZaHpXU1MzOGloSGtnYkpvcXc1cU1URnlmVXgKSG9pUkl2V25BandFRFVqL1RtRUdCRXI0YmtFUDZtWFFEZlR4d3BISnh2cUdFNVRGc2c3d1NibGpiSFBRRVRDNQpzbVl0QnF2Z1l5THMvT1p0N29iSDI4YzdLd1QwK0tjY21UVnl6bWF4b3RqRkNsMzFOMDRXTWdEdmhPV3JzTFd0ClBJQy9kNkhZVllENVUxeWllM1NnSjQyd2NtaXpldUlkTTJwREF5Zk0zVzI2K2xZZ3ZZeE11cGFnU2dTYjBmNVoKQ0FEdWM2YThwOEJNR1hHMGNjaEQ4UXNlZTJOT1VpaDdJQVV4b0hQcWE1OXNpNmJlWWRiSUp6aFZxMDJXYnJaVgpmVkJWeUp4Y0xTR2ttUFJUbDZSbjcxSHBpbTBkdlZzdkpZazRKYXlDNWJTTE02Tm9Ccyt5Z3o4RXkyVkxXQm4wCmlKQVFVck5EQXRpWDZyL1RoYW1wUlRpSjhKZnlxc1E3WHFPZll0MWVhZEFGdnBHZlpJdmxOYkJnV0I0UlY5R3cKbDhJTnlDUENSK3NKc2laZXRWenZXZ0tzS2h5K1hGV1E1NTVuWHdQOC91MlAxQXdKVVNGMndBcGpRbUNZQkxGRAo3Wi8va2dQWFREUG96T2lxRTdRZG5WK2ZxalBQY215eHlGRjJiZFhUNDFiWEErNW9UU2NsTklJUm1qV01LTW92CmZWTGZXZktuYUtITE9mcmNEZVBlRHBQZENBREFJSC8ra2tjUklnd2lhYmZXSGRKK1NhQ3ZHUG5ONkJNNHczODAKQVcxOEp2MGo3b2V6Y0ZSWjZSejQzYzZYVzh0Q2ZVT2cyb2ZCU1EyeDZEd3BSb3VlZkJ4TVQ2a2lPRlFjb3duZQpXVVRLbkJUR092Um1wRElhbkhocWZGODNhenQ5djF5TlRZc2dnNVFSNnlqWm13ZGZxVnJmWnNOMU04bzRqUHFBCnI2U1Azb05SZlM5RElzUjVubXVhYy9HSE80QnRaRkszeHpzUTFVL05md2hoSlFubTZvVE9rUEVQeWN6S2dZK1QKWTVrU0Nrb3RhQUhxZi8xMklSYVNieEdzeFBZNVpsc0tEazBkWEx1bWVtTFN0YlE3Y2pucThJbTdUZHJvdy9FNgo5dm9HOWJFeFZwTEIxSk9DeXdiZ2RobldEOFhlWGNma0lWczNGUUtvSDcwNUNDYjZkak9KQWpZRUdBRUlBQ0FXCklRUW51MlMzdjZxSGY1SVZ3QnNxMGNOcXhNTzg2Z1VDWFFlZHNRSWJEQUFLQ1JBcTBjTnF4TU84NmlNMUVBQ0wKV093Q1JyTFRuR2U2WTNpZ0hBdU9HelpPVW5NSGFNc1o5aFgvZlE5MjlYTFdTeGNhZDVsVE9SVkErS05wOTViQQpVRGpUZlZGZWE2aUoremYyZ1dqTTJ2SzlmbmJKbFRHUWRIVk42Ynd5am9GR0ZjWnZLTmJvVmJhdTZWRDFRTGlVCld5WWF5eVUvR1NCaFkyRTJBbEFUWFFoZkYxT1JYYWx4L0F2ZzZYNS85bk5oVjdObjF0bU0rdXFFdDJvdlJrRmgKWTBFMi9XWS9icFIrYlozckdtbHVvZVZtWE43Z0ZUZEduY08rS0d4SnFUQUJzV3M5UlJ0RzY2dTYydTM1bWpYcgpqY1JGZG4zTE5VRjlaZFRwRVRvQlEvOTBoLzFxOVRBTUdJRmdXdzNOREtoN1A5S2JEdmpzR01BeUw1RkZmYmVuCjZKaGV5K2F2YlFSZU4vREprUmRlbDRibGRadjhURndpVnZUc2NubjI1M0xMems3eEs1VmFLVXd0Umw0UC9QeEIKMWVuVVkvUnZ2K0JXVXNGdlJMUWpJVittdm9nVS9JdzJJYW8xT09PNWlaWUNqemt3THJ5Z0NpQUZvRWFsdC9veQowdExmZnZXcmVJWUtjdzVHSGJNeVQ5M2dva1RLY1B6cWlOM0hpQVM4YUNqNGZuZURHc2p3blBXL0lETEpMVGZ6CnZqZE9GTnFXczZ0aGYxRzZwQnZZaTVBUmZOb2N0SHROb3NtZTBLNDJZSXpVdWM5SDdYR2dtTVlmd2p6QU8vTDgKb29QclRaYU90bnNnMndhRHo2dkE3S1dnMkRhYXU1STI5VzUrTWdRdm5kRzBEekg3SmlJeW1NTXI5dnhXQmQyNwpQZjYraU4yUkF6SkVyZHdOcEdGWWVzb0doYmMxTmowS2U1S1FqV0toQVE9PQo9ZmtPRAotLS0tLUVORCBQR1AgUFJJVkFURSBLRVkgQkxPQ0stLS0tLQ=="
          },
          "next": ["3. Parse JSON"],
          "error": []
        },
        {
          "id": "3. Parse JSON",
          "type": "file.parse.json",
          "params": {
            "addFilename": false
          },
          "next": ["4. Add data.idxImportJobId"],
          "error": []
        },
        {
          "id": "13. Take phone number for update",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgdmFyIG5ld3JlY29yZCA9IHt9Ow0KICAgIG5ld3JlY29yZC5VSUQgPSByZWNvcmQuVUlEOw0KICAgIG5ld3JlY29yZC5waG9uZU51bWJlciA9IHJlY29yZC5waG9uZU51bWJlcjsNCiAgICByZXR1cm4gbmV3cmVjb3JkOw0KfQ==",
            "notifyLastRecord": false,
            "ECMAScriptVersion": "12"
          },
          "next": ["14. Update account phone number"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "14. Update account phone number",
          "type": "datasource.write.gigya.account",
          "params": {
            "updatePolicy": "append",
            "maxConnections": 10
          },
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "1. Read From Blob Storage",
          "type": "datasource.read.azure.blob_token",
          "params": {
            "baseUri": "{{AZURE_BASE_URI}}",
            "accessToken": "********",
            "container": "{{AZURE_CONTAINER}}",
            "blobPrefix": "{{AZURE_BLOB_PREFIX}}"
          },
          "next": ["2. Decrypt PGP"],
          "error": []
        },
        {
          "id": "6A. PhoneNumber accounts",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgaWYocmVjb3JkLnBob25lTnVtYmVyKQ0KICAgICAgICByZXR1cm4gcmVjb3JkOw0KfQ==",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["7A. Rename Fields To Merge"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "6B. Email accounts",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgaWYoIXJlY29yZC5waG9uZU51bWJlcikNCiAgICAgICAgcmV0dXJuIHJlY29yZDsNCn0=",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["7B. Rename Fields To Merge"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "8B. Existing Accounts",
          "type": "datasource.lookup.gigya.account",
          "params": {
            "select": "UID,data.areaOfInterest,data.pet,data.child,data.externalApplication,lastUpdated,data.initialAppSourceCode",
            "handleFieldConflicts": "take_lookup",
            "mismatchBehavior": "remove",
            "lookupFields": [
              {
                "sourceField": "profile.email",
                "gigyaField": "loginIDs.emails"
              },
              {
                "sourceField": "profile.email",
                "gigyaField": "loginIDs.unverifiedEmails"
              }
            ],
            "lookupFieldsOperator": "OR",
            "matchBehavior": "process",
            "isCaseSensitive": false,
            "from": "accounts",
            "batchSize": 200,
            "maxConcurrency": 1,
            "multiMatchBehavior": "error"
          },
          "next": [" 9B. Perform Merge Logic", "Prepare existent accounts to extract"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": " 9B. Perform Merge Logic",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgewogICAgY29uc3QgY2hlY2tMYXN0VXBkYXRlZCA9IGZhbHNlOwogICAgY29uc3QgbWVyZ2VDaGlsZCA9IHRydWU7CiAgICBjb25zdCBtZXJnZVBldCA9IHRydWU7CiAgICBjb25zdCBtZXJnZUV4dGVybmFsQXBwbGljYXRpb24gPSB0cnVlOwoKICAgIGlmIChjaGVja0xhc3RVcGRhdGVkICYmIHJlY29yZC5sYXN0VXBkYXRlZCA+IHJlY29yZC5fbGFzdFVwZGF0ZWQpIHJldHVybjsKCiAgICAvLyBXZSB1cGRhdGUgaW5pdGlhbEFwcFNvdXJjZUNvZGUgb25seSBpZiBpdCBkb2Vzbid0IGV4aXN0IGluIHRoZSBzeXN0ZW0KICAgIGlmIChyZWNvcmQuZGF0YSAmJiByZWNvcmQuZGF0YS5faW5pdGlhbEFwcFNvdXJjZUNvZGUgJiYgIXJlY29yZC5kYXRhLmluaXRpYWxBcHBTb3VyY2VDb2RlKSByZWNvcmQuZGF0YS5pbml0aWFsQXBwU291cmNlQ29kZSA9IHJlY29yZC5kYXRhLl9pbml0aWFsQXBwU291cmNlQ29kZTsKCiAgICBjb25zdCBzdHJhdGVneUNob29zZW4gPSAie3tNRVJHRV9TVFJBVEVHWX19IjsKCiAgICAvLyBBcHBseSBtZXJnZSBsb2dpY3MKICAgIGlmIChtZXJnZUNoaWxkKSBjYWxsTWVyZ2VMb2dpYyhyZWNvcmQsICJjaGlsZCIsIHN0cmF0ZWd5Q2hvb3Nlbik7CiAgICBpZiAobWVyZ2VQZXQpIGNhbGxNZXJnZUxvZ2ljKHJlY29yZCwgInBldCIsIHN0cmF0ZWd5Q2hvb3Nlbik7CiAgICBpZiAobWVyZ2VFeHRlcm5hbEFwcGxpY2F0aW9uKSBjYWxsTWVyZ2VMb2dpYyhyZWNvcmQsICJleHRlcm5hbEFwcGxpY2F0aW9uIiwgc3RyYXRlZ3lDaG9vc2VuKTsKICAgIAogICAgaWYgKHJlY29yZC5fZXJyb3JEZXRhaWxzICYmIHJlY29yZC5fZXJyb3JEZXRhaWxzLmxlbmd0aCkgewogICAgICAgIGVycm9yLmFjY2VwdChyZWNvcmQsIHJlY29yZCk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIElkZW50aXRpZXMgbG9naWNzCiAgICAgICAgaWYgKHJlY29yZC5faWRlbnRpdGllcyAmJiByZWNvcmQuX2lkZW50aXRpZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBsZXQgaWRlbnRpdGllcyA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlY29yZC5faWRlbnRpdGllcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXlXb3JkIGluIFsiZW1haWwiLCAiZmlyc3ROYW1lIiwgImxhc3ROYW1lIiwgImxvY2FsZSIsICJjaXR5IiwgImdlbmRlciIsICJjb3VudHJ5IiwgInppcCJdKQogICAgICAgICAgICAgICAgICAgIHJlY29yZC5faWRlbnRpdGllc1tpXVtrZXlXb3JkXSA9IGFzc2lnbklkZW50aXRpZXNQcm9wZXJ0eShyZWNvcmQuX2lkZW50aXRpZXNbaV1ba2V5V29yZF0sIHJlY29yZC5wcm9maWxlW2tleVdvcmRdKTsKICAgICAgICAgICAgICAgIGlkZW50aXRpZXMucHVzaChyZWNvcmQuX2lkZW50aXRpZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlY29yZC5pZGVudGl0aWVzID0gaWRlbnRpdGllczsKICAgICAgICB9CiAgICAKICAgICAgICAvLyBQcmVmZXJlbmNlcyBsb2dpYwogICAgICAgIGlmIChyZWNvcmQucHJlZmVyZW5jZXMpCiAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIHJlY29yZC5wcmVmZXJlbmNlcykgewogICAgICAgICAgICAgICAgaWYgKGtleSAhPSAidGVybXMiICYmIGtleSAhPSAicHJpdmFjeSIpIHJlY29yZC5wcmVmZXJlbmNlc1trZXldLmN1c3RvbURhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgZWxzZSBmb3IgKGNvbnN0IHByZWZJbmRleCBpbiByZWNvcmQucHJlZmVyZW5jZXNba2V5XSkgcmVjb3JkLnByZWZlcmVuY2VzW2tleV1bcHJlZkluZGV4XS5jdXN0b21EYXRhID0gbnVsbDsKICAgICAgICAgICAgfQogICAgCiAgICAgICAgLy8gU3Vic2NyaXB0aW9uIGxvZ2ljCiAgICAgICAgcmVjb3JkLnN1YnNjcmlwdGlvbnMgPSB7fTsKICAgICAgICBpZiAocmVjb3JkLl9zdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICAgIGZvciAodmFyIHN1YktleSBpbiByZWNvcmQuX3N1YnNjcmlwdGlvbnMpIHsKICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbCkgewogICAgICAgICAgICAgICAgICAgIGlmICgidHJ1ZSIgPT0gInt7RE9VQkxFX09QVF9JTn19IikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4gJiYgcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uc3RhdHVzICYmIHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLnN0YXR1cyA9PT0gIkNvbmZpcm1lZCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZCA9IHByb2Nlc3NTdWJzY3JpcHRpb25zKHJlY29yZCwgc3ViS2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4gfHwgKHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLnN0YXR1cyAmJiByZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5zdGF0dXMgPT09ICJDb25maXJtZWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkID0gcHJvY2Vzc1N1YnNjcmlwdGlvbnMocmVjb3JkLCBzdWJLZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gcmVjb3JkOyAgICAgICAgCiAgICB9Cn0KCmZ1bmN0aW9uIHByb2Nlc3NTdWJzY3JpcHRpb25zKHJlY29yZCwgc3ViS2V5KSB7CiAgICByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldID0gcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV07CgogICAgaWYgKHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4pIHsKICAgICAgICBsZXQgb2JqZWN0ID0ge307CiAgICAgICAgbGV0IGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPSByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLmRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQ7CiAgICAgICAgY29uc3QgY29uZGl0aW9uYWxseVByZXNlbnQgPSBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkICE9PSBudWxsICYmIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgIT09IHVuZGVmaW5lZDsKICAgICAgICBjb25zdCBjb25kaXRpb25hbGx5SXNCb29sID0gdHlwZW9mIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPT09ICJib29sZWFuIjsKCiAgICAgICAgaWYgKGNvbmRpdGlvbmFsbHlQcmVzZW50KSBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkID0gY29uZGl0aW9uYWxseUlzQm9vbCA/IGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgOiBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkID09ICJ0cnVlIjsKICAgICAgICBlbHNlIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPSBudWxsOwoKICAgICAgICBpZiAoZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCAhPT0gbnVsbCkgcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5pc0V4dGVybmFsbHlWZXJpZmllZCA9IGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQ7CgogICAgICAgIGZvciAoY29uc3Qga2V5IGluIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4pIGlmIChrZXkgIT09ICJkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkIikgb2JqZWN0W2tleV0gPSByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluW2tleV07CgogICAgICAgIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4gPSBvYmplY3Q7CiAgICB9CiAgICAKICAgIC8vU1RBUlQgLSBNU0NORC0zOTE3MiAtIENoYW5nZSBvbiBpbXBvcnRpbmcgc3Vic2NyaXB0aW9ucyB0byBleGlzdGluZyBhY2NvdW50cwogICAgaWYgKHJlY29yZD8uc3Vic2NyaXB0aW9ucz8uW3N1YktleV0/LmVtYWlsPy5sYXN0VXBkYXRlZFN1YnNjcmlwdGlvblN0YXRlICYmCiAgICBpc0RhdGVJbkZ1dHVyZShyZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmxhc3RVcGRhdGVkU3Vic2NyaXB0aW9uU3RhdGUpKSB7CiAgICAgICAgZGVsZXRlIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwubGFzdFVwZGF0ZWRTdWJzY3JpcHRpb25TdGF0ZTsKICAgIH0KICAgIC8vRU5EIC0gTVNDTkQtMzkxNzIgLSBDaGFuZ2Ugb24gaW1wb3J0aW5nIHN1YnNjcmlwdGlvbnMgdG8gZXhpc3RpbmcgYWNjb3VudHMKCiAgICByZXR1cm4gcmVjb3JkOwp9CgovL1NUQVJUIC0gTVNDTkQtMzkxNzIgLSBDaGFuZ2Ugb24gaW1wb3J0aW5nIHN1YnNjcmlwdGlvbnMgdG8gZXhpc3RpbmcgYWNjb3VudHMKZnVuY3Rpb24gaXNEYXRlSW5GdXR1cmUoZGF0ZVN0cmluZykgewogIC8vIFBhcnNlIHRoZSBnaXZlbiBkYXRlIHN0cmluZyBpbnRvIGEgRGF0ZSBvYmplY3QKICBjb25zdCBnaXZlbkRhdGUgPSBuZXcgRGF0ZShkYXRlU3RyaW5nKTsKICAKICAvLyBHZXQgdGhlIGN1cnJlbnQgZGF0ZSBhbmQgdGltZQogIGNvbnN0IGN1cnJlbnREYXRlID0gbmV3IERhdGUoKTsKICAKICAvLyBDb21wYXJlIHRoZSBnaXZlbiBkYXRlIHdpdGggdGhlIGN1cnJlbnQgZGF0ZQogIHJldHVybiBnaXZlbkRhdGUgPiBjdXJyZW50RGF0ZTsKfQovL0VORCAtIE1TQ05ELTM5MTcyIC0gQ2hhbmdlIG9uIGltcG9ydGluZyBzdWJzY3JpcHRpb25zIHRvIGV4aXN0aW5nIGFjY291bnRzCgpmdW5jdGlvbiBnZW5lcmF0ZVVVSUQoKSB7CiAgICBsZXQgZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgY29uc3QgdXVpZCA9ICJ4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgiLnJlcGxhY2UoL1t4eV0vZywgZnVuY3Rpb24gKGMpIHsKICAgICAgICBjb25zdCByID0gKGQgKyBNYXRoLnJhbmRvbSgpICogMTYpICUgMTYgfCAwOwogICAgICAgIGQgPSBNYXRoLmZsb29yKGQgLyAxNik7CiAgICAgICAgcmV0dXJuIChjID09ICJ4IiA/IHIgOiAociAmIDB4MykgfCAweDgpLnRvU3RyaW5nKDE2KTsKICAgIH0pOwogICAgcmV0dXJuIHV1aWQ7Cn0KCmZ1bmN0aW9uIGNhbGxNZXJnZUxvZ2ljKHJlY29yZCwgcHJvcGVydHlOYW1lLCBzdHJhdGVneUNob29zZW4pIHsKICAgIGNvbnN0IF9wcm9wZXJ0eU5hbWUgPSAiXyIgKyBwcm9wZXJ0eU5hbWU7CiAgICBjb25zdCBvbmx5VW5kZXJTY29yZSA9IHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdICYmICFyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdOwogICAgY29uc3QgYm90aENhc2VzID0gcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXSAmJiByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXTsKICAgIGNvbnN0IG5vcm1hbExlbmdodCA9IHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gJiYgcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXS5sZW5ndGggPT09IDA7CiAgICBjb25zdCB1bmRlclNjb3JlTGVuZ2h0ID0gcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0gJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0ubGVuZ3RoICE9PSAwOwoKICAgIGlmICgob25seVVuZGVyU2NvcmUgJiYgdW5kZXJTY29yZUxlbmdodCkgfHwgKGJvdGhDYXNlcyAmJiBub3JtYWxMZW5naHQgJiYgdW5kZXJTY29yZUxlbmdodCkpIHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gPSByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXTsKICAgIGVsc2UgaWYgKGJvdGhDYXNlcyAmJiB1bmRlclNjb3JlTGVuZ2h0KSB7CiAgICAgICAgY29uc3QgbWVyZ2VSZXN1bHQgPSBwcm9jZXNzTWVyZ2UocmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXSwgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0sIHN0cmF0ZWd5Q2hvb3NlbiwgcHJvcGVydHlOYW1lKTsKICAgICAgICBpZiAodHlwZW9mIG1lcmdlUmVzdWx0ID09PSAnc3RyaW5nJykgcmVjb3JkLl9lcnJvckRldGFpbHMgPSBtZXJnZVJlc3VsdDsKICAgICAgICBlbHNlIHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gPSBtZXJnZVJlc3VsdDsKICAgIH0KfQoKZnVuY3Rpb24gYXNzaWduSWRlbnRpdGllc1Byb3BlcnR5KGlkZW50aXR5UHJvcGVydHksIHByb2ZpbGVQcm9wZXJ0eSkgewogICAgaWYgKGlkZW50aXR5UHJvcGVydHkgJiYgaWRlbnRpdHlQcm9wZXJ0eS5sZW5ndGgpIHsKICAgICAgICBpZiAocHJvZmlsZVByb3BlcnR5ICYmIHByb2ZpbGVQcm9wZXJ0eS5sZW5ndGggJiYgaWRlbnRpdHlQcm9wZXJ0eSAhPT0gcHJvZmlsZVByb3BlcnR5KSByZXR1cm4gcHJvZmlsZVByb3BlcnR5OwogICAgICAgIGVsc2UgcmV0dXJuIGlkZW50aXR5UHJvcGVydHk7CiAgICB9IGVsc2UgcmV0dXJuIHByb2ZpbGVQcm9wZXJ0eTsKfQoKZnVuY3Rpb24gY2hlY2tVVUlEKHV1aWQpIHsKICAgIGNvbnN0IHJlZ2V4ID0gL15bMC05YS1mXXs4fS1bMC05YS1mXXs0fS00WzAtOWEtZl17M30tWzg5YWJdWzAtOWEtZl17M30tWzAtOWEtZl17MTJ9JC9pOwogICAgcmV0dXJuIHJlZ2V4LnRlc3QodXVpZCk7Cn0KCmZ1bmN0aW9uIGdlbmVyYXRlVVVJRGFuZFVwZGF0ZURhdGUodHlwZSwgdGFyZ2V0LCBpKSB7CiAgICBpZiAodHlwZSA9PT0gImNoaWxkIiB8fCB0eXBlID09PSAicGV0IikgewogICAgICAgIGlmKCFjaGVja1VVSUQodGFyZ2V0W2ldLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyKSl7CiAgICAgICAgICAgIHRhcmdldFtpXS5hcHBsaWNhdGlvbkludGVybmFsSWRlbnRpZmllciA9IGdlbmVyYXRlVVVJRCgpOwogICAgICAgIH0KICAgIH0KfQoKZnVuY3Rpb24gcHJvY2Vzc01lcmdlKGV4aXN0aW5nUmVjb3JkQXJyYXksIG5ld1JlY29yZEFycmF5LCBzdHJhdGVneSwgdHlwZSkgewogICAgbGV0IHJlc3VsdCA9IFtdOwogICAgbGV0IGNoZWNrID0gZmFsc2U7CiAgICBpZiAoc3RyYXRlZ3kgPT09ICJmdWxsUmVwbGFjZSIpIHsKICAgICAgICByZXN1bHQgPSBuZXdSZWNvcmRBcnJheTsKICAgICAgICBmb3IgKGNvbnN0IHggaW4gcmVzdWx0KSBnZW5lcmF0ZVVVSURhbmRVcGRhdGVEYXRlKHR5cGUsIHJlc3VsdCwgeCk7CiAgICB9IGVsc2UgewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGV4aXN0aW5nUmVjb3JkQXJyYXkpKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IEFycmF5LmZyb20oZXhpc3RpbmdSZWNvcmRBcnJheSk7CiAgICAgICAgICAgIGZvciAoY29uc3QgbSBpbiBuZXdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCBuIGluIGV4aXN0aW5nUmVjb3JkQXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoKHR5cGUgPT09ICJjaGlsZCIgfHwgdHlwZSA9PT0gInBldCIpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UmVjb3JkQXJyYXlbbV0uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbbl0uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdSZWNvcmRBcnJheVttXS5hcHBsaWNhdGlvbkludGVybmFsSWRlbnRpZmllci50b0xvd2VyQ2FzZSgpID09PSByZXN1bHRbbl0uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIudG9Mb3dlckNhc2UoKSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlID09PSAiY2hpbGQiICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UmVjb3JkQXJyYXlbbV0uYmlydGhEYXRlICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0W25dLmJpcnRoRGF0ZSA9PT0gbmV3UmVjb3JkQXJyYXlbbV0uYmlydGhEYXRlICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UmVjb3JkQXJyYXlbbV0uZmlyc3ROYW1lICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0W25dLmZpcnN0TmFtZSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtuXS5maXJzdE5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmV3UmVjb3JkQXJyYXlbbV0uZmlyc3ROYW1lLnRvTG93ZXJDYXNlKCkpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAodHlwZSA9PT0gInBldCIgJiYgbmV3UmVjb3JkQXJyYXlbbV0ubmFtZSAmJiByZXN1bHRbbl0ubmFtZSAmJiByZXN1bHRbbl0ubmFtZS50b0xvd2VyQ2FzZSgpID09PSBuZXdSZWNvcmRBcnJheVttXS5uYW1lLnRvTG93ZXJDYXNlKCkpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAodHlwZSA9PT0gImV4dGVybmFsQXBwbGljYXRpb24iICYmIG5ld1JlY29yZEFycmF5W21dLmFwcGxpY2F0aW9uQ29kZSAmJiByZXN1bHRbbl0uYXBwbGljYXRpb25Db2RlICYmIHJlc3VsdFtuXS5hcHBsaWNhdGlvbkNvZGUudG9Mb3dlckNhc2UoKSA9PT0gbmV3UmVjb3JkQXJyYXlbbV0uYXBwbGljYXRpb25Db2RlLnRvTG93ZXJDYXNlKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHN0cmF0ZWd5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyZXBsYWNlUGFydGlhbGx5IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGF0dHJOYW1lUmVwbGFjZSBpbiByZXN1bHRbbl0pIHJlc3VsdFtuXVthdHRyTmFtZVJlcGxhY2VdID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGF0dHJOYW1lTmV3UmVwbGFjZSBpbiBuZXdSZWNvcmRBcnJheVttXSkgcmVzdWx0W25dW2F0dHJOYW1lTmV3UmVwbGFjZV0gPSBuZXdSZWNvcmRBcnJheVttXVthdHRyTmFtZU5ld1JlcGxhY2VdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAibWVyZ2UiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgYXR0ck5hbWVNZXJnZSBpbiBuZXdSZWNvcmRBcnJheVttXSkgcmVzdWx0W25dW2F0dHJOYW1lTWVyZ2VdID0gbmV3UmVjb3JkQXJyYXlbbV1bYXR0ck5hbWVNZXJnZV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic2tpcCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGVVVUlEYW5kVXBkYXRlRGF0ZSh0eXBlLCByZXN1bHQsIG4pOwogICAgICAgICAgICAgICAgICAgICAgICBjaGVjayA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFjaGVjayAmJiAodHlwZSA9PT0gImNoaWxkIiB8fCB0eXBlID09PSAicGV0IiB8fCB0eXBlID09PSAiZXh0ZXJuYWxBcHBsaWNhdGlvbiIpKSB7CiAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGVVVUlEYW5kVXBkYXRlRGF0ZSh0eXBlLCBuZXdSZWNvcmRBcnJheSwgbSk7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobmV3UmVjb3JkQXJyYXlbbV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hlY2sgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBgVGhlIGV4dGVybmFsQXBwbGljYXRpb24sIGNoaWxkIGFuZC9vciBwZXQgaXMgbm90IGFuIGFycmF5LmA7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKfQo=",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["9B bis. Perform Merge Area Of Interest Logic"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "10C. Remove Fields",
          "type": "field.remove",
          "params": {
            "fields": [
              "_identities",
              "password",
              "_response",
              "query",
              "data._areaOfInterest",
              "data._child",
              "data._pet",
              "data._externalApplication",
              "_lastUpdated",
              "data._initialAppSourceCode",
              "_subscriptions"
            ]
          },
          "next": ["11D. Import Full Account Upsert"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "8C. New Accounts",
          "type": "datasource.lookup.gigya.account",
          "params": {
            "select": "UID",
            "handleFieldConflicts": "take_lookup",
            "mismatchBehavior": "process",
            "lookupFields": [
              {
                "sourceField": "profile.email",
                "gigyaField": "loginIDs.emails"
              },
              {
                "sourceField": "profile.email",
                "gigyaField": "loginIDs.unverifiedEmails"
              }
            ],
            "lookupFieldsOperator": "OR",
            "matchBehavior": "remove",
            "isCaseSensitive": false,
            "from": "accounts",
            "batchSize": 200,
            "maxConcurrency": 1,
            "multiMatchBehavior": "error"
          },
          "next": ["9C. Rename fields"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "9C. Rename fields",
          "type": "field.rename",
          "params": {
            "fields": [
              {
                "sourceField": "data._areaOfInterest",
                "targetField": "data.areaOfInterest"
              },
              {
                "sourceField": "data._pet",
                "targetField": "data.pet"
              },
              {
                "sourceField": "data._child",
                "targetField": "data.child"
              },
              {
                "sourceField": "data._externalApplication",
                "targetField": "data.externalApplication"
              },
              {
                "sourceField": "data._initialAppSourceCode",
                "targetField": "data.initialAppSourceCode"
              },
              {
                "sourceField": "_identities",
                "targetField": "identities"
              }
            ]
          },
          "next": ["10E. Set Standard Data"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "10E. Set Standard Data",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQoNCiAgICAvLyBzZXQgZGF0YS5jaGlsZFtdLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyDQogICAgaWYgKHJlY29yZC5kYXRhLmNoaWxkICYmIHJlY29yZC5kYXRhLmNoaWxkLmxlbmd0aCA+IDApew0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8ICByZWNvcmQuZGF0YS5jaGlsZC5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgaWYoIWNoZWNrVVVJRChyZWNvcmQuZGF0YS5jaGlsZFtpXVsiYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIiXSkpew0KICAgICAgICAgICAgICAgIHJlY29yZC5kYXRhLmNoaWxkW2ldWyJhcHBsaWNhdGlvbkludGVybmFsSWRlbnRpZmllciJdID0gZ2VuZXJhdGVVVUlEKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgIC8vIHNldCBkYXRhLnBldFtdLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyDQogICAgaWYgKHJlY29yZC5kYXRhLnBldCAmJiByZWNvcmQuZGF0YS5wZXQubGVuZ3RoID4gMCl7DQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgIHJlY29yZC5kYXRhLnBldC5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgaWYoIWNoZWNrVVVJRChyZWNvcmQuZGF0YS5wZXRbaV1bImFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyIl0pKXsNCiAgICAgICAgICAgICAgICByZWNvcmQuZGF0YS5wZXRbaV1bImFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyIl0gPSBnZW5lcmF0ZVVVSUQoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGlmIChyZWNvcmQuX2lkZW50aXRpZXMgJiYgcmVjb3JkLl9pZGVudGl0aWVzLmxlbmd0aCA+IDApIHsNCiAgICAgICAgdmFyIGlkZW50aXRpZXMgPSBbXTsNCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWNvcmQuX2lkZW50aXRpZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIGZvciAodmFyIGtleVdvcmQgaW4gWyJlbWFpbCIsICJmaXJzdE5hbWUiLCAibGFzdE5hbWUiLCAibG9jYWxlIiwgImNpdHkiLCAiZ2VuZGVyIiwgImNvdW50cnkiLCAiemlwIl0pDQogICAgICAgICAgICAgICAgcmVjb3JkLl9pZGVudGl0aWVzW2ldW2tleVdvcmRdID0gYXNzaWduSWRlbnRpdGllc1Byb3BlcnR5KHJlY29yZC5faWRlbnRpdGllc1tpXVtrZXlXb3JkXSwgcmVjb3JkLnByb2ZpbGVba2V5V29yZF0pOw0KICAgICAgICAgICAgaWRlbnRpdGllcy5wdXNoKHJlY29yZC5faWRlbnRpdGllc1tpXSk7DQogICAgICAgIH0NCiAgICAgICAgcmVjb3JkLmlkZW50aXRpZXMgPSBpZGVudGl0aWVzOw0KICAgIH0gZWxzZSB7DQogICAgICAgIHJlY29yZC5pZGVudGl0aWVzID0gW107DQogICAgfQ0KICAgIA0KICAgIGlmIChyZWNvcmQucHJlZmVyZW5jZXMpIHsNCiAgICAgICAgDQogICAgICAgIGZvciAodmFyIGtleSBpbiByZWNvcmQucHJlZmVyZW5jZXMpIHsNCiAgICAgICAgICAgIGlmIChrZXkgIT0gInRlcm1zIiAmJiBrZXkgIT0gInByaXZhY3kiKQ0KICAgICAgICAgICAgICAgIHJlY29yZC5wcmVmZXJlbmNlc1trZXldLmN1c3RvbURhdGEgPSBudWxsOw0KICAgICAgICAgICAgDQogICAgICAgIH0gICANCg0KICAgICAgICBpZiAocmVjb3JkLnByZWZlcmVuY2VzLnRlcm1zKSB7DQogICAgICAgICAgICBmb3IgKHZhciB0ZXJtc0tleSBpbiByZWNvcmQucHJlZmVyZW5jZXMudGVybXMpIHsNCiAgICAgICAgICAgICAgICByZWNvcmQucHJlZmVyZW5jZXMudGVybXNbdGVybXNLZXldLmN1c3RvbURhdGEgPSBudWxsOw0KICAgICAgICAgICAgfSAgICAgICAgDQogICAgICAgIH0NCg0KICAgICAgICBpZiAocmVjb3JkLnByZWZlcmVuY2VzLnByaXZhY3kpIHsNCiAgICAgICAgICAgIGZvciAodmFyIHByaXZhY3lLZXkgaW4gcmVjb3JkLnByZWZlcmVuY2VzLnByaXZhY3kpIHsNCiAgICAgICAgICAgICAgICByZWNvcmQucHJlZmVyZW5jZXMucHJpdmFjeVtwcml2YWN5S2V5XS5jdXN0b21EYXRhID0gbnVsbDsNCiAgICAgICAgICAgIH0gICAgICAgIA0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIHJlY29yZC5zdWJzY3JpcHRpb25zID0ge307DQogICAgaWYgKHJlY29yZC5fc3Vic2NyaXB0aW9ucykgew0KICAgICAgICBmb3IgKHZhciBzdWJLZXkgaW4gcmVjb3JkLl9zdWJzY3JpcHRpb25zKSB7DQogICAgICAgICAgICBpZiAocmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwpIHsNCiAgICAgICAgICAgICAgICBpZiAoInRydWUiID09ICJ7e0RPVUJMRV9PUFRfSU59fSIpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluICYmIHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLnN0YXR1cyAmJiByZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5zdGF0dXMgPT09ICJDb25maXJtZWQiKSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZWNvcmQgPSBwcm9jZXNzU3Vic2NyaXB0aW9ucyhyZWNvcmQsIHN1YktleSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBpZiAoIXJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluIHx8IChyZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5zdGF0dXMgJiYgcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uc3RhdHVzID09PSAiQ29uZmlybWVkIikpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZCA9IHByb2Nlc3NTdWJzY3JpcHRpb25zKHJlY29yZCwgc3ViS2V5KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICByZXR1cm4gcmVjb3JkOw0KfQ0KDQpmdW5jdGlvbiBwcm9jZXNzU3Vic2NyaXB0aW9ucyhyZWNvcmQsIHN1YktleSkgew0KICAgIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0gPSByZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XTsNCiAgICANCiAgICBpZiAocmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbikgew0KICAgICAgICB2YXIgZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCA9IHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZDsNCiAgICAgICAgZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCA9IChkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkICE9PSBudWxsICYmIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgIT09IHVuZGVmaW5lZCkNCiAgICAgICAgICAgID8gdHlwZW9mIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPT09ICJib29sZWFuIiA/IGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgOiBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkID09ICJ0cnVlIg0KICAgICAgICAgICAgOiBudWxsOw0KDQogICAgICAgIHN3aXRjaCAoZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCkgew0KICAgICAgICAgICAgY2FzZSB0cnVlOg0KICAgICAgICAgICAgICAgIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uaXNFeHRlcm5hbGx5VmVyaWZpZWQgPSB0cnVlOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgY2FzZSBmYWxzZToNCiAgICAgICAgICAgICAgICByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLmlzRXh0ZXJuYWxseVZlcmlmaWVkID0gZmFsc2U7DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICBjYXNlIG51bGw6DQogICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHZhciBvYmplY3QgPSB7fTsNCiAgICAgICAgZm9yICh2YXIga2V5IGluIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4pIHsNCiAgICAgICAgICAgIGlmIChrZXkgIT09ICdkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkJykgew0KICAgICAgICAgICAgICAgIG9iamVjdFtrZXldID0gcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbltrZXldOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbiA9IG9iamVjdDsNCiAgICB9DQogICAgDQogICAgLy9TVEFSVCAtIE1TQ05ELTM5MTcyIC0gQ2hhbmdlIG9uIGltcG9ydGluZyBzdWJzY3JpcHRpb25zIHRvIGV4aXN0aW5nIGFjY291bnRzDQogICAgaWYgKHJlY29yZD8uc3Vic2NyaXB0aW9ucz8uW3N1YktleV0/LmVtYWlsPy5sYXN0VXBkYXRlZFN1YnNjcmlwdGlvblN0YXRlICYmDQogICAgaXNEYXRlSW5GdXR1cmUocmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5sYXN0VXBkYXRlZFN1YnNjcmlwdGlvblN0YXRlKSkgew0KICAgICAgICBkZWxldGUgcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5sYXN0VXBkYXRlZFN1YnNjcmlwdGlvblN0YXRlOw0KICAgIH0NCiAgICAvL0VORCAtIE1TQ05ELTM5MTcyIC0gQ2hhbmdlIG9uIGltcG9ydGluZyBzdWJzY3JpcHRpb25zIHRvIGV4aXN0aW5nIGFjY291bnRzDQoNCiAgICByZXR1cm4gcmVjb3JkOw0KfQ0KDQovL1NUQVJUIC0gTVNDTkQtMzkxNzIgLSBDaGFuZ2Ugb24gaW1wb3J0aW5nIHN1YnNjcmlwdGlvbnMgdG8gZXhpc3RpbmcgYWNjb3VudHMNCmZ1bmN0aW9uIGlzRGF0ZUluRnV0dXJlKGRhdGVTdHJpbmcpIHsNCiAgLy8gUGFyc2UgdGhlIGdpdmVuIGRhdGUgc3RyaW5nIGludG8gYSBEYXRlIG9iamVjdA0KICBjb25zdCBnaXZlbkRhdGUgPSBuZXcgRGF0ZShkYXRlU3RyaW5nKTsNCiAgDQogIC8vIEdldCB0aGUgY3VycmVudCBkYXRlIGFuZCB0aW1lDQogIGNvbnN0IGN1cnJlbnREYXRlID0gbmV3IERhdGUoKTsNCiAgDQogIC8vIENvbXBhcmUgdGhlIGdpdmVuIGRhdGUgd2l0aCB0aGUgY3VycmVudCBkYXRlDQogIHJldHVybiBnaXZlbkRhdGUgPiBjdXJyZW50RGF0ZTsNCn0NCi8vRU5EIC0gTVNDTkQtMzkxNzIgLSBDaGFuZ2Ugb24gaW1wb3J0aW5nIHN1YnNjcmlwdGlvbnMgdG8gZXhpc3RpbmcgYWNjb3VudHMNCg0KZnVuY3Rpb24gY2hlY2tVVUlEKHV1aWQpIHsNCiAgICBjb25zdCByZWdleCA9IC9eWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tNFswLTlhLWZdezN9LVs4OWFiXVswLTlhLWZdezN9LVswLTlhLWZdezEyfSQvaTsNCiAgICByZXR1cm4gcmVnZXgudGVzdCh1dWlkKTsNCn0NCg0KZnVuY3Rpb24gZ2VuZXJhdGVVVUlEKCkgew0KICAgdmFyIGQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsNCiAgIHZhciB1dWlkID0gInh4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCIucmVwbGFjZSgvW3h5XS9nLCBmdW5jdGlvbihjKSB7DQogICAgICAgdmFyIHIgPSAoZCArIE1hdGgucmFuZG9tKCkqMTYpJTE2IHwgMDsNCiAgICAgICBkID0gTWF0aC5mbG9vcihkLzE2KTsNCiAgICAgICAgICAgIHJldHVybiAoYz09IngiID8gciA6IChyJjB4M3wweDgpKS50b1N0cmluZygxNik7DQogICAgfSk7DQogICAgcmV0dXJuIHV1aWQ7DQp9DQoNCmZ1bmN0aW9uIGFzc2lnbklkZW50aXRpZXNQcm9wZXJ0eShpZGVudGl0eVByb3BlcnR5LCBwcm9maWxlUHJvcGVydHkpIHsNCiAgICBpZiAoaWRlbnRpdHlQcm9wZXJ0eSAmJiBpZGVudGl0eVByb3BlcnR5Lmxlbmd0aCkgew0KICAgICAgICBpZiAocHJvZmlsZVByb3BlcnR5ICYmIHByb2ZpbGVQcm9wZXJ0eS5sZW5ndGggJiYgaWRlbnRpdHlQcm9wZXJ0eSAhPT0gcHJvZmlsZVByb3BlcnR5KSByZXR1cm4gcHJvZmlsZVByb3BlcnR5Ow0KICAgICAgICBlbHNlIHJldHVybiBpZGVudGl0eVByb3BlcnR5Ow0KICAgIH0gZWxzZSByZXR1cm4gcHJvZmlsZVByb3BlcnR5Ow0KfQ==",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["10E bis. Set standard Area Of Interest"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "11F. Import Full Account Insert",
          "type": "datasource.write.gigya.importaccount",
          "params": {
            "importPolicy": "insert",
            "maxConnections": 20,
            "addResponse": false
          },
          "next": ["12C. Set Account Info Webhook"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "7A. Rename Fields To Merge",
          "type": "field.rename",
          "params": {
            "fields": [
              {
                "sourceField": "data.areaOfInterest",
                "targetField": "data._areaOfInterest"
              },
              {
                "sourceField": "data.pet",
                "targetField": "data._pet"
              },
              {
                "sourceField": "data.child",
                "targetField": "data._child"
              },
              {
                "sourceField": "data.externalApplication",
                "targetField": "data._externalApplication"
              },
              {
                "sourceField": "lastUpdated",
                "targetField": "_lastUpdated"
              },
              {
                "sourceField": "data.initialAppSourceCode",
                "targetField": "data._initialAppSourceCode"
              },
              {
                "sourceField": "profile.email",
                "targetField": "profile._email"
              },
              {
                "sourceField": "phoneNumber",
                "targetField": "_phoneNumber"
              },
              {
                "sourceField": "loginIDs",
                "targetField": "_loginIDs"
              },
              {
                "sourceField": "emails",
                "targetField": "_emails"
              },
              {
                "sourceField": "identities",
                "targetField": "_identities"
              },
              {
                "sourceField": "subscriptions",
                "targetField": "_subscriptions"
              }
            ]
          },
          "next": ["8A. New Accounts", "6A. Existing Accounts"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "11B. Remove Fields",
          "type": "field.remove",
          "params": {
            "fields": ["lastUpdated", "_subscriptions"]
          },
          "next": ["12B. Import Full Account Insert"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "12C. Set Account Info Webhook",
          "type": "datasource.write.gigya.generic",
          "params": {
            "apiMethod": "accounts.setAccountInfo",
            "maxConnections": 10,
            "apiParams": [
              {
                "sourceField": "UID",
                "paramName": "UID",
                "value": ""
              }
            ],
            "addResponse": false
          },
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "Generate file",
          "type": "file.format.json",
          "params": {
            "fileName": "{{AZURE_ERRORS_FILENAME}}_${now:yyMMddHHmm}.json",
            "maxFileSize": 5000,
            "createEmptyFile": false
          },
          "next": ["Encrypt file"]
        },
        {
          "id": "Prepare fields to extract phone as ID",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgdmFyIHJlY29yZFRvRXh0cmFjdCA9IHt9Ow0KICAgIHJlY29yZFRvRXh0cmFjdC5waG9uZU51bWJlciA9IHJlY29yZC5waG9uZU51bWJlcjsNCiAgICAgICAgaWYgKHJlY29yZC5VSUQgJiYgcmVjb3JkLlVJRC5sZW5ndGgpIHsNCiAgICAgICAgcmVjb3JkVG9FeHRyYWN0LlVJRCA9IHJlY29yZC5VSUQ7DQogICAgfQ0KICAgIA0KICAgIHJlY29yZFRvRXh0cmFjdC5lcnJvckRldGFpbHMgPSByZWNvcmQuX2Vycm9yRGV0YWlsczsNCiAgICANCiAgICBpZiAocmVjb3JkVG9FeHRyYWN0LmVycm9yRGV0YWlscy5lcnJvck1lc3NhZ2UgIT09ICJJZ25vcmVkIFBhcmFtczogW3twYXJhbU5hbWUgPSBwaG9uZU51bWJlciwgd2FybmluZ0NvZGUgPSA0MDMwMDcsIG1lc3NhZ2UgPSBUaGlzIHBhcmFtZXRlciB3YXMgbm90IHJlY29nbml6ZWQgYXMgdmFsaWQgZm9yIHRoaXMgQVBJIG1ldGhvZCB3aXRoIHlvdXIgc2VjdXJpdHkgY3JlZGVudGlhbHMgbm9yIHdhcyBpdCByZWNvZ25pemVkIGFzIGEgc3RhbmRhcmQgR2lneWEgY29udHJvbCBwYXJhbWV0ZXIufV0iKSB7DQogICAgICAgIHJldHVybiByZWNvcmRUb0V4dHJhY3Q7DQogICAgfQ0KfQ==",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["Generate file"]
        },
        {
          "id": "Prepare fields to extract email",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgdmFyIHJlY29yZFRvRXh0cmFjdCA9IHt9Ow0KICAgIHJlY29yZFRvRXh0cmFjdC5lbWFpbCA9IHJlY29yZC5wcm9maWxlLmVtYWlsOw0KICAgIGlmIChyZWNvcmQuVUlEICYmIHJlY29yZC5VSUQubGVuZ3RoKSB7DQogICAgICAgIHJlY29yZFRvRXh0cmFjdC5VSUQgPSByZWNvcmQuVUlEOw0KICAgIH0NCiAgICANCiAgICByZWNvcmRUb0V4dHJhY3QuZXJyb3JEZXRhaWxzID0gcmVjb3JkLl9lcnJvckRldGFpbHM7DQoNCiAgICByZXR1cm4gcmVjb3JkVG9FeHRyYWN0Ow0KfQ==",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["Generate file"]
        },
        {
          "id": "Encrypt file",
          "type": "file.encrypt.pgp",
          "params": {
            "publicKey": "{{PGP_Public_Key_Base64_Encoded}}",
            "asciiArmor": true
          },
          "next": ["Upload to Blob Storage"]
        },
        {
          "id": "Remove auxiliar fields",
          "type": "field.remove",
          "params": {
            "fields": ["_lastUpdated", "_subscriptions"]
          },
          "next": ["11F. Import Full Account Insert"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "Generate Existent Accounts File",
          "type": "file.format.json",
          "params": {
            "fileName": "{{AZURE_EXISTENT_ACCOUNTS_FILENAME}}_${now:yyMMddHHmm}.json",
            "maxFileSize": 5000,
            "createEmptyFile": false
          },
          "next": ["Encrypt file"]
        },
        {
          "id": "Prepare existent accounts to extract",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgdmFyIG5ld1JlY29yZCA9IHsNCiAgICAgICAgIlVJRCI6IHJlY29yZC5VSUQsDQogICAgICAgICJlbWFpbCI6IHJlY29yZC5wcm9maWxlLmVtYWlsLA0KICAgICAgICAiaW5pdGlhbEFwcFNvdXJjZUNvZGUiOiByZWNvcmQuZGF0YS5pbml0aWFsQXBwU291cmNlQ29kZQ0KICAgIH0NCiAgICANCiAgICBpZiAocmVjb3JkLnBob25lTnVtYmVyKSB7DQogICAgICAgIG5ld1JlY29yZC5waG9uZU51bWJlciA9IHJlY29yZC5waG9uZU51bWJlcjsNCiAgICB9DQogICAgDQogICAgcmV0dXJuIG5ld1JlY29yZDsNCn0=",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["Generate Existent Accounts File"]
        },
        {
          "id": "4. Add data.idxImportJobId",
          "type": "field.add",
          "params": {
            "fields": [
              {
                "field": "data.idxImportJobId",
                "value": "${jobId}"
              },
              {
                "field": "isRegistered",
                "value": "true"
              }
            ]
          },
          "next": ["5. Generate UID and check lang"]
        },
        {
          "id": "9B bis. Perform Merge Area Of Interest Logic",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgewogICAgLy8gSWYgc2V0IHRvIHRydWUgdGhlIHJlY29yZCB3aWxsIGJlIHByb2Nlc3NlZCBvbmx5IGlmIHRoZSBsYXN0VXBkYXRlIGluIHRoZSBmaWxlIGlzID4gbGFzdHVwZGF0ZSBpbiBTQVAtQ0RDLiBJZiBzZXQgdG8gZmFsc2UgdGhlIHJlY29yZCB3aWxsIGJlIGFsd2F5cyBwcm9jZXNzZWQuCiAgICB2YXIgY2hlY2tMYXN0VXBkYXRlZCA9IGZhbHNlOwogICAgLy8gSWYgc2V0IHRvIHRydWUgd2Ugd2lsbCBhcHBseSB0aGUgbWVyZ2UgbG9naWMgZm9yIHRoZSBjYXRlZ29yeS4gSWYgc2V0IHRvIGZhbHNlIHdlIHdpbGwgbm90IGFwcGx5IHRoZSBtZXJnaW5nIGxvZ2ljLgogICAgdmFyIG1lcmdlQXJlYU9mSW50ZXJlc3QgPSB0cnVlOwoKICAgIGlmKCBjaGVja0xhc3RVcGRhdGVkICYmIHJlY29yZC5sYXN0VXBkYXRlZCA+IHJlY29yZC5fbGFzdFVwZGF0ZWQgKSByZXR1cm47CiAgICAKICAgIHZhciBtYXRjaGluZ0NvbmRpdGlvbkFyZWFPZkludGVyZXN0ID0gWyJpbnRlcmVzdENvZGUiXTsKICAgIHZhciBzdHJhdGVneUNob29zZW4gPSAie3tNRVJHRV9TVFJBVEVHWX19IjsKCiAgICBpZiAoIG1lcmdlQXJlYU9mSW50ZXJlc3QgKSBjYWxsTWVyZ2VMb2dpYyggcmVjb3JkLCAiYXJlYU9mSW50ZXJlc3QiLCBzdHJhdGVneUNob29zZW4sIGxvZ2dlciwgZXJyb3IpOwogICAgCiAgICBpZiAocmVjb3JkLl9lcnJvckRldGFpbHMgJiYgcmVjb3JkLl9lcnJvckRldGFpbHMubGVuZ3RoKSB7CiAgICAgICAgZXJyb3IuYWNjZXB0KHJlY29yZCwgcmVjb3JkKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgIH0KfQoKZnVuY3Rpb24gY2FsbE1lcmdlTG9naWMoIHJlY29yZCwgcHJvcGVydHlOYW1lLCBzdHJhdGVneUNob29zZW4sIGxvZ2dlciwgZXJyb3IpIHsKICAgIHZhciBfcHJvcGVydHlOYW1lID0gIl8iICsgcHJvcGVydHlOYW1lOwogICAgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdICYmICFyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdKSB7CiAgICAgICAgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gZGVsZXRlUmVwZWF0ZWRzKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdKTsKICAgICAgICB9CiAgICB9IGVsc2UgaWYgKHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0pIHsKICAgICAgICBpZiAocmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXS5sZW5ndGggPT09IDAgJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0ubGVuZ3RoICE9PSAwKSByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gZGVsZXRlUmVwZWF0ZWRzKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdKTsgIAogICAgICAgIGVsc2UgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICBjb25zdCBtZXJnZVJlc3VsdCA9IHByb2Nlc3NNZXJnZShyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdLCByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXSwgc3RyYXRlZ3lDaG9vc2VuKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXJnZVJlc3VsdCA9PT0gJ3N0cmluZycpIHJlY29yZC5fZXJyb3JEZXRhaWxzID0gbWVyZ2VSZXN1bHQ7CiAgICAgICAgICAgIGVsc2UgcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXSA9IG1lcmdlUmVzdWx0OwogICAgICAgIH0KICAgIH0KfQoKCmZ1bmN0aW9uIHByb2Nlc3NNZXJnZShleGlzdGluZ1JlY29yZEFycmF5LCBuZXdSZWNvcmRBcnJheSwgc3RyYXRlZ3kpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIHZhciBjaGVjayA9IGZhbHNlOwogICAgaWYgKCBzdHJhdGVneSA9PT0gImZ1bGxSZXBsYWNlIikgewogICAgICAgIHJlc3VsdCA9IG5ld1JlY29yZEFycmF5OwogICAgICAgIHJldHVybiBkZWxldGVSZXBlYXRlZHMocmVzdWx0KTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXhpc3RpbmdSZWNvcmRBcnJheSkpIHsKICAgICAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAicmVwbGFjZVBhcnRpYWxseSIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5ld0ludGVyZXN0Q29kZXMgPSBuZXdSZWNvcmRBcnJheS5tYXAocmVjb3JkID0+IHJlY29yZC5pbnRlcmVzdENvZGUpOwogICAgCiAgICAgICAgICAgICAgICBleGlzdGluZ1JlY29yZEFycmF5ID0gWy4uLmV4aXN0aW5nUmVjb3JkQXJyYXkuZmlsdGVyKHJlY29yZCA9PiAhISFuZXdJbnRlcmVzdENvZGVzLmZpbmQoaW50ZXJlc3RDb2RlID0+IGludGVyZXN0Q29kZSA9PT0gcmVjb3JkLmludGVyZXN0Q29kZSkpXTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAibWVyZ2UiKSB7CiAgICAgICAgICAgICAgICBjb25zdCBleGlzdGluZ1JlY29yZEFycmF5V291dFJlcGVhdGVkID0gZXhpc3RpbmdSZWNvcmRBcnJheS5maWx0ZXIocmVjb3JkID0+ICFuZXdSZWNvcmRBcnJheS5maW5kKF9yZWNvcmQgPT4gX3JlY29yZC5pbnRlcmVzdENvZGUgPT09IHJlY29yZC5pbnRlcmVzdENvZGUgJiYgX3JlY29yZC5hbnN3ZXJEZXRhaWxzID09PSByZWNvcmQuYW5zd2VyRGV0YWlscykpOwogICAgICAgICAgICAgICAgcmVzdWx0ID0gWy4uLmV4aXN0aW5nUmVjb3JkQXJyYXlXb3V0UmVwZWF0ZWQsIC4uLm5ld1JlY29yZEFycmF5XTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGV4aXN0aW5nUmVjb3JkQXJyYXkgJiYgZXhpc3RpbmdSZWNvcmRBcnJheS5sZW5ndGggPyBbLi4uZXhpc3RpbmdSZWNvcmRBcnJheV0gOiBbXTsKICAgIAogICAgICAgICAgICAgICAgZm9yICh2YXIgbSBpbiBuZXdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG4gaW4gZXhpc3RpbmdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3UmVjb3JkQXJyYXlbbV0gJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXSAmJiBuZXdSZWNvcmRBcnJheVttXS5pbnRlcmVzdENvZGUgJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXS5pbnRlcmVzdENvZGUgJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXS5pbnRlcmVzdENvZGUgPT09IG5ld1JlY29yZEFycmF5W21dLmludGVyZXN0Q29kZSApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIWNoZWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5ld1JlY29yZEFycmF5W21dKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2hlY2sgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZVJlcGVhdGVkcyhyZXN1bHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiVGhlIGFyZWEgb2YgaW50ZXJlc3QgaXMgbm90IGFuIGFycmF5LiI7CiAgICAgICAgfQogICAgfQp9CgpmdW5jdGlvbiBkZWxldGVSZXBlYXRlZHMocmVzdWx0KSB7CiAgICBjb25zdCBlcnJvcnMgPSBuZXcgU2V0KCk7CiAgICBjb25zdCBfcmVzdWx0ID0gWy4uLnJlc3VsdC5maWx0ZXIoKHZhbHVlLCBpbmRleCkgPT4gewogICAgICAgIGlmICghdmFsdWUuaW50ZXJlc3RDb2RlIHx8ICF2YWx1ZS5hbnN3ZXJEZXRhaWxzKSB7CiAgICAgICAgICAgIGVycm9ycy5hZGQoYFRoZSByZWNvcmQgaGFzIGFuIGludGVyZXN0IGluIHRoZSByZXBvIHdpdGhvdXQgaW50ZXJlc3RDb2RlIG9yIHdpdGhvdXQgYW5zd2VyRGV0YWlscy5gKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbnRlcmVzdENvZGVWYWx1ZSA9IHR5cGVvZiB2YWx1ZS5pbnRlcmVzdENvZGUgPT09ICJzdHJpbmciID8gdmFsdWUuaW50ZXJlc3RDb2RlLnRvTG93ZXJDYXNlKCkgOiBgJHt2YWx1ZS5pbnRlcmVzdENvZGV9YC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBjb25zdCBhbnN3ZXJEZXRhaWxzVmFsdWUgPSB0eXBlb2YgdmFsdWUuYW5zd2VyRGV0YWlscyA9PT0gInN0cmluZyIgPyB2YWx1ZS5hbnN3ZXJEZXRhaWxzLnRvTG93ZXJDYXNlKCkgOiBgJHt2YWx1ZS5hbnN3ZXJEZXRhaWxzfWAudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgY29uc3QgX3ZhbHVlID0gYCR7IGludGVyZXN0Q29kZVZhbHVlIH0gLSAkeyBhbnN3ZXJEZXRhaWxzVmFsdWUgfWA7CiAgICAgICAgICAgIHJldHVybiBpbmRleCA9PT0gcmVzdWx0LmZpbmRJbmRleChvYmogPT4gewogICAgICAgICAgICAgICAgaWYgKCFvYmouaW50ZXJlc3RDb2RlIHx8ICFvYmouYW5zd2VyRGV0YWlscykgewogICAgICAgICAgICAgICAgICAgIGVycm9ycy5hZGQoYFRoZSByZWNvcmQgaGFzIGFuIGludGVyZXN0IGluIHRoZSByZXBvIHdpdGhvdXQgaW50ZXJlc3RDb2RlIG9yIHdpdGhvdXQgYW5zd2VyRGV0YWlscy5gKQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnRlcmVzdENvZGVPYmogPSB0eXBlb2Ygb2JqLmludGVyZXN0Q29kZSA9PT0gInN0cmluZyIgPyBvYmouaW50ZXJlc3RDb2RlLnRvTG93ZXJDYXNlKCkgOiBgJHtvYmouaW50ZXJlc3RDb2RlfWAudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbnN3ZXJEZXRhaWxzT2JqID0gdHlwZW9mIG9iai5hbnN3ZXJEZXRhaWxzID09PSAic3RyaW5nIiA/IG9iai5hbnN3ZXJEZXRhaWxzLnRvTG93ZXJDYXNlKCkgOiBgJHtvYmouYW5zd2VyRGV0YWlsc31gLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGAkeyBpbnRlcmVzdENvZGVPYmogfSAtICR7IGFuc3dlckRldGFpbHNPYmogfWAgPT0gX3ZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KV07CiAgICAKICAgIGlmIChlcnJvcnMuc2l6ZSkgewogICAgICAgIGxldCBlcnJvck1lc3NhZ2UgPSAiIjsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgZXJyb3JzKSB7CiAgICAgICAgICAgIGlmIChlcnJvck1lc3NhZ2UgJiYgZXJyb3JNZXNzYWdlLmxlbmd0aCkgZXJyb3JNZXNzYWdlICs9IGAsICR7aXRlbX1gOwogICAgICAgICAgICBlbHNlIGVycm9yTWVzc2FnZSA9IGl0ZW07CiAgICAgICAgfQogICAgICAgIHJldHVybiBlcnJvck1lc3NhZ2U7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBfcmVzdWx0OwogICAgfQp9",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["10C. Remove Fields"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "10E bis. Set standard Area Of Interest",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgew0KICAgIC8vYXZvaWQgcmVwZWF0ZWQgaW50ZXJlc3RDb2Rlcy1hbnN3ZXJEZXRhaWxzIG9uIGFyZWEgb2YgaW50ZXJlc3QNCiAgICBjb25zdCBlcnJvcnMgPSBuZXcgU2V0KCk7DQoNCiAgICBpZiAocmVjb3JkLmRhdGEuYXJlYU9mSW50ZXJlc3QgJiYgcmVjb3JkLmRhdGEuYXJlYU9mSW50ZXJlc3QubGVuZ3RoID4gMCkgew0KICAgICAgICByZWNvcmQuZGF0YS5hcmVhT2ZJbnRlcmVzdCA9IFsuLi5yZWNvcmQuZGF0YS5hcmVhT2ZJbnRlcmVzdC5maWx0ZXIoKHZhbHVlLCBpbmRleCkgPT4gew0KICAgICAgICAgICAgaWYgKCF2YWx1ZS5pbnRlcmVzdENvZGUgfHwgIXZhbHVlLmFuc3dlckRldGFpbHMpIHsNCiAgICAgICAgICAgICAgICBlcnJvcnMuYWRkKGBJbnZhbGlkIHJlY29yZCBzZW50LiBUaGUgcmVjb3JkIGhhcyBhbiBpbnRlcmVzdCB3aXRob3V0IGludGVyZXN0Q29kZSBvciB3aXRob3V0IGFuc3dlckRldGFpbHMuYCk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGNvbnN0IF92YWx1ZSA9IGAke3ZhbHVlLmludGVyZXN0Q29kZS50b0xvd2VyQ2FzZSgpfSAtICR7dmFsdWUuYW5zd2VyRGV0YWlscy50b0xvd2VyQ2FzZSgpfWA7DQogICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4ID09PSByZWNvcmQuZGF0YS5hcmVhT2ZJbnRlcmVzdC5maW5kSW5kZXgob2JqID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKCFvYmouaW50ZXJlc3RDb2RlIHx8ICFvYmouYW5zd2VyRGV0YWlscykgew0KICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzLmFkZChgSW52YWxpZCByZWNvcmQgc2VudC4gVGhlIHJlY29yZCBoYXMgYW4gaW50ZXJlc3Qgd2l0aG91dCBpbnRlcmVzdENvZGUgb3Igd2l0aG91dCBhbnN3ZXJEZXRhaWxzLmApOw0KICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGAke29iai5pbnRlcmVzdENvZGUudG9Mb3dlckNhc2UoKX0gLSAke29iai5hbnN3ZXJEZXRhaWxzLnRvTG93ZXJDYXNlKCl9YCA9PSBfdmFsdWU7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSldOw0KICAgIH0NCiAgICBpZiAoZXJyb3JzLnNpemUpIHsNCiAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIGVycm9ycykgew0KICAgICAgICAgICAgaWYgKHJlY29yZC5fZXJyb3JEZXRhaWxzICYmIHJlY29yZC5fZXJyb3JEZXRhaWxzLmxlbmd0aCkgcmVjb3JkLl9lcnJvckRldGFpbHMgKz0gYCwgJHtpdGVtfWA7DQogICAgICAgICAgICBlbHNlIHJlY29yZC5fZXJyb3JEZXRhaWxzID0gaXRlbTsNCiAgICAgICAgfQ0KICAgICAgICBlcnJvci5hY2NlcHQocmVjb3JkLCByZWNvcmQpOw0KICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiByZWNvcmQ7DQogICAgfQ0KfQ0K",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["Remove auxiliar fields"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "7A bis. Perform Merge Logic Area of Interest",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgewogICAgLy8gSWYgc2V0IHRvIHRydWUgdGhlIHJlY29yZCB3aWxsIGJlIHByb2Nlc3NlZCBvbmx5IGlmIHRoZSBsYXN0VXBkYXRlIGluIHRoZSBmaWxlIGlzID4gbGFzdHVwZGF0ZSBpbiBTQVAtQ0RDLiBJZiBzZXQgdG8gZmFsc2UgdGhlIHJlY29yZCB3aWxsIGJlIGFsd2F5cyBwcm9jZXNzZWQuCiAgICB2YXIgY2hlY2tMYXN0VXBkYXRlZCA9IGZhbHNlOwogICAgLy8gSWYgc2V0IHRvIHRydWUgd2Ugd2lsbCBhcHBseSB0aGUgbWVyZ2UgbG9naWMgZm9yIHRoZSBjYXRlZ29yeS4gSWYgc2V0IHRvIGZhbHNlIHdlIHdpbGwgbm90IGFwcGx5IHRoZSBtZXJnaW5nIGxvZ2ljLgogICAgdmFyIG1lcmdlQXJlYU9mSW50ZXJlc3QgPSB0cnVlOwoKICAgIGlmKCBjaGVja0xhc3RVcGRhdGVkICYmIHJlY29yZC5sYXN0VXBkYXRlZCA+IHJlY29yZC5fbGFzdFVwZGF0ZWQgKSByZXR1cm47CiAgICAKICAgIHZhciBtYXRjaGluZ0NvbmRpdGlvbkFyZWFPZkludGVyZXN0ID0gWyJpbnRlcmVzdENvZGUiXTsKICAgIHZhciBzdHJhdGVneUNob29zZW4gPSAie3tNRVJHRV9TVFJBVEVHWX19IjsKCiAgICBpZiAoIG1lcmdlQXJlYU9mSW50ZXJlc3QgKSBjYWxsTWVyZ2VMb2dpYyggcmVjb3JkLCAiYXJlYU9mSW50ZXJlc3QiLCBzdHJhdGVneUNob29zZW4sIGxvZ2dlciwgZXJyb3IpOwogICAgCiAgICBpZiAocmVjb3JkLl9lcnJvckRldGFpbHMgJiYgcmVjb3JkLl9lcnJvckRldGFpbHMubGVuZ3RoKSB7CiAgICAgICAgZXJyb3IuYWNjZXB0KHJlY29yZCwgcmVjb3JkKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgIH0KfQoKZnVuY3Rpb24gY2FsbE1lcmdlTG9naWMoIHJlY29yZCwgcHJvcGVydHlOYW1lLCBzdHJhdGVneUNob29zZW4sIGxvZ2dlciwgZXJyb3IpIHsKICAgIHZhciBfcHJvcGVydHlOYW1lID0gIl8iICsgcHJvcGVydHlOYW1lOwogICAgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdICYmICFyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdKSB7CiAgICAgICAgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gZGVsZXRlUmVwZWF0ZWRzKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdKTsKICAgICAgICB9CiAgICB9IGVsc2UgaWYgKHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0pIHsKICAgICAgICBpZiAocmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXS5sZW5ndGggPT09IDAgJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0ubGVuZ3RoICE9PSAwKSByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gZGVsZXRlUmVwZWF0ZWRzKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdKTsgIAogICAgICAgIGVsc2UgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICBjb25zdCBtZXJnZVJlc3VsdCA9IHByb2Nlc3NNZXJnZShyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdLCByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXSwgc3RyYXRlZ3lDaG9vc2VuKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXJnZVJlc3VsdCA9PT0gJ3N0cmluZycpIHJlY29yZC5fZXJyb3JEZXRhaWxzID0gbWVyZ2VSZXN1bHQ7CiAgICAgICAgICAgIGVsc2UgcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXSA9IG1lcmdlUmVzdWx0OwogICAgICAgIH0KICAgIH0KfQoKCmZ1bmN0aW9uIHByb2Nlc3NNZXJnZShleGlzdGluZ1JlY29yZEFycmF5LCBuZXdSZWNvcmRBcnJheSwgc3RyYXRlZ3kpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIHZhciBjaGVjayA9IGZhbHNlOwogICAgaWYgKCBzdHJhdGVneSA9PT0gImZ1bGxSZXBsYWNlIikgewogICAgICAgIHJlc3VsdCA9IG5ld1JlY29yZEFycmF5OwogICAgICAgIHJldHVybiBkZWxldGVSZXBlYXRlZHMocmVzdWx0KTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXhpc3RpbmdSZWNvcmRBcnJheSkpIHsKICAgICAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAicmVwbGFjZVBhcnRpYWxseSIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5ld0ludGVyZXN0Q29kZXMgPSBuZXdSZWNvcmRBcnJheS5tYXAocmVjb3JkID0+IHJlY29yZC5pbnRlcmVzdENvZGUpOwogICAgCiAgICAgICAgICAgICAgICBleGlzdGluZ1JlY29yZEFycmF5ID0gWy4uLmV4aXN0aW5nUmVjb3JkQXJyYXkuZmlsdGVyKHJlY29yZCA9PiAhISFuZXdJbnRlcmVzdENvZGVzLmZpbmQoaW50ZXJlc3RDb2RlID0+IGludGVyZXN0Q29kZSA9PT0gcmVjb3JkLmludGVyZXN0Q29kZSkpXTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAibWVyZ2UiKSB7CiAgICAgICAgICAgICAgICBjb25zdCBleGlzdGluZ1JlY29yZEFycmF5V291dFJlcGVhdGVkID0gZXhpc3RpbmdSZWNvcmRBcnJheS5maWx0ZXIocmVjb3JkID0+ICFuZXdSZWNvcmRBcnJheS5maW5kKF9yZWNvcmQgPT4gX3JlY29yZC5pbnRlcmVzdENvZGUgPT09IHJlY29yZC5pbnRlcmVzdENvZGUgJiYgX3JlY29yZC5hbnN3ZXJEZXRhaWxzID09PSByZWNvcmQuYW5zd2VyRGV0YWlscykpOwogICAgICAgICAgICAgICAgcmVzdWx0ID0gWy4uLmV4aXN0aW5nUmVjb3JkQXJyYXlXb3V0UmVwZWF0ZWQsIC4uLm5ld1JlY29yZEFycmF5XTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGV4aXN0aW5nUmVjb3JkQXJyYXkgJiYgZXhpc3RpbmdSZWNvcmRBcnJheS5sZW5ndGggPyBbLi4uZXhpc3RpbmdSZWNvcmRBcnJheV0gOiBbXTsKICAgIAogICAgICAgICAgICAgICAgZm9yICh2YXIgbSBpbiBuZXdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG4gaW4gZXhpc3RpbmdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3UmVjb3JkQXJyYXlbbV0gJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXSAmJiBuZXdSZWNvcmRBcnJheVttXS5pbnRlcmVzdENvZGUgJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXS5pbnRlcmVzdENvZGUgJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXS5pbnRlcmVzdENvZGUgPT09IG5ld1JlY29yZEFycmF5W21dLmludGVyZXN0Q29kZSApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIWNoZWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5ld1JlY29yZEFycmF5W21dKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2hlY2sgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZVJlcGVhdGVkcyhyZXN1bHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiVGhlIGFyZWEgb2YgaW50ZXJlc3QgaXMgbm90IGFuIGFycmF5LiI7CiAgICAgICAgfQogICAgfQp9CgpmdW5jdGlvbiBkZWxldGVSZXBlYXRlZHMocmVzdWx0KSB7CiAgICBjb25zdCBlcnJvcnMgPSBuZXcgU2V0KCk7CiAgICBjb25zdCBfcmVzdWx0ID0gWy4uLnJlc3VsdC5maWx0ZXIoKHZhbHVlLCBpbmRleCkgPT4gewogICAgICAgIGlmICghdmFsdWUuaW50ZXJlc3RDb2RlIHx8ICF2YWx1ZS5hbnN3ZXJEZXRhaWxzKSB7CiAgICAgICAgICAgIGVycm9ycy5hZGQoYFRoZSByZWNvcmQgaGFzIGFuIGludGVyZXN0IGluIHRoZSByZXBvIHdpdGhvdXQgaW50ZXJlc3RDb2RlIG9yIHdpdGhvdXQgYW5zd2VyRGV0YWlscy5gKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbnRlcmVzdENvZGVWYWx1ZSA9IHR5cGVvZiB2YWx1ZS5pbnRlcmVzdENvZGUgPT09ICJzdHJpbmciID8gdmFsdWUuaW50ZXJlc3RDb2RlLnRvTG93ZXJDYXNlKCkgOiBgJHt2YWx1ZS5pbnRlcmVzdENvZGV9YC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBjb25zdCBhbnN3ZXJEZXRhaWxzVmFsdWUgPSB0eXBlb2YgdmFsdWUuYW5zd2VyRGV0YWlscyA9PT0gInN0cmluZyIgPyB2YWx1ZS5hbnN3ZXJEZXRhaWxzLnRvTG93ZXJDYXNlKCkgOiBgJHt2YWx1ZS5hbnN3ZXJEZXRhaWxzfWAudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgY29uc3QgX3ZhbHVlID0gYCR7IGludGVyZXN0Q29kZVZhbHVlIH0gLSAkeyBhbnN3ZXJEZXRhaWxzVmFsdWUgfWA7CiAgICAgICAgICAgIHJldHVybiBpbmRleCA9PT0gcmVzdWx0LmZpbmRJbmRleChvYmogPT4gewogICAgICAgICAgICAgICAgaWYgKCFvYmouaW50ZXJlc3RDb2RlIHx8ICFvYmouYW5zd2VyRGV0YWlscykgewogICAgICAgICAgICAgICAgICAgIGVycm9ycy5hZGQoYFRoZSByZWNvcmQgaGFzIGFuIGludGVyZXN0IGluIHRoZSByZXBvIHdpdGhvdXQgaW50ZXJlc3RDb2RlIG9yIHdpdGhvdXQgYW5zd2VyRGV0YWlscy5gKQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnRlcmVzdENvZGVPYmogPSB0eXBlb2Ygb2JqLmludGVyZXN0Q29kZSA9PT0gInN0cmluZyIgPyBvYmouaW50ZXJlc3RDb2RlLnRvTG93ZXJDYXNlKCkgOiBgJHtvYmouaW50ZXJlc3RDb2RlfWAudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbnN3ZXJEZXRhaWxzT2JqID0gdHlwZW9mIG9iai5hbnN3ZXJEZXRhaWxzID09PSAic3RyaW5nIiA/IG9iai5hbnN3ZXJEZXRhaWxzLnRvTG93ZXJDYXNlKCkgOiBgJHtvYmouYW5zd2VyRGV0YWlsc31gLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGAkeyBpbnRlcmVzdENvZGVPYmogfSAtICR7IGFuc3dlckRldGFpbHNPYmogfWAgPT0gX3ZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KV07CiAgICAKICAgIGlmIChlcnJvcnMuc2l6ZSkgewogICAgICAgIGxldCBlcnJvck1lc3NhZ2UgPSAiIjsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgZXJyb3JzKSB7CiAgICAgICAgICAgIGlmIChlcnJvck1lc3NhZ2UgJiYgZXJyb3JNZXNzYWdlLmxlbmd0aCkgZXJyb3JNZXNzYWdlICs9IGAsICR7aXRlbX1gOwogICAgICAgICAgICBlbHNlIGVycm9yTWVzc2FnZSA9IGl0ZW07CiAgICAgICAgfQogICAgICAgIHJldHVybiBlcnJvck1lc3NhZ2U7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBfcmVzdWx0OwogICAgfQp9",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["10B. Remove Fields"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "10A bis. Set standard Area of Interest",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgew0KICAgIC8vYXZvaWQgcmVwZWF0ZWQgaW50ZXJlc3RDb2Rlcy1hbnN3ZXJEZXRhaWxzIG9uIGFyZWEgb2YgaW50ZXJlc3QNCiAgICBjb25zdCBlcnJvcnMgPSBuZXcgU2V0KCk7DQoNCiAgICBpZiAocmVjb3JkLmRhdGEuYXJlYU9mSW50ZXJlc3QgJiYgcmVjb3JkLmRhdGEuYXJlYU9mSW50ZXJlc3QubGVuZ3RoID4gMCkgew0KICAgICAgICByZWNvcmQuZGF0YS5hcmVhT2ZJbnRlcmVzdCA9IFsuLi5yZWNvcmQuZGF0YS5hcmVhT2ZJbnRlcmVzdC5maWx0ZXIoKHZhbHVlLCBpbmRleCkgPT4gew0KICAgICAgICAgICAgaWYgKCF2YWx1ZS5pbnRlcmVzdENvZGUgfHwgIXZhbHVlLmFuc3dlckRldGFpbHMpIHsNCiAgICAgICAgICAgICAgICBlcnJvcnMuYWRkKGBJbnZhbGlkIHJlY29yZCBzZW50LiBUaGUgcmVjb3JkIGhhcyBhbiBpbnRlcmVzdCB3aXRob3V0IGludGVyZXN0Q29kZSBvciB3aXRob3V0IGFuc3dlckRldGFpbHMuYCk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGNvbnN0IF92YWx1ZSA9IGAke3ZhbHVlLmludGVyZXN0Q29kZS50b0xvd2VyQ2FzZSgpfSAtICR7dmFsdWUuYW5zd2VyRGV0YWlscy50b0xvd2VyQ2FzZSgpfWA7DQogICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4ID09PSByZWNvcmQuZGF0YS5hcmVhT2ZJbnRlcmVzdC5maW5kSW5kZXgob2JqID0+IHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKCFvYmouaW50ZXJlc3RDb2RlIHx8ICFvYmouYW5zd2VyRGV0YWlscykgew0KICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzLmFkZChgSW52YWxpZCByZWNvcmQgc2VudC4gVGhlIHJlY29yZCBoYXMgYW4gaW50ZXJlc3Qgd2l0aG91dCBpbnRlcmVzdENvZGUgb3Igd2l0aG91dCBhbnN3ZXJEZXRhaWxzLmApOw0KICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGAke29iai5pbnRlcmVzdENvZGUudG9Mb3dlckNhc2UoKX0gLSAke29iai5hbnN3ZXJEZXRhaWxzLnRvTG93ZXJDYXNlKCl9YCA9PSBfdmFsdWU7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSldOw0KICAgIH0NCiAgICBpZiAoZXJyb3JzLnNpemUpIHsNCiAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIGVycm9ycykgew0KICAgICAgICAgICAgaWYgKHJlY29yZC5fZXJyb3JEZXRhaWxzICYmIHJlY29yZC5fZXJyb3JEZXRhaWxzLmxlbmd0aCkgcmVjb3JkLl9lcnJvckRldGFpbHMgKz0gYCwgJHtpdGVtfWA7DQogICAgICAgICAgICBlbHNlIHJlY29yZC5fZXJyb3JEZXRhaWxzID0gaXRlbTsNCiAgICAgICAgfQ0KICAgICAgICBlcnJvci5hY2NlcHQocmVjb3JkLCByZWNvcmQpOw0KICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiByZWNvcmQ7DQogICAgfQ0KfQ0K",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["11B. Remove Fields"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "Upload to Blob Storage",
          "type": "datasource.write.azure.blob_token",
          "params": {
            "baseUri": "https://ciamprblobdataplatform.blob.core.windows.net",
            "accessToken": "********",
            "container": "{{AZURE_CONTAINER_IMPORT_ERROR}}"
          }
        },
        {
          "id": "11C. Update Account",
          "type": "datasource.write.gigya.importaccount",
          "params": {
            "importPolicy": "upsert",
            "maxConnections": 20,
            "addResponse": false
          },
          "next": ["12A. Rename Fields To Register"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "12A. Rename Fields To Register",
          "type": "field.rename",
          "params": {
            "fields": [
              {
                "sourceField": "profile.email",
                "targetField": "profile._email"
              },
              {
                "sourceField": "phoneNumber",
                "targetField": "_phoneNumber"
              },
              {
                "sourceField": "loginIDs",
                "targetField": "_loginIDs"
              },
              {
                "sourceField": "emails",
                "targetField": "_emails"
              }
            ]
          },
          "next": ["13A. Existing Account to Register"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "13A. Existing Account to Register",
          "type": "datasource.lookup.gigya.account",
          "params": {
            "select": "UID,phoneNumber,profile.email,isRegistered",
            "handleFieldConflicts": "take_lookup",
            "mismatchBehavior": "remove",
            "lookupFields": [
              {
                "sourceField": "_phoneNumber",
                "gigyaField": "phoneNumber"
              },
              {
                "sourceField": "profile._email",
                "gigyaField": "loginIDs.unverifiedEmails"
              },
              {
                "sourceField": "profile._email",
                "gigyaField": "loginIDs.emails"
              }
            ],
            "lookupFieldsOperator": "OR",
            "matchBehavior": "process",
            "isCaseSensitive": true,
            "maxConcurrency": 1,
            "from": "accounts",
            "batchSize": 200,
            "multiMatchBehavior": "error"
          },
          "next": ["14A. Check isRegistered"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "14A. Check isRegistered",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgaWYgKCFyZWNvcmQuaXNSZWdpc3RlcmVkKSB7DQogICAgICAgIHJldHVybiByZWNvcmQ7DQogICAgfQ0KfQ==",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["15. Notify Login"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "15. Notify Login",
          "type": "datasource.write.gigya.generic",
          "params": {
            "apiMethod": "accounts.notifyLogin",
            "maxConnections": 10,
            "apiParams": [
              {
                "sourceField": "UID",
                "paramName": "siteUID",
                "value": ""
              }
            ],
            "addResponse": false
          },
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "11D. Import Full Account Upsert",
          "type": "datasource.write.gigya.importaccount",
          "params": {
            "importPolicy": "upsert",
            "maxConnections": 20,
            "addResponse": false
          },
          "next": ["12C. Set Account Info Webhook"],
          "error": ["Prepare fields to extract email"]
        }
      ],
      "version": 1,
      "createTime": "2024-10-15T09:59:15.877Z",
      "updateTime": "2024-10-15T09:59:15.877Z",
      "updatedByEmail": "l.marques@sap.com"
    },
    {
      "apiKey": "4_6Tv6z8O6NmUO_BZoHcXIRw",
      "siteId": 435061734600,
      "id": "a8387ebce4ab44098cf63db565674ab1",
      "name": "[LITE ACCOUNTS] - Import from DQV (BLOB STORAGE) - ONE-FIELD",
      "status": "published",
      "description": "[LITE ACCOUNTS] - Import from DQV (BLOB STORAGE) - ONE-FIELD",
      "steps": [
        {
          "id": "2. Decrypt PGP",
          "type": "file.decrypt.pgp",
          "params": {
            "pgpKey.importedPrivateKey": "LS0tLS1CRUdJTiBQR1AgUFJJVkFURSBLRVkgQkxPQ0stLS0tLQoKbFFjWUJGMEhuYkVCRUFDeVh1K3pCc2p2L3lJaTZBWEhQZy9PNW9lZ0RlQ000TGgzMWNsTDFYYytCdHVhUG9QdApLVURyS0F1YUdUOHJ4MzRpc3hMWHZib0k1RUVPejU3eVRFcVg4TExxWnZWOFNWRWVLVXcxNVlYSlZKRVQ4RVlyClU1dE5lbytGaWo3dXpRMFh1d2tCUzhqcTBERnBUVHl5dXN2a3h0bWVjZ0FvOWtxZUNCZjhBd1dBMEl6YkZqbU8KUm1QWEkwY2JjMllqZVV2dVlJMjl1TmtoTG1DOVRVQ3FPYzBZU2gyQ1lWemt4QWYxeXRlTmdQbUJFZ0UwVjZhYgppQzBYZUhEQUkzdGd2cVdnNDZPK1hTQ012U3JVZ3V1d2l0aW5rTm1weUlrWnZxb1hPZFJrQTdIQnJnNVVUalRDCjhTOS95RzJRd2pzb0VLUUZsYVhzNjc2SXUwcGkzNitZdER1bmJzSE5WZm5xK2kreWRxRHJpT0Q2YUZqVzRBVWEKdjUzcDlSUEFxMnQ3QlZzdEpJYnh1dk1kUXAySThKdDFtdjVxU3hyQTlWU3lPQTFxTHFJeDR3eE9LdEZYV2VyYQpxZlZEWld0bUtDZEMrT0RKZ251RzB3U0ZEMkRWNlhzd2EzZHVyeEpOUWhGaXNiaU1ySU42YXNHc0lOVlJvWDZhCndYUThFNitnMk43Sm4rQnh6ZDQ5ZWdodWd5NnR0eCszY20wSUNpWFU1SUU2cmVXZzU1RVNnMXc0OEtwdUplbTMKNk1oVFBFMHJLMmNHNnpuRWVFdEdHRU84cXFwbUQ1Y25lM1cyUXRoSS93blU0eGoraUlyWldDUmwrWGZHZXNsWAo2ZDQ1TEk2QStwaUxkZGlXVElhWUs0NTh1a1Zxa3k0UVJuUmVaak92c2w2NG1ZRnQxT2J5aUloZXN3QVJBUUFCCkFBLzhDMnpYcDF6UlpSeXZWK2kxdjEvaklsVVRnelhiQXNXOWV5RGgvbTREYjh2VS9YOGJTSWNpY0kyYTcwN0cKV1pjSWUzb3Q3dmRvOXZzcjRhSW5PUXp0b0QyR01FdlNWZTR2b3lJYnVXaTZGajNJOXl2UTlYaUFVNTVSOEIzOQpUdmdxYWx2aGIvTDdRUjNVZEdnWDhialRxT2xGeWpJeUtXMkdpbDNVQk12cXY5S3hSYktaa3RxV1l1ZzdFZS9sCkx4NHN0aGhRSysxWnJHMlhPN2psaktIRzJIM3kxWnJ5bU0xU1Z6VHhjL3BsYTVZMjBUUDdhTmlpK1c4T1d5TDEKV3YvZ2hicmZEbFA5RlphNUFNTmhZUk1HWFV3Q3dvUjZVbFdyVG5FMnExdFlqazB5LzIvQ1RiNzdmeEN4clVVMgpXeWdmRENQY1FoM2k1cDR4M2IzSE5uTDJUblZKOVpML2dhRXJRNUhGWDA5a2JPUzRSTWVQbzY3K1JLckowZ2F6CmZoYjdsNUlIdHdpajg1NVIxWWlyWGtQd0lxcEVIaXQ3Q2U1RWtRTEk4Nm42QnNJdHpnM3ZWKzcrTmFjS0RGRDQKK3BwTnhaYUYxdGFsWGo5N2NIS1hjOTNKNDhmc2NoYWNJekZVa2JLbjJZMGI0c2EvVWVMUHM4Y2drWkhuT3R3egppOEZ3M1o2RHVWSEdKbzdKdmJlMnFzdXdsQjFXZHprVUxEdzl5OUJvSjlTTTJhT1hsVWpQOFl6Um1ROVhkWXJQCmg0MGFuUURsN2lxT3RoNHVQSjgzZGI0ZHdPY1M1K0FGNTZlcitwZ3hpeE14ZzI1V1lEbWxMQXlHV2JqMDBXcGYKTndibDlwU3BRdmxvQnUwd1MrVlgwKzFqZEVlMVZ4SFF4bFNZenNReHJKTU9Xd1VJQU1pcEpqUjQxVXA1LzNGawpxc0hOS29BSndzakQ0TFpLeTRrWVJCUElHMXhDL3VtdlFFK3luL0VxczdvYm9raVU5aDBoWUJ5OXF5c2trK2pICldhZ0NTQjAyU0pNK25mSVcxazhVWTRnSHJBd3hJSC9BY1dtSUlLZmZYb1VzMENYMGhsdEUyTGxaS2pWd0hEdkoKbTJSbG8yeU5McHVtSkd0TCtGU3QveTVRTEY3VlNYck1HaDA1YVE1OGZORDFhcG5yKy9tekE1bkdIMFNUeEU5agorellpM3Axak91UkVUZmE1cWl6anJhNGZGVWlJeWFRdThpakRaUGNUUVBYTTBaK1pBMTJFUlFNbFBzK1ZZWlFECndkMXl2RUFmK0JsMG1KNFBzb2VKdHF3TElvZHFhV1lUS0VzeG5lbU43TTdMaDJzdWRsQ1c4MFh0a2owc3NZNmIKWXNmdUd0MElBT09RR1Jvai9zbFJ2ZzV2ODhUNElOMWtvRXI3OUZnWk1kb1VURS9vN2FjWjlMN0E1c25qdWp3UgpBM2dLNXpHelBPeVAxdW80ellEdWMycStBSjNQcXdoTDFleXNCWWNWVFg0Y3F1M3c3Qkk5VW5UbG9ObytHb3FyCi9JN3VCaThGNys1a2w3K3ovb3JwelAxc1RCdHNVRUs1V0YyVFdobnN2aGR4OVRWSDNZLzFuY3Y5dFdEWWVWR1gKZ0FTcUI3L2xCWkI5UmNkTDl4Y3haUU5ZeitoVFQyeEIvbDZXNDBSZHc0cUJ2UVNoV3NpcUFESEdsS1o3QysrSgpSZUhreU5iWFljUndhQnA2eExiS1NZeWM3WW5YMU03YUFMc3licGVpMkxDWHowNWNpWm9FNkl6UWRhamVEZlByCjNHK2Z3WXhUbU9yZ0pabmYwUUx1TUhWNFJFSzUzczhJQUs5cGNOQ09EODZxZGtrRmlGaWEwZ2tSZjRTTjBGK3IKZzJFT3F4UkJ5VlRoRzdUVTRVcEgrN0oySFlyV1ErVjg5b05oZjlIcTNKMXlEN1Z4Q2Q5UGRlVTBVTEJ3YTFEVQoyVGdHZ3kzVEgvcFQ5Zjl3MUpOd2lQZjZOODNUQTFGUG03R1hBVlhaMXRsYTZiMGE5T1NWSXQ0cVpMRXRIZnNpCllJN1pWSVFpL0ZiVXF2WnRBSzB6VnRZaFdUVDdPalVzQ2owbWNNNmJBRHhlZ1ZSRTNyTjJ0VGJxemRiR1U0ZTYKVmU2UDdWMmlUbUtkSWNBZVAzVFBZQzMyNEdCck1zUC8rdWZReWQ4RkY3U1paWlUrKzI0TUJRMlUwejBpdUxVbgo5WGRKZGR0dVVwUFZoeUdLc29XaVB3cTltK0ovMFRoaUxTOUJKdkJoa3M4K0ZTMVdIRjBtSU9hVW1MUWRRMGxCClRTQkpiWEJ2Y25RZ1BHTnBZVzFBYm1WemRHeGxMbU52YlQ2SkFrNEVFd0VJQURnV0lRUW51MlMzdjZxSGY1SVYKd0JzcTBjTnF4TU84NmdVQ1hRZWRzUUliQXdVTENRZ0hBZ1lWQ2drSUN3SUVGZ0lEQVFJZUFRSVhnQUFLQ1JBcQowY05xeE1PODZ0UGdELzBiVFZxeGk2ZnFVVmpoMGp6QlVvVUFRRWtHTGlQU1RVYnpxTjZtbGJZb3UrTXFJT1NTCkZiOTNnQ2luMVBHbitUdkNNOHJ5WW9JZkNVc0Qzckh0d1ZvRG5PbzMvaFBnWHhpcEJRTkdxMHovK2lsZ2hVdUwKWHovRlNhVkQ3RlJOSnYzbzdFUGk5K1oycUFFMGEvaFpDZXhBQlZtRnZGeml6dlRzYlh3dlZkbHFiUVR3K0gxQQpGbnFmZ2FjbnQ4SHFVVTBqYzF4cHh5U2dISVJBYWh1ZXVFaFhnZVhMeE1OcjZ1aHZqTXVydE80QTdJRDAxdGZPCnJKR1NPbXdEVndaNitVWVYrWE5CeFUyZWxWaXdhbXR1RWlWdXJwYzVYM3BJZ1ZlOEF3b3l4SmlIRkI4S3dpZkoKU1I3YlJ0VG16RzlFenN3NkcvSTdrZDBWVDJiZC9GcE1hU2l1Ulk5SllsOGNkcW9tYVNoKzNWWE9Ibnl1cjNXQQpUS2hYZjZjQ1dhUFpyNmJ0R3RPZXFIdFYwcXVMSnBYNDBjRi9GOU9MS0RFeU5mNWl4UGx1WW13d3dBaXBRVXBSCi96SGNFalUrU0xzVHRhcmhuTnRDUWk3MkVNUFIxVkxFdHVjdU1iT2VvNUx1dGhKM1VWM2FsTndKeWNEYVFmUG8KZUJCbGFneFhkcFZEVmw2TWkyQ1RSNTF0aitzOWs2NEROR0k0NU9KRHVPbElMUDFYYTRNTE5OMmhPKzlKZk1JYQp5aVpoUmx5R3BDR3pvOFFwdzU5NHB4MXJ4ZVEvYmN0WTduWU1KbkRKQ3pEV2E4aWRkSnJTMS9VSmlGVTFjeGtBCms0LzhtZXBSYUQ4bXhMV3UrNEFyMzFNOUJWOFNjNk5nU2ROcWhyQnpMSkxDTzVZMjNFVXpSOVVNMDUwSEdBUmQKQjUyeEFSQUF6bFJLc2ZqZVlUQzhvblNzRGV1ODNNU0JEWTJldXdUcS9EYSt0clFFbkEraWFpNHRLSXNhRHQ3aQp1SGtlMnFLR2VaOUN3eG9VZVJKZ1JRN1hwWEhoeGhpbTJsSytLZUNzZVJtdnY5R01wZThob054OXRkako2TWxTCmtvRVhxZHZ1d0dUcGNGZjFtWjJPVzVYK3daNUpuaU05UGVJYlVPVGp5NUxGRUg2bmhTYzRPV1lVL2tSdlRUQmUKZkRLc0lMa3Jucm5nSkVRTExIcjhQeUtISlRQYWJ0aXg4TUNIK0tpWloyOUNzL3JUd2U0ODhEaHBBZVRSbWgwTQp2Ni9MOHZSNHZHeXQ1R1R0ZmdHSzUzTDRCaDluVWZ5UkdGa25OMllqM3JlcGRWVHJUdnJIdFdONzlwMCtlYUUzCmZVRm9uWlVqc1pXd1BwS3hKZytKOVN4NWNUZ2ZydCtDd1RDdi80bVRCcUE0bmdraTZrYjBqZWc2WHZNRzhpVS8KTnFCeXlxdTRxMnQzOHFlNTA3VUFvTVJtTm5tajN1ZWhGTEFEWXdQMmVOaXNQSFhZc1VCQm8yZExaQkZ0QnpHRAora2Vub1Z2UE5CQ2V0Y21tbXNpSlRMT3dBNzFNU2ZOMlpVTVYxbEZtOUM2Y1V5aE1BODNYdWhhdENnQzdLcnpiCllHaUxGdS9WOGowQlFveWJjM0FhVVc2UUkvWlNNRUx1LzJGTndPRHRGbU5CVzdJUVpXb3NsdEsrcXU2L3I0TmYKZldmelZzaVYyMHZ6YURJSCszaXUyUDI2dmRPbFFJMUthRDVocjNWZG1vTU5lU3FGb2hiOVRqSC82RkFDcElPNgpHS1JrVktLNWpscWY5R3VkTTRZckZBVGVMUWY0Mzh0dUszMVhjS3d3Y2R3NWJEQXpyZFVBRVFFQUFRQVArUUVnCkhaNXJqcFZJb21oUXJaR0EzdTdXejN2d1RwdjYrQmsrU1paek1kQStDT1crVmRwZ3lBVFJab2wybzlNQXEvelgKV0xtaGNwMVZUQjJpZUtZb3ZydGttbUNMcndraHRqMUk4WE1JVDh1NXIzTXRiYVF4RkdaQXd3ZVA1WUx2bGRDUApSUGhTZHg3YnQyZU4xVVFWaHd2WmtTcU1NTDlnZ0kzNlVDODNMUWZLQ21HYko4NjhqN1lEMDR3ZEUzM3dSN1pFCkViY3NubUdGM2RTUXQyWlpFY1dnSVdTQVJ0QU9lV0NDaW5PVnJuL25OZktkYTlsZHFTMlJXcnAzb3hNUUs3NEsKbXk1TG5jdDdRZDFyMVM0V1N2VWVncFl0MFQwS2ZKRzN6UVM4ZFk2cWpyZTlqa2JDWXU3ZnBJQS9PK0R5eVZTZApQeCttdHljQXRSNTFDRWdxaDYrejV5WCt0dlJub1F5V2tBN0k1ZExEaHN0RW5McFozUW1Ec3V5WjVwZDRDS1BOClVacGU1di8wRDQ2dW1iQUliM1I1bEt2b1V2K1UwYVVXZDJJcDVEdER1VTd0OWk3L090a09RS2RKU25xSlJMOFkKd0VIWFdvcU1UVHA3U1dBMHo2Q29HSm43cDhHQ1RNUDdsQlUwWjdHUkFuaUljVVc5YnN4MkcvQUc4S29QVWF6eQpPUjVkVzFiUVpNY003S2xWRVVyZkowYzFCWGFGOVhkellFWW12QnFaYzUyR0Jrd0g1bFRKYkt2dWtLazF0MmVBClluWmJ3Rm9CeFQ1UVlSS3NTOFVsSWhFYnFkd1JicURwSk1oTzZwVEFFNFpLWEozUzR6cUJSN3NJN09KT0VNUC8KVGxiblZXeFN2cWVvdDdVYmpVQUFSSjgwcXA3b3dUT010cVdqcmxOcENBRGRnM2ExODVZejZMcGxYeWxlUG1KMApLWEEzQUtEcGtmV3hXcGpBRzhFaEtKYzcvNWdvZGtXZFdsUkR4eVpETEVEMGU2VG92MlN3bEdHeHlqUURjQXNNCkdxZ3hDd09QcWhsRjhLcjhxTkc5OEFNMllVd1ppVE5xalVRMEdZaHpXU1MzOGloSGtnYkpvcXc1cU1URnlmVXgKSG9pUkl2V25BandFRFVqL1RtRUdCRXI0YmtFUDZtWFFEZlR4d3BISnh2cUdFNVRGc2c3d1NibGpiSFBRRVRDNQpzbVl0QnF2Z1l5THMvT1p0N29iSDI4YzdLd1QwK0tjY21UVnl6bWF4b3RqRkNsMzFOMDRXTWdEdmhPV3JzTFd0ClBJQy9kNkhZVllENVUxeWllM1NnSjQyd2NtaXpldUlkTTJwREF5Zk0zVzI2K2xZZ3ZZeE11cGFnU2dTYjBmNVoKQ0FEdWM2YThwOEJNR1hHMGNjaEQ4UXNlZTJOT1VpaDdJQVV4b0hQcWE1OXNpNmJlWWRiSUp6aFZxMDJXYnJaVgpmVkJWeUp4Y0xTR2ttUFJUbDZSbjcxSHBpbTBkdlZzdkpZazRKYXlDNWJTTE02Tm9Ccyt5Z3o4RXkyVkxXQm4wCmlKQVFVck5EQXRpWDZyL1RoYW1wUlRpSjhKZnlxc1E3WHFPZll0MWVhZEFGdnBHZlpJdmxOYkJnV0I0UlY5R3cKbDhJTnlDUENSK3NKc2laZXRWenZXZ0tzS2h5K1hGV1E1NTVuWHdQOC91MlAxQXdKVVNGMndBcGpRbUNZQkxGRAo3Wi8va2dQWFREUG96T2lxRTdRZG5WK2ZxalBQY215eHlGRjJiZFhUNDFiWEErNW9UU2NsTklJUm1qV01LTW92CmZWTGZXZktuYUtITE9mcmNEZVBlRHBQZENBREFJSC8ra2tjUklnd2lhYmZXSGRKK1NhQ3ZHUG5ONkJNNHczODAKQVcxOEp2MGo3b2V6Y0ZSWjZSejQzYzZYVzh0Q2ZVT2cyb2ZCU1EyeDZEd3BSb3VlZkJ4TVQ2a2lPRlFjb3duZQpXVVRLbkJUR092Um1wRElhbkhocWZGODNhenQ5djF5TlRZc2dnNVFSNnlqWm13ZGZxVnJmWnNOMU04bzRqUHFBCnI2U1Azb05SZlM5RElzUjVubXVhYy9HSE80QnRaRkszeHpzUTFVL05md2hoSlFubTZvVE9rUEVQeWN6S2dZK1QKWTVrU0Nrb3RhQUhxZi8xMklSYVNieEdzeFBZNVpsc0tEazBkWEx1bWVtTFN0YlE3Y2pucThJbTdUZHJvdy9FNgo5dm9HOWJFeFZwTEIxSk9DeXdiZ2RobldEOFhlWGNma0lWczNGUUtvSDcwNUNDYjZkak9KQWpZRUdBRUlBQ0FXCklRUW51MlMzdjZxSGY1SVZ3QnNxMGNOcXhNTzg2Z1VDWFFlZHNRSWJEQUFLQ1JBcTBjTnF4TU84NmlNMUVBQ0wKV093Q1JyTFRuR2U2WTNpZ0hBdU9HelpPVW5NSGFNc1o5aFgvZlE5MjlYTFdTeGNhZDVsVE9SVkErS05wOTViQQpVRGpUZlZGZWE2aUoremYyZ1dqTTJ2SzlmbmJKbFRHUWRIVk42Ynd5am9GR0ZjWnZLTmJvVmJhdTZWRDFRTGlVCld5WWF5eVUvR1NCaFkyRTJBbEFUWFFoZkYxT1JYYWx4L0F2ZzZYNS85bk5oVjdObjF0bU0rdXFFdDJvdlJrRmgKWTBFMi9XWS9icFIrYlozckdtbHVvZVZtWE43Z0ZUZEduY08rS0d4SnFUQUJzV3M5UlJ0RzY2dTYydTM1bWpYcgpqY1JGZG4zTE5VRjlaZFRwRVRvQlEvOTBoLzFxOVRBTUdJRmdXdzNOREtoN1A5S2JEdmpzR01BeUw1RkZmYmVuCjZKaGV5K2F2YlFSZU4vREprUmRlbDRibGRadjhURndpVnZUc2NubjI1M0xMems3eEs1VmFLVXd0Umw0UC9QeEIKMWVuVVkvUnZ2K0JXVXNGdlJMUWpJVittdm9nVS9JdzJJYW8xT09PNWlaWUNqemt3THJ5Z0NpQUZvRWFsdC9veQowdExmZnZXcmVJWUtjdzVHSGJNeVQ5M2dva1RLY1B6cWlOM0hpQVM4YUNqNGZuZURHc2p3blBXL0lETEpMVGZ6CnZqZE9GTnFXczZ0aGYxRzZwQnZZaTVBUmZOb2N0SHROb3NtZTBLNDJZSXpVdWM5SDdYR2dtTVlmd2p6QU8vTDgKb29QclRaYU90bnNnMndhRHo2dkE3S1dnMkRhYXU1STI5VzUrTWdRdm5kRzBEekg3SmlJeW1NTXI5dnhXQmQyNwpQZjYraU4yUkF6SkVyZHdOcEdGWWVzb0doYmMxTmowS2U1S1FqV0toQVE9PQo9ZmtPRAotLS0tLUVORCBQR1AgUFJJVkFURSBLRVkgQkxPQ0stLS0tLQ==",
            "pgpKey": "LS0tLS1CRUdJTiBQR1AgUFVCTElDIEtFWSBCTE9DSy0tLS0tCgptUUlOQkYwSG5iRUJFQUN5WHUrekJzanYveUlpNkFYSFBnL081b2VnRGVDTTRMaDMxY2xMMVhjK0J0dWFQb1B0CktVRHJLQXVhR1Q4cngzNGlzeExYdmJvSTVFRU96NTd5VEVxWDhMTHFadlY4U1ZFZUtVdzE1WVhKVkpFVDhFWXIKVTV0TmVvK0Zpajd1elEwWHV3a0JTOGpxMERGcFRUeXl1c3ZreHRtZWNnQW85a3FlQ0JmOEF3V0EwSXpiRmptTwpSbVBYSTBjYmMyWWplVXZ1WUkyOXVOa2hMbUM5VFVDcU9jMFlTaDJDWVZ6a3hBZjF5dGVOZ1BtQkVnRTBWNmFiCmlDMFhlSERBSTN0Z3ZxV2c0Nk8rWFNDTXZTclVndXV3aXRpbmtObXB5SWtadnFvWE9kUmtBN0hCcmc1VVRqVEMKOFM5L3lHMlF3anNvRUtRRmxhWHM2NzZJdTBwaTM2K1l0RHVuYnNITlZmbnEraSt5ZHFEcmlPRDZhRmpXNEFVYQp2NTNwOVJQQXEydDdCVnN0SklieHV2TWRRcDJJOEp0MW12NXFTeHJBOVZTeU9BMXFMcUl4NHd4T0t0RlhXZXJhCnFmVkRaV3RtS0NkQytPREpnbnVHMHdTRkQyRFY2WHN3YTNkdXJ4Sk5RaEZpc2JpTXJJTjZhc0dzSU5WUm9YNmEKd1hROEU2K2cyTjdKbitCeHpkNDllZ2h1Z3k2dHR4KzNjbTBJQ2lYVTVJRTZyZVdnNTVFU2cxdzQ4S3B1SmVtMwo2TWhUUEUwcksyY0c2em5FZUV0R0dFTzhxcXBtRDVjbmUzVzJRdGhJL3duVTR4aitpSXJaV0NSbCtYZkdlc2xYCjZkNDVMSTZBK3BpTGRkaVdUSWFZSzQ1OHVrVnFreTRRUm5SZVpqT3ZzbDY0bVlGdDFPYnlpSWhlc3dBUkFRQUIKdEIxRFNVRk5JRWx0Y0c5eWRDQThZMmxoYlVCdVpYTjBiR1V1WTI5dFBva0NUZ1FUQVFnQU9CWWhCQ2U3WkxlLwpxb2Qva2hYQUd5clJ3MnJFdzd6cUJRSmRCNTJ4QWhzREJRc0pDQWNDQmhVS0NRZ0xBZ1FXQWdNQkFoNEJBaGVBCkFBb0pFQ3JSdzJyRXc3enEwK0FQL1J0TldyR0xwK3BSV09IU1BNRlNoUUJBU1FZdUk5Sk5Sdk9vM3FhVnRpaTcKNHlvZzVKSVZ2M2VBS0tmVThhZjVPOEl6eXZKaWdoOEpTd1Blc2UzQldnT2M2amYrRStCZkdLa0ZBMGFyVFAvNgpLV0NGUzR0ZlA4VkpwVVBzVkUwbS9lanNRK0wzNW5hb0FUUnIrRmtKN0VBRldZVzhYT0xPOU94dGZDOVYyV3B0CkJQRDRmVUFXZXArQnB5ZTN3ZXBSVFNOelhHbkhKS0FjaEVCcUc1NjRTRmVCNWN2RXcydnE2RytNeTZ1MDdnRHMKZ1BUVzE4NnNrWkk2YkFOWEJucjVSaFg1YzBIRlRaNlZXTEJxYTI0U0pXNnVsemxmZWtpQlY3d0RDakxFbUljVQpId3JDSjhsSkh0dEcxT2JNYjBUT3pEb2I4anVSM1JWUFp0MzhXa3hwS0s1RmowbGlYeHgycWlacEtIN2RWYzRlCmZLNnZkWUJNcUZkL3B3SlpvOW12cHUwYTA1Nm9lMVhTcTRzbWxmalJ3WDhYMDRzb01USTEvbUxFK1c1aWJEREEKQ0tsQlNsSC9NZHdTTlQ1SXV4TzFxdUdjMjBKQ0x2WVF3OUhWVXNTMjV5NHhzNTZqa3U2MkVuZFJYZHFVM0FuSgp3TnBCOCtoNEVHVnFERmQybFVOV1hveUxZSk5IblcyUDZ6MlRyZ00wWWpqazRrTzQ2VWdzL1Zkcmd3czAzYUU3CjcwbDh3aHJLSm1GR1hJYWtJYk9qeENuRG4zaW5IV3ZGNUQ5dHkxanVkZ3dtY01rTE1OWnJ5SjEwbXRMWDlRbUkKVlRWekdRQ1RqL3laNmxGb1B5YkV0YTc3Z0N2ZlV6MEZYeEp6bzJCSjAycUdzSE1za3NJN2xqYmNSVE5IMVF6VAp1UUlOQkYwSG5iRUJFQURPVkVxeCtONWhNTHlpZEt3TjY3emN4SUVOalo2N0JPcjhOcjYydEFTY0Q2SnFMaTBvCml4b08zdUs0ZVI3YW9vWjVuMExER2hSNUVtQkZEdGVsY2VIR0dLYmFVcjRwNEt4NUdhKy8wWXlsN3lHZzNIMjEKMk1ub3lWS1NnUmVwMis3QVpPbHdWL1dablk1YmxmN0Jua21lSXowOTRodFE1T1BMa3NVUWZxZUZKemc1WmhUKwpSRzlOTUY1OE1xd2d1U3VldWVBa1JBc3NldncvSW9jbE05cHUyTEh3d0lmNHFKbG5iMEt6K3RQQjdqendPR2tCCjVOR2FIUXkvcjh2eTlIaThiSzNrWk8xK0FZcm5jdmdHSDJkUi9KRVlXU2MzWmlQZXQ2bDFWT3RPK3NlMVkzdjIKblQ1NW9UZDlRV2lkbFNPeGxiQStrckVtRDRuMUxIbHhPQit1MzRMQk1LLy9pWk1Hb0RpZUNTTHFSdlNONkRwZQo4d2J5SlQ4Mm9ITEtxN2lyYTNmeXA3blR0UUNneEdZMmVhUGU1NkVVc0FOakEvWjQyS3c4ZGRpeFFFR2paMHRrCkVXMEhNWVA2UjZlaFc4ODBFSjYxeWFhYXlJbE1zN0FEdlV4SjgzWmxReFhXVVdiMExweFRLRXdEemRlNkZxMEsKQUxzcXZOdGdhSXNXNzlYeVBRRkNqSnR6Y0JwUmJwQWo5bEl3UXU3L1lVM0E0TzBXWTBGYnNoQmxhaXlXMHI2cQo3cit2ZzE5OVovTld5SlhiUy9Ob01nZjdlSzdZL2JxOTA2VkFqVXBvUG1HdmRWMmFndzE1S29XaUZ2MU9NZi9vClVBS2tnN29ZcEdSVW9ybU9XcC8wYTUwemhpc1VCTjR0Qi9qZnkyNHJmVmR3ckRCeDNEbHNNRE90MVFBUkFRQUIKaVFJMkJCZ0JDQUFnRmlFRUo3dGt0NytxaDMrU0ZjQWJLdEhEYXNURHZPb0ZBbDBIbmJFQ0d3d0FDZ2tRS3RIRAphc1REdk9vak5SQUFpMWpzQWtheTA1eG51bU40b0J3TGpoczJUbEp6QjJqTEdmWVYvMzBQZHZWeTFrc1hHbmVaClV6a1ZRUGlqYWZlV3dGQTQwMzFSWG11b2lmczM5b0Zvek5yeXZYNTJ5WlV4a0hSMVRlbThNbzZCUmhYR2J5alcKNkZXMnJ1bFE5VUM0bEZzbUdzc2xQeGtnWVdOaE5nSlFFMTBJWHhkVGtWMnBjZndMNE9sK2YvWnpZVmV6WjliWgpqUHJxaExkcUwwWkJZV05CTnYxbVAyNlVmbTJkNnhwcGJxSGxabHplNEJVM1JwM0R2aWhzU2Frd0FiRnJQVVViClJ1dXJ1dHJ0K1pvMTY0M0VSWFo5eXpWQmZXWFU2UkU2QVVQL2RJZjlhdlV3REJpQllGc056UXlvZXovU213NzQKN0JqQU1pK1JSWDIzcCtpWVhzdm1yMjBFWGpmd3laRVhYcGVHNVhXYi9FeGNJbGIwN0hKNTl1ZHl5ODVPOFN1VgpXaWxNTFVaZUQvejhRZFhwMUdQMGI3L2dWbExCYjBTMEl5RmZwcjZJRlB5TU5pR3FOVGpqdVltV0FvODVNQzY4Cm9Bb2dCYUJHcGJmNk10TFMzMzcxcTNpR0NuTU9SaDJ6TWsvZDRLSkV5bkQ4Nm9qZHg0Z0V2R2dvK0g1M2d4ckkKOEp6MXZ5QXl5UzAzODc0M1RoVGFsck9yWVg5UnVxUWIySXVRRVh6YUhMUjdUYUxKbnRDdU5tQ00xTG5QUisxeApvSmpHSDhJOHdEdnkvS0tENjAyV2pyWjdJTnNHZzgrcndPeWxvTmcybXJ1U052VnVmaklFTDUzUnRBOHgreVlpCk1wakRLL2I4VmdYZHV6Myt2b2pka1FNeVJLM2NEYVJoV0hyS0JvVzNOVFk5Q251U2tJMWlvUUU9Cj1pMDlqCi0tLS0tRU5EIFBHUCBQVUJMSUMgS0VZIEJMT0NLLS0tLS0="
          },
          "next": ["3. Parse JSON"]
        },
        {
          "id": "3. Parse JSON",
          "type": "file.parse.json",
          "params": {
            "addFilename": false
          },
          "next": ["3. Rename Fields To Merge"]
        },
        {
          "id": "8. Evaluate Subscriptions & Preferences",
          "type": "field.evaluate",
          "params": {
            "fields": [
              {
                "expression": "subscriptions eq null || subscriptions eq ''? '{}' : subscriptions",
                "field": "subscriptions"
              }
            ],
            "language": "jexl"
          },
          "next": ["9. Import lite account"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "9. Import lite account",
          "type": "datasource.write.gigya.generic",
          "params": {
            "apiMethod": "accounts.importLiteAccount",
            "maxConnections": 20,
            "addResponse": true,
            "apiParams": [
              {
                "sourceField": "email",
                "paramName": "email",
                "value": ""
              },
              {
                "sourceField": "data",
                "paramName": "data",
                "value": ""
              },
              {
                "sourceField": "profile",
                "paramName": "profile",
                "value": ""
              },
              {
                "sourceField": "subscriptions",
                "paramName": "subscriptions",
                "value": ""
              }
            ]
          },
          "next": ["10A. Check if Preferences exists"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "4A. Existing Accounts",
          "type": "datasource.lookup.gigya.account",
          "params": {
            "select": "profile.email,data.areaOfInterest,data.pet,data.child,data.externalApplication,lastUpdated,data.initialAppSourceCode,UID",
            "handleFieldConflicts": "take_lookup",
            "mismatchBehavior": "remove",
            "lookupFields": [
              {
                "sourceField": "profile.email",
                "gigyaField": "profile.email"
              }
            ],
            "lookupFieldsOperator": "OR",
            "matchBehavior": "process",
            "isCaseSensitive": false,
            "from": "emailAccounts",
            "batchSize": 200,
            "maxConcurrency": 1,
            "multiMatchBehavior": "error"
          },
          "next": ["5A. Perform Merge Logic", "Prepare existent accounts to extract"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "4B. New Accounts",
          "type": "datasource.lookup.gigya.account",
          "params": {
            "select": "profile.email",
            "handleFieldConflicts": "take_lookup",
            "mismatchBehavior": "process",
            "lookupFields": [
              {
                "sourceField": "profile.email",
                "gigyaField": "profile.email"
              }
            ],
            "lookupFieldsOperator": "OR",
            "matchBehavior": "remove",
            "isCaseSensitive": false,
            "from": "emailAccounts",
            "batchSize": 200,
            "maxConcurrency": 1,
            "multiMatchBehavior": "error"
          },
          "next": ["Prepare new accounts error"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "3. Rename Fields To Merge",
          "type": "field.rename",
          "params": {
            "fields": [
              {
                "sourceField": "data.areaOfInterest",
                "targetField": "data._areaOfInterest"
              },
              {
                "sourceField": "data.pet",
                "targetField": "data._pet"
              },
              {
                "sourceField": "data.child",
                "targetField": "data._child"
              },
              {
                "sourceField": "data.externalApplication",
                "targetField": "data._externalApplication"
              },
              {
                "sourceField": "lastUpdated",
                "targetField": "_lastUpdated"
              },
              {
                "sourceField": "data.initialAppSourceCode",
                "targetField": "data._initialAppSourceCode"
              },
              {
                "sourceField": "subscriptions",
                "targetField": "_subscriptions"
              }
            ]
          },
          "next": ["4A. Existing Accounts", "4B. New Accounts"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "5A. Perform Merge Logic",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgewogICAgY29uc3QgY2hlY2tMYXN0VXBkYXRlZCA9IGZhbHNlOwogICAgY29uc3QgbWVyZ2VDaGlsZCA9IHRydWU7CiAgICBjb25zdCBtZXJnZVBldCA9IHRydWU7CiAgICBjb25zdCBtZXJnZUV4dGVybmFsQXBwbGljYXRpb24gPSB0cnVlOwoKICAgIGlmIChjaGVja0xhc3RVcGRhdGVkICYmIHJlY29yZC5sYXN0VXBkYXRlZCA+IHJlY29yZC5fbGFzdFVwZGF0ZWQpIHJldHVybjsKCiAgICAvLyBXZSB1cGRhdGUgaW5pdGlhbEFwcFNvdXJjZUNvZGUgb25seSBpZiBpdCBkb2Vzbid0IGV4aXN0IGluIHRoZSBzeXN0ZW0KICAgIGlmIChyZWNvcmQuZGF0YSAmJiByZWNvcmQuZGF0YS5faW5pdGlhbEFwcFNvdXJjZUNvZGUgJiYgIXJlY29yZC5kYXRhLmluaXRpYWxBcHBTb3VyY2VDb2RlKSByZWNvcmQuZGF0YS5pbml0aWFsQXBwU291cmNlQ29kZSA9IHJlY29yZC5kYXRhLl9pbml0aWFsQXBwU291cmNlQ29kZTsKCiAgICBjb25zdCBzdHJhdGVneUNob29zZW4gPSAie3tNRVJHRV9TVFJBVEVHWX19IjsKCiAgICAvLyBBcHBseSBtZXJnZSBsb2dpY3MKICAgIGlmIChtZXJnZUNoaWxkKSBjYWxsTWVyZ2VMb2dpYyhyZWNvcmQsICJjaGlsZCIsIHN0cmF0ZWd5Q2hvb3Nlbik7CiAgICBpZiAobWVyZ2VQZXQpIGNhbGxNZXJnZUxvZ2ljKHJlY29yZCwgInBldCIsIHN0cmF0ZWd5Q2hvb3Nlbik7CiAgICBpZiAobWVyZ2VFeHRlcm5hbEFwcGxpY2F0aW9uKSBjYWxsTWVyZ2VMb2dpYyhyZWNvcmQsICJleHRlcm5hbEFwcGxpY2F0aW9uIiwgc3RyYXRlZ3lDaG9vc2VuKTsKICAgIAogICAgaWYgKHJlY29yZC5fZXJyb3JEZXRhaWxzICYmIHJlY29yZC5fZXJyb3JEZXRhaWxzLmxlbmd0aCkgewogICAgICAgIGVycm9yLmFjY2VwdChyZWNvcmQsIHJlY29yZCk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIFByZWZlcmVuY2VzIGxvZ2ljCiAgICAgICAgaWYgKHJlY29yZC5wcmVmZXJlbmNlcykKICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gcmVjb3JkLnByZWZlcmVuY2VzKSB7CiAgICAgICAgICAgICAgICBpZiAoa2V5ICE9ICJ0ZXJtcyIgJiYga2V5ICE9ICJwcml2YWN5IikgcmVjb3JkLnByZWZlcmVuY2VzW2tleV0uY3VzdG9tRGF0YSA9IG51bGw7CiAgICAgICAgICAgICAgICBlbHNlIGZvciAoY29uc3QgcHJlZkluZGV4IGluIHJlY29yZC5wcmVmZXJlbmNlc1trZXldKSByZWNvcmQucHJlZmVyZW5jZXNba2V5XVtwcmVmSW5kZXhdLmN1c3RvbURhdGEgPSBudWxsOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAvLyBTdWJzY3JpcHRpb24gbG9naWMKICAgICAgICByZWNvcmQuc3Vic2NyaXB0aW9ucyA9IHt9OwogICAgICAgIGlmIChyZWNvcmQuX3N1YnNjcmlwdGlvbnMpIHsKICAgICAgICAgICAgZm9yICh2YXIgc3ViS2V5IGluIHJlY29yZC5fc3Vic2NyaXB0aW9ucykgewogICAgICAgICAgICAgICAgaWYgKHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCJ0cnVlIiA9PSAie3tET1VCTEVfT1BUX0lOfX0iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbiAmJiByZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5zdGF0dXMgJiYgcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uc3RhdHVzID09PSAiQ29uZmlybWVkIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkID0gcHJvY2Vzc1N1YnNjcmlwdGlvbnMocmVjb3JkLCBzdWJLZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbiB8fCAocmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uc3RhdHVzICYmIHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLnN0YXR1cyA9PT0gIkNvbmZpcm1lZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmQgPSBwcm9jZXNzU3Vic2NyaXB0aW9ucyhyZWNvcmQsIHN1YktleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIHJldHVybiByZWNvcmQ7ICAgICAgICAKICAgIH0KfQoKZnVuY3Rpb24gcHJvY2Vzc1N1YnNjcmlwdGlvbnMocmVjb3JkLCBzdWJLZXkpIHsKICAgIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0gPSByZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XTsKCiAgICBpZiAocmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbikgewogICAgICAgIGxldCBvYmplY3QgPSB7fTsKICAgICAgICBsZXQgZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCA9IHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZDsKICAgICAgICBjb25zdCBjb25kaXRpb25hbGx5UHJlc2VudCA9IGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgIT09IG51bGwgJiYgZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCAhPT0gdW5kZWZpbmVkOwogICAgICAgIGNvbnN0IGNvbmRpdGlvbmFsbHlJc0Jvb2wgPSB0eXBlb2YgZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCA9PT0gImJvb2xlYW4iOwoKICAgICAgICBpZiAoY29uZGl0aW9uYWxseVByZXNlbnQpIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPSBjb25kaXRpb25hbGx5SXNCb29sID8gZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCA6IGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPT0gInRydWUiOwogICAgICAgIGVsc2UgZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCA9IG51bGw7CgogICAgICAgIGlmIChkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkICE9PSBudWxsKSByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLmlzRXh0ZXJuYWxseVZlcmlmaWVkID0gZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZDsKCiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbikgaWYgKGtleSAhPT0gImRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQiKSBvYmplY3Rba2V5XSA9IHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW5ba2V5XTsKCiAgICAgICAgcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbiA9IG9iamVjdDsKICAgIH0KICAgIAogICAgZGVsZXRlIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwubGFzdFVwZGF0ZWRTdWJzY3JpcHRpb25TdGF0ZTsKCiAgICByZXR1cm4gcmVjb3JkOwp9CgoKZnVuY3Rpb24gZ2VuZXJhdGVVVUlEKCkgewogICAgbGV0IGQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIGNvbnN0IHV1aWQgPSAieHh4eHh4eHgteHh4eC00eHh4LXl4eHgteHh4eHh4eHh4eHh4Ii5yZXBsYWNlKC9beHldL2csIGZ1bmN0aW9uIChjKSB7CiAgICAgICAgY29uc3QgciA9IChkICsgTWF0aC5yYW5kb20oKSAqIDE2KSAlIDE2IHwgMDsKICAgICAgICBkID0gTWF0aC5mbG9vcihkIC8gMTYpOwogICAgICAgIHJldHVybiAoYyA9PSAieCIgPyByIDogKHIgJiAweDMpIHwgMHg4KS50b1N0cmluZygxNik7CiAgICB9KTsKICAgIHJldHVybiB1dWlkOwp9CgpmdW5jdGlvbiBjYWxsTWVyZ2VMb2dpYyhyZWNvcmQsIHByb3BlcnR5TmFtZSwgc3RyYXRlZ3lDaG9vc2VuKSB7CiAgICBjb25zdCBfcHJvcGVydHlOYW1lID0gIl8iICsgcHJvcGVydHlOYW1lOwogICAgY29uc3Qgb25seVVuZGVyU2NvcmUgPSByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXSAmJiAhcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXTsKICAgIGNvbnN0IGJvdGhDYXNlcyA9IHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV07CiAgICBjb25zdCBub3JtYWxMZW5naHQgPSByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdICYmIHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0ubGVuZ3RoID09PSAwOwogICAgY29uc3QgdW5kZXJTY29yZUxlbmdodCA9IHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdICYmIHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMDsKCiAgICBpZiAoKG9ubHlVbmRlclNjb3JlICYmIHVuZGVyU2NvcmVMZW5naHQpIHx8IChib3RoQ2FzZXMgJiYgbm9ybWFsTGVuZ2h0ICYmIHVuZGVyU2NvcmVMZW5naHQpKSByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV07CiAgICBlbHNlIGlmIChib3RoQ2FzZXMgJiYgdW5kZXJTY29yZUxlbmdodCkgewogICAgICAgIGNvbnN0IG1lcmdlUmVzdWx0ID0gcHJvY2Vzc01lcmdlKHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0sIHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLCBzdHJhdGVneUNob29zZW4sIHByb3BlcnR5TmFtZSk7CiAgICAgICAgaWYgKHR5cGVvZiBtZXJnZVJlc3VsdCA9PT0gJ3N0cmluZycpIHJlY29yZC5fZXJyb3JEZXRhaWxzID0gbWVyZ2VSZXN1bHQ7CiAgICAgICAgZWxzZSByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gbWVyZ2VSZXN1bHQ7CiAgICB9Cn0KCmZ1bmN0aW9uIGNoZWNrVVVJRCh1dWlkKSB7CiAgICBjb25zdCByZWdleCA9IC9eWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tNFswLTlhLWZdezN9LVs4OWFiXVswLTlhLWZdezN9LVswLTlhLWZdezEyfSQvaTsKICAgIHJldHVybiByZWdleC50ZXN0KHV1aWQpOwp9CgpmdW5jdGlvbiBnZW5lcmF0ZVVVSURhbmRVcGRhdGVEYXRlKHR5cGUsIHRhcmdldCwgaSkgewogICAgaWYgKHR5cGUgPT09ICJjaGlsZCIgfHwgdHlwZSA9PT0gInBldCIpIHsKICAgICAgICBpZighY2hlY2tVVUlEKHRhcmdldFtpXS5hcHBsaWNhdGlvbkludGVybmFsSWRlbnRpZmllcikpewogICAgICAgICAgICB0YXJnZXRbaV0uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIgPSBnZW5lcmF0ZVVVSUQoKTsKICAgICAgICB9CiAgICB9Cn0KCmZ1bmN0aW9uIHByb2Nlc3NNZXJnZShleGlzdGluZ1JlY29yZEFycmF5LCBuZXdSZWNvcmRBcnJheSwgc3RyYXRlZ3ksIHR5cGUpIHsKICAgIGxldCByZXN1bHQgPSBbXTsKICAgIGxldCBjaGVjayA9IGZhbHNlOwogICAgaWYgKHN0cmF0ZWd5ID09PSAiZnVsbFJlcGxhY2UiKSB7CiAgICAgICAgcmVzdWx0ID0gbmV3UmVjb3JkQXJyYXk7CiAgICAgICAgZm9yIChsZXQgeCBpbiByZXN1bHQpIGdlbmVyYXRlVVVJRGFuZFVwZGF0ZURhdGUodHlwZSwgcmVzdWx0LCB4KTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXhpc3RpbmdSZWNvcmRBcnJheSkpIHsKICAgICAgICAgICAgcmVzdWx0ID0gQXJyYXkuZnJvbShleGlzdGluZ1JlY29yZEFycmF5KTsKICAgICAgICAgICAgZm9yIChjb25zdCBtIGluIG5ld1JlY29yZEFycmF5KSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IG4gaW4gZXhpc3RpbmdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICAgICAgKCh0eXBlID09PSAiY2hpbGQiIHx8IHR5cGUgPT09ICJwZXQiKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UmVjb3JkQXJyYXlbbV0uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtuXS5hcHBsaWNhdGlvbkludGVybmFsSWRlbnRpZmllciAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UmVjb3JkQXJyYXlbbV0uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIudG9Mb3dlckNhc2UoKSA9PT0gcmVzdWx0W25dLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyLnRvTG93ZXJDYXNlKCkpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlID09PSAiY2hpbGQiICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdSZWNvcmRBcnJheVttXS5iaXJ0aERhdGUgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtuXS5iaXJ0aERhdGUgPT09IG5ld1JlY29yZEFycmF5W21dLmJpcnRoRGF0ZSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UmVjb3JkQXJyYXlbbV0uZmlyc3ROYW1lICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbbl0uZmlyc3ROYW1lICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbbl0uZmlyc3ROYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5ld1JlY29yZEFycmF5W21dLmZpcnN0TmFtZS50b0xvd2VyQ2FzZSgpKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAodHlwZSA9PT0gInBldCIgJiYgbmV3UmVjb3JkQXJyYXlbbV0ubmFtZSAmJiByZXN1bHRbbl0ubmFtZSAmJiByZXN1bHRbbl0ubmFtZS50b0xvd2VyQ2FzZSgpID09PSBuZXdSZWNvcmRBcnJheVttXS5uYW1lLnRvTG93ZXJDYXNlKCkpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlID09PSAiZXh0ZXJuYWxBcHBsaWNhdGlvbiIgJiYgbmV3UmVjb3JkQXJyYXlbbV0uYXBwbGljYXRpb25Db2RlICYmIHJlc3VsdFtuXS5hcHBsaWNhdGlvbkNvZGUgJiYgcmVzdWx0W25dLmFwcGxpY2F0aW9uQ29kZS50b0xvd2VyQ2FzZSgpID09PSBuZXdSZWNvcmRBcnJheVttXS5hcHBsaWNhdGlvbkNvZGUudG9Mb3dlckNhc2UoKSkKICAgICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChzdHJhdGVneSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAicmVwbGFjZVBhcnRpYWxseSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBhdHRyTmFtZVJlcGxhY2UgaW4gcmVzdWx0W25dKSByZXN1bHRbbl1bYXR0ck5hbWVSZXBsYWNlXSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBhdHRyTmFtZU5ld1JlcGxhY2UgaW4gbmV3UmVjb3JkQXJyYXlbbV0pIHJlc3VsdFtuXVthdHRyTmFtZU5ld1JlcGxhY2VdID0gbmV3UmVjb3JkQXJyYXlbbV1bYXR0ck5hbWVOZXdSZXBsYWNlXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIm1lcmdlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGF0dHJOYW1lTWVyZ2UgaW4gbmV3UmVjb3JkQXJyYXlbbV0pIHJlc3VsdFtuXVthdHRyTmFtZU1lcmdlXSA9IG5ld1JlY29yZEFycmF5W21dW2F0dHJOYW1lTWVyZ2VdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInNraXAiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGdlbmVyYXRlVVVJRGFuZFVwZGF0ZURhdGUodHlwZSwgcmVzdWx0LCBuKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghY2hlY2sgJiYgKHR5cGUgPT09ICJjaGlsZCIgfHwgdHlwZSA9PT0gInBldCIgfHwgdHlwZSA9PT0gImV4dGVybmFsQXBwbGljYXRpb24iKSkgewogICAgICAgICAgICAgICAgICAgIGdlbmVyYXRlVVVJRGFuZFVwZGF0ZURhdGUodHlwZSwgbmV3UmVjb3JkQXJyYXksIG0pOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5ld1JlY29yZEFycmF5W21dKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoZWNrID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gYFRoZSBleHRlcm5hbEFwcGxpY2F0aW9uLCBjaGlsZCBhbmQvb3IgcGV0IGlzIG5vdCBhbiBhcnJheS5gOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7Cn0=",
            "notifyLastRecord": false,
            "ECMAScriptVersion": "12"
          },
          "next": ["5A bis. Perform Merge Area of Interest Logic"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "11. Lite InitRegistrationgigya.generic",
          "type": "datasource.write.gigya.generic",
          "params": {
            "apiMethod": "accounts.initRegistration",
            "maxConnections": 10,
            "apiParams": [
              {
                "sourceField": "",
                "paramName": "isLite",
                "value": "true"
              }
            ],
            "addResponse": true
          },
          "next": ["12. setAccountInfo"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "12. setAccountInfo",
          "type": "datasource.write.gigya.generic",
          "params": {
            "apiMethod": "accounts.setAccountInfo",
            "maxConnections": 20,
            "addResponse": true,
            "apiParams": [
              {
                "sourceField": "profile",
                "paramName": "profile",
                "value": ""
              },
              {
                "sourceField": "_response.regToken",
                "paramName": "regToken",
                "value": ""
              },
              {
                "sourceField": "preferences",
                "paramName": "preferences",
                "value": ""
              },
              {
                "sourceField": "lang",
                "paramName": "lang",
                "value": ""
              }
            ]
          },
          "next": [],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "6A. Remove Fields",
          "type": "field.remove",
          "params": {
            "fields": ["data._areaOfInterest", "data._child", "data._pet", "data._externalApplication", "_lastUpdated", "data._initialAppSourceCode", "_subscriptions"]
          },
          "next": ["7. Add data.idxImportJobId"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "10A. Check if Preferences exists",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgaWYocmVjb3JkICYmIHJlY29yZC5wcmVmZXJlbmNlcykgew0KICAgICAgICBpZiAocmVjb3JkLnByZWZlcmVuY2VzICYmICFyZWNvcmQubGFuZykgew0KICAgICAgICAgICAgaWYgKHJlY29yZC5wcm9maWxlICYmIHJlY29yZC5wcm9maWxlLmxvY2FsZSkgew0KICAgICAgICAgICAgICAgIHJlY29yZC5sYW5nID0gcmVjb3JkLnByb2ZpbGUubG9jYWxlOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgIHJlY29yZC5sYW5nID0gImVuIjsgDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHJlY29yZDsNCiAgICB9DQp9",
            "notifyLastRecord": false,
            "ECMAScriptVersion": "12"
          },
          "next": ["11. Lite InitRegistrationgigya.generic"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "Prepare new accounts error",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgew0KICAgIHJlY29yZC5fZXJyb3JEZXRhaWxzID0gJ1RoaXMgcmVjb3JkIGRvZXMgbm90IGV4aXN0IG9uIHRoZSByZXBvc2l0b3J5IG9yIHlvdSBhcmUgdHJ5aW5nIHRvIHVwZGF0ZSBhIEZ1bGwgQWNjb3VudCB3aXRoIHRoZSBMaXRlIEFjY291bnQgZGF0YWZsb3cuIFlvdSBtdXN0IHJ1biBpdCB3aXRoIHRoZSBpbXBvcnQgd2l0aCBhbGwgdGhlIHJlcXVpcmVkIGZpZWxkcy4nOw0KICAgIGVycm9yLmFjY2VwdChyZWNvcmQsIHJlY29yZCk7DQogICAgcmV0dXJuOw0KfQ==",
            "notifyLastRecord": false,
            "ECMAScriptVersion": "12"
          },
          "next": [],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "1. Read From Blob Storage",
          "type": "datasource.read.azure.blob_token",
          "params": {
            "baseUri": "{{AZURE_BASE_URI}}",
            "accessToken": "********",
            "container": "{{AZURE_CONTAINER}}",
            "blobPrefix": "{{AZURE_BLOB_PREFIX}}"
          },
          "next": ["2. Decrypt PGP"]
        },
        {
          "id": "Prepare fields to extract email",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgdmFyIHJlY29yZFRvRXh0cmFjdCA9IHt9Ow0KICAgIHJlY29yZFRvRXh0cmFjdC5lbWFpbCA9IHJlY29yZC5lbWFpbDsNCiAgICBpZiAocmVjb3JkLlVJRCAmJiByZWNvcmQuVUlELmxlbmd0aCkgew0KICAgICAgICByZWNvcmRUb0V4dHJhY3QuVUlEID0gcmVjb3JkLlVJRDsNCiAgICB9DQogICAgDQogICAgcmVjb3JkVG9FeHRyYWN0LmVycm9yRGV0YWlscyA9IHJlY29yZC5fZXJyb3JEZXRhaWxzOw0KDQogICAgcmV0dXJuIHJlY29yZFRvRXh0cmFjdDsNCn0=",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["Generate file"]
        },
        {
          "id": "Generate file",
          "type": "file.format.json",
          "params": {
            "fileName": "{{AZURE_ERRORS_FILENAME}}_${now:yyMMddHHmm}.json",
            "maxFileSize": 5000,
            "createEmptyFile": false
          },
          "next": ["Encrypt file"]
        },
        {
          "id": "Encrypt file",
          "type": "file.encrypt.pgp",
          "params": {
            "publicKey": "{{PGP_Public_Key_Base64_Encoded}}",
            "asciiArmor": true
          },
          "next": ["Upload to Blob Storage"]
        },
        {
          "id": "Prepare existent accounts to extract",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgdmFyIG5ld1JlY29yZCA9IHsNCiAgICAgICAgIlVJRCI6IHJlY29yZC5VSUQsDQogICAgICAgICJlbWFpbCI6IHJlY29yZC5wcm9maWxlLmVtYWlsDQogICAgfTsNCiAgICANCiAgICBpZiAocmVjb3JkLmRhdGEuaW5pdGlhbEFwcFNvdXJjZUNvZGUpIHsNCiAgICAgICAgbmV3UmVjb3JkLmluaXRpYWxBcHBTb3VyY2VDb2RlID0gcmVjb3JkLmRhdGEuaW5pdGlhbEFwcFNvdXJjZUNvZGU7DQogICAgfQ0KICAgIA0KICAgIGlmIChyZWNvcmQuZGF0YS5saXRlQXBwU291cmNlQ29kZSkgew0KICAgICAgICBuZXdSZWNvcmQubGl0ZUFwcFNvdXJjZUNvZGUgPSByZWNvcmQuZGF0YS5saXRlQXBwU291cmNlQ29kZTsNCiAgICB9DQogICAgDQogICAgcmV0dXJuIG5ld1JlY29yZDsNCn0=",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["Generate Existent Accounts File"]
        },
        {
          "id": "Generate Existent Accounts File",
          "type": "file.format.json",
          "params": {
            "fileName": "{{AZURE_EXISTENT_ACCOUNTS_FILENAME}}_${now:yyMMddHHmm}.json",
            "maxFileSize": 5000,
            "createEmptyFile": false
          },
          "next": ["Encrypt file"]
        },
        {
          "id": "7. Add data.idxImportJobId",
          "type": "field.add",
          "params": {
            "fields": [
              {
                "field": "data.idxImportJobId",
                "value": "${jobId}"
              }
            ]
          },
          "next": ["8. Evaluate Subscriptions & Preferences"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "5A bis. Perform Merge Area of Interest Logic",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgewogICAgLy8gSWYgc2V0IHRvIHRydWUgdGhlIHJlY29yZCB3aWxsIGJlIHByb2Nlc3NlZCBvbmx5IGlmIHRoZSBsYXN0VXBkYXRlIGluIHRoZSBmaWxlIGlzID4gbGFzdHVwZGF0ZSBpbiBTQVAtQ0RDLiBJZiBzZXQgdG8gZmFsc2UgdGhlIHJlY29yZCB3aWxsIGJlIGFsd2F5cyBwcm9jZXNzZWQuCiAgICB2YXIgY2hlY2tMYXN0VXBkYXRlZCA9IGZhbHNlOwogICAgLy8gSWYgc2V0IHRvIHRydWUgd2Ugd2lsbCBhcHBseSB0aGUgbWVyZ2UgbG9naWMgZm9yIHRoZSBjYXRlZ29yeS4gSWYgc2V0IHRvIGZhbHNlIHdlIHdpbGwgbm90IGFwcGx5IHRoZSBtZXJnaW5nIGxvZ2ljLgogICAgdmFyIG1lcmdlQXJlYU9mSW50ZXJlc3QgPSB0cnVlOwoKICAgIGlmKCBjaGVja0xhc3RVcGRhdGVkICYmIHJlY29yZC5sYXN0VXBkYXRlZCA+IHJlY29yZC5fbGFzdFVwZGF0ZWQgKSByZXR1cm47CiAgICAKICAgIHZhciBtYXRjaGluZ0NvbmRpdGlvbkFyZWFPZkludGVyZXN0ID0gWyJpbnRlcmVzdENvZGUiXTsKICAgIHZhciBzdHJhdGVneUNob29zZW4gPSAie3tNRVJHRV9TVFJBVEVHWX19IjsKCiAgICBpZiAoIG1lcmdlQXJlYU9mSW50ZXJlc3QgKSBjYWxsTWVyZ2VMb2dpYyggcmVjb3JkLCAiYXJlYU9mSW50ZXJlc3QiLCBzdHJhdGVneUNob29zZW4sIGxvZ2dlciwgZXJyb3IpOwogICAgCiAgICBpZiAocmVjb3JkLl9lcnJvckRldGFpbHMgJiYgcmVjb3JkLl9lcnJvckRldGFpbHMubGVuZ3RoKSB7CiAgICAgICAgZXJyb3IuYWNjZXB0KHJlY29yZCwgcmVjb3JkKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgIH0KfQoKZnVuY3Rpb24gY2FsbE1lcmdlTG9naWMoIHJlY29yZCwgcHJvcGVydHlOYW1lLCBzdHJhdGVneUNob29zZW4sIGxvZ2dlciwgZXJyb3IpIHsKICAgIHZhciBfcHJvcGVydHlOYW1lID0gIl8iICsgcHJvcGVydHlOYW1lOwogICAgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdICYmICFyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdKSB7CiAgICAgICAgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gZGVsZXRlUmVwZWF0ZWRzKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdKTsKICAgICAgICB9CiAgICB9IGVsc2UgaWYgKHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0pIHsKICAgICAgICBpZiAocmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXS5sZW5ndGggPT09IDAgJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0ubGVuZ3RoICE9PSAwKSByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gZGVsZXRlUmVwZWF0ZWRzKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdKTsgIAogICAgICAgIGVsc2UgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICBjb25zdCBtZXJnZVJlc3VsdCA9IHByb2Nlc3NNZXJnZShyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdLCByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXSwgc3RyYXRlZ3lDaG9vc2VuKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXJnZVJlc3VsdCA9PT0gJ3N0cmluZycpIHJlY29yZC5fZXJyb3JEZXRhaWxzID0gbWVyZ2VSZXN1bHQ7CiAgICAgICAgICAgIGVsc2UgcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXSA9IG1lcmdlUmVzdWx0OwogICAgICAgIH0KICAgIH0KfQoKCmZ1bmN0aW9uIHByb2Nlc3NNZXJnZShleGlzdGluZ1JlY29yZEFycmF5LCBuZXdSZWNvcmRBcnJheSwgc3RyYXRlZ3kpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIHZhciBjaGVjayA9IGZhbHNlOwogICAgaWYgKCBzdHJhdGVneSA9PT0gImZ1bGxSZXBsYWNlIikgewogICAgICAgIHJlc3VsdCA9IG5ld1JlY29yZEFycmF5OwogICAgICAgIHJldHVybiBkZWxldGVSZXBlYXRlZHMocmVzdWx0KTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXhpc3RpbmdSZWNvcmRBcnJheSkpIHsKICAgICAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAicmVwbGFjZVBhcnRpYWxseSIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5ld0ludGVyZXN0Q29kZXMgPSBuZXdSZWNvcmRBcnJheS5tYXAocmVjb3JkID0+IHJlY29yZC5pbnRlcmVzdENvZGUpOwogICAgCiAgICAgICAgICAgICAgICBleGlzdGluZ1JlY29yZEFycmF5ID0gWy4uLmV4aXN0aW5nUmVjb3JkQXJyYXkuZmlsdGVyKHJlY29yZCA9PiAhISFuZXdJbnRlcmVzdENvZGVzLmZpbmQoaW50ZXJlc3RDb2RlID0+IGludGVyZXN0Q29kZSA9PT0gcmVjb3JkLmludGVyZXN0Q29kZSkpXTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAibWVyZ2UiKSB7CiAgICAgICAgICAgICAgICBjb25zdCBleGlzdGluZ1JlY29yZEFycmF5V291dFJlcGVhdGVkID0gZXhpc3RpbmdSZWNvcmRBcnJheS5maWx0ZXIocmVjb3JkID0+ICFuZXdSZWNvcmRBcnJheS5maW5kKF9yZWNvcmQgPT4gX3JlY29yZC5pbnRlcmVzdENvZGUgPT09IHJlY29yZC5pbnRlcmVzdENvZGUgJiYgX3JlY29yZC5hbnN3ZXJEZXRhaWxzID09PSByZWNvcmQuYW5zd2VyRGV0YWlscykpOwogICAgICAgICAgICAgICAgcmVzdWx0ID0gWy4uLmV4aXN0aW5nUmVjb3JkQXJyYXlXb3V0UmVwZWF0ZWQsIC4uLm5ld1JlY29yZEFycmF5XTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGV4aXN0aW5nUmVjb3JkQXJyYXkgJiYgZXhpc3RpbmdSZWNvcmRBcnJheS5sZW5ndGggPyBbLi4uZXhpc3RpbmdSZWNvcmRBcnJheV0gOiBbXTsKICAgIAogICAgICAgICAgICAgICAgZm9yICh2YXIgbSBpbiBuZXdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG4gaW4gZXhpc3RpbmdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3UmVjb3JkQXJyYXlbbV0gJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXSAmJiBuZXdSZWNvcmRBcnJheVttXS5pbnRlcmVzdENvZGUgJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXS5pbnRlcmVzdENvZGUgJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXS5pbnRlcmVzdENvZGUgPT09IG5ld1JlY29yZEFycmF5W21dLmludGVyZXN0Q29kZSApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIWNoZWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5ld1JlY29yZEFycmF5W21dKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2hlY2sgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZVJlcGVhdGVkcyhyZXN1bHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiVGhlIGFyZWEgb2YgaW50ZXJlc3QgaXMgbm90IGFuIGFycmF5LiI7CiAgICAgICAgfQogICAgICAgCiAgICB9Cn0KCmZ1bmN0aW9uIGRlbGV0ZVJlcGVhdGVkcyhyZXN1bHQpIHsKICAgIGNvbnN0IGVycm9ycyA9IG5ldyBTZXQoKTsKICAgIGNvbnN0IF9yZXN1bHQgPSBbLi4ucmVzdWx0LmZpbHRlcigodmFsdWUsIGluZGV4KSA9PiB7CiAgICAgICAgaWYgKCF2YWx1ZS5pbnRlcmVzdENvZGUgfHwgIXZhbHVlLmFuc3dlckRldGFpbHMpIHsKICAgICAgICAgICAgZXJyb3JzLmFkZChgVGhlIHJlY29yZCBoYXMgYW4gaW50ZXJlc3QgaW4gdGhlIHJlcG8gd2l0aG91dCBpbnRlcmVzdENvZGUgb3Igd2l0aG91dCBhbnN3ZXJEZXRhaWxzLmApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGludGVyZXN0Q29kZVZhbHVlID0gdHlwZW9mIHZhbHVlLmludGVyZXN0Q29kZSA9PT0gInN0cmluZyIgPyB2YWx1ZS5pbnRlcmVzdENvZGUudG9Mb3dlckNhc2UoKSA6IGAke3ZhbHVlLmludGVyZXN0Q29kZX1gLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGNvbnN0IGFuc3dlckRldGFpbHNWYWx1ZSA9IHR5cGVvZiB2YWx1ZS5hbnN3ZXJEZXRhaWxzID09PSAic3RyaW5nIiA/IHZhbHVlLmFuc3dlckRldGFpbHMudG9Mb3dlckNhc2UoKSA6IGAke3ZhbHVlLmFuc3dlckRldGFpbHN9YC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBjb25zdCBfdmFsdWUgPSBgJHsgaW50ZXJlc3RDb2RlVmFsdWUgfSAtICR7IGFuc3dlckRldGFpbHNWYWx1ZSB9YDsKICAgICAgICAgICAgcmV0dXJuIGluZGV4ID09PSByZXN1bHQuZmluZEluZGV4KG9iaiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIW9iai5pbnRlcmVzdENvZGUgfHwgIW9iai5hbnN3ZXJEZXRhaWxzKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzLmFkZChgVGhlIHJlY29yZCBoYXMgYW4gaW50ZXJlc3QgaW4gdGhlIHJlcG8gd2l0aG91dCBpbnRlcmVzdENvZGUgb3Igd2l0aG91dCBhbnN3ZXJEZXRhaWxzLmApCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGludGVyZXN0Q29kZU9iaiA9IHR5cGVvZiBvYmouaW50ZXJlc3RDb2RlID09PSAic3RyaW5nIiA/IG9iai5pbnRlcmVzdENvZGUudG9Mb3dlckNhc2UoKSA6IGAke29iai5pbnRlcmVzdENvZGV9YC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuc3dlckRldGFpbHNPYmogPSB0eXBlb2Ygb2JqLmFuc3dlckRldGFpbHMgPT09ICJzdHJpbmciID8gb2JqLmFuc3dlckRldGFpbHMudG9Mb3dlckNhc2UoKSA6IGAke29iai5hbnN3ZXJEZXRhaWxzfWAudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYCR7IGludGVyZXN0Q29kZU9iaiB9IC0gJHsgYW5zd2VyRGV0YWlsc09iaiB9YCA9PSBfdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0pXTsKICAgIAogICAgaWYgKGVycm9ycy5zaXplKSB7CiAgICAgICAgbGV0IGVycm9yTWVzc2FnZSA9ICIiOwogICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBlcnJvcnMpIHsKICAgICAgICAgICAgaWYgKGVycm9yTWVzc2FnZSAmJiBlcnJvck1lc3NhZ2UubGVuZ3RoKSBlcnJvck1lc3NhZ2UgKz0gYCwgJHtpdGVtfWA7CiAgICAgICAgICAgIGVsc2UgZXJyb3JNZXNzYWdlID0gaXRlbTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGVycm9yTWVzc2FnZTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIF9yZXN1bHQ7CiAgICB9Cn0=",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["6A. Remove Fields"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "Upload to Blob Storage",
          "type": "datasource.write.azure.blob_token",
          "params": {
            "baseUri": "https://ciamprblobdataplatform.blob.core.windows.net",
            "accessToken": "********",
            "container": "{{AZURE_CONTAINER_IMPORT_ERROR}}"
          }
        }
      ],
      "version": 1,
      "createTime": "2024-10-15T09:59:15.822Z",
      "updateTime": "2024-10-15T09:59:15.822Z",
      "updatedByEmail": "l.marques@sap.com"
    },
    {
      "apiKey": "4_6Tv6z8O6NmUO_BZoHcXIRw",
      "siteId": 435061734600,
      "id": "288fa6ee2d644115aa039ec89e92406a",
      "name": "[LITE ACCOUNTS] - Import from DQV (BLOB STORAGE)",
      "status": "published",
      "description": "[LITE ACCOUNTS] - Import from DQV (BLOB STORAGE)",
      "steps": [
        {
          "id": "2. Decrypt PGP",
          "type": "file.decrypt.pgp",
          "params": {
            "pgpKey.importedPrivateKey": "LS0tLS1CRUdJTiBQR1AgUFJJVkFURSBLRVkgQkxPQ0stLS0tLQoKbFFjWUJGMEhuYkVCRUFDeVh1K3pCc2p2L3lJaTZBWEhQZy9PNW9lZ0RlQ000TGgzMWNsTDFYYytCdHVhUG9QdApLVURyS0F1YUdUOHJ4MzRpc3hMWHZib0k1RUVPejU3eVRFcVg4TExxWnZWOFNWRWVLVXcxNVlYSlZKRVQ4RVlyClU1dE5lbytGaWo3dXpRMFh1d2tCUzhqcTBERnBUVHl5dXN2a3h0bWVjZ0FvOWtxZUNCZjhBd1dBMEl6YkZqbU8KUm1QWEkwY2JjMllqZVV2dVlJMjl1TmtoTG1DOVRVQ3FPYzBZU2gyQ1lWemt4QWYxeXRlTmdQbUJFZ0UwVjZhYgppQzBYZUhEQUkzdGd2cVdnNDZPK1hTQ012U3JVZ3V1d2l0aW5rTm1weUlrWnZxb1hPZFJrQTdIQnJnNVVUalRDCjhTOS95RzJRd2pzb0VLUUZsYVhzNjc2SXUwcGkzNitZdER1bmJzSE5WZm5xK2kreWRxRHJpT0Q2YUZqVzRBVWEKdjUzcDlSUEFxMnQ3QlZzdEpJYnh1dk1kUXAySThKdDFtdjVxU3hyQTlWU3lPQTFxTHFJeDR3eE9LdEZYV2VyYQpxZlZEWld0bUtDZEMrT0RKZ251RzB3U0ZEMkRWNlhzd2EzZHVyeEpOUWhGaXNiaU1ySU42YXNHc0lOVlJvWDZhCndYUThFNitnMk43Sm4rQnh6ZDQ5ZWdodWd5NnR0eCszY20wSUNpWFU1SUU2cmVXZzU1RVNnMXc0OEtwdUplbTMKNk1oVFBFMHJLMmNHNnpuRWVFdEdHRU84cXFwbUQ1Y25lM1cyUXRoSS93blU0eGoraUlyWldDUmwrWGZHZXNsWAo2ZDQ1TEk2QStwaUxkZGlXVElhWUs0NTh1a1Zxa3k0UVJuUmVaak92c2w2NG1ZRnQxT2J5aUloZXN3QVJBUUFCCkFBLzhDMnpYcDF6UlpSeXZWK2kxdjEvaklsVVRnelhiQXNXOWV5RGgvbTREYjh2VS9YOGJTSWNpY0kyYTcwN0cKV1pjSWUzb3Q3dmRvOXZzcjRhSW5PUXp0b0QyR01FdlNWZTR2b3lJYnVXaTZGajNJOXl2UTlYaUFVNTVSOEIzOQpUdmdxYWx2aGIvTDdRUjNVZEdnWDhialRxT2xGeWpJeUtXMkdpbDNVQk12cXY5S3hSYktaa3RxV1l1ZzdFZS9sCkx4NHN0aGhRSysxWnJHMlhPN2psaktIRzJIM3kxWnJ5bU0xU1Z6VHhjL3BsYTVZMjBUUDdhTmlpK1c4T1d5TDEKV3YvZ2hicmZEbFA5RlphNUFNTmhZUk1HWFV3Q3dvUjZVbFdyVG5FMnExdFlqazB5LzIvQ1RiNzdmeEN4clVVMgpXeWdmRENQY1FoM2k1cDR4M2IzSE5uTDJUblZKOVpML2dhRXJRNUhGWDA5a2JPUzRSTWVQbzY3K1JLckowZ2F6CmZoYjdsNUlIdHdpajg1NVIxWWlyWGtQd0lxcEVIaXQ3Q2U1RWtRTEk4Nm42QnNJdHpnM3ZWKzcrTmFjS0RGRDQKK3BwTnhaYUYxdGFsWGo5N2NIS1hjOTNKNDhmc2NoYWNJekZVa2JLbjJZMGI0c2EvVWVMUHM4Y2drWkhuT3R3egppOEZ3M1o2RHVWSEdKbzdKdmJlMnFzdXdsQjFXZHprVUxEdzl5OUJvSjlTTTJhT1hsVWpQOFl6Um1ROVhkWXJQCmg0MGFuUURsN2lxT3RoNHVQSjgzZGI0ZHdPY1M1K0FGNTZlcitwZ3hpeE14ZzI1V1lEbWxMQXlHV2JqMDBXcGYKTndibDlwU3BRdmxvQnUwd1MrVlgwKzFqZEVlMVZ4SFF4bFNZenNReHJKTU9Xd1VJQU1pcEpqUjQxVXA1LzNGawpxc0hOS29BSndzakQ0TFpLeTRrWVJCUElHMXhDL3VtdlFFK3luL0VxczdvYm9raVU5aDBoWUJ5OXF5c2trK2pICldhZ0NTQjAyU0pNK25mSVcxazhVWTRnSHJBd3hJSC9BY1dtSUlLZmZYb1VzMENYMGhsdEUyTGxaS2pWd0hEdkoKbTJSbG8yeU5McHVtSkd0TCtGU3QveTVRTEY3VlNYck1HaDA1YVE1OGZORDFhcG5yKy9tekE1bkdIMFNUeEU5agorellpM3Axak91UkVUZmE1cWl6anJhNGZGVWlJeWFRdThpakRaUGNUUVBYTTBaK1pBMTJFUlFNbFBzK1ZZWlFECndkMXl2RUFmK0JsMG1KNFBzb2VKdHF3TElvZHFhV1lUS0VzeG5lbU43TTdMaDJzdWRsQ1c4MFh0a2owc3NZNmIKWXNmdUd0MElBT09RR1Jvai9zbFJ2ZzV2ODhUNElOMWtvRXI3OUZnWk1kb1VURS9vN2FjWjlMN0E1c25qdWp3UgpBM2dLNXpHelBPeVAxdW80ellEdWMycStBSjNQcXdoTDFleXNCWWNWVFg0Y3F1M3c3Qkk5VW5UbG9ObytHb3FyCi9JN3VCaThGNys1a2w3K3ovb3JwelAxc1RCdHNVRUs1V0YyVFdobnN2aGR4OVRWSDNZLzFuY3Y5dFdEWWVWR1gKZ0FTcUI3L2xCWkI5UmNkTDl4Y3haUU5ZeitoVFQyeEIvbDZXNDBSZHc0cUJ2UVNoV3NpcUFESEdsS1o3QysrSgpSZUhreU5iWFljUndhQnA2eExiS1NZeWM3WW5YMU03YUFMc3licGVpMkxDWHowNWNpWm9FNkl6UWRhamVEZlByCjNHK2Z3WXhUbU9yZ0pabmYwUUx1TUhWNFJFSzUzczhJQUs5cGNOQ09EODZxZGtrRmlGaWEwZ2tSZjRTTjBGK3IKZzJFT3F4UkJ5VlRoRzdUVTRVcEgrN0oySFlyV1ErVjg5b05oZjlIcTNKMXlEN1Z4Q2Q5UGRlVTBVTEJ3YTFEVQoyVGdHZ3kzVEgvcFQ5Zjl3MUpOd2lQZjZOODNUQTFGUG03R1hBVlhaMXRsYTZiMGE5T1NWSXQ0cVpMRXRIZnNpCllJN1pWSVFpL0ZiVXF2WnRBSzB6VnRZaFdUVDdPalVzQ2owbWNNNmJBRHhlZ1ZSRTNyTjJ0VGJxemRiR1U0ZTYKVmU2UDdWMmlUbUtkSWNBZVAzVFBZQzMyNEdCck1zUC8rdWZReWQ4RkY3U1paWlUrKzI0TUJRMlUwejBpdUxVbgo5WGRKZGR0dVVwUFZoeUdLc29XaVB3cTltK0ovMFRoaUxTOUJKdkJoa3M4K0ZTMVdIRjBtSU9hVW1MUWRRMGxCClRTQkpiWEJ2Y25RZ1BHTnBZVzFBYm1WemRHeGxMbU52YlQ2SkFrNEVFd0VJQURnV0lRUW51MlMzdjZxSGY1SVYKd0JzcTBjTnF4TU84NmdVQ1hRZWRzUUliQXdVTENRZ0hBZ1lWQ2drSUN3SUVGZ0lEQVFJZUFRSVhnQUFLQ1JBcQowY05xeE1PODZ0UGdELzBiVFZxeGk2ZnFVVmpoMGp6QlVvVUFRRWtHTGlQU1RVYnpxTjZtbGJZb3UrTXFJT1NTCkZiOTNnQ2luMVBHbitUdkNNOHJ5WW9JZkNVc0Qzckh0d1ZvRG5PbzMvaFBnWHhpcEJRTkdxMHovK2lsZ2hVdUwKWHovRlNhVkQ3RlJOSnYzbzdFUGk5K1oycUFFMGEvaFpDZXhBQlZtRnZGeml6dlRzYlh3dlZkbHFiUVR3K0gxQQpGbnFmZ2FjbnQ4SHFVVTBqYzF4cHh5U2dISVJBYWh1ZXVFaFhnZVhMeE1OcjZ1aHZqTXVydE80QTdJRDAxdGZPCnJKR1NPbXdEVndaNitVWVYrWE5CeFUyZWxWaXdhbXR1RWlWdXJwYzVYM3BJZ1ZlOEF3b3l4SmlIRkI4S3dpZkoKU1I3YlJ0VG16RzlFenN3NkcvSTdrZDBWVDJiZC9GcE1hU2l1Ulk5SllsOGNkcW9tYVNoKzNWWE9Ibnl1cjNXQQpUS2hYZjZjQ1dhUFpyNmJ0R3RPZXFIdFYwcXVMSnBYNDBjRi9GOU9MS0RFeU5mNWl4UGx1WW13d3dBaXBRVXBSCi96SGNFalUrU0xzVHRhcmhuTnRDUWk3MkVNUFIxVkxFdHVjdU1iT2VvNUx1dGhKM1VWM2FsTndKeWNEYVFmUG8KZUJCbGFneFhkcFZEVmw2TWkyQ1RSNTF0aitzOWs2NEROR0k0NU9KRHVPbElMUDFYYTRNTE5OMmhPKzlKZk1JYQp5aVpoUmx5R3BDR3pvOFFwdzU5NHB4MXJ4ZVEvYmN0WTduWU1KbkRKQ3pEV2E4aWRkSnJTMS9VSmlGVTFjeGtBCms0LzhtZXBSYUQ4bXhMV3UrNEFyMzFNOUJWOFNjNk5nU2ROcWhyQnpMSkxDTzVZMjNFVXpSOVVNMDUwSEdBUmQKQjUyeEFSQUF6bFJLc2ZqZVlUQzhvblNzRGV1ODNNU0JEWTJldXdUcS9EYSt0clFFbkEraWFpNHRLSXNhRHQ3aQp1SGtlMnFLR2VaOUN3eG9VZVJKZ1JRN1hwWEhoeGhpbTJsSytLZUNzZVJtdnY5R01wZThob054OXRkako2TWxTCmtvRVhxZHZ1d0dUcGNGZjFtWjJPVzVYK3daNUpuaU05UGVJYlVPVGp5NUxGRUg2bmhTYzRPV1lVL2tSdlRUQmUKZkRLc0lMa3Jucm5nSkVRTExIcjhQeUtISlRQYWJ0aXg4TUNIK0tpWloyOUNzL3JUd2U0ODhEaHBBZVRSbWgwTQp2Ni9MOHZSNHZHeXQ1R1R0ZmdHSzUzTDRCaDluVWZ5UkdGa25OMllqM3JlcGRWVHJUdnJIdFdONzlwMCtlYUUzCmZVRm9uWlVqc1pXd1BwS3hKZytKOVN4NWNUZ2ZydCtDd1RDdi80bVRCcUE0bmdraTZrYjBqZWc2WHZNRzhpVS8KTnFCeXlxdTRxMnQzOHFlNTA3VUFvTVJtTm5tajN1ZWhGTEFEWXdQMmVOaXNQSFhZc1VCQm8yZExaQkZ0QnpHRAora2Vub1Z2UE5CQ2V0Y21tbXNpSlRMT3dBNzFNU2ZOMlpVTVYxbEZtOUM2Y1V5aE1BODNYdWhhdENnQzdLcnpiCllHaUxGdS9WOGowQlFveWJjM0FhVVc2UUkvWlNNRUx1LzJGTndPRHRGbU5CVzdJUVpXb3NsdEsrcXU2L3I0TmYKZldmelZzaVYyMHZ6YURJSCszaXUyUDI2dmRPbFFJMUthRDVocjNWZG1vTU5lU3FGb2hiOVRqSC82RkFDcElPNgpHS1JrVktLNWpscWY5R3VkTTRZckZBVGVMUWY0Mzh0dUszMVhjS3d3Y2R3NWJEQXpyZFVBRVFFQUFRQVArUUVnCkhaNXJqcFZJb21oUXJaR0EzdTdXejN2d1RwdjYrQmsrU1paek1kQStDT1crVmRwZ3lBVFJab2wybzlNQXEvelgKV0xtaGNwMVZUQjJpZUtZb3ZydGttbUNMcndraHRqMUk4WE1JVDh1NXIzTXRiYVF4RkdaQXd3ZVA1WUx2bGRDUApSUGhTZHg3YnQyZU4xVVFWaHd2WmtTcU1NTDlnZ0kzNlVDODNMUWZLQ21HYko4NjhqN1lEMDR3ZEUzM3dSN1pFCkViY3NubUdGM2RTUXQyWlpFY1dnSVdTQVJ0QU9lV0NDaW5PVnJuL25OZktkYTlsZHFTMlJXcnAzb3hNUUs3NEsKbXk1TG5jdDdRZDFyMVM0V1N2VWVncFl0MFQwS2ZKRzN6UVM4ZFk2cWpyZTlqa2JDWXU3ZnBJQS9PK0R5eVZTZApQeCttdHljQXRSNTFDRWdxaDYrejV5WCt0dlJub1F5V2tBN0k1ZExEaHN0RW5McFozUW1Ec3V5WjVwZDRDS1BOClVacGU1di8wRDQ2dW1iQUliM1I1bEt2b1V2K1UwYVVXZDJJcDVEdER1VTd0OWk3L090a09RS2RKU25xSlJMOFkKd0VIWFdvcU1UVHA3U1dBMHo2Q29HSm43cDhHQ1RNUDdsQlUwWjdHUkFuaUljVVc5YnN4MkcvQUc4S29QVWF6eQpPUjVkVzFiUVpNY003S2xWRVVyZkowYzFCWGFGOVhkellFWW12QnFaYzUyR0Jrd0g1bFRKYkt2dWtLazF0MmVBClluWmJ3Rm9CeFQ1UVlSS3NTOFVsSWhFYnFkd1JicURwSk1oTzZwVEFFNFpLWEozUzR6cUJSN3NJN09KT0VNUC8KVGxiblZXeFN2cWVvdDdVYmpVQUFSSjgwcXA3b3dUT010cVdqcmxOcENBRGRnM2ExODVZejZMcGxYeWxlUG1KMApLWEEzQUtEcGtmV3hXcGpBRzhFaEtKYzcvNWdvZGtXZFdsUkR4eVpETEVEMGU2VG92MlN3bEdHeHlqUURjQXNNCkdxZ3hDd09QcWhsRjhLcjhxTkc5OEFNMllVd1ppVE5xalVRMEdZaHpXU1MzOGloSGtnYkpvcXc1cU1URnlmVXgKSG9pUkl2V25BandFRFVqL1RtRUdCRXI0YmtFUDZtWFFEZlR4d3BISnh2cUdFNVRGc2c3d1NibGpiSFBRRVRDNQpzbVl0QnF2Z1l5THMvT1p0N29iSDI4YzdLd1QwK0tjY21UVnl6bWF4b3RqRkNsMzFOMDRXTWdEdmhPV3JzTFd0ClBJQy9kNkhZVllENVUxeWllM1NnSjQyd2NtaXpldUlkTTJwREF5Zk0zVzI2K2xZZ3ZZeE11cGFnU2dTYjBmNVoKQ0FEdWM2YThwOEJNR1hHMGNjaEQ4UXNlZTJOT1VpaDdJQVV4b0hQcWE1OXNpNmJlWWRiSUp6aFZxMDJXYnJaVgpmVkJWeUp4Y0xTR2ttUFJUbDZSbjcxSHBpbTBkdlZzdkpZazRKYXlDNWJTTE02Tm9Ccyt5Z3o4RXkyVkxXQm4wCmlKQVFVck5EQXRpWDZyL1RoYW1wUlRpSjhKZnlxc1E3WHFPZll0MWVhZEFGdnBHZlpJdmxOYkJnV0I0UlY5R3cKbDhJTnlDUENSK3NKc2laZXRWenZXZ0tzS2h5K1hGV1E1NTVuWHdQOC91MlAxQXdKVVNGMndBcGpRbUNZQkxGRAo3Wi8va2dQWFREUG96T2lxRTdRZG5WK2ZxalBQY215eHlGRjJiZFhUNDFiWEErNW9UU2NsTklJUm1qV01LTW92CmZWTGZXZktuYUtITE9mcmNEZVBlRHBQZENBREFJSC8ra2tjUklnd2lhYmZXSGRKK1NhQ3ZHUG5ONkJNNHczODAKQVcxOEp2MGo3b2V6Y0ZSWjZSejQzYzZYVzh0Q2ZVT2cyb2ZCU1EyeDZEd3BSb3VlZkJ4TVQ2a2lPRlFjb3duZQpXVVRLbkJUR092Um1wRElhbkhocWZGODNhenQ5djF5TlRZc2dnNVFSNnlqWm13ZGZxVnJmWnNOMU04bzRqUHFBCnI2U1Azb05SZlM5RElzUjVubXVhYy9HSE80QnRaRkszeHpzUTFVL05md2hoSlFubTZvVE9rUEVQeWN6S2dZK1QKWTVrU0Nrb3RhQUhxZi8xMklSYVNieEdzeFBZNVpsc0tEazBkWEx1bWVtTFN0YlE3Y2pucThJbTdUZHJvdy9FNgo5dm9HOWJFeFZwTEIxSk9DeXdiZ2RobldEOFhlWGNma0lWczNGUUtvSDcwNUNDYjZkak9KQWpZRUdBRUlBQ0FXCklRUW51MlMzdjZxSGY1SVZ3QnNxMGNOcXhNTzg2Z1VDWFFlZHNRSWJEQUFLQ1JBcTBjTnF4TU84NmlNMUVBQ0wKV093Q1JyTFRuR2U2WTNpZ0hBdU9HelpPVW5NSGFNc1o5aFgvZlE5MjlYTFdTeGNhZDVsVE9SVkErS05wOTViQQpVRGpUZlZGZWE2aUoremYyZ1dqTTJ2SzlmbmJKbFRHUWRIVk42Ynd5am9GR0ZjWnZLTmJvVmJhdTZWRDFRTGlVCld5WWF5eVUvR1NCaFkyRTJBbEFUWFFoZkYxT1JYYWx4L0F2ZzZYNS85bk5oVjdObjF0bU0rdXFFdDJvdlJrRmgKWTBFMi9XWS9icFIrYlozckdtbHVvZVZtWE43Z0ZUZEduY08rS0d4SnFUQUJzV3M5UlJ0RzY2dTYydTM1bWpYcgpqY1JGZG4zTE5VRjlaZFRwRVRvQlEvOTBoLzFxOVRBTUdJRmdXdzNOREtoN1A5S2JEdmpzR01BeUw1RkZmYmVuCjZKaGV5K2F2YlFSZU4vREprUmRlbDRibGRadjhURndpVnZUc2NubjI1M0xMems3eEs1VmFLVXd0Umw0UC9QeEIKMWVuVVkvUnZ2K0JXVXNGdlJMUWpJVittdm9nVS9JdzJJYW8xT09PNWlaWUNqemt3THJ5Z0NpQUZvRWFsdC9veQowdExmZnZXcmVJWUtjdzVHSGJNeVQ5M2dva1RLY1B6cWlOM0hpQVM4YUNqNGZuZURHc2p3blBXL0lETEpMVGZ6CnZqZE9GTnFXczZ0aGYxRzZwQnZZaTVBUmZOb2N0SHROb3NtZTBLNDJZSXpVdWM5SDdYR2dtTVlmd2p6QU8vTDgKb29QclRaYU90bnNnMndhRHo2dkE3S1dnMkRhYXU1STI5VzUrTWdRdm5kRzBEekg3SmlJeW1NTXI5dnhXQmQyNwpQZjYraU4yUkF6SkVyZHdOcEdGWWVzb0doYmMxTmowS2U1S1FqV0toQVE9PQo9ZmtPRAotLS0tLUVORCBQR1AgUFJJVkFURSBLRVkgQkxPQ0stLS0tLQ==",
            "pgpKey": "LS0tLS1CRUdJTiBQR1AgUFVCTElDIEtFWSBCTE9DSy0tLS0tCgptUUlOQkYwSG5iRUJFQUN5WHUrekJzanYveUlpNkFYSFBnL081b2VnRGVDTTRMaDMxY2xMMVhjK0J0dWFQb1B0CktVRHJLQXVhR1Q4cngzNGlzeExYdmJvSTVFRU96NTd5VEVxWDhMTHFadlY4U1ZFZUtVdzE1WVhKVkpFVDhFWXIKVTV0TmVvK0Zpajd1elEwWHV3a0JTOGpxMERGcFRUeXl1c3ZreHRtZWNnQW85a3FlQ0JmOEF3V0EwSXpiRmptTwpSbVBYSTBjYmMyWWplVXZ1WUkyOXVOa2hMbUM5VFVDcU9jMFlTaDJDWVZ6a3hBZjF5dGVOZ1BtQkVnRTBWNmFiCmlDMFhlSERBSTN0Z3ZxV2c0Nk8rWFNDTXZTclVndXV3aXRpbmtObXB5SWtadnFvWE9kUmtBN0hCcmc1VVRqVEMKOFM5L3lHMlF3anNvRUtRRmxhWHM2NzZJdTBwaTM2K1l0RHVuYnNITlZmbnEraSt5ZHFEcmlPRDZhRmpXNEFVYQp2NTNwOVJQQXEydDdCVnN0SklieHV2TWRRcDJJOEp0MW12NXFTeHJBOVZTeU9BMXFMcUl4NHd4T0t0RlhXZXJhCnFmVkRaV3RtS0NkQytPREpnbnVHMHdTRkQyRFY2WHN3YTNkdXJ4Sk5RaEZpc2JpTXJJTjZhc0dzSU5WUm9YNmEKd1hROEU2K2cyTjdKbitCeHpkNDllZ2h1Z3k2dHR4KzNjbTBJQ2lYVTVJRTZyZVdnNTVFU2cxdzQ4S3B1SmVtMwo2TWhUUEUwcksyY0c2em5FZUV0R0dFTzhxcXBtRDVjbmUzVzJRdGhJL3duVTR4aitpSXJaV0NSbCtYZkdlc2xYCjZkNDVMSTZBK3BpTGRkaVdUSWFZSzQ1OHVrVnFreTRRUm5SZVpqT3ZzbDY0bVlGdDFPYnlpSWhlc3dBUkFRQUIKdEIxRFNVRk5JRWx0Y0c5eWRDQThZMmxoYlVCdVpYTjBiR1V1WTI5dFBva0NUZ1FUQVFnQU9CWWhCQ2U3WkxlLwpxb2Qva2hYQUd5clJ3MnJFdzd6cUJRSmRCNTJ4QWhzREJRc0pDQWNDQmhVS0NRZ0xBZ1FXQWdNQkFoNEJBaGVBCkFBb0pFQ3JSdzJyRXc3enEwK0FQL1J0TldyR0xwK3BSV09IU1BNRlNoUUJBU1FZdUk5Sk5Sdk9vM3FhVnRpaTcKNHlvZzVKSVZ2M2VBS0tmVThhZjVPOEl6eXZKaWdoOEpTd1Blc2UzQldnT2M2amYrRStCZkdLa0ZBMGFyVFAvNgpLV0NGUzR0ZlA4VkpwVVBzVkUwbS9lanNRK0wzNW5hb0FUUnIrRmtKN0VBRldZVzhYT0xPOU94dGZDOVYyV3B0CkJQRDRmVUFXZXArQnB5ZTN3ZXBSVFNOelhHbkhKS0FjaEVCcUc1NjRTRmVCNWN2RXcydnE2RytNeTZ1MDdnRHMKZ1BUVzE4NnNrWkk2YkFOWEJucjVSaFg1YzBIRlRaNlZXTEJxYTI0U0pXNnVsemxmZWtpQlY3d0RDakxFbUljVQpId3JDSjhsSkh0dEcxT2JNYjBUT3pEb2I4anVSM1JWUFp0MzhXa3hwS0s1RmowbGlYeHgycWlacEtIN2RWYzRlCmZLNnZkWUJNcUZkL3B3SlpvOW12cHUwYTA1Nm9lMVhTcTRzbWxmalJ3WDhYMDRzb01USTEvbUxFK1c1aWJEREEKQ0tsQlNsSC9NZHdTTlQ1SXV4TzFxdUdjMjBKQ0x2WVF3OUhWVXNTMjV5NHhzNTZqa3U2MkVuZFJYZHFVM0FuSgp3TnBCOCtoNEVHVnFERmQybFVOV1hveUxZSk5IblcyUDZ6MlRyZ00wWWpqazRrTzQ2VWdzL1Zkcmd3czAzYUU3CjcwbDh3aHJLSm1GR1hJYWtJYk9qeENuRG4zaW5IV3ZGNUQ5dHkxanVkZ3dtY01rTE1OWnJ5SjEwbXRMWDlRbUkKVlRWekdRQ1RqL3laNmxGb1B5YkV0YTc3Z0N2ZlV6MEZYeEp6bzJCSjAycUdzSE1za3NJN2xqYmNSVE5IMVF6VAp1UUlOQkYwSG5iRUJFQURPVkVxeCtONWhNTHlpZEt3TjY3emN4SUVOalo2N0JPcjhOcjYydEFTY0Q2SnFMaTBvCml4b08zdUs0ZVI3YW9vWjVuMExER2hSNUVtQkZEdGVsY2VIR0dLYmFVcjRwNEt4NUdhKy8wWXlsN3lHZzNIMjEKMk1ub3lWS1NnUmVwMis3QVpPbHdWL1dablk1YmxmN0Jua21lSXowOTRodFE1T1BMa3NVUWZxZUZKemc1WmhUKwpSRzlOTUY1OE1xd2d1U3VldWVBa1JBc3NldncvSW9jbE05cHUyTEh3d0lmNHFKbG5iMEt6K3RQQjdqendPR2tCCjVOR2FIUXkvcjh2eTlIaThiSzNrWk8xK0FZcm5jdmdHSDJkUi9KRVlXU2MzWmlQZXQ2bDFWT3RPK3NlMVkzdjIKblQ1NW9UZDlRV2lkbFNPeGxiQStrckVtRDRuMUxIbHhPQit1MzRMQk1LLy9pWk1Hb0RpZUNTTHFSdlNONkRwZQo4d2J5SlQ4Mm9ITEtxN2lyYTNmeXA3blR0UUNneEdZMmVhUGU1NkVVc0FOakEvWjQyS3c4ZGRpeFFFR2paMHRrCkVXMEhNWVA2UjZlaFc4ODBFSjYxeWFhYXlJbE1zN0FEdlV4SjgzWmxReFhXVVdiMExweFRLRXdEemRlNkZxMEsKQUxzcXZOdGdhSXNXNzlYeVBRRkNqSnR6Y0JwUmJwQWo5bEl3UXU3L1lVM0E0TzBXWTBGYnNoQmxhaXlXMHI2cQo3cit2ZzE5OVovTld5SlhiUy9Ob01nZjdlSzdZL2JxOTA2VkFqVXBvUG1HdmRWMmFndzE1S29XaUZ2MU9NZi9vClVBS2tnN29ZcEdSVW9ybU9XcC8wYTUwemhpc1VCTjR0Qi9qZnkyNHJmVmR3ckRCeDNEbHNNRE90MVFBUkFRQUIKaVFJMkJCZ0JDQUFnRmlFRUo3dGt0NytxaDMrU0ZjQWJLdEhEYXNURHZPb0ZBbDBIbmJFQ0d3d0FDZ2tRS3RIRAphc1REdk9vak5SQUFpMWpzQWtheTA1eG51bU40b0J3TGpoczJUbEp6QjJqTEdmWVYvMzBQZHZWeTFrc1hHbmVaClV6a1ZRUGlqYWZlV3dGQTQwMzFSWG11b2lmczM5b0Zvek5yeXZYNTJ5WlV4a0hSMVRlbThNbzZCUmhYR2J5alcKNkZXMnJ1bFE5VUM0bEZzbUdzc2xQeGtnWVdOaE5nSlFFMTBJWHhkVGtWMnBjZndMNE9sK2YvWnpZVmV6WjliWgpqUHJxaExkcUwwWkJZV05CTnYxbVAyNlVmbTJkNnhwcGJxSGxabHplNEJVM1JwM0R2aWhzU2Frd0FiRnJQVVViClJ1dXJ1dHJ0K1pvMTY0M0VSWFo5eXpWQmZXWFU2UkU2QVVQL2RJZjlhdlV3REJpQllGc056UXlvZXovU213NzQKN0JqQU1pK1JSWDIzcCtpWVhzdm1yMjBFWGpmd3laRVhYcGVHNVhXYi9FeGNJbGIwN0hKNTl1ZHl5ODVPOFN1VgpXaWxNTFVaZUQvejhRZFhwMUdQMGI3L2dWbExCYjBTMEl5RmZwcjZJRlB5TU5pR3FOVGpqdVltV0FvODVNQzY4Cm9Bb2dCYUJHcGJmNk10TFMzMzcxcTNpR0NuTU9SaDJ6TWsvZDRLSkV5bkQ4Nm9qZHg0Z0V2R2dvK0g1M2d4ckkKOEp6MXZ5QXl5UzAzODc0M1RoVGFsck9yWVg5UnVxUWIySXVRRVh6YUhMUjdUYUxKbnRDdU5tQ00xTG5QUisxeApvSmpHSDhJOHdEdnkvS0tENjAyV2pyWjdJTnNHZzgrcndPeWxvTmcybXJ1U052VnVmaklFTDUzUnRBOHgreVlpCk1wakRLL2I4VmdYZHV6Myt2b2pka1FNeVJLM2NEYVJoV0hyS0JvVzNOVFk5Q251U2tJMWlvUUU9Cj1pMDlqCi0tLS0tRU5EIFBHUCBQVUJMSUMgS0VZIEJMT0NLLS0tLS0="
          },
          "next": ["3. Parse JSON"]
        },
        {
          "id": "3. Parse JSON",
          "type": "file.parse.json",
          "params": {
            "addFilename": false
          },
          "next": ["3. Rename Fields To Merge"]
        },
        {
          "id": "8. Evaluate Subscriptions & Preferences",
          "type": "field.evaluate",
          "params": {
            "fields": [
              {
                "expression": "subscriptions eq null || subscriptions eq ''? '{}' : subscriptions",
                "field": "subscriptions"
              }
            ],
            "language": "jexl"
          },
          "next": ["9. Import lite account"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "9. Import lite account",
          "type": "datasource.write.gigya.generic",
          "params": {
            "apiMethod": "accounts.importLiteAccount",
            "maxConnections": 20,
            "addResponse": true,
            "apiParams": [
              {
                "sourceField": "email",
                "paramName": "email",
                "value": ""
              },
              {
                "sourceField": "data",
                "paramName": "data",
                "value": ""
              },
              {
                "sourceField": "profile",
                "paramName": "profile",
                "value": ""
              },
              {
                "sourceField": "subscriptions",
                "paramName": "subscriptions",
                "value": ""
              }
            ]
          },
          "next": ["10A. Check if Preferences exists"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "4A. Existing Accounts",
          "type": "datasource.lookup.gigya.account",
          "params": {
            "select": "profile.email,data.areaOfInterest,data.pet,data.child,data.externalApplication,lastUpdated,data.initialAppSourceCode,UID",
            "handleFieldConflicts": "take_lookup",
            "mismatchBehavior": "remove",
            "lookupFields": [
              {
                "sourceField": "profile.email",
                "gigyaField": "profile.email"
              }
            ],
            "lookupFieldsOperator": "OR",
            "matchBehavior": "process",
            "isCaseSensitive": false,
            "from": "emailAccounts",
            "batchSize": 200,
            "maxConcurrency": 1,
            "multiMatchBehavior": "error"
          },
          "next": ["5A. Perform Merge Logic", "Prepare existent accounts to extract"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "4B. New Accounts",
          "type": "datasource.lookup.gigya.account",
          "params": {
            "select": "profile.email",
            "handleFieldConflicts": "take_lookup",
            "mismatchBehavior": "process",
            "lookupFields": [
              {
                "sourceField": "profile.email",
                "gigyaField": "profile.email"
              }
            ],
            "lookupFieldsOperator": "OR",
            "matchBehavior": "remove",
            "isCaseSensitive": false,
            "from": "emailAccounts",
            "batchSize": 200,
            "maxConcurrency": 1,
            "multiMatchBehavior": "error"
          },
          "next": ["5B. Rename Fields"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "3. Rename Fields To Merge",
          "type": "field.rename",
          "params": {
            "fields": [
              {
                "sourceField": "data.areaOfInterest",
                "targetField": "data._areaOfInterest"
              },
              {
                "sourceField": "data.pet",
                "targetField": "data._pet"
              },
              {
                "sourceField": "data.child",
                "targetField": "data._child"
              },
              {
                "sourceField": "data.externalApplication",
                "targetField": "data._externalApplication"
              },
              {
                "sourceField": "lastUpdated",
                "targetField": "_lastUpdated"
              },
              {
                "sourceField": "data.initialAppSourceCode",
                "targetField": "data._initialAppSourceCode"
              },
              {
                "sourceField": "subscriptions",
                "targetField": "_subscriptions"
              }
            ]
          },
          "next": ["4A. Existing Accounts", "4B. New Accounts"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "5A. Perform Merge Logic",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgewogICAgY29uc3QgY2hlY2tMYXN0VXBkYXRlZCA9IGZhbHNlOwogICAgY29uc3QgbWVyZ2VDaGlsZCA9IHRydWU7CiAgICBjb25zdCBtZXJnZVBldCA9IHRydWU7CiAgICBjb25zdCBtZXJnZUV4dGVybmFsQXBwbGljYXRpb24gPSB0cnVlOwoKICAgIGlmIChjaGVja0xhc3RVcGRhdGVkICYmIHJlY29yZC5sYXN0VXBkYXRlZCA+IHJlY29yZC5fbGFzdFVwZGF0ZWQpIHJldHVybjsKCiAgICAvLyBXZSB1cGRhdGUgaW5pdGlhbEFwcFNvdXJjZUNvZGUgb25seSBpZiBpdCBkb2Vzbid0IGV4aXN0IGluIHRoZSBzeXN0ZW0KICAgIGlmIChyZWNvcmQuZGF0YSAmJiByZWNvcmQuZGF0YS5faW5pdGlhbEFwcFNvdXJjZUNvZGUgJiYgIXJlY29yZC5kYXRhLmluaXRpYWxBcHBTb3VyY2VDb2RlKSByZWNvcmQuZGF0YS5pbml0aWFsQXBwU291cmNlQ29kZSA9IHJlY29yZC5kYXRhLl9pbml0aWFsQXBwU291cmNlQ29kZTsKCiAgICBjb25zdCBzdHJhdGVneUNob29zZW4gPSAie3tNRVJHRV9TVFJBVEVHWX19IjsKCiAgICAvLyBBcHBseSBtZXJnZSBsb2dpY3MKICAgIGlmIChtZXJnZUNoaWxkKSBjYWxsTWVyZ2VMb2dpYyhyZWNvcmQsICJjaGlsZCIsIHN0cmF0ZWd5Q2hvb3Nlbik7CiAgICBpZiAobWVyZ2VQZXQpIGNhbGxNZXJnZUxvZ2ljKHJlY29yZCwgInBldCIsIHN0cmF0ZWd5Q2hvb3Nlbik7CiAgICBpZiAobWVyZ2VFeHRlcm5hbEFwcGxpY2F0aW9uKSBjYWxsTWVyZ2VMb2dpYyhyZWNvcmQsICJleHRlcm5hbEFwcGxpY2F0aW9uIiwgc3RyYXRlZ3lDaG9vc2VuKTsKICAgIAogICAgaWYgKHJlY29yZC5fZXJyb3JEZXRhaWxzICYmIHJlY29yZC5fZXJyb3JEZXRhaWxzLmxlbmd0aCkgewogICAgICAgIGVycm9yLmFjY2VwdChyZWNvcmQsIHJlY29yZCk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIFByZWZlcmVuY2VzIGxvZ2ljCiAgICAgICAgaWYgKHJlY29yZC5wcmVmZXJlbmNlcykKICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gcmVjb3JkLnByZWZlcmVuY2VzKSB7CiAgICAgICAgICAgICAgICBpZiAoa2V5ICE9ICJ0ZXJtcyIgJiYga2V5ICE9ICJwcml2YWN5IikgcmVjb3JkLnByZWZlcmVuY2VzW2tleV0uY3VzdG9tRGF0YSA9IG51bGw7CiAgICAgICAgICAgICAgICBlbHNlIGZvciAoY29uc3QgcHJlZkluZGV4IGluIHJlY29yZC5wcmVmZXJlbmNlc1trZXldKSByZWNvcmQucHJlZmVyZW5jZXNba2V5XVtwcmVmSW5kZXhdLmN1c3RvbURhdGEgPSBudWxsOwogICAgICAgICAgICB9CiAgICAKICAgICAgICAvLyBTdWJzY3JpcHRpb24gbG9naWMKICAgICAgICByZWNvcmQuc3Vic2NyaXB0aW9ucyA9IHt9OwogICAgICAgIGlmIChyZWNvcmQuX3N1YnNjcmlwdGlvbnMpIHsKICAgICAgICAgICAgZm9yICh2YXIgc3ViS2V5IGluIHJlY29yZC5fc3Vic2NyaXB0aW9ucykgewogICAgICAgICAgICAgICAgaWYgKHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCJ0cnVlIiA9PSAie3tET1VCTEVfT1BUX0lOfX0iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbiAmJiByZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5zdGF0dXMgJiYgcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uc3RhdHVzID09PSAiQ29uZmlybWVkIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkID0gcHJvY2Vzc1N1YnNjcmlwdGlvbnMocmVjb3JkLCBzdWJLZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbiB8fCAocmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uc3RhdHVzICYmIHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLnN0YXR1cyA9PT0gIkNvbmZpcm1lZCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmQgPSBwcm9jZXNzU3Vic2NyaXB0aW9ucyhyZWNvcmQsIHN1YktleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIHJldHVybiByZWNvcmQ7ICAgICAgICAKICAgIH0KfQoKZnVuY3Rpb24gcHJvY2Vzc1N1YnNjcmlwdGlvbnMocmVjb3JkLCBzdWJLZXkpIHsKICAgIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0gPSByZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XTsKCiAgICBpZiAocmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbikgewogICAgICAgIGxldCBvYmplY3QgPSB7fTsKICAgICAgICBsZXQgZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCA9IHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZDsKICAgICAgICBjb25zdCBjb25kaXRpb25hbGx5UHJlc2VudCA9IGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgIT09IG51bGwgJiYgZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCAhPT0gdW5kZWZpbmVkOwogICAgICAgIGNvbnN0IGNvbmRpdGlvbmFsbHlJc0Jvb2wgPSB0eXBlb2YgZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCA9PT0gImJvb2xlYW4iOwoKICAgICAgICBpZiAoY29uZGl0aW9uYWxseVByZXNlbnQpIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPSBjb25kaXRpb25hbGx5SXNCb29sID8gZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCA6IGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPT0gInRydWUiOwogICAgICAgIGVsc2UgZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCA9IG51bGw7CgogICAgICAgIGlmIChkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkICE9PSBudWxsKSByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLmlzRXh0ZXJuYWxseVZlcmlmaWVkID0gZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZDsKCiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbikgaWYgKGtleSAhPT0gImRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQiKSBvYmplY3Rba2V5XSA9IHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW5ba2V5XTsKCiAgICAgICAgcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbiA9IG9iamVjdDsKICAgIH0KICAgIAogICAgLy9TVEFSVCAtIE1TQ05ELTM5MTcyIC0gQ2hhbmdlIG9uIGltcG9ydGluZyBzdWJzY3JpcHRpb25zIHRvIGV4aXN0aW5nIGFjY291bnRzCiAgICBpZiAocmVjb3JkPy5zdWJzY3JpcHRpb25zPy5bc3ViS2V5XT8uZW1haWw/Lmxhc3RVcGRhdGVkU3Vic2NyaXB0aW9uU3RhdGUgJiYKICAgIGlzRGF0ZUluRnV0dXJlKHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwubGFzdFVwZGF0ZWRTdWJzY3JpcHRpb25TdGF0ZSkpIHsKICAgICAgICBkZWxldGUgcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5sYXN0VXBkYXRlZFN1YnNjcmlwdGlvblN0YXRlOwogICAgfQogICAgLy9FTkQgLSBNU0NORC0zOTE3MiAtIENoYW5nZSBvbiBpbXBvcnRpbmcgc3Vic2NyaXB0aW9ucyB0byBleGlzdGluZyBhY2NvdW50cwoKICAgIHJldHVybiByZWNvcmQ7Cn0KCi8vU1RBUlQgLSBNU0NORC0zOTE3MiAtIENoYW5nZSBvbiBpbXBvcnRpbmcgc3Vic2NyaXB0aW9ucyB0byBleGlzdGluZyBhY2NvdW50cwpmdW5jdGlvbiBpc0RhdGVJbkZ1dHVyZShkYXRlU3RyaW5nKSB7CiAgLy8gUGFyc2UgdGhlIGdpdmVuIGRhdGUgc3RyaW5nIGludG8gYSBEYXRlIG9iamVjdAogIGNvbnN0IGdpdmVuRGF0ZSA9IG5ldyBEYXRlKGRhdGVTdHJpbmcpOwogIAogIC8vIEdldCB0aGUgY3VycmVudCBkYXRlIGFuZCB0aW1lCiAgY29uc3QgY3VycmVudERhdGUgPSBuZXcgRGF0ZSgpOwogIAogIC8vIENvbXBhcmUgdGhlIGdpdmVuIGRhdGUgd2l0aCB0aGUgY3VycmVudCBkYXRlCiAgcmV0dXJuIGdpdmVuRGF0ZSA+IGN1cnJlbnREYXRlOwp9Ci8vRU5EIC0gTVNDTkQtMzkxNzIgLSBDaGFuZ2Ugb24gaW1wb3J0aW5nIHN1YnNjcmlwdGlvbnMgdG8gZXhpc3RpbmcgYWNjb3VudHMKCgpmdW5jdGlvbiBnZW5lcmF0ZVVVSUQoKSB7CiAgICBsZXQgZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgY29uc3QgdXVpZCA9ICJ4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgiLnJlcGxhY2UoL1t4eV0vZywgZnVuY3Rpb24gKGMpIHsKICAgICAgICBjb25zdCByID0gKGQgKyBNYXRoLnJhbmRvbSgpICogMTYpICUgMTYgfCAwOwogICAgICAgIGQgPSBNYXRoLmZsb29yKGQgLyAxNik7CiAgICAgICAgcmV0dXJuIChjID09ICJ4IiA/IHIgOiAociAmIDB4MykgfCAweDgpLnRvU3RyaW5nKDE2KTsKICAgIH0pOwogICAgcmV0dXJuIHV1aWQ7Cn0KCmZ1bmN0aW9uIGNhbGxNZXJnZUxvZ2ljKHJlY29yZCwgcHJvcGVydHlOYW1lLCBzdHJhdGVneUNob29zZW4pIHsKICAgIGNvbnN0IF9wcm9wZXJ0eU5hbWUgPSAiXyIgKyBwcm9wZXJ0eU5hbWU7CiAgICBjb25zdCBvbmx5VW5kZXJTY29yZSA9IHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdICYmICFyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdOwogICAgY29uc3QgYm90aENhc2VzID0gcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXSAmJiByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXTsKICAgIGNvbnN0IG5vcm1hbExlbmdodCA9IHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gJiYgcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXS5sZW5ndGggPT09IDA7CiAgICBjb25zdCB1bmRlclNjb3JlTGVuZ2h0ID0gcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0gJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0ubGVuZ3RoICE9PSAwOwoKICAgIGlmICgob25seVVuZGVyU2NvcmUgJiYgdW5kZXJTY29yZUxlbmdodCkgfHwgKGJvdGhDYXNlcyAmJiBub3JtYWxMZW5naHQgJiYgdW5kZXJTY29yZUxlbmdodCkpIHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gPSByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXTsKICAgIGVsc2UgaWYgKGJvdGhDYXNlcyAmJiB1bmRlclNjb3JlTGVuZ2h0KSB7CiAgICAgICAgY29uc3QgbWVyZ2VSZXN1bHQgPSBwcm9jZXNzTWVyZ2UocmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXSwgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0sIHN0cmF0ZWd5Q2hvb3NlbiwgcHJvcGVydHlOYW1lKTsKICAgICAgICBpZiAodHlwZW9mIG1lcmdlUmVzdWx0ID09PSAnc3RyaW5nJykgcmVjb3JkLl9lcnJvckRldGFpbHMgPSBtZXJnZVJlc3VsdDsKICAgICAgICBlbHNlIHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gPSBtZXJnZVJlc3VsdDsKICAgIH0KfQoKZnVuY3Rpb24gY2hlY2tVVUlEKHV1aWQpIHsKICAgIGNvbnN0IHJlZ2V4ID0gL15bMC05YS1mXXs4fS1bMC05YS1mXXs0fS00WzAtOWEtZl17M30tWzg5YWJdWzAtOWEtZl17M30tWzAtOWEtZl17MTJ9JC9pOwogICAgcmV0dXJuIHJlZ2V4LnRlc3QodXVpZCk7Cn0KCmZ1bmN0aW9uIGdlbmVyYXRlVVVJRGFuZFVwZGF0ZURhdGUodHlwZSwgdGFyZ2V0LCBpKSB7CiAgICBpZiAodHlwZSA9PT0gImNoaWxkIiB8fCB0eXBlID09PSAicGV0IikgewogICAgICAgIGlmKCFjaGVja1VVSUQodGFyZ2V0W2ldLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyKSl7CiAgICAgICAgICAgIHRhcmdldFtpXS5hcHBsaWNhdGlvbkludGVybmFsSWRlbnRpZmllciA9IGdlbmVyYXRlVVVJRCgpOwogICAgICAgIH0KICAgIH0KfQoKZnVuY3Rpb24gcHJvY2Vzc01lcmdlKGV4aXN0aW5nUmVjb3JkQXJyYXksIG5ld1JlY29yZEFycmF5LCBzdHJhdGVneSwgdHlwZSkgewogICAgbGV0IHJlc3VsdCA9IFtdOwogICAgbGV0IGNoZWNrID0gZmFsc2U7CiAgICBpZiAoc3RyYXRlZ3kgPT09ICJmdWxsUmVwbGFjZSIpIHsKICAgICAgICByZXN1bHQgPSBuZXdSZWNvcmRBcnJheTsKICAgICAgICBmb3IgKGxldCB4IGluIHJlc3VsdCkgZ2VuZXJhdGVVVUlEYW5kVXBkYXRlRGF0ZSh0eXBlLCByZXN1bHQsIHgpOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShleGlzdGluZ1JlY29yZEFycmF5KSkgewogICAgICAgICAgICByZXN1bHQgPSBBcnJheS5mcm9tKGV4aXN0aW5nUmVjb3JkQXJyYXkpOwogICAgICAgICAgICBmb3IgKGNvbnN0IG0gaW4gbmV3UmVjb3JkQXJyYXkpIHsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgbiBpbiBleGlzdGluZ1JlY29yZEFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgICAgICAoKHR5cGUgPT09ICJjaGlsZCIgfHwgdHlwZSA9PT0gInBldCIpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdSZWNvcmRBcnJheVttXS5hcHBsaWNhdGlvbkludGVybmFsSWRlbnRpZmllciAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0W25dLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdSZWNvcmRBcnJheVttXS5hcHBsaWNhdGlvbkludGVybmFsSWRlbnRpZmllci50b0xvd2VyQ2FzZSgpID09PSByZXN1bHRbbl0uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIudG9Mb3dlckNhc2UoKSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHR5cGUgPT09ICJjaGlsZCIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1JlY29yZEFycmF5W21dLmJpcnRoRGF0ZSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0W25dLmJpcnRoRGF0ZSA9PT0gbmV3UmVjb3JkQXJyYXlbbV0uYmlydGhEYXRlICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdSZWNvcmRBcnJheVttXS5maXJzdE5hbWUgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtuXS5maXJzdE5hbWUgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtuXS5maXJzdE5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmV3UmVjb3JkQXJyYXlbbV0uZmlyc3ROYW1lLnRvTG93ZXJDYXNlKCkpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlID09PSAicGV0IiAmJiBuZXdSZWNvcmRBcnJheVttXS5uYW1lICYmIHJlc3VsdFtuXS5uYW1lICYmIHJlc3VsdFtuXS5uYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5ld1JlY29yZEFycmF5W21dLm5hbWUudG9Mb3dlckNhc2UoKSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHR5cGUgPT09ICJleHRlcm5hbEFwcGxpY2F0aW9uIiAmJiBuZXdSZWNvcmRBcnJheVttXS5hcHBsaWNhdGlvbkNvZGUgJiYgcmVzdWx0W25dLmFwcGxpY2F0aW9uQ29kZSAmJiByZXN1bHRbbl0uYXBwbGljYXRpb25Db2RlLnRvTG93ZXJDYXNlKCkgPT09IG5ld1JlY29yZEFycmF5W21dLmFwcGxpY2F0aW9uQ29kZS50b0xvd2VyQ2FzZSgpKQogICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHN0cmF0ZWd5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyZXBsYWNlUGFydGlhbGx5IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGF0dHJOYW1lUmVwbGFjZSBpbiByZXN1bHRbbl0pIHJlc3VsdFtuXVthdHRyTmFtZVJlcGxhY2VdID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGF0dHJOYW1lTmV3UmVwbGFjZSBpbiBuZXdSZWNvcmRBcnJheVttXSkgcmVzdWx0W25dW2F0dHJOYW1lTmV3UmVwbGFjZV0gPSBuZXdSZWNvcmRBcnJheVttXVthdHRyTmFtZU5ld1JlcGxhY2VdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAibWVyZ2UiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgYXR0ck5hbWVNZXJnZSBpbiBuZXdSZWNvcmRBcnJheVttXSkgcmVzdWx0W25dW2F0dHJOYW1lTWVyZ2VdID0gbmV3UmVjb3JkQXJyYXlbbV1bYXR0ck5hbWVNZXJnZV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic2tpcCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGVVVUlEYW5kVXBkYXRlRGF0ZSh0eXBlLCByZXN1bHQsIG4pOwogICAgICAgICAgICAgICAgICAgICAgICBjaGVjayA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFjaGVjayAmJiAodHlwZSA9PT0gImNoaWxkIiB8fCB0eXBlID09PSAicGV0IiB8fCB0eXBlID09PSAiZXh0ZXJuYWxBcHBsaWNhdGlvbiIpKSB7CiAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdGVVVUlEYW5kVXBkYXRlRGF0ZSh0eXBlLCBuZXdSZWNvcmRBcnJheSwgbSk7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobmV3UmVjb3JkQXJyYXlbbV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hlY2sgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBgVGhlIGV4dGVybmFsQXBwbGljYXRpb24sIGNoaWxkIGFuZC9vciBwZXQgaXMgbm90IGFuIGFycmF5LmA7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKfQ==",
            "notifyLastRecord": false,
            "ECMAScriptVersion": "12"
          },
          "next": ["5A bis. Perform Merge Area of Interest Logic"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "5B. Rename Fields",
          "type": "field.rename",
          "params": {
            "fields": [
              {
                "sourceField": "data._areaOfInterest",
                "targetField": "data.areaOfInterest"
              },
              {
                "sourceField": "data._child",
                "targetField": "data.child"
              },
              {
                "sourceField": "data._pet",
                "targetField": "data.pet"
              },
              {
                "sourceField": "data._externalApplication",
                "targetField": "data.externalApplication"
              },
              {
                "sourceField": "_lastUpdated",
                "targetField": "lastUpdated"
              },
              {
                "sourceField": "data._initialAppSourceCode",
                "targetField": "data.initialAppSourceCode"
              }
            ]
          },
          "next": ["6B. Set Standard Data"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "11. Lite InitRegistrationgigya.generic",
          "type": "datasource.write.gigya.generic",
          "params": {
            "apiMethod": "accounts.initRegistration",
            "maxConnections": 10,
            "apiParams": [
              {
                "sourceField": "",
                "paramName": "isLite",
                "value": "true"
              }
            ],
            "addResponse": true
          },
          "next": ["12. setAccountInfo"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "12. setAccountInfo",
          "type": "datasource.write.gigya.generic",
          "params": {
            "apiMethod": "accounts.setAccountInfo",
            "maxConnections": 20,
            "addResponse": true,
            "apiParams": [
              {
                "sourceField": "profile",
                "paramName": "profile",
                "value": ""
              },
              {
                "sourceField": "_response.regToken",
                "paramName": "regToken",
                "value": ""
              },
              {
                "sourceField": "preferences",
                "paramName": "preferences",
                "value": ""
              },
              {
                "sourceField": "lang",
                "paramName": "lang",
                "value": ""
              }
            ]
          },
          "next": [],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "6A. Remove Fields",
          "type": "field.remove",
          "params": {
            "fields": ["data._areaOfInterest", "data._child", "data._pet", "data._externalApplication", "_lastUpdated", "data._initialAppSourceCode", "_subscriptions"]
          },
          "next": ["7. Add data.idxImportJobId"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "10A. Check if Preferences exists",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgaWYocmVjb3JkICYmIHJlY29yZC5wcmVmZXJlbmNlcykgew0KICAgICAgICBpZiAocmVjb3JkLnByZWZlcmVuY2VzICYmICFyZWNvcmQubGFuZykgew0KICAgICAgICAgICAgaWYgKHJlY29yZC5wcm9maWxlICYmIHJlY29yZC5wcm9maWxlLmxvY2FsZSkgew0KICAgICAgICAgICAgICAgIHJlY29yZC5sYW5nID0gcmVjb3JkLnByb2ZpbGUubG9jYWxlOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgIHJlY29yZC5sYW5nID0gImVuIjsgDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHJlY29yZDsNCiAgICB9DQp9",
            "notifyLastRecord": false,
            "ECMAScriptVersion": "12"
          },
          "next": ["11. Lite InitRegistrationgigya.generic"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "6B. Set Standard Data",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQoNCiAgICAvLyBzZXQgZGF0YS5jaGlsZFtdLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyDQogICAgaWYgKHJlY29yZC5kYXRhLmNoaWxkICYmIHJlY29yZC5kYXRhLmNoaWxkLmxlbmd0aCA+IDApew0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8ICByZWNvcmQuZGF0YS5jaGlsZC5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgaWYoIWNoZWNrVVVJRChyZWNvcmQuZGF0YS5jaGlsZFtpXVsiYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIiXSkpew0KICAgICAgICAgICAgICAgIHJlY29yZC5kYXRhLmNoaWxkW2ldWyJhcHBsaWNhdGlvbkludGVybmFsSWRlbnRpZmllciJdID0gZ2VuZXJhdGVVVUlEKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgIC8vIHNldCBkYXRhLnBldFtdLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyDQogICAgaWYgKHJlY29yZC5kYXRhLnBldCAmJiByZWNvcmQuZGF0YS5wZXQubGVuZ3RoID4gMCl7DQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgIHJlY29yZC5kYXRhLnBldC5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgaWYoIWNoZWNrVVVJRChyZWNvcmQuZGF0YS5wZXRbaV1bImFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyIl0pKXsNCiAgICAgICAgICAgICAgICByZWNvcmQuZGF0YS5wZXRbaV1bImFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyIl0gPSBnZW5lcmF0ZVVVSUQoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICBpZiAocmVjb3JkLnByZWZlcmVuY2VzKSB7DQogICAgICAgIA0KICAgICAgICBmb3IgKHZhciBrZXkgaW4gcmVjb3JkLnByZWZlcmVuY2VzKSB7DQogICAgICAgICAgICBpZiAoa2V5ICE9ICJ0ZXJtcyIgJiYga2V5ICE9ICJwcml2YWN5IikNCiAgICAgICAgICAgICAgICByZWNvcmQucHJlZmVyZW5jZXNba2V5XS5jdXN0b21EYXRhID0gbnVsbDsNCiAgICAgICAgICAgIA0KICAgICAgICB9ICAgDQoNCiAgICAgICAgaWYgKHJlY29yZC5wcmVmZXJlbmNlcy50ZXJtcykgew0KICAgICAgICAgICAgZm9yICh2YXIgdGVybXNLZXkgaW4gcmVjb3JkLnByZWZlcmVuY2VzLnRlcm1zKSB7DQogICAgICAgICAgICAgICAgcmVjb3JkLnByZWZlcmVuY2VzLnRlcm1zW3Rlcm1zS2V5XS5jdXN0b21EYXRhID0gbnVsbDsNCiAgICAgICAgICAgIH0gICAgICAgIA0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKHJlY29yZC5wcmVmZXJlbmNlcy5wcml2YWN5KSB7DQogICAgICAgICAgICBmb3IgKHZhciBwcml2YWN5S2V5IGluIHJlY29yZC5wcmVmZXJlbmNlcy5wcml2YWN5KSB7DQogICAgICAgICAgICAgICAgcmVjb3JkLnByZWZlcmVuY2VzLnByaXZhY3lbcHJpdmFjeUtleV0uY3VzdG9tRGF0YSA9IG51bGw7DQogICAgICAgICAgICB9ICAgICAgICANCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICByZWNvcmQuc3Vic2NyaXB0aW9ucyA9IHt9Ow0KICAgIGlmIChyZWNvcmQuX3N1YnNjcmlwdGlvbnMpIHsNCiAgICAgICAgZm9yICh2YXIgc3ViS2V5IGluIHJlY29yZC5fc3Vic2NyaXB0aW9ucykgew0KICAgICAgICAgICAgaWYgKHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsKSB7DQogICAgICAgICAgICAgICAgaWYgKCJ0cnVlIiA9PSAie3tET1VCTEVfT1BUX0lOfX0iKSB7DQogICAgICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbiAmJiByZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5zdGF0dXMgJiYgcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uc3RhdHVzID09PSAiQ29uZmlybWVkIikgew0KICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkID0gcHJvY2Vzc1N1YnNjcmlwdGlvbnMocmVjb3JkLCBzdWJLZXkpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbiB8fCAocmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uc3RhdHVzICYmIHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLnN0YXR1cyA9PT0gIkNvbmZpcm1lZCIpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZWNvcmQgPSBwcm9jZXNzU3Vic2NyaXB0aW9ucyhyZWNvcmQsIHN1YktleSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQogICAgDQogICAgcmV0dXJuIHJlY29yZDsNCn0NCg0KZnVuY3Rpb24gcHJvY2Vzc1N1YnNjcmlwdGlvbnMocmVjb3JkLCBzdWJLZXkpIHsNCiAgICByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldID0gcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV07DQogICAgDQogICAgaWYgKHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4pIHsNCiAgICAgICAgdmFyIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPSByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLmRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQ7DQogICAgICAgIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPSAoZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCAhPT0gbnVsbCAmJiBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkICE9PSB1bmRlZmluZWQpDQogICAgICAgICAgICA/IHR5cGVvZiBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkID09PSAiYm9vbGVhbiIgPyBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkIDogZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCA9PSAidHJ1ZSINCiAgICAgICAgICAgIDogbnVsbDsNCg0KICAgICAgICBzd2l0Y2ggKGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQpIHsNCiAgICAgICAgICAgIGNhc2UgdHJ1ZToNCiAgICAgICAgICAgICAgICByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLmlzRXh0ZXJuYWxseVZlcmlmaWVkID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGNhc2UgZmFsc2U6DQogICAgICAgICAgICAgICAgcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5pc0V4dGVybmFsbHlWZXJpZmllZCA9IGZhbHNlOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgY2FzZSBudWxsOg0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICB2YXIgb2JqZWN0ID0ge307DQogICAgICAgIGZvciAodmFyIGtleSBpbiByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluKSB7DQogICAgICAgICAgICBpZiAoa2V5ICE9PSAnZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCcpIHsNCiAgICAgICAgICAgICAgICBvYmplY3Rba2V5XSA9IHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW5ba2V5XTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4gPSBvYmplY3Q7DQogICAgfQ0KICAgIA0KICAgIC8vU1RBUlQgLSBNU0NORC0zOTE3MiAtIENoYW5nZSBvbiBpbXBvcnRpbmcgc3Vic2NyaXB0aW9ucyB0byBleGlzdGluZyBhY2NvdW50cw0KICAgIGlmIChyZWNvcmQ/LnN1YnNjcmlwdGlvbnM/LltzdWJLZXldPy5lbWFpbD8ubGFzdFVwZGF0ZWRTdWJzY3JpcHRpb25TdGF0ZSAmJg0KICAgIGlzRGF0ZUluRnV0dXJlKHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwubGFzdFVwZGF0ZWRTdWJzY3JpcHRpb25TdGF0ZSkpIHsNCiAgICAgICAgZGVsZXRlIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwubGFzdFVwZGF0ZWRTdWJzY3JpcHRpb25TdGF0ZTsNCiAgICB9DQogICAgLy9FTkQgLSBNU0NORC0zOTE3MiAtIENoYW5nZSBvbiBpbXBvcnRpbmcgc3Vic2NyaXB0aW9ucyB0byBleGlzdGluZyBhY2NvdW50cw0KDQogICAgcmV0dXJuIHJlY29yZDsNCn0NCg0KLy9TVEFSVCAtIE1TQ05ELTM5MTcyIC0gQ2hhbmdlIG9uIGltcG9ydGluZyBzdWJzY3JpcHRpb25zIHRvIGV4aXN0aW5nIGFjY291bnRzDQpmdW5jdGlvbiBpc0RhdGVJbkZ1dHVyZShkYXRlU3RyaW5nKSB7DQogIC8vIFBhcnNlIHRoZSBnaXZlbiBkYXRlIHN0cmluZyBpbnRvIGEgRGF0ZSBvYmplY3QNCiAgY29uc3QgZ2l2ZW5EYXRlID0gbmV3IERhdGUoZGF0ZVN0cmluZyk7DQogIA0KICAvLyBHZXQgdGhlIGN1cnJlbnQgZGF0ZSBhbmQgdGltZQ0KICBjb25zdCBjdXJyZW50RGF0ZSA9IG5ldyBEYXRlKCk7DQogIA0KICAvLyBDb21wYXJlIHRoZSBnaXZlbiBkYXRlIHdpdGggdGhlIGN1cnJlbnQgZGF0ZQ0KICByZXR1cm4gZ2l2ZW5EYXRlID4gY3VycmVudERhdGU7DQp9DQovL0VORCAtIE1TQ05ELTM5MTcyIC0gQ2hhbmdlIG9uIGltcG9ydGluZyBzdWJzY3JpcHRpb25zIHRvIGV4aXN0aW5nIGFjY291bnRzDQoNCmZ1bmN0aW9uIGNoZWNrVVVJRCh1dWlkKSB7DQogICAgY29uc3QgcmVnZXggPSAvXlswLTlhLWZdezh9LVswLTlhLWZdezR9LTRbMC05YS1mXXszfS1bODlhYl1bMC05YS1mXXszfS1bMC05YS1mXXsxMn0kL2k7DQogICAgcmV0dXJuIHJlZ2V4LnRlc3QodXVpZCk7DQp9DQoNCmZ1bmN0aW9uIGdlbmVyYXRlVVVJRCgpIHsNCiAgIHZhciBkID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7DQogICB2YXIgdXVpZCA9ICJ4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgiLnJlcGxhY2UoL1t4eV0vZywgZnVuY3Rpb24oYykgew0KICAgICAgIHZhciByID0gKGQgKyBNYXRoLnJhbmRvbSgpKjE2KSUxNiB8IDA7DQogICAgICAgZCA9IE1hdGguZmxvb3IoZC8xNik7DQogICAgICAgICAgICByZXR1cm4gKGM9PSJ4IiA/IHIgOiAociYweDN8MHg4KSkudG9TdHJpbmcoMTYpOw0KICAgIH0pOw0KICAgIHJldHVybiB1dWlkOw0KfQ==",
            "notifyLastRecord": false,
            "ECMAScriptVersion": "12"
          },
          "next": ["6B bis. Set standard Area of Interest"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "1. Read From Blob Storage",
          "type": "datasource.read.azure.blob_token",
          "params": {
            "baseUri": "{{AZURE_BASE_URI}}",
            "accessToken": "********",
            "container": "{{AZURE_CONTAINER}}",
            "blobPrefix": "{{AZURE_BLOB_PREFIX}}"
          },
          "next": ["2. Decrypt PGP"]
        },
        {
          "id": "Prepare fields to extract email",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgdmFyIHJlY29yZFRvRXh0cmFjdCA9IHt9Ow0KICAgIHJlY29yZFRvRXh0cmFjdC5lbWFpbCA9IHJlY29yZC5lbWFpbDsNCiAgICBpZiAocmVjb3JkLlVJRCAmJiByZWNvcmQuVUlELmxlbmd0aCkgew0KICAgICAgICByZWNvcmRUb0V4dHJhY3QuVUlEID0gcmVjb3JkLlVJRDsNCiAgICB9DQogICAgDQogICAgcmVjb3JkVG9FeHRyYWN0LmVycm9yRGV0YWlscyA9IHJlY29yZC5fZXJyb3JEZXRhaWxzOw0KDQogICAgcmV0dXJuIHJlY29yZFRvRXh0cmFjdDsNCn0=",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["Generate file"]
        },
        {
          "id": "Generate file",
          "type": "file.format.json",
          "params": {
            "fileName": "{{AZURE_ERRORS_FILENAME}}_${now:yyMMddHHmm}.json",
            "maxFileSize": 5000,
            "createEmptyFile": false
          },
          "next": ["Encrypt file"]
        },
        {
          "id": "Encrypt file",
          "type": "file.encrypt.pgp",
          "params": {
            "publicKey": "{{PGP_Public_Key_Base64_Encoded}}",
            "asciiArmor": true
          },
          "next": ["Upload to Blob Storage"]
        },
        {
          "id": "Prepare existent accounts to extract",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgdmFyIG5ld1JlY29yZCA9IHsNCiAgICAgICAgIlVJRCI6IHJlY29yZC5VSUQsDQogICAgICAgICJlbWFpbCI6IHJlY29yZC5wcm9maWxlLmVtYWlsDQogICAgfTsNCiAgICANCiAgICBpZiAocmVjb3JkLmRhdGEuaW5pdGlhbEFwcFNvdXJjZUNvZGUpIHsNCiAgICAgICAgbmV3UmVjb3JkLmluaXRpYWxBcHBTb3VyY2VDb2RlID0gcmVjb3JkLmRhdGEuaW5pdGlhbEFwcFNvdXJjZUNvZGU7DQogICAgfQ0KICAgIA0KICAgIGlmIChyZWNvcmQuZGF0YS5saXRlQXBwU291cmNlQ29kZSkgew0KICAgICAgICBuZXdSZWNvcmQubGl0ZUFwcFNvdXJjZUNvZGUgPSByZWNvcmQuZGF0YS5saXRlQXBwU291cmNlQ29kZTsNCiAgICB9DQogICAgDQogICAgcmV0dXJuIG5ld1JlY29yZDsNCn0=",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["Generate Existent Accounts File"]
        },
        {
          "id": "Generate Existent Accounts File",
          "type": "file.format.json",
          "params": {
            "fileName": "{{AZURE_EXISTENT_ACCOUNTS_FILENAME}}_${now:yyMMddHHmm}.json",
            "maxFileSize": 5000,
            "createEmptyFile": false
          },
          "next": ["Encrypt file"]
        },
        {
          "id": "7. Add data.idxImportJobId",
          "type": "field.add",
          "params": {
            "fields": [
              {
                "field": "data.idxImportJobId",
                "value": "${jobId}"
              }
            ]
          },
          "next": ["8. Evaluate Subscriptions & Preferences"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "6B bis. Set standard Area of Interest",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgew0KICAgIC8vYXZvaWQgcmVwZWF0ZWQgaW50ZXJlc3RDb2Rlcy1hbnN3ZXJEZXRhaWxzIG9uIGFyZWEgb2YgaW50ZXJlc3QNCiAgICBjb25zdCBlcnJvcnMgPSBuZXcgU2V0KCk7DQoNCiAgICBpZiAocmVjb3JkLmRhdGEuYXJlYU9mSW50ZXJlc3QgJiYgcmVjb3JkLmRhdGEuYXJlYU9mSW50ZXJlc3QubGVuZ3RoID4gMCl7DQogICAgICAgIHJlY29yZC5kYXRhLmFyZWFPZkludGVyZXN0ID0gWy4uLnJlY29yZC5kYXRhLmFyZWFPZkludGVyZXN0LmZpbHRlcigodmFsdWUsIGluZGV4KSA9PiB7DQogICAgICAgICAgICBpZiAoIXZhbHVlLmludGVyZXN0Q29kZSB8fCAhdmFsdWUuYW5zd2VyRGV0YWlscykgew0KICAgICAgICAgICAgICAgIGVycm9ycy5hZGQoYEludmFsaWQgcmVjb3JkIHNlbnQuIFRoZSByZWNvcmQgaGFzIGFuIGludGVyZXN0IHdpdGhvdXQgaW50ZXJlc3RDb2RlIG9yIHdpdGhvdXQgYW5zd2VyRGV0YWlscy5gKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgY29uc3QgX3ZhbHVlID0gYCR7dmFsdWUuaW50ZXJlc3RDb2RlLnRvTG93ZXJDYXNlKCl9IC0gJHt2YWx1ZS5hbnN3ZXJEZXRhaWxzLnRvTG93ZXJDYXNlKCl9YDsNCiAgICAgICAgICAgICAgICByZXR1cm4gaW5kZXggPT09IHJlY29yZC5kYXRhLmFyZWFPZkludGVyZXN0LmZpbmRJbmRleChvYmogPT4gew0KICAgICAgICAgICAgICAgICAgICBpZiAoIW9iai5pbnRlcmVzdENvZGUgfHwgIW9iai5hbnN3ZXJEZXRhaWxzKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnMuYWRkKGBJbnZhbGlkIHJlY29yZCBzZW50LiBUaGUgcmVjb3JkIGhhcyBhbiBpbnRlcmVzdCB3aXRob3V0IGludGVyZXN0Q29kZSBvciB3aXRob3V0IGFuc3dlckRldGFpbHMuYCk7DQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYCR7b2JqLmludGVyZXN0Q29kZS50b0xvd2VyQ2FzZSgpfSAtICR7b2JqLmFuc3dlckRldGFpbHMudG9Mb3dlckNhc2UoKX1gID09IF92YWx1ZTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KV07DQogICAgfQ0KICAgIGlmIChlcnJvcnMuc2l6ZSkgew0KICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgZXJyb3JzKSB7DQogICAgICAgICAgICBpZiAocmVjb3JkLl9lcnJvckRldGFpbHMgJiYgcmVjb3JkLl9lcnJvckRldGFpbHMubGVuZ3RoKSByZWNvcmQuX2Vycm9yRGV0YWlscyArPSBgLCAke2l0ZW19YDsNCiAgICAgICAgICAgIGVsc2UgcmVjb3JkLl9lcnJvckRldGFpbHMgPSBpdGVtOw0KICAgICAgICB9DQogICAgICAgIGVycm9yLmFjY2VwdChyZWNvcmQsIHJlY29yZCk7DQogICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIHJlY29yZDsNCiAgICB9DQp9",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["6A. Remove Fields"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "5A bis. Perform Merge Area of Interest Logic",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgewogICAgLy8gSWYgc2V0IHRvIHRydWUgdGhlIHJlY29yZCB3aWxsIGJlIHByb2Nlc3NlZCBvbmx5IGlmIHRoZSBsYXN0VXBkYXRlIGluIHRoZSBmaWxlIGlzID4gbGFzdHVwZGF0ZSBpbiBTQVAtQ0RDLiBJZiBzZXQgdG8gZmFsc2UgdGhlIHJlY29yZCB3aWxsIGJlIGFsd2F5cyBwcm9jZXNzZWQuCiAgICB2YXIgY2hlY2tMYXN0VXBkYXRlZCA9IGZhbHNlOwogICAgLy8gSWYgc2V0IHRvIHRydWUgd2Ugd2lsbCBhcHBseSB0aGUgbWVyZ2UgbG9naWMgZm9yIHRoZSBjYXRlZ29yeS4gSWYgc2V0IHRvIGZhbHNlIHdlIHdpbGwgbm90IGFwcGx5IHRoZSBtZXJnaW5nIGxvZ2ljLgogICAgdmFyIG1lcmdlQXJlYU9mSW50ZXJlc3QgPSB0cnVlOwoKICAgIGlmKCBjaGVja0xhc3RVcGRhdGVkICYmIHJlY29yZC5sYXN0VXBkYXRlZCA+IHJlY29yZC5fbGFzdFVwZGF0ZWQgKSByZXR1cm47CiAgICAKICAgIHZhciBtYXRjaGluZ0NvbmRpdGlvbkFyZWFPZkludGVyZXN0ID0gWyJpbnRlcmVzdENvZGUiXTsKICAgIHZhciBzdHJhdGVneUNob29zZW4gPSAie3tNRVJHRV9TVFJBVEVHWX19IjsKCiAgICBpZiAoIG1lcmdlQXJlYU9mSW50ZXJlc3QgKSBjYWxsTWVyZ2VMb2dpYyggcmVjb3JkLCAiYXJlYU9mSW50ZXJlc3QiLCBzdHJhdGVneUNob29zZW4sIGxvZ2dlciwgZXJyb3IpOwogICAgCiAgICBpZiAocmVjb3JkLl9lcnJvckRldGFpbHMgJiYgcmVjb3JkLl9lcnJvckRldGFpbHMubGVuZ3RoKSB7CiAgICAgICAgZXJyb3IuYWNjZXB0KHJlY29yZCwgcmVjb3JkKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgIH0KfQoKZnVuY3Rpb24gY2FsbE1lcmdlTG9naWMoIHJlY29yZCwgcHJvcGVydHlOYW1lLCBzdHJhdGVneUNob29zZW4sIGxvZ2dlciwgZXJyb3IpIHsKICAgIHZhciBfcHJvcGVydHlOYW1lID0gIl8iICsgcHJvcGVydHlOYW1lOwogICAgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdICYmICFyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdKSB7CiAgICAgICAgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gZGVsZXRlUmVwZWF0ZWRzKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdKTsKICAgICAgICB9CiAgICB9IGVsc2UgaWYgKHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0pIHsKICAgICAgICBpZiAocmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXS5sZW5ndGggPT09IDAgJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0ubGVuZ3RoICE9PSAwKSByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gZGVsZXRlUmVwZWF0ZWRzKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdKTsgIAogICAgICAgIGVsc2UgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICBjb25zdCBtZXJnZVJlc3VsdCA9IHByb2Nlc3NNZXJnZShyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdLCByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXSwgc3RyYXRlZ3lDaG9vc2VuKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXJnZVJlc3VsdCA9PT0gJ3N0cmluZycpIHJlY29yZC5fZXJyb3JEZXRhaWxzID0gbWVyZ2VSZXN1bHQ7CiAgICAgICAgICAgIGVsc2UgcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXSA9IG1lcmdlUmVzdWx0OwogICAgICAgIH0KICAgIH0KfQoKCmZ1bmN0aW9uIHByb2Nlc3NNZXJnZShleGlzdGluZ1JlY29yZEFycmF5LCBuZXdSZWNvcmRBcnJheSwgc3RyYXRlZ3kpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIHZhciBjaGVjayA9IGZhbHNlOwogICAgaWYgKCBzdHJhdGVneSA9PT0gImZ1bGxSZXBsYWNlIikgewogICAgICAgIHJlc3VsdCA9IG5ld1JlY29yZEFycmF5OwogICAgICAgIHJldHVybiBkZWxldGVSZXBlYXRlZHMocmVzdWx0KTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXhpc3RpbmdSZWNvcmRBcnJheSkpIHsKICAgICAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAicmVwbGFjZVBhcnRpYWxseSIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5ld0ludGVyZXN0Q29kZXMgPSBuZXdSZWNvcmRBcnJheS5tYXAocmVjb3JkID0+IHJlY29yZC5pbnRlcmVzdENvZGUpOwogICAgCiAgICAgICAgICAgICAgICBleGlzdGluZ1JlY29yZEFycmF5ID0gWy4uLmV4aXN0aW5nUmVjb3JkQXJyYXkuZmlsdGVyKHJlY29yZCA9PiAhISFuZXdJbnRlcmVzdENvZGVzLmZpbmQoaW50ZXJlc3RDb2RlID0+IGludGVyZXN0Q29kZSA9PT0gcmVjb3JkLmludGVyZXN0Q29kZSkpXTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAibWVyZ2UiKSB7CiAgICAgICAgICAgICAgICBjb25zdCBleGlzdGluZ1JlY29yZEFycmF5V291dFJlcGVhdGVkID0gZXhpc3RpbmdSZWNvcmRBcnJheS5maWx0ZXIocmVjb3JkID0+ICFuZXdSZWNvcmRBcnJheS5maW5kKF9yZWNvcmQgPT4gX3JlY29yZC5pbnRlcmVzdENvZGUgPT09IHJlY29yZC5pbnRlcmVzdENvZGUgJiYgX3JlY29yZC5hbnN3ZXJEZXRhaWxzID09PSByZWNvcmQuYW5zd2VyRGV0YWlscykpOwogICAgICAgICAgICAgICAgcmVzdWx0ID0gWy4uLmV4aXN0aW5nUmVjb3JkQXJyYXlXb3V0UmVwZWF0ZWQsIC4uLm5ld1JlY29yZEFycmF5XTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGV4aXN0aW5nUmVjb3JkQXJyYXkgJiYgZXhpc3RpbmdSZWNvcmRBcnJheS5sZW5ndGggPyBbLi4uZXhpc3RpbmdSZWNvcmRBcnJheV0gOiBbXTsKICAgIAogICAgICAgICAgICAgICAgZm9yICh2YXIgbSBpbiBuZXdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG4gaW4gZXhpc3RpbmdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3UmVjb3JkQXJyYXlbbV0gJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXSAmJiBuZXdSZWNvcmRBcnJheVttXS5pbnRlcmVzdENvZGUgJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXS5pbnRlcmVzdENvZGUgJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXS5pbnRlcmVzdENvZGUgPT09IG5ld1JlY29yZEFycmF5W21dLmludGVyZXN0Q29kZSApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIWNoZWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5ld1JlY29yZEFycmF5W21dKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2hlY2sgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZVJlcGVhdGVkcyhyZXN1bHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiVGhlIGFyZWEgb2YgaW50ZXJlc3QgaXMgbm90IGFuIGFycmF5LiI7CiAgICAgICAgfQogICAgICAgCiAgICB9Cn0KCmZ1bmN0aW9uIGRlbGV0ZVJlcGVhdGVkcyhyZXN1bHQpIHsKICAgIGNvbnN0IGVycm9ycyA9IG5ldyBTZXQoKTsKICAgIGNvbnN0IF9yZXN1bHQgPSBbLi4ucmVzdWx0LmZpbHRlcigodmFsdWUsIGluZGV4KSA9PiB7CiAgICAgICAgaWYgKCF2YWx1ZS5pbnRlcmVzdENvZGUgfHwgIXZhbHVlLmFuc3dlckRldGFpbHMpIHsKICAgICAgICAgICAgZXJyb3JzLmFkZChgVGhlIHJlY29yZCBoYXMgYW4gaW50ZXJlc3QgaW4gdGhlIHJlcG8gd2l0aG91dCBpbnRlcmVzdENvZGUgb3Igd2l0aG91dCBhbnN3ZXJEZXRhaWxzLmApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGludGVyZXN0Q29kZVZhbHVlID0gdHlwZW9mIHZhbHVlLmludGVyZXN0Q29kZSA9PT0gInN0cmluZyIgPyB2YWx1ZS5pbnRlcmVzdENvZGUudG9Mb3dlckNhc2UoKSA6IGAke3ZhbHVlLmludGVyZXN0Q29kZX1gLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGNvbnN0IGFuc3dlckRldGFpbHNWYWx1ZSA9IHR5cGVvZiB2YWx1ZS5hbnN3ZXJEZXRhaWxzID09PSAic3RyaW5nIiA/IHZhbHVlLmFuc3dlckRldGFpbHMudG9Mb3dlckNhc2UoKSA6IGAke3ZhbHVlLmFuc3dlckRldGFpbHN9YC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBjb25zdCBfdmFsdWUgPSBgJHsgaW50ZXJlc3RDb2RlVmFsdWUgfSAtICR7IGFuc3dlckRldGFpbHNWYWx1ZSB9YDsKICAgICAgICAgICAgcmV0dXJuIGluZGV4ID09PSByZXN1bHQuZmluZEluZGV4KG9iaiA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIW9iai5pbnRlcmVzdENvZGUgfHwgIW9iai5hbnN3ZXJEZXRhaWxzKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JzLmFkZChgVGhlIHJlY29yZCBoYXMgYW4gaW50ZXJlc3QgaW4gdGhlIHJlcG8gd2l0aG91dCBpbnRlcmVzdENvZGUgb3Igd2l0aG91dCBhbnN3ZXJEZXRhaWxzLmApCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGludGVyZXN0Q29kZU9iaiA9IHR5cGVvZiBvYmouaW50ZXJlc3RDb2RlID09PSAic3RyaW5nIiA/IG9iai5pbnRlcmVzdENvZGUudG9Mb3dlckNhc2UoKSA6IGAke29iai5pbnRlcmVzdENvZGV9YC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFuc3dlckRldGFpbHNPYmogPSB0eXBlb2Ygb2JqLmFuc3dlckRldGFpbHMgPT09ICJzdHJpbmciID8gb2JqLmFuc3dlckRldGFpbHMudG9Mb3dlckNhc2UoKSA6IGAke29iai5hbnN3ZXJEZXRhaWxzfWAudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYCR7IGludGVyZXN0Q29kZU9iaiB9IC0gJHsgYW5zd2VyRGV0YWlsc09iaiB9YCA9PSBfdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0pXTsKICAgIAogICAgaWYgKGVycm9ycy5zaXplKSB7CiAgICAgICAgbGV0IGVycm9yTWVzc2FnZSA9ICIiOwogICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBlcnJvcnMpIHsKICAgICAgICAgICAgaWYgKGVycm9yTWVzc2FnZSAmJiBlcnJvck1lc3NhZ2UubGVuZ3RoKSBlcnJvck1lc3NhZ2UgKz0gYCwgJHtpdGVtfWA7CiAgICAgICAgICAgIGVsc2UgZXJyb3JNZXNzYWdlID0gaXRlbTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGVycm9yTWVzc2FnZTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIF9yZXN1bHQ7CiAgICB9Cn0=",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["6A. Remove Fields"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "Upload to Blob Storage",
          "type": "datasource.write.azure.blob_token",
          "params": {
            "baseUri": "https://ciamprblobdataplatform.blob.core.windows.net",
            "accessToken": "********",
            "container": "{{AZURE_CONTAINER_IMPORT_ERROR}}"
          }
        }
      ],
      "version": 1,
      "createTime": "2024-10-15T09:59:15.825Z",
      "updateTime": "2024-10-15T09:59:15.825Z",
      "updatedByEmail": "l.marques@sap.com"
    },
    {
      "apiKey": "4_6Tv6z8O6NmUO_BZoHcXIRw",
      "siteId": 435061734600,
      "id": "71eef8ac47884bf2a69149b133c1a4ac",
      "name": "[FULL ACCOUNTS] - Import from DQV (BLOB STORAGE) - ONE-FIELD",
      "status": "published",
      "description": "[FULL ACCOUNTS] - Import from DQV (BLOB STORAGE) - ONE-FIELD",
      "steps": [
        {
          "id": "10B. Remove Fields",
          "type": "field.remove",
          "params": {
            "fields": [
              "_loginIDs",
              "_emails",
              "_identities",
              "_phoneNumber",
              "profile._email",
              "password",
              "_response",
              "query",
              "data._areaOfInterest",
              "data._child",
              "data._pet",
              "data._externalApplication",
              "_lastUpdated",
              "data._initialAppSourceCode",
              "isRegistered",
              "lastUpdated",
              "identities",
              "loginIDs",
              "_subscriptions"
            ]
          },
          "next": ["11C. Update Account"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": " 7A. Perform Merge Logic",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgewogICAgY29uc3QgY2hlY2tMYXN0VXBkYXRlZCA9IGZhbHNlOwogICAgY29uc3QgbWVyZ2VDaGlsZCA9IHRydWU7CiAgICBjb25zdCBtZXJnZVBldCA9IHRydWU7CiAgICBjb25zdCBtZXJnZUV4dGVybmFsQXBwbGljYXRpb24gPSB0cnVlOwogICAgCiAgICBpZihjaGVja0xhc3RVcGRhdGVkICYmIHJlY29yZC5sYXN0VXBkYXRlZCA+IHJlY29yZC5fbGFzdFVwZGF0ZWQpICByZXR1cm47CiAgICAKICAgIC8vV2UgdXBkYXRlIGluaXRpYWxBcHBTb3VyY2VDb2RlIG9ubHkgaWYgaXQgZG9lc24ndCBleGlzdCBpbiB0aGUgc3lzdGVtCiAgICBpZihyZWNvcmQuZGF0YSAmJiByZWNvcmQuZGF0YS5faW5pdGlhbEFwcFNvdXJjZUNvZGUgJiYgIXJlY29yZC5kYXRhLmluaXRpYWxBcHBTb3VyY2VDb2RlKSByZWNvcmQuZGF0YS5pbml0aWFsQXBwU291cmNlQ29kZSA9IHJlY29yZC5kYXRhLl9pbml0aWFsQXBwU291cmNlQ29kZTsKICAgIAogICAgLy9QaG9uZU51bWJlciBsb2dpYwogICAgaWYocmVjb3JkLnByb2ZpbGUuX2VtYWlsKSB7CiAgICAgICAgaWYocmVjb3JkLnByb2ZpbGUuX2VtYWlsLmluZGV4T2YoInJhbmRvbWVtYWlsLm5lc3RsZS5jb20iKSA9PSAtMSAmJiAoIXJlY29yZC5wcm9maWxlLmVtYWlsIHx8IHJlY29yZC5wcm9maWxlLmVtYWlsLmluZGV4T2YoInJhbmRvbWVtYWlsLm5lc3RsZS5jb20iKSA+IC0xKSkgewogICAgICAgICAgICBpZihyZWNvcmQucHJvZmlsZS5fZW1haWwpIHJlY29yZC5wcm9maWxlLmVtYWlsID0gcmVjb3JkLnByb2ZpbGUuX2VtYWlsOwogICAgICAgICAgICBpZiggcmVjb3JkLl9sb2dpbklEcykgcmVjb3JkLmxvZ2luSURzID0gcmVjb3JkLl9sb2dpbklEczsKICAgICAgICAgICAgaWYocmVjb3JkLl9lbWFpbHMpIHJlY29yZC5lbWFpbHMgPSByZWNvcmQuX2VtYWlsczsKICAgICAgICAgICAgaWYgKHJlY29yZC5faWRlbnRpdGllcykgewogICAgICAgICAgICAgICAgcmVjb3JkLmlkZW50aXRpZXMgPSByZWNvcmQuX2lkZW50aXRpZXM7CiAgICAgICAgICAgICAgICByZWNvcmQuX2lkZW50aXRpZXMgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWNvcmQuaXNSZWdpc3RlcmVkID0gdHJ1ZTsgLy9IYXJkY29kZSBpc1JlZ2lzdGVyZWQgYXMgdHJ1ZS4KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmIChyZWNvcmQuX3Bob25lTnVtYmVyICYmICFyZWNvcmQucHJvZmlsZS5lbWFpbCkgewogICAgICAgICAgICByZWNvcmQucHJvZmlsZS5lbWFpbCA9IHJlY29yZC5VSUQrIkByYW5kb21lbWFpbC5uZXN0bGUuY29tIjsKICAgICAgICAgICAgcmVjb3JkLmxvZ2luSURzID0ge307CiAgICAgICAgICAgIHJlY29yZC5sb2dpbklEcy51bnZlcmlmaWVkRW1haWxzID0gW3JlY29yZC5VSUQrIkByYW5kb21lbWFpbC5uZXN0bGUuY29tIl07CiAgICAgICAgICAgIHJlY29yZC5lbWFpbHMgPSB7fTsKICAgICAgICAgICAgcmVjb3JkLmVtYWlscy51bnZlcmlmaWVkID0gW3JlY29yZC5VSUQrIkByYW5kb21lbWFpbC5uZXN0bGUuY29tIl07CiAgICAgICAgICAgIGlmKHJlY29yZC5faWRlbnRpdGllcykgewogICAgICAgICAgICAgICAgdmFyIG5ld2lkZW50aXRpZXMgPSBbXTsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSBpbiByZWNvcmQuX2lkZW50aXRpZXMpIHsKICAgICAgICAgICAgICAgICAgICBpZihyZWNvcmQuX2lkZW50aXRpZXNbaV1bInByb3ZpZGVyIl0gJiYgcmVjb3JkLl9pZGVudGl0aWVzWzBdWyJwcm92aWRlciJdID09ICJzaXRlIikgewogICAgICAgICAgICAgICAgICAgICAgICByZWNvcmQuX2lkZW50aXRpZXNbaV1bImVtYWlsIl0gPSByZWNvcmQuVUlEKyJAcmFuZG9tZW1haWwubmVzdGxlLmNvbSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG5ld2lkZW50aXRpZXMucHVzaChyZWNvcmQuX2lkZW50aXRpZXNbaV0pCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZWNvcmQuaWRlbnRpdGllcyA9IG5ld2lkZW50aXRpZXM7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIC8vRG9uJ3QgY2hhbmdlIHRoZSBwaG9uZW51bWJlciBzdG9yZWQgaW4gdGhlIHN5c3RlbQogICAgaWYoIXJlY29yZC5waG9uZU51bWJlciAmJiByZWNvcmQuX3Bob25lTnVtYmVyKSByZWNvcmQucGhvbmVOdW1iZXIgPSByZWNvcmQuX3Bob25lTnVtYmVyOwogICAgCiAgICBjb25zdCBtYXRjaGluZ0NvbmRpdGlvbkV4dGVybmFsQXBwbGljYXRpb24gPSBbImFwcGxpY2F0aW9uQ29kZSJdOwoKICAgIGNvbnN0IHN0cmF0ZWd5Q2hvb3NlbiA9ICJ7e01FUkdFX1NUUkFURUdZfX0iOwogICAgCiAgICAvL0FwcGx5IGN1c3RvbSBsb2dpYyBmb3IgRXh0ZXJuYWxBcHBsaWNhdGlvbgogICAgaWYgKG1lcmdlRXh0ZXJuYWxBcHBsaWNhdGlvbikgewogICAgICAgIGlmIChyZWNvcmQuZGF0YS5fZXh0ZXJuYWxBcHBsaWNhdGlvbiAmJiAhcmVjb3JkLmRhdGEuZXh0ZXJuYWxBcHBsaWNhdGlvbikgewogICAgICAgICAgICBpZiAocmVjb3JkLmRhdGEuX2V4dGVybmFsQXBwbGljYXRpb24ubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgICAgICByZWNvcmQuZGF0YS5leHRlcm5hbEFwcGxpY2F0aW9uID0gcmVjb3JkLmRhdGEuX2V4dGVybmFsQXBwbGljYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHJlY29yZC5kYXRhLmV4dGVybmFsQXBwbGljYXRpb24gJiYgcmVjb3JkLmRhdGEuX2V4dGVybmFsQXBwbGljYXRpb24pIHsKICAgICAgICAgICAgc3dpdGNoIChyZWNvcmQuZGF0YS5leHRlcm5hbEFwcGxpY2F0aW9uLmxlbmd0aCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuZGF0YS5fZXh0ZXJuYWxBcHBsaWNhdGlvbi5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkLmRhdGEuZXh0ZXJuYWxBcHBsaWNhdGlvbiA9IHJlY29yZC5kYXRhLl9leHRlcm5hbEFwcGxpY2F0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlY29yZC5kYXRhLl9leHRlcm5hbEFwcGxpY2F0aW9uLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICByZWNvcmQuZGF0YS5leHRlcm5hbEFwcGxpY2F0aW9uID0gcHJvY2Vzc01lcmdlKHJlY29yZC5kYXRhLmV4dGVybmFsQXBwbGljYXRpb24sIHJlY29yZC5kYXRhLl9leHRlcm5hbEFwcGxpY2F0aW9uLCBtYXRjaGluZ0NvbmRpdGlvbkV4dGVybmFsQXBwbGljYXRpb24sIHN0cmF0ZWd5Q2hvb3NlbiwiZXh0ZXJuYWxBcHBsaWNhdGlvbiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLyBBcHBseSBtZXJnZSBsb2dpY3MKICAgIGlmICggbWVyZ2VDaGlsZCApIGNhbGxNZXJnZUxvZ2ljKCByZWNvcmQsICJjaGlsZCIsIHN0cmF0ZWd5Q2hvb3Nlbik7CiAgICBpZiAoIG1lcmdlUGV0ICkgY2FsbE1lcmdlTG9naWMoIHJlY29yZCwgInBldCIsIHN0cmF0ZWd5Q2hvb3Nlbik7CiAgICBpZiAoIG1lcmdlRXh0ZXJuYWxBcHBsaWNhdGlvbiApIGNhbGxNZXJnZUxvZ2ljKCByZWNvcmQsICJleHRlcm5hbEFwcGxpY2F0aW9uIiwgc3RyYXRlZ3lDaG9vc2VuICk7CiAgICAKICAgIGlmIChyZWNvcmQuX2Vycm9yRGV0YWlscyAmJiByZWNvcmQuX2Vycm9yRGV0YWlscy5sZW5ndGgpIHsKICAgICAgICBlcnJvci5hY2NlcHQocmVjb3JkLCByZWNvcmQpOwogICAgfSBlbHNlIHsKICAgICAgICByZWNvcmQuaWRlbnRpdGllcyA9IHJlY29yZC5faWRlbnRpdGllczsKICAgICAgICBpZiAocmVjb3JkLmlkZW50aXRpZXMgJiYgcmVjb3JkLmlkZW50aXRpZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlY29yZC5pZGVudGl0aWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICByZWNvcmQuaWRlbnRpdGllc1tpXS5lbWFpbCA9IGFzc2lnbklkZW50aXRpZXNQcm9wZXJ0eShyZWNvcmQuaWRlbnRpdGllc1tpXS5lbWFpbCwgcmVjb3JkLnByb2ZpbGUuZW1haWwpOwogICAgICAgICAgICAgICAgcmVjb3JkLmlkZW50aXRpZXNbaV0uZmlyc3ROYW1lID0gYXNzaWduSWRlbnRpdGllc1Byb3BlcnR5KHJlY29yZC5pZGVudGl0aWVzW2ldLmZpcnN0TmFtZSwgcmVjb3JkLnByb2ZpbGUuZmlyc3ROYW1lKTsKICAgICAgICAgICAgICAgIHJlY29yZC5pZGVudGl0aWVzW2ldLmxhc3ROYW1lID0gYXNzaWduSWRlbnRpdGllc1Byb3BlcnR5KHJlY29yZC5pZGVudGl0aWVzW2ldLmxhc3ROYW1lLCByZWNvcmQucHJvZmlsZS5sYXN0TmFtZSk7CiAgICAgICAgICAgICAgICByZWNvcmQuaWRlbnRpdGllc1tpXS5sb2NhbGUgPSBhc3NpZ25JZGVudGl0aWVzUHJvcGVydHkocmVjb3JkLmlkZW50aXRpZXNbaV0ubG9jYWxlLCByZWNvcmQucHJvZmlsZS5sb2NhbGUpOwogICAgICAgICAgICAgICAgcmVjb3JkLmlkZW50aXRpZXNbaV0uY2l0eSA9IGFzc2lnbklkZW50aXRpZXNQcm9wZXJ0eShyZWNvcmQuaWRlbnRpdGllc1tpXS5jaXR5LCByZWNvcmQucHJvZmlsZS5jaXR5KTsKICAgICAgICAgICAgICAgIHJlY29yZC5pZGVudGl0aWVzW2ldLmdlbmRlciA9IGFzc2lnbklkZW50aXRpZXNQcm9wZXJ0eShyZWNvcmQuaWRlbnRpdGllc1tpXS5nZW5kZXIsIHJlY29yZC5wcm9maWxlLmdlbmRlcik7CiAgICAgICAgICAgICAgICByZWNvcmQuaWRlbnRpdGllc1tpXS5jb3VudHJ5ID0gYXNzaWduSWRlbnRpdGllc1Byb3BlcnR5KHJlY29yZC5pZGVudGl0aWVzW2ldLmNvdW50cnksIHJlY29yZC5wcm9maWxlLmNvdW50cnkpOwogICAgICAgICAgICAgICAgcmVjb3JkLmlkZW50aXRpZXNbaV0uemlwID0gYXNzaWduSWRlbnRpdGllc1Byb3BlcnR5KHJlY29yZC5pZGVudGl0aWVzW2ldLnppcCwgcmVjb3JkLnByb2ZpbGUuemlwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAocmVjb3JkLnByZWZlcmVuY2VzKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiByZWNvcmQucHJlZmVyZW5jZXMpIHsKICAgICAgICAgICAgICAgIGlmIChrZXkgIT0gInRlcm1zIiAmJiBrZXkgIT0gInByaXZhY3kiKQogICAgICAgICAgICAgICAgICAgIHJlY29yZC5wcmVmZXJlbmNlc1trZXldLmN1c3RvbURhdGEgPSBudWxsOwogICAgICAgICAgICB9ICAgCiAgICAKICAgICAgICAgICAgaWYgKHJlY29yZC5wcmVmZXJlbmNlcy50ZXJtcykgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCB0ZXJtc0tleSBpbiByZWNvcmQucHJlZmVyZW5jZXMudGVybXMpIHsKICAgICAgICAgICAgICAgICAgICByZWNvcmQucHJlZmVyZW5jZXMudGVybXNbdGVybXNLZXldLmN1c3RvbURhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgfSAgICAgICAgCiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICBpZiAocmVjb3JkLnByZWZlcmVuY2VzLnByaXZhY3kpIHsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcHJpdmFjeUtleSBpbiByZWNvcmQucHJlZmVyZW5jZXMucHJpdmFjeSkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZC5wcmVmZXJlbmNlcy5wcml2YWN5W3ByaXZhY3lLZXldLmN1c3RvbURhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgfSAgICAgICAgCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gU3Vic2NyaXB0aW9uIGxvZ2ljCiAgICAgICAgcmVjb3JkLnN1YnNjcmlwdGlvbnMgPSB7fTsKICAgICAgICBpZiAocmVjb3JkLl9zdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICAgIGZvciAodmFyIHN1YktleSBpbiByZWNvcmQuX3N1YnNjcmlwdGlvbnMpIHsKICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbCkgewogICAgICAgICAgICAgICAgICAgIGlmICgidHJ1ZSIgPT0gInt7RE9VQkxFX09QVF9JTn19IikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4gJiYgcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uc3RhdHVzICYmIHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLnN0YXR1cyA9PT0gIkNvbmZpcm1lZCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZCA9IHByb2Nlc3NTdWJzY3JpcHRpb25zKHJlY29yZCwgc3ViS2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4gfHwgKHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLnN0YXR1cyAmJiByZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5zdGF0dXMgPT09ICJDb25maXJtZWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkID0gcHJvY2Vzc1N1YnNjcmlwdGlvbnMocmVjb3JkLCBzdWJLZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgCiAgICAgICAgcmV0dXJuIHJlY29yZDsgICAgICAgIAogICAgfQp9CgpmdW5jdGlvbiBwcm9jZXNzU3Vic2NyaXB0aW9ucyhyZWNvcmQsIHN1YktleSkgewogICAgcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XSA9IHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldOwogICAgCiAgICBpZiAocmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbikgewogICAgICAgIGxldCBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkID0gcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5kb2lDb25kaXRpb25hbGx5Q29uZmlybWVkOwogICAgICAgIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPSAoZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCAhPT0gbnVsbCAmJiBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkICE9PSB1bmRlZmluZWQpCiAgICAgICAgICAgID8gdHlwZW9mIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPT09ICJib29sZWFuIiA/IGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgOiBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkID09ICJ0cnVlIgogICAgICAgICAgICA6IG51bGw7CgogICAgICAgIHN3aXRjaCAoZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCkgewogICAgICAgICAgICBjYXNlIHRydWU6CiAgICAgICAgICAgICAgICByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLmlzRXh0ZXJuYWxseVZlcmlmaWVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIGZhbHNlOgogICAgICAgICAgICAgICAgcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5pc0V4dGVybmFsbHlWZXJpZmllZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgbnVsbDoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBsZXQgb2JqZWN0ID0ge307CiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbikgewogICAgICAgICAgICBpZiAoa2V5ICE9PSAnZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCcpIHsKICAgICAgICAgICAgICAgIG9iamVjdFtrZXldID0gcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbltrZXldOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluID0gb2JqZWN0OwogICAgfQogICAgCiAgICBkZWxldGUgcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5sYXN0VXBkYXRlZFN1YnNjcmlwdGlvblN0YXRlOwogICAgCiAgICByZXR1cm4gcmVjb3JkOwp9CgpmdW5jdGlvbiBnZW5lcmF0ZVVVSUQoKSB7CiAgIGxldCBkID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgIGNvbnN0IHV1aWQgPSAieHh4eHh4eHgteHh4eC00eHh4LXl4eHgteHh4eHh4eHh4eHh4Ii5yZXBsYWNlKC9beHldL2csIGZ1bmN0aW9uKGMpIHsKICAgICAgIGNvbnN0IHIgPSAoZCArIE1hdGgucmFuZG9tKCkqMTYpJTE2IHwgMDsKICAgICAgIGQgPSBNYXRoLmZsb29yKGQvMTYpOwogICAgICAgICAgICByZXR1cm4gKGM9PSJ4IiA/IHIgOiAociYweDN8MHg4KSkudG9TdHJpbmcoMTYpOwogICAgfSk7CiAgICByZXR1cm4gdXVpZDsKfQoKZnVuY3Rpb24gY2FsbE1lcmdlTG9naWMoIHJlY29yZCwgcHJvcGVydHlOYW1lLCBzdHJhdGVneUNob29zZW4gKSB7CiAgICBjb25zdCBfcHJvcGVydHlOYW1lID0gIl8iICsgcHJvcGVydHlOYW1lOwogICAgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdICYmICFyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdKSB7CiAgICAgICAgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXSA9IHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdOwogICAgfSBlbHNlIGlmIChyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdICYmIHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdKSB7CiAgICAgICAgaWYgKHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0ubGVuZ3RoID09PSAwICYmIHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXSA9IHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdOyAgCiAgICAgICAgZWxzZSBpZiAocmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0ubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIGNvbnN0IG1lcmdlUmVzdWx0ID0gcHJvY2Vzc01lcmdlKHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0sIHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLCBzdHJhdGVneUNob29zZW4sIHByb3BlcnR5TmFtZSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbWVyZ2VSZXN1bHQgPT09ICdzdHJpbmcnKSByZWNvcmQuX2Vycm9yRGV0YWlscyA9IG1lcmdlUmVzdWx0OwogICAgICAgICAgICBlbHNlIHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gPSBtZXJnZVJlc3VsdDsKICAgICAgICB9CiAgICB9Cn0KCmZ1bmN0aW9uIGNoZWNrVVVJRCh1dWlkKSB7CiAgICBjb25zdCByZWdleCA9IC9eWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tNFswLTlhLWZdezN9LVs4OWFiXVswLTlhLWZdezN9LVswLTlhLWZdezEyfSQvaTsKICAgIHJldHVybiByZWdleC50ZXN0KHV1aWQpOwp9CgpmdW5jdGlvbiBnZW5lcmF0ZVVVSURhbmRVcGRhdGVEYXRlKHR5cGUsIHRhcmdldCwgaSkgewogICAgaWYgKHR5cGUgPT09ICJjaGlsZCIgfHwgdHlwZSA9PT0gInBldCIpIHsKICAgICAgICBpZighY2hlY2tVVUlEKHRhcmdldFtpXS5hcHBsaWNhdGlvbkludGVybmFsSWRlbnRpZmllcikpewogICAgICAgICAgICB0YXJnZXRbaV0uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIgPSBnZW5lcmF0ZVVVSUQoKTsKICAgICAgICB9CiAgICB9Cn0KCmZ1bmN0aW9uIHByb2Nlc3NNZXJnZShleGlzdGluZ1JlY29yZEFycmF5LCBuZXdSZWNvcmRBcnJheSwgc3RyYXRlZ3ksIHR5cGUpIHsKICAgIGxldCByZXN1bHQgPSBbXTsKICAgIGxldCBjaGVjayA9IGZhbHNlOwogICAgaWYgKCBzdHJhdGVneSA9PT0gImZ1bGxSZXBsYWNlIikgewogICAgICAgIHJlc3VsdCA9IG5ld1JlY29yZEFycmF5OwogICAgICAgIGZvciAoY29uc3QgeCBpbiByZXN1bHQpIGdlbmVyYXRlVVVJRGFuZFVwZGF0ZURhdGUodHlwZSwgcmVzdWx0LCB4KTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXhpc3RpbmdSZWNvcmRBcnJheSkpIHsKICAgICAgICAgICAgcmVzdWx0ID0gQXJyYXkuZnJvbShleGlzdGluZ1JlY29yZEFycmF5KTsKICAgICAgICAgICAgZm9yIChjb25zdCBtIGluIG5ld1JlY29yZEFycmF5KSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IG4gaW4gZXhpc3RpbmdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICAgICAgKCh0eXBlID09PSAiY2hpbGQiIHx8IHR5cGUgPT09ICJwZXQiKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UmVjb3JkQXJyYXlbbV0uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtuXS5hcHBsaWNhdGlvbkludGVybmFsSWRlbnRpZmllciAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UmVjb3JkQXJyYXlbbV0uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIudG9Mb3dlckNhc2UoKSA9PT0gcmVzdWx0W25dLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyLnRvTG93ZXJDYXNlKCkpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlID09PSAiY2hpbGQiICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdSZWNvcmRBcnJheVttXS5iaXJ0aERhdGUgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtuXS5iaXJ0aERhdGUgPT09IG5ld1JlY29yZEFycmF5W21dLmJpcnRoRGF0ZSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UmVjb3JkQXJyYXlbbV0uZmlyc3ROYW1lICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbbl0uZmlyc3ROYW1lICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbbl0uZmlyc3ROYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5ld1JlY29yZEFycmF5W21dLmZpcnN0TmFtZS50b0xvd2VyQ2FzZSgpKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAodHlwZSA9PT0gInBldCIgJiYgbmV3UmVjb3JkQXJyYXlbbV0ubmFtZSAmJiByZXN1bHRbbl0ubmFtZSAmJiByZXN1bHRbbl0ubmFtZS50b0xvd2VyQ2FzZSgpID09PSBuZXdSZWNvcmRBcnJheVttXS5uYW1lLnRvTG93ZXJDYXNlKCkpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlID09PSAiZXh0ZXJuYWxBcHBsaWNhdGlvbiIgJiYgbmV3UmVjb3JkQXJyYXlbbV0uYXBwbGljYXRpb25Db2RlICYmIHJlc3VsdFtuXS5hcHBsaWNhdGlvbkNvZGUgJiYgcmVzdWx0W25dLmFwcGxpY2F0aW9uQ29kZS50b0xvd2VyQ2FzZSgpID09PSBuZXdSZWNvcmRBcnJheVttXS5hcHBsaWNhdGlvbkNvZGUudG9Mb3dlckNhc2UoKSkKICAgICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoc3RyYXRlZ3kpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyZXBsYWNlUGFydGlhbGx5IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICggY29uc3QgYXR0ck5hbWVSZXBsYWNlIGluIHJlc3VsdFtuXSApIHJlc3VsdFtuXVthdHRyTmFtZVJlcGxhY2VdID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICggY29uc3QgYXR0ck5hbWVOZXdSZXBsYWNlIGluIG5ld1JlY29yZEFycmF5W21dKSByZXN1bHRbbl1bYXR0ck5hbWVOZXdSZXBsYWNlXSA9IG5ld1JlY29yZEFycmF5W21dW2F0dHJOYW1lTmV3UmVwbGFjZV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIm1lcmdlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICggY29uc3QgYXR0ck5hbWVNZXJnZSBpbiBuZXdSZWNvcmRBcnJheVttXSApIHJlc3VsdFtuXVthdHRyTmFtZU1lcmdlXSA9IG5ld1JlY29yZEFycmF5W21dW2F0dHJOYW1lTWVyZ2VdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInNraXAiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdlbmVyYXRlVVVJRGFuZFVwZGF0ZURhdGUodHlwZSwgcmVzdWx0LCBuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIWNoZWNrICYmICh0eXBlID09PSAiY2hpbGQiIHx8IHR5cGUgPT09ICJwZXQiIHx8IHR5cGUgPT09ICJleHRlcm5hbEFwcGxpY2F0aW9uIikpIHsKICAgICAgICAgICAgICAgICAgICBnZW5lcmF0ZVVVSURhbmRVcGRhdGVEYXRlKHR5cGUsIG5ld1JlY29yZEFycmF5LCBtKTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChuZXdSZWNvcmRBcnJheVttXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjaGVjayA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGBUaGUgZXh0ZXJuYWxBcHBsaWNhdGlvbiwgY2hpbGQgYW5kL29yIHBldCBpcyBub3QgYW4gYXJyYXkuYDsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0Owp9CgpmdW5jdGlvbiBhc3NpZ25JZGVudGl0aWVzUHJvcGVydHkoaWRlbnRpdHlQcm9wZXJ0eSwgcHJvZmlsZVByb3BlcnR5KSB7CiAgICBpZiAoaWRlbnRpdHlQcm9wZXJ0eSAmJiBpZGVudGl0eVByb3BlcnR5Lmxlbmd0aCkgewogICAgICAgIGlmIChwcm9maWxlUHJvcGVydHkgJiYgcHJvZmlsZVByb3BlcnR5Lmxlbmd0aCAmJiBpZGVudGl0eVByb3BlcnR5ICE9PSBwcm9maWxlUHJvcGVydHkpIHJldHVybiBwcm9maWxlUHJvcGVydHk7CiAgICAgICAgZWxzZSByZXR1cm4gaWRlbnRpdHlQcm9wZXJ0eTsKICAgIH0KICAgIGVsc2UgcmV0dXJuIHByb2ZpbGVQcm9wZXJ0eTsKfQ==",
            "notifyLastRecord": false,
            "ECMAScriptVersion": "12"
          },
          "next": ["7A bis. Perform Merge Logic Area of Interest"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "7B. Rename Fields To Merge",
          "type": "field.rename",
          "params": {
            "fields": [
              {
                "sourceField": "data.areaOfInterest",
                "targetField": "data._areaOfInterest"
              },
              {
                "sourceField": "data.pet",
                "targetField": "data._pet"
              },
              {
                "sourceField": "data.child",
                "targetField": "data._child"
              },
              {
                "sourceField": "data.externalApplication",
                "targetField": "data._externalApplication"
              },
              {
                "sourceField": "lastUpdated",
                "targetField": "_lastUpdated"
              },
              {
                "sourceField": "data.initialAppSourceCode",
                "targetField": "data._initialAppSourceCode"
              },
              {
                "sourceField": "identities",
                "targetField": "_identities"
              },
              {
                "sourceField": "subscriptions",
                "targetField": "_subscriptions"
              }
            ]
          },
          "next": ["8B. Existing Accounts", "8C. New Accounts"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "8A. New Accounts",
          "type": "datasource.lookup.gigya.account",
          "params": {
            "select": "UID",
            "handleFieldConflicts": "take_lookup",
            "mismatchBehavior": "process",
            "lookupFields": [
              {
                "sourceField": "_phoneNumber",
                "gigyaField": "phoneNumber"
              }
            ],
            "lookupFieldsOperator": "OR",
            "matchBehavior": "remove",
            "isCaseSensitive": false,
            "from": "accounts",
            "batchSize": 200,
            "maxConcurrency": 1,
            "multiMatchBehavior": "error"
          },
          "next": ["Process new phone account error"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "6A. Existing Accounts",
          "type": "datasource.lookup.gigya.account",
          "params": {
            "select": "UID,identities,data.areaOfInterest,data.pet,data.child,data.externalApplication,lastUpdated,data.initialAppSourceCode,phoneNumber,profile.email",
            "handleFieldConflicts": "take_lookup",
            "mismatchBehavior": "remove",
            "lookupFields": [
              {
                "sourceField": "_phoneNumber",
                "gigyaField": "phoneNumber"
              },
              {
                "sourceField": "profile._email",
                "gigyaField": "loginIDs.unverifiedEmails"
              },
              {
                "sourceField": "profile._email",
                "gigyaField": "loginIDs.emails"
              }
            ],
            "lookupFieldsOperator": "OR",
            "matchBehavior": "process",
            "isCaseSensitive": false,
            "from": "accounts",
            "batchSize": 200,
            "maxConcurrency": 1,
            "multiMatchBehavior": "error"
          },
          "next": [" 7A. Perform Merge Logic", "Prepare existent accounts to extract"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "5. Generate UID and check lang",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7CiAgICByZWNvcmQuVUlEID0gJ3h4eHh4eHh4eHh4eDR4eHh5eHh4eHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beHldL2csIGZ1bmN0aW9uKGMpIHsKICAgICAgICB2YXIgciA9IE1hdGgucmFuZG9tKCkgKiAxNiB8IDAsIHYgPSBjID09ICd4JyA/IHIgOiAociAmIDB4MyB8IDB4OCk7CiAgICAgICAgcmV0dXJuIHYudG9TdHJpbmcoMTYpOwogICAgfSk7CiAgICBpZiAocmVjb3JkLnByZWZlcmVuY2VzICYmICFyZWNvcmQubGFuZykgewogICAgICAgIGlmIChyZWNvcmQucHJvZmlsZSAmJiByZWNvcmQucHJvZmlsZS5sb2NhbGUpIHsKICAgICAgICAgICAgcmVjb3JkLmxhbmcgPSByZWNvcmQucHJvZmlsZS5sb2NhbGU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICByZWNvcmQubGFuZyA9ICJlbiI7IAogICAgICAgIH0KICAgIH0KICAgIHJldHVybiByZWNvcmQ7Cn0=",
            "notifyLastRecord": false,
            "ECMAScriptVersion": "12"
          },
          "next": ["6A. PhoneNumber accounts", "6B. Email accounts"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "2. Decrypt PGP",
          "type": "file.decrypt.pgp",
          "params": {
            "pgpKey": "LS0tLS1CRUdJTiBQR1AgUFVCTElDIEtFWSBCTE9DSy0tLS0tCgptUUlOQkYwSG5iRUJFQUN5WHUrekJzanYveUlpNkFYSFBnL081b2VnRGVDTTRMaDMxY2xMMVhjK0J0dWFQb1B0CktVRHJLQXVhR1Q4cngzNGlzeExYdmJvSTVFRU96NTd5VEVxWDhMTHFadlY4U1ZFZUtVdzE1WVhKVkpFVDhFWXIKVTV0TmVvK0Zpajd1elEwWHV3a0JTOGpxMERGcFRUeXl1c3ZreHRtZWNnQW85a3FlQ0JmOEF3V0EwSXpiRmptTwpSbVBYSTBjYmMyWWplVXZ1WUkyOXVOa2hMbUM5VFVDcU9jMFlTaDJDWVZ6a3hBZjF5dGVOZ1BtQkVnRTBWNmFiCmlDMFhlSERBSTN0Z3ZxV2c0Nk8rWFNDTXZTclVndXV3aXRpbmtObXB5SWtadnFvWE9kUmtBN0hCcmc1VVRqVEMKOFM5L3lHMlF3anNvRUtRRmxhWHM2NzZJdTBwaTM2K1l0RHVuYnNITlZmbnEraSt5ZHFEcmlPRDZhRmpXNEFVYQp2NTNwOVJQQXEydDdCVnN0SklieHV2TWRRcDJJOEp0MW12NXFTeHJBOVZTeU9BMXFMcUl4NHd4T0t0RlhXZXJhCnFmVkRaV3RtS0NkQytPREpnbnVHMHdTRkQyRFY2WHN3YTNkdXJ4Sk5RaEZpc2JpTXJJTjZhc0dzSU5WUm9YNmEKd1hROEU2K2cyTjdKbitCeHpkNDllZ2h1Z3k2dHR4KzNjbTBJQ2lYVTVJRTZyZVdnNTVFU2cxdzQ4S3B1SmVtMwo2TWhUUEUwcksyY0c2em5FZUV0R0dFTzhxcXBtRDVjbmUzVzJRdGhJL3duVTR4aitpSXJaV0NSbCtYZkdlc2xYCjZkNDVMSTZBK3BpTGRkaVdUSWFZSzQ1OHVrVnFreTRRUm5SZVpqT3ZzbDY0bVlGdDFPYnlpSWhlc3dBUkFRQUIKdEIxRFNVRk5JRWx0Y0c5eWRDQThZMmxoYlVCdVpYTjBiR1V1WTI5dFBva0NUZ1FUQVFnQU9CWWhCQ2U3WkxlLwpxb2Qva2hYQUd5clJ3MnJFdzd6cUJRSmRCNTJ4QWhzREJRc0pDQWNDQmhVS0NRZ0xBZ1FXQWdNQkFoNEJBaGVBCkFBb0pFQ3JSdzJyRXc3enEwK0FQL1J0TldyR0xwK3BSV09IU1BNRlNoUUJBU1FZdUk5Sk5Sdk9vM3FhVnRpaTcKNHlvZzVKSVZ2M2VBS0tmVThhZjVPOEl6eXZKaWdoOEpTd1Blc2UzQldnT2M2amYrRStCZkdLa0ZBMGFyVFAvNgpLV0NGUzR0ZlA4VkpwVVBzVkUwbS9lanNRK0wzNW5hb0FUUnIrRmtKN0VBRldZVzhYT0xPOU94dGZDOVYyV3B0CkJQRDRmVUFXZXArQnB5ZTN3ZXBSVFNOelhHbkhKS0FjaEVCcUc1NjRTRmVCNWN2RXcydnE2RytNeTZ1MDdnRHMKZ1BUVzE4NnNrWkk2YkFOWEJucjVSaFg1YzBIRlRaNlZXTEJxYTI0U0pXNnVsemxmZWtpQlY3d0RDakxFbUljVQpId3JDSjhsSkh0dEcxT2JNYjBUT3pEb2I4anVSM1JWUFp0MzhXa3hwS0s1RmowbGlYeHgycWlacEtIN2RWYzRlCmZLNnZkWUJNcUZkL3B3SlpvOW12cHUwYTA1Nm9lMVhTcTRzbWxmalJ3WDhYMDRzb01USTEvbUxFK1c1aWJEREEKQ0tsQlNsSC9NZHdTTlQ1SXV4TzFxdUdjMjBKQ0x2WVF3OUhWVXNTMjV5NHhzNTZqa3U2MkVuZFJYZHFVM0FuSgp3TnBCOCtoNEVHVnFERmQybFVOV1hveUxZSk5IblcyUDZ6MlRyZ00wWWpqazRrTzQ2VWdzL1Zkcmd3czAzYUU3CjcwbDh3aHJLSm1GR1hJYWtJYk9qeENuRG4zaW5IV3ZGNUQ5dHkxanVkZ3dtY01rTE1OWnJ5SjEwbXRMWDlRbUkKVlRWekdRQ1RqL3laNmxGb1B5YkV0YTc3Z0N2ZlV6MEZYeEp6bzJCSjAycUdzSE1za3NJN2xqYmNSVE5IMVF6VAp1UUlOQkYwSG5iRUJFQURPVkVxeCtONWhNTHlpZEt3TjY3emN4SUVOalo2N0JPcjhOcjYydEFTY0Q2SnFMaTBvCml4b08zdUs0ZVI3YW9vWjVuMExER2hSNUVtQkZEdGVsY2VIR0dLYmFVcjRwNEt4NUdhKy8wWXlsN3lHZzNIMjEKMk1ub3lWS1NnUmVwMis3QVpPbHdWL1dablk1YmxmN0Jua21lSXowOTRodFE1T1BMa3NVUWZxZUZKemc1WmhUKwpSRzlOTUY1OE1xd2d1U3VldWVBa1JBc3NldncvSW9jbE05cHUyTEh3d0lmNHFKbG5iMEt6K3RQQjdqendPR2tCCjVOR2FIUXkvcjh2eTlIaThiSzNrWk8xK0FZcm5jdmdHSDJkUi9KRVlXU2MzWmlQZXQ2bDFWT3RPK3NlMVkzdjIKblQ1NW9UZDlRV2lkbFNPeGxiQStrckVtRDRuMUxIbHhPQit1MzRMQk1LLy9pWk1Hb0RpZUNTTHFSdlNONkRwZQo4d2J5SlQ4Mm9ITEtxN2lyYTNmeXA3blR0UUNneEdZMmVhUGU1NkVVc0FOakEvWjQyS3c4ZGRpeFFFR2paMHRrCkVXMEhNWVA2UjZlaFc4ODBFSjYxeWFhYXlJbE1zN0FEdlV4SjgzWmxReFhXVVdiMExweFRLRXdEemRlNkZxMEsKQUxzcXZOdGdhSXNXNzlYeVBRRkNqSnR6Y0JwUmJwQWo5bEl3UXU3L1lVM0E0TzBXWTBGYnNoQmxhaXlXMHI2cQo3cit2ZzE5OVovTld5SlhiUy9Ob01nZjdlSzdZL2JxOTA2VkFqVXBvUG1HdmRWMmFndzE1S29XaUZ2MU9NZi9vClVBS2tnN29ZcEdSVW9ybU9XcC8wYTUwemhpc1VCTjR0Qi9qZnkyNHJmVmR3ckRCeDNEbHNNRE90MVFBUkFRQUIKaVFJMkJCZ0JDQUFnRmlFRUo3dGt0NytxaDMrU0ZjQWJLdEhEYXNURHZPb0ZBbDBIbmJFQ0d3d0FDZ2tRS3RIRAphc1REdk9vak5SQUFpMWpzQWtheTA1eG51bU40b0J3TGpoczJUbEp6QjJqTEdmWVYvMzBQZHZWeTFrc1hHbmVaClV6a1ZRUGlqYWZlV3dGQTQwMzFSWG11b2lmczM5b0Zvek5yeXZYNTJ5WlV4a0hSMVRlbThNbzZCUmhYR2J5alcKNkZXMnJ1bFE5VUM0bEZzbUdzc2xQeGtnWVdOaE5nSlFFMTBJWHhkVGtWMnBjZndMNE9sK2YvWnpZVmV6WjliWgpqUHJxaExkcUwwWkJZV05CTnYxbVAyNlVmbTJkNnhwcGJxSGxabHplNEJVM1JwM0R2aWhzU2Frd0FiRnJQVVViClJ1dXJ1dHJ0K1pvMTY0M0VSWFo5eXpWQmZXWFU2UkU2QVVQL2RJZjlhdlV3REJpQllGc056UXlvZXovU213NzQKN0JqQU1pK1JSWDIzcCtpWVhzdm1yMjBFWGpmd3laRVhYcGVHNVhXYi9FeGNJbGIwN0hKNTl1ZHl5ODVPOFN1VgpXaWxNTFVaZUQvejhRZFhwMUdQMGI3L2dWbExCYjBTMEl5RmZwcjZJRlB5TU5pR3FOVGpqdVltV0FvODVNQzY4Cm9Bb2dCYUJHcGJmNk10TFMzMzcxcTNpR0NuTU9SaDJ6TWsvZDRLSkV5bkQ4Nm9qZHg0Z0V2R2dvK0g1M2d4ckkKOEp6MXZ5QXl5UzAzODc0M1RoVGFsck9yWVg5UnVxUWIySXVRRVh6YUhMUjdUYUxKbnRDdU5tQ00xTG5QUisxeApvSmpHSDhJOHdEdnkvS0tENjAyV2pyWjdJTnNHZzgrcndPeWxvTmcybXJ1U052VnVmaklFTDUzUnRBOHgreVlpCk1wakRLL2I4VmdYZHV6Myt2b2pka1FNeVJLM2NEYVJoV0hyS0JvVzNOVFk5Q251U2tJMWlvUUU9Cj1pMDlqCi0tLS0tRU5EIFBHUCBQVUJMSUMgS0VZIEJMT0NLLS0tLS0=",
            "pgpKey.importedPrivateKey": "LS0tLS1CRUdJTiBQR1AgUFJJVkFURSBLRVkgQkxPQ0stLS0tLQoKbFFjWUJGMEhuYkVCRUFDeVh1K3pCc2p2L3lJaTZBWEhQZy9PNW9lZ0RlQ000TGgzMWNsTDFYYytCdHVhUG9QdApLVURyS0F1YUdUOHJ4MzRpc3hMWHZib0k1RUVPejU3eVRFcVg4TExxWnZWOFNWRWVLVXcxNVlYSlZKRVQ4RVlyClU1dE5lbytGaWo3dXpRMFh1d2tCUzhqcTBERnBUVHl5dXN2a3h0bWVjZ0FvOWtxZUNCZjhBd1dBMEl6YkZqbU8KUm1QWEkwY2JjMllqZVV2dVlJMjl1TmtoTG1DOVRVQ3FPYzBZU2gyQ1lWemt4QWYxeXRlTmdQbUJFZ0UwVjZhYgppQzBYZUhEQUkzdGd2cVdnNDZPK1hTQ012U3JVZ3V1d2l0aW5rTm1weUlrWnZxb1hPZFJrQTdIQnJnNVVUalRDCjhTOS95RzJRd2pzb0VLUUZsYVhzNjc2SXUwcGkzNitZdER1bmJzSE5WZm5xK2kreWRxRHJpT0Q2YUZqVzRBVWEKdjUzcDlSUEFxMnQ3QlZzdEpJYnh1dk1kUXAySThKdDFtdjVxU3hyQTlWU3lPQTFxTHFJeDR3eE9LdEZYV2VyYQpxZlZEWld0bUtDZEMrT0RKZ251RzB3U0ZEMkRWNlhzd2EzZHVyeEpOUWhGaXNiaU1ySU42YXNHc0lOVlJvWDZhCndYUThFNitnMk43Sm4rQnh6ZDQ5ZWdodWd5NnR0eCszY20wSUNpWFU1SUU2cmVXZzU1RVNnMXc0OEtwdUplbTMKNk1oVFBFMHJLMmNHNnpuRWVFdEdHRU84cXFwbUQ1Y25lM1cyUXRoSS93blU0eGoraUlyWldDUmwrWGZHZXNsWAo2ZDQ1TEk2QStwaUxkZGlXVElhWUs0NTh1a1Zxa3k0UVJuUmVaak92c2w2NG1ZRnQxT2J5aUloZXN3QVJBUUFCCkFBLzhDMnpYcDF6UlpSeXZWK2kxdjEvaklsVVRnelhiQXNXOWV5RGgvbTREYjh2VS9YOGJTSWNpY0kyYTcwN0cKV1pjSWUzb3Q3dmRvOXZzcjRhSW5PUXp0b0QyR01FdlNWZTR2b3lJYnVXaTZGajNJOXl2UTlYaUFVNTVSOEIzOQpUdmdxYWx2aGIvTDdRUjNVZEdnWDhialRxT2xGeWpJeUtXMkdpbDNVQk12cXY5S3hSYktaa3RxV1l1ZzdFZS9sCkx4NHN0aGhRSysxWnJHMlhPN2psaktIRzJIM3kxWnJ5bU0xU1Z6VHhjL3BsYTVZMjBUUDdhTmlpK1c4T1d5TDEKV3YvZ2hicmZEbFA5RlphNUFNTmhZUk1HWFV3Q3dvUjZVbFdyVG5FMnExdFlqazB5LzIvQ1RiNzdmeEN4clVVMgpXeWdmRENQY1FoM2k1cDR4M2IzSE5uTDJUblZKOVpML2dhRXJRNUhGWDA5a2JPUzRSTWVQbzY3K1JLckowZ2F6CmZoYjdsNUlIdHdpajg1NVIxWWlyWGtQd0lxcEVIaXQ3Q2U1RWtRTEk4Nm42QnNJdHpnM3ZWKzcrTmFjS0RGRDQKK3BwTnhaYUYxdGFsWGo5N2NIS1hjOTNKNDhmc2NoYWNJekZVa2JLbjJZMGI0c2EvVWVMUHM4Y2drWkhuT3R3egppOEZ3M1o2RHVWSEdKbzdKdmJlMnFzdXdsQjFXZHprVUxEdzl5OUJvSjlTTTJhT1hsVWpQOFl6Um1ROVhkWXJQCmg0MGFuUURsN2lxT3RoNHVQSjgzZGI0ZHdPY1M1K0FGNTZlcitwZ3hpeE14ZzI1V1lEbWxMQXlHV2JqMDBXcGYKTndibDlwU3BRdmxvQnUwd1MrVlgwKzFqZEVlMVZ4SFF4bFNZenNReHJKTU9Xd1VJQU1pcEpqUjQxVXA1LzNGawpxc0hOS29BSndzakQ0TFpLeTRrWVJCUElHMXhDL3VtdlFFK3luL0VxczdvYm9raVU5aDBoWUJ5OXF5c2trK2pICldhZ0NTQjAyU0pNK25mSVcxazhVWTRnSHJBd3hJSC9BY1dtSUlLZmZYb1VzMENYMGhsdEUyTGxaS2pWd0hEdkoKbTJSbG8yeU5McHVtSkd0TCtGU3QveTVRTEY3VlNYck1HaDA1YVE1OGZORDFhcG5yKy9tekE1bkdIMFNUeEU5agorellpM3Axak91UkVUZmE1cWl6anJhNGZGVWlJeWFRdThpakRaUGNUUVBYTTBaK1pBMTJFUlFNbFBzK1ZZWlFECndkMXl2RUFmK0JsMG1KNFBzb2VKdHF3TElvZHFhV1lUS0VzeG5lbU43TTdMaDJzdWRsQ1c4MFh0a2owc3NZNmIKWXNmdUd0MElBT09RR1Jvai9zbFJ2ZzV2ODhUNElOMWtvRXI3OUZnWk1kb1VURS9vN2FjWjlMN0E1c25qdWp3UgpBM2dLNXpHelBPeVAxdW80ellEdWMycStBSjNQcXdoTDFleXNCWWNWVFg0Y3F1M3c3Qkk5VW5UbG9ObytHb3FyCi9JN3VCaThGNys1a2w3K3ovb3JwelAxc1RCdHNVRUs1V0YyVFdobnN2aGR4OVRWSDNZLzFuY3Y5dFdEWWVWR1gKZ0FTcUI3L2xCWkI5UmNkTDl4Y3haUU5ZeitoVFQyeEIvbDZXNDBSZHc0cUJ2UVNoV3NpcUFESEdsS1o3QysrSgpSZUhreU5iWFljUndhQnA2eExiS1NZeWM3WW5YMU03YUFMc3licGVpMkxDWHowNWNpWm9FNkl6UWRhamVEZlByCjNHK2Z3WXhUbU9yZ0pabmYwUUx1TUhWNFJFSzUzczhJQUs5cGNOQ09EODZxZGtrRmlGaWEwZ2tSZjRTTjBGK3IKZzJFT3F4UkJ5VlRoRzdUVTRVcEgrN0oySFlyV1ErVjg5b05oZjlIcTNKMXlEN1Z4Q2Q5UGRlVTBVTEJ3YTFEVQoyVGdHZ3kzVEgvcFQ5Zjl3MUpOd2lQZjZOODNUQTFGUG03R1hBVlhaMXRsYTZiMGE5T1NWSXQ0cVpMRXRIZnNpCllJN1pWSVFpL0ZiVXF2WnRBSzB6VnRZaFdUVDdPalVzQ2owbWNNNmJBRHhlZ1ZSRTNyTjJ0VGJxemRiR1U0ZTYKVmU2UDdWMmlUbUtkSWNBZVAzVFBZQzMyNEdCck1zUC8rdWZReWQ4RkY3U1paWlUrKzI0TUJRMlUwejBpdUxVbgo5WGRKZGR0dVVwUFZoeUdLc29XaVB3cTltK0ovMFRoaUxTOUJKdkJoa3M4K0ZTMVdIRjBtSU9hVW1MUWRRMGxCClRTQkpiWEJ2Y25RZ1BHTnBZVzFBYm1WemRHeGxMbU52YlQ2SkFrNEVFd0VJQURnV0lRUW51MlMzdjZxSGY1SVYKd0JzcTBjTnF4TU84NmdVQ1hRZWRzUUliQXdVTENRZ0hBZ1lWQ2drSUN3SUVGZ0lEQVFJZUFRSVhnQUFLQ1JBcQowY05xeE1PODZ0UGdELzBiVFZxeGk2ZnFVVmpoMGp6QlVvVUFRRWtHTGlQU1RVYnpxTjZtbGJZb3UrTXFJT1NTCkZiOTNnQ2luMVBHbitUdkNNOHJ5WW9JZkNVc0Qzckh0d1ZvRG5PbzMvaFBnWHhpcEJRTkdxMHovK2lsZ2hVdUwKWHovRlNhVkQ3RlJOSnYzbzdFUGk5K1oycUFFMGEvaFpDZXhBQlZtRnZGeml6dlRzYlh3dlZkbHFiUVR3K0gxQQpGbnFmZ2FjbnQ4SHFVVTBqYzF4cHh5U2dISVJBYWh1ZXVFaFhnZVhMeE1OcjZ1aHZqTXVydE80QTdJRDAxdGZPCnJKR1NPbXdEVndaNitVWVYrWE5CeFUyZWxWaXdhbXR1RWlWdXJwYzVYM3BJZ1ZlOEF3b3l4SmlIRkI4S3dpZkoKU1I3YlJ0VG16RzlFenN3NkcvSTdrZDBWVDJiZC9GcE1hU2l1Ulk5SllsOGNkcW9tYVNoKzNWWE9Ibnl1cjNXQQpUS2hYZjZjQ1dhUFpyNmJ0R3RPZXFIdFYwcXVMSnBYNDBjRi9GOU9MS0RFeU5mNWl4UGx1WW13d3dBaXBRVXBSCi96SGNFalUrU0xzVHRhcmhuTnRDUWk3MkVNUFIxVkxFdHVjdU1iT2VvNUx1dGhKM1VWM2FsTndKeWNEYVFmUG8KZUJCbGFneFhkcFZEVmw2TWkyQ1RSNTF0aitzOWs2NEROR0k0NU9KRHVPbElMUDFYYTRNTE5OMmhPKzlKZk1JYQp5aVpoUmx5R3BDR3pvOFFwdzU5NHB4MXJ4ZVEvYmN0WTduWU1KbkRKQ3pEV2E4aWRkSnJTMS9VSmlGVTFjeGtBCms0LzhtZXBSYUQ4bXhMV3UrNEFyMzFNOUJWOFNjNk5nU2ROcWhyQnpMSkxDTzVZMjNFVXpSOVVNMDUwSEdBUmQKQjUyeEFSQUF6bFJLc2ZqZVlUQzhvblNzRGV1ODNNU0JEWTJldXdUcS9EYSt0clFFbkEraWFpNHRLSXNhRHQ3aQp1SGtlMnFLR2VaOUN3eG9VZVJKZ1JRN1hwWEhoeGhpbTJsSytLZUNzZVJtdnY5R01wZThob054OXRkako2TWxTCmtvRVhxZHZ1d0dUcGNGZjFtWjJPVzVYK3daNUpuaU05UGVJYlVPVGp5NUxGRUg2bmhTYzRPV1lVL2tSdlRUQmUKZkRLc0lMa3Jucm5nSkVRTExIcjhQeUtISlRQYWJ0aXg4TUNIK0tpWloyOUNzL3JUd2U0ODhEaHBBZVRSbWgwTQp2Ni9MOHZSNHZHeXQ1R1R0ZmdHSzUzTDRCaDluVWZ5UkdGa25OMllqM3JlcGRWVHJUdnJIdFdONzlwMCtlYUUzCmZVRm9uWlVqc1pXd1BwS3hKZytKOVN4NWNUZ2ZydCtDd1RDdi80bVRCcUE0bmdraTZrYjBqZWc2WHZNRzhpVS8KTnFCeXlxdTRxMnQzOHFlNTA3VUFvTVJtTm5tajN1ZWhGTEFEWXdQMmVOaXNQSFhZc1VCQm8yZExaQkZ0QnpHRAora2Vub1Z2UE5CQ2V0Y21tbXNpSlRMT3dBNzFNU2ZOMlpVTVYxbEZtOUM2Y1V5aE1BODNYdWhhdENnQzdLcnpiCllHaUxGdS9WOGowQlFveWJjM0FhVVc2UUkvWlNNRUx1LzJGTndPRHRGbU5CVzdJUVpXb3NsdEsrcXU2L3I0TmYKZldmelZzaVYyMHZ6YURJSCszaXUyUDI2dmRPbFFJMUthRDVocjNWZG1vTU5lU3FGb2hiOVRqSC82RkFDcElPNgpHS1JrVktLNWpscWY5R3VkTTRZckZBVGVMUWY0Mzh0dUszMVhjS3d3Y2R3NWJEQXpyZFVBRVFFQUFRQVArUUVnCkhaNXJqcFZJb21oUXJaR0EzdTdXejN2d1RwdjYrQmsrU1paek1kQStDT1crVmRwZ3lBVFJab2wybzlNQXEvelgKV0xtaGNwMVZUQjJpZUtZb3ZydGttbUNMcndraHRqMUk4WE1JVDh1NXIzTXRiYVF4RkdaQXd3ZVA1WUx2bGRDUApSUGhTZHg3YnQyZU4xVVFWaHd2WmtTcU1NTDlnZ0kzNlVDODNMUWZLQ21HYko4NjhqN1lEMDR3ZEUzM3dSN1pFCkViY3NubUdGM2RTUXQyWlpFY1dnSVdTQVJ0QU9lV0NDaW5PVnJuL25OZktkYTlsZHFTMlJXcnAzb3hNUUs3NEsKbXk1TG5jdDdRZDFyMVM0V1N2VWVncFl0MFQwS2ZKRzN6UVM4ZFk2cWpyZTlqa2JDWXU3ZnBJQS9PK0R5eVZTZApQeCttdHljQXRSNTFDRWdxaDYrejV5WCt0dlJub1F5V2tBN0k1ZExEaHN0RW5McFozUW1Ec3V5WjVwZDRDS1BOClVacGU1di8wRDQ2dW1iQUliM1I1bEt2b1V2K1UwYVVXZDJJcDVEdER1VTd0OWk3L090a09RS2RKU25xSlJMOFkKd0VIWFdvcU1UVHA3U1dBMHo2Q29HSm43cDhHQ1RNUDdsQlUwWjdHUkFuaUljVVc5YnN4MkcvQUc4S29QVWF6eQpPUjVkVzFiUVpNY003S2xWRVVyZkowYzFCWGFGOVhkellFWW12QnFaYzUyR0Jrd0g1bFRKYkt2dWtLazF0MmVBClluWmJ3Rm9CeFQ1UVlSS3NTOFVsSWhFYnFkd1JicURwSk1oTzZwVEFFNFpLWEozUzR6cUJSN3NJN09KT0VNUC8KVGxiblZXeFN2cWVvdDdVYmpVQUFSSjgwcXA3b3dUT010cVdqcmxOcENBRGRnM2ExODVZejZMcGxYeWxlUG1KMApLWEEzQUtEcGtmV3hXcGpBRzhFaEtKYzcvNWdvZGtXZFdsUkR4eVpETEVEMGU2VG92MlN3bEdHeHlqUURjQXNNCkdxZ3hDd09QcWhsRjhLcjhxTkc5OEFNMllVd1ppVE5xalVRMEdZaHpXU1MzOGloSGtnYkpvcXc1cU1URnlmVXgKSG9pUkl2V25BandFRFVqL1RtRUdCRXI0YmtFUDZtWFFEZlR4d3BISnh2cUdFNVRGc2c3d1NibGpiSFBRRVRDNQpzbVl0QnF2Z1l5THMvT1p0N29iSDI4YzdLd1QwK0tjY21UVnl6bWF4b3RqRkNsMzFOMDRXTWdEdmhPV3JzTFd0ClBJQy9kNkhZVllENVUxeWllM1NnSjQyd2NtaXpldUlkTTJwREF5Zk0zVzI2K2xZZ3ZZeE11cGFnU2dTYjBmNVoKQ0FEdWM2YThwOEJNR1hHMGNjaEQ4UXNlZTJOT1VpaDdJQVV4b0hQcWE1OXNpNmJlWWRiSUp6aFZxMDJXYnJaVgpmVkJWeUp4Y0xTR2ttUFJUbDZSbjcxSHBpbTBkdlZzdkpZazRKYXlDNWJTTE02Tm9Ccyt5Z3o4RXkyVkxXQm4wCmlKQVFVck5EQXRpWDZyL1RoYW1wUlRpSjhKZnlxc1E3WHFPZll0MWVhZEFGdnBHZlpJdmxOYkJnV0I0UlY5R3cKbDhJTnlDUENSK3NKc2laZXRWenZXZ0tzS2h5K1hGV1E1NTVuWHdQOC91MlAxQXdKVVNGMndBcGpRbUNZQkxGRAo3Wi8va2dQWFREUG96T2lxRTdRZG5WK2ZxalBQY215eHlGRjJiZFhUNDFiWEErNW9UU2NsTklJUm1qV01LTW92CmZWTGZXZktuYUtITE9mcmNEZVBlRHBQZENBREFJSC8ra2tjUklnd2lhYmZXSGRKK1NhQ3ZHUG5ONkJNNHczODAKQVcxOEp2MGo3b2V6Y0ZSWjZSejQzYzZYVzh0Q2ZVT2cyb2ZCU1EyeDZEd3BSb3VlZkJ4TVQ2a2lPRlFjb3duZQpXVVRLbkJUR092Um1wRElhbkhocWZGODNhenQ5djF5TlRZc2dnNVFSNnlqWm13ZGZxVnJmWnNOMU04bzRqUHFBCnI2U1Azb05SZlM5RElzUjVubXVhYy9HSE80QnRaRkszeHpzUTFVL05md2hoSlFubTZvVE9rUEVQeWN6S2dZK1QKWTVrU0Nrb3RhQUhxZi8xMklSYVNieEdzeFBZNVpsc0tEazBkWEx1bWVtTFN0YlE3Y2pucThJbTdUZHJvdy9FNgo5dm9HOWJFeFZwTEIxSk9DeXdiZ2RobldEOFhlWGNma0lWczNGUUtvSDcwNUNDYjZkak9KQWpZRUdBRUlBQ0FXCklRUW51MlMzdjZxSGY1SVZ3QnNxMGNOcXhNTzg2Z1VDWFFlZHNRSWJEQUFLQ1JBcTBjTnF4TU84NmlNMUVBQ0wKV093Q1JyTFRuR2U2WTNpZ0hBdU9HelpPVW5NSGFNc1o5aFgvZlE5MjlYTFdTeGNhZDVsVE9SVkErS05wOTViQQpVRGpUZlZGZWE2aUoremYyZ1dqTTJ2SzlmbmJKbFRHUWRIVk42Ynd5am9GR0ZjWnZLTmJvVmJhdTZWRDFRTGlVCld5WWF5eVUvR1NCaFkyRTJBbEFUWFFoZkYxT1JYYWx4L0F2ZzZYNS85bk5oVjdObjF0bU0rdXFFdDJvdlJrRmgKWTBFMi9XWS9icFIrYlozckdtbHVvZVZtWE43Z0ZUZEduY08rS0d4SnFUQUJzV3M5UlJ0RzY2dTYydTM1bWpYcgpqY1JGZG4zTE5VRjlaZFRwRVRvQlEvOTBoLzFxOVRBTUdJRmdXdzNOREtoN1A5S2JEdmpzR01BeUw1RkZmYmVuCjZKaGV5K2F2YlFSZU4vREprUmRlbDRibGRadjhURndpVnZUc2NubjI1M0xMems3eEs1VmFLVXd0Umw0UC9QeEIKMWVuVVkvUnZ2K0JXVXNGdlJMUWpJVittdm9nVS9JdzJJYW8xT09PNWlaWUNqemt3THJ5Z0NpQUZvRWFsdC9veQowdExmZnZXcmVJWUtjdzVHSGJNeVQ5M2dva1RLY1B6cWlOM0hpQVM4YUNqNGZuZURHc2p3blBXL0lETEpMVGZ6CnZqZE9GTnFXczZ0aGYxRzZwQnZZaTVBUmZOb2N0SHROb3NtZTBLNDJZSXpVdWM5SDdYR2dtTVlmd2p6QU8vTDgKb29QclRaYU90bnNnMndhRHo2dkE3S1dnMkRhYXU1STI5VzUrTWdRdm5kRzBEekg3SmlJeW1NTXI5dnhXQmQyNwpQZjYraU4yUkF6SkVyZHdOcEdGWWVzb0doYmMxTmowS2U1S1FqV0toQVE9PQo9ZmtPRAotLS0tLUVORCBQR1AgUFJJVkFURSBLRVkgQkxPQ0stLS0tLQ=="
          },
          "next": ["3. Parse JSON"],
          "error": []
        },
        {
          "id": "3. Parse JSON",
          "type": "file.parse.json",
          "params": {
            "addFilename": false
          },
          "next": ["4. Add data.idxImportJobId"],
          "error": []
        },
        {
          "id": "1. Read From Blob Storage",
          "type": "datasource.read.azure.blob_token",
          "params": {
            "baseUri": "{{AZURE_BASE_URI}}",
            "accessToken": "********",
            "container": "{{AZURE_CONTAINER}}",
            "blobPrefix": "{{AZURE_BLOB_PREFIX}}"
          },
          "next": ["2. Decrypt PGP"],
          "error": []
        },
        {
          "id": "6A. PhoneNumber accounts",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgaWYocmVjb3JkLnBob25lTnVtYmVyKQ0KICAgICAgICByZXR1cm4gcmVjb3JkOw0KfQ==",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["7A. Rename Fields To Merge"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "6B. Email accounts",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgaWYoIXJlY29yZC5waG9uZU51bWJlcikNCiAgICAgICAgcmV0dXJuIHJlY29yZDsNCn0=",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["7B. Rename Fields To Merge"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "8B. Existing Accounts",
          "type": "datasource.lookup.gigya.account",
          "params": {
            "select": "UID,data.areaOfInterest,data.pet,data.child,data.externalApplication,lastUpdated,data.initialAppSourceCode",
            "handleFieldConflicts": "take_lookup",
            "mismatchBehavior": "remove",
            "lookupFields": [
              {
                "sourceField": "profile.email",
                "gigyaField": "loginIDs.emails"
              },
              {
                "sourceField": "profile.email",
                "gigyaField": "loginIDs.unverifiedEmails"
              }
            ],
            "lookupFieldsOperator": "OR",
            "matchBehavior": "process",
            "isCaseSensitive": false,
            "from": "accounts",
            "batchSize": 200,
            "maxConcurrency": 1,
            "multiMatchBehavior": "error"
          },
          "next": [" 9B. Perform Merge Logic", "Prepare existent accounts to extract"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": " 9B. Perform Merge Logic",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgewogICAgY29uc3QgY2hlY2tMYXN0VXBkYXRlZCA9IGZhbHNlOwogICAgY29uc3QgbWVyZ2VDaGlsZCA9IHRydWU7CiAgICBjb25zdCBtZXJnZVBldCA9IHRydWU7CiAgICBjb25zdCBtZXJnZUV4dGVybmFsQXBwbGljYXRpb24gPSB0cnVlOwoKICAgIGlmIChjaGVja0xhc3RVcGRhdGVkICYmIHJlY29yZC5sYXN0VXBkYXRlZCA+IHJlY29yZC5fbGFzdFVwZGF0ZWQpIHJldHVybjsKCiAgICAvLyBXZSB1cGRhdGUgaW5pdGlhbEFwcFNvdXJjZUNvZGUgb25seSBpZiBpdCBkb2Vzbid0IGV4aXN0IGluIHRoZSBzeXN0ZW0KICAgIGlmIChyZWNvcmQuZGF0YSAmJiByZWNvcmQuZGF0YS5faW5pdGlhbEFwcFNvdXJjZUNvZGUgJiYgIXJlY29yZC5kYXRhLmluaXRpYWxBcHBTb3VyY2VDb2RlKSByZWNvcmQuZGF0YS5pbml0aWFsQXBwU291cmNlQ29kZSA9IHJlY29yZC5kYXRhLl9pbml0aWFsQXBwU291cmNlQ29kZTsKCiAgICBjb25zdCBzdHJhdGVneUNob29zZW4gPSAie3tNRVJHRV9TVFJBVEVHWX19IjsKCiAgICAvLyBBcHBseSBtZXJnZSBsb2dpY3MKICAgIGlmIChtZXJnZUNoaWxkKSBjYWxsTWVyZ2VMb2dpYyhyZWNvcmQsICJjaGlsZCIsIHN0cmF0ZWd5Q2hvb3Nlbik7CiAgICBpZiAobWVyZ2VQZXQpIGNhbGxNZXJnZUxvZ2ljKHJlY29yZCwgInBldCIsIHN0cmF0ZWd5Q2hvb3Nlbik7CiAgICBpZiAobWVyZ2VFeHRlcm5hbEFwcGxpY2F0aW9uKSBjYWxsTWVyZ2VMb2dpYyhyZWNvcmQsICJleHRlcm5hbEFwcGxpY2F0aW9uIiwgc3RyYXRlZ3lDaG9vc2VuKTsKICAgIAogICAgaWYgKHJlY29yZC5fZXJyb3JEZXRhaWxzICYmIHJlY29yZC5fZXJyb3JEZXRhaWxzLmxlbmd0aCkgewogICAgICAgIGVycm9yLmFjY2VwdChyZWNvcmQsIHJlY29yZCk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIElkZW50aXRpZXMgbG9naWNzCiAgICAgICAgaWYgKHJlY29yZC5faWRlbnRpdGllcyAmJiByZWNvcmQuX2lkZW50aXRpZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBsZXQgaWRlbnRpdGllcyA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlY29yZC5faWRlbnRpdGllcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXlXb3JkIGluIFsiZW1haWwiLCAiZmlyc3ROYW1lIiwgImxhc3ROYW1lIiwgImxvY2FsZSIsICJjaXR5IiwgImdlbmRlciIsICJjb3VudHJ5IiwgInppcCJdKQogICAgICAgICAgICAgICAgICAgIHJlY29yZC5faWRlbnRpdGllc1tpXVtrZXlXb3JkXSA9IGFzc2lnbklkZW50aXRpZXNQcm9wZXJ0eShyZWNvcmQuX2lkZW50aXRpZXNbaV1ba2V5V29yZF0sIHJlY29yZC5wcm9maWxlW2tleVdvcmRdKTsKICAgICAgICAgICAgICAgIGlkZW50aXRpZXMucHVzaChyZWNvcmQuX2lkZW50aXRpZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlY29yZC5pZGVudGl0aWVzID0gaWRlbnRpdGllczsKICAgICAgICB9CiAgICAKICAgICAgICAvLyBQcmVmZXJlbmNlcyBsb2dpYwogICAgICAgIGlmIChyZWNvcmQucHJlZmVyZW5jZXMpCiAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIHJlY29yZC5wcmVmZXJlbmNlcykgewogICAgICAgICAgICAgICAgaWYgKGtleSAhPSAidGVybXMiICYmIGtleSAhPSAicHJpdmFjeSIpIHJlY29yZC5wcmVmZXJlbmNlc1trZXldLmN1c3RvbURhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgZWxzZSBmb3IgKGNvbnN0IHByZWZJbmRleCBpbiByZWNvcmQucHJlZmVyZW5jZXNba2V5XSkgcmVjb3JkLnByZWZlcmVuY2VzW2tleV1bcHJlZkluZGV4XS5jdXN0b21EYXRhID0gbnVsbDsKICAgICAgICAgICAgfQogICAgCiAgICAgICAgLy8gU3Vic2NyaXB0aW9uIGxvZ2ljCiAgICAgICAgcmVjb3JkLnN1YnNjcmlwdGlvbnMgPSB7fTsKICAgICAgICBpZiAocmVjb3JkLl9zdWJzY3JpcHRpb25zKSB7CiAgICAgICAgICAgIGZvciAodmFyIHN1YktleSBpbiByZWNvcmQuX3N1YnNjcmlwdGlvbnMpIHsKICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbCkgewogICAgICAgICAgICAgICAgICAgIGlmICgidHJ1ZSIgPT0gInt7RE9VQkxFX09QVF9JTn19IikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4gJiYgcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4uc3RhdHVzICYmIHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLnN0YXR1cyA9PT0gIkNvbmZpcm1lZCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZCA9IHByb2Nlc3NTdWJzY3JpcHRpb25zKHJlY29yZCwgc3ViS2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4gfHwgKHJlY29yZC5fc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLnN0YXR1cyAmJiByZWNvcmQuX3N1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5zdGF0dXMgPT09ICJDb25maXJtZWQiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkID0gcHJvY2Vzc1N1YnNjcmlwdGlvbnMocmVjb3JkLCBzdWJLZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gcmVjb3JkOyAgICAgICAgCiAgICB9Cn0KCmZ1bmN0aW9uIHByb2Nlc3NTdWJzY3JpcHRpb25zKHJlY29yZCwgc3ViS2V5KSB7CiAgICByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldID0gcmVjb3JkLl9zdWJzY3JpcHRpb25zW3N1YktleV07CgogICAgaWYgKHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4pIHsKICAgICAgICBsZXQgb2JqZWN0ID0ge307CiAgICAgICAgbGV0IGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPSByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluLmRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQ7CiAgICAgICAgY29uc3QgY29uZGl0aW9uYWxseVByZXNlbnQgPSBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkICE9PSBudWxsICYmIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgIT09IHVuZGVmaW5lZDsKICAgICAgICBjb25zdCBjb25kaXRpb25hbGx5SXNCb29sID0gdHlwZW9mIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPT09ICJib29sZWFuIjsKCiAgICAgICAgaWYgKGNvbmRpdGlvbmFsbHlQcmVzZW50KSBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkID0gY29uZGl0aW9uYWxseUlzQm9vbCA/IGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgOiBkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkID09ICJ0cnVlIjsKICAgICAgICBlbHNlIGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQgPSBudWxsOwoKICAgICAgICBpZiAoZG9pQ29uZGl0aW9uYWxseUNvbmZpcm1lZCAhPT0gbnVsbCkgcmVjb3JkLnN1YnNjcmlwdGlvbnNbc3ViS2V5XS5lbWFpbC5kb3VibGVPcHRJbi5pc0V4dGVybmFsbHlWZXJpZmllZCA9IGRvaUNvbmRpdGlvbmFsbHlDb25maXJtZWQ7CgogICAgICAgIGZvciAoY29uc3Qga2V5IGluIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4pIGlmIChrZXkgIT09ICJkb2lDb25kaXRpb25hbGx5Q29uZmlybWVkIikgb2JqZWN0W2tleV0gPSByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmRvdWJsZU9wdEluW2tleV07CgogICAgICAgIHJlY29yZC5zdWJzY3JpcHRpb25zW3N1YktleV0uZW1haWwuZG91YmxlT3B0SW4gPSBvYmplY3Q7CiAgICB9CiAgICAKICAgIGRlbGV0ZSByZWNvcmQuc3Vic2NyaXB0aW9uc1tzdWJLZXldLmVtYWlsLmxhc3RVcGRhdGVkU3Vic2NyaXB0aW9uU3RhdGU7CgogICAgcmV0dXJuIHJlY29yZDsKfQoKZnVuY3Rpb24gZ2VuZXJhdGVVVUlEKCkgewogICAgbGV0IGQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIGNvbnN0IHV1aWQgPSAieHh4eHh4eHgteHh4eC00eHh4LXl4eHgteHh4eHh4eHh4eHh4Ii5yZXBsYWNlKC9beHldL2csIGZ1bmN0aW9uIChjKSB7CiAgICAgICAgY29uc3QgciA9IChkICsgTWF0aC5yYW5kb20oKSAqIDE2KSAlIDE2IHwgMDsKICAgICAgICBkID0gTWF0aC5mbG9vcihkIC8gMTYpOwogICAgICAgIHJldHVybiAoYyA9PSAieCIgPyByIDogKHIgJiAweDMpIHwgMHg4KS50b1N0cmluZygxNik7CiAgICB9KTsKICAgIHJldHVybiB1dWlkOwp9CgpmdW5jdGlvbiBjYWxsTWVyZ2VMb2dpYyhyZWNvcmQsIHByb3BlcnR5TmFtZSwgc3RyYXRlZ3lDaG9vc2VuKSB7CiAgICBjb25zdCBfcHJvcGVydHlOYW1lID0gIl8iICsgcHJvcGVydHlOYW1lOwogICAgY29uc3Qgb25seVVuZGVyU2NvcmUgPSByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXSAmJiAhcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXTsKICAgIGNvbnN0IGJvdGhDYXNlcyA9IHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV07CiAgICBjb25zdCBub3JtYWxMZW5naHQgPSByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdICYmIHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0ubGVuZ3RoID09PSAwOwogICAgY29uc3QgdW5kZXJTY29yZUxlbmdodCA9IHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdICYmIHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMDsKCiAgICBpZiAoKG9ubHlVbmRlclNjb3JlICYmIHVuZGVyU2NvcmVMZW5naHQpIHx8IChib3RoQ2FzZXMgJiYgbm9ybWFsTGVuZ2h0ICYmIHVuZGVyU2NvcmVMZW5naHQpKSByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV07CiAgICBlbHNlIGlmIChib3RoQ2FzZXMgJiYgdW5kZXJTY29yZUxlbmdodCkgewogICAgICAgIGNvbnN0IG1lcmdlUmVzdWx0ID0gcHJvY2Vzc01lcmdlKHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0sIHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLCBzdHJhdGVneUNob29zZW4sIHByb3BlcnR5TmFtZSk7CiAgICAgICAgaWYgKHR5cGVvZiBtZXJnZVJlc3VsdCA9PT0gJ3N0cmluZycpIHJlY29yZC5fZXJyb3JEZXRhaWxzID0gbWVyZ2VSZXN1bHQ7CiAgICAgICAgZWxzZSByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gbWVyZ2VSZXN1bHQ7CiAgICB9Cn0KCmZ1bmN0aW9uIGFzc2lnbklkZW50aXRpZXNQcm9wZXJ0eShpZGVudGl0eVByb3BlcnR5LCBwcm9maWxlUHJvcGVydHkpIHsKICAgIGlmIChpZGVudGl0eVByb3BlcnR5ICYmIGlkZW50aXR5UHJvcGVydHkubGVuZ3RoKSB7CiAgICAgICAgaWYgKHByb2ZpbGVQcm9wZXJ0eSAmJiBwcm9maWxlUHJvcGVydHkubGVuZ3RoICYmIGlkZW50aXR5UHJvcGVydHkgIT09IHByb2ZpbGVQcm9wZXJ0eSkgcmV0dXJuIHByb2ZpbGVQcm9wZXJ0eTsKICAgICAgICBlbHNlIHJldHVybiBpZGVudGl0eVByb3BlcnR5OwogICAgfSBlbHNlIHJldHVybiBwcm9maWxlUHJvcGVydHk7Cn0KCmZ1bmN0aW9uIGNoZWNrVVVJRCh1dWlkKSB7CiAgICBjb25zdCByZWdleCA9IC9eWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tNFswLTlhLWZdezN9LVs4OWFiXVswLTlhLWZdezN9LVswLTlhLWZdezEyfSQvaTsKICAgIHJldHVybiByZWdleC50ZXN0KHV1aWQpOwp9CgpmdW5jdGlvbiBnZW5lcmF0ZVVVSURhbmRVcGRhdGVEYXRlKHR5cGUsIHRhcmdldCwgaSkgewogICAgaWYgKHR5cGUgPT09ICJjaGlsZCIgfHwgdHlwZSA9PT0gInBldCIpIHsKICAgICAgICBpZighY2hlY2tVVUlEKHRhcmdldFtpXS5hcHBsaWNhdGlvbkludGVybmFsSWRlbnRpZmllcikpewogICAgICAgICAgICB0YXJnZXRbaV0uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIgPSBnZW5lcmF0ZVVVSUQoKTsKICAgICAgICB9CiAgICB9Cn0KCmZ1bmN0aW9uIHByb2Nlc3NNZXJnZShleGlzdGluZ1JlY29yZEFycmF5LCBuZXdSZWNvcmRBcnJheSwgc3RyYXRlZ3ksIHR5cGUpIHsKICAgIGxldCByZXN1bHQgPSBbXTsKICAgIGxldCBjaGVjayA9IGZhbHNlOwogICAgaWYgKHN0cmF0ZWd5ID09PSAiZnVsbFJlcGxhY2UiKSB7CiAgICAgICAgcmVzdWx0ID0gbmV3UmVjb3JkQXJyYXk7CiAgICAgICAgZm9yIChjb25zdCB4IGluIHJlc3VsdCkgZ2VuZXJhdGVVVUlEYW5kVXBkYXRlRGF0ZSh0eXBlLCByZXN1bHQsIHgpOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShleGlzdGluZ1JlY29yZEFycmF5KSkgewogICAgICAgICAgICByZXN1bHQgPSBBcnJheS5mcm9tKGV4aXN0aW5nUmVjb3JkQXJyYXkpOwogICAgICAgICAgICBmb3IgKGNvbnN0IG0gaW4gbmV3UmVjb3JkQXJyYXkpIHsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgbiBpbiBleGlzdGluZ1JlY29yZEFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKCh0eXBlID09PSAiY2hpbGQiIHx8IHR5cGUgPT09ICJwZXQiKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1JlY29yZEFycmF5W21dLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0W25dLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UmVjb3JkQXJyYXlbbV0uYXBwbGljYXRpb25JbnRlcm5hbElkZW50aWZpZXIudG9Mb3dlckNhc2UoKSA9PT0gcmVzdWx0W25dLmFwcGxpY2F0aW9uSW50ZXJuYWxJZGVudGlmaWVyLnRvTG93ZXJDYXNlKCkpIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAodHlwZSA9PT0gImNoaWxkIiAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1JlY29yZEFycmF5W21dLmJpcnRoRGF0ZSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtuXS5iaXJ0aERhdGUgPT09IG5ld1JlY29yZEFycmF5W21dLmJpcnRoRGF0ZSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1JlY29yZEFycmF5W21dLmZpcnN0TmFtZSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFtuXS5maXJzdE5hbWUgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbbl0uZmlyc3ROYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5ld1JlY29yZEFycmF5W21dLmZpcnN0TmFtZS50b0xvd2VyQ2FzZSgpKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKHR5cGUgPT09ICJwZXQiICYmIG5ld1JlY29yZEFycmF5W21dLm5hbWUgJiYgcmVzdWx0W25dLm5hbWUgJiYgcmVzdWx0W25dLm5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmV3UmVjb3JkQXJyYXlbbV0ubmFtZS50b0xvd2VyQ2FzZSgpKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKHR5cGUgPT09ICJleHRlcm5hbEFwcGxpY2F0aW9uIiAmJiBuZXdSZWNvcmRBcnJheVttXS5hcHBsaWNhdGlvbkNvZGUgJiYgcmVzdWx0W25dLmFwcGxpY2F0aW9uQ29kZSAmJiByZXN1bHRbbl0uYXBwbGljYXRpb25Db2RlLnRvTG93ZXJDYXNlKCkgPT09IG5ld1JlY29yZEFycmF5W21dLmFwcGxpY2F0aW9uQ29kZS50b0xvd2VyQ2FzZSgpKQogICAgICAgICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChzdHJhdGVneSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAicmVwbGFjZVBhcnRpYWxseSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBhdHRyTmFtZVJlcGxhY2UgaW4gcmVzdWx0W25dKSByZXN1bHRbbl1bYXR0ck5hbWVSZXBsYWNlXSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBhdHRyTmFtZU5ld1JlcGxhY2UgaW4gbmV3UmVjb3JkQXJyYXlbbV0pIHJlc3VsdFtuXVthdHRyTmFtZU5ld1JlcGxhY2VdID0gbmV3UmVjb3JkQXJyYXlbbV1bYXR0ck5hbWVOZXdSZXBsYWNlXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgIm1lcmdlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGF0dHJOYW1lTWVyZ2UgaW4gbmV3UmVjb3JkQXJyYXlbbV0pIHJlc3VsdFtuXVthdHRyTmFtZU1lcmdlXSA9IG5ld1JlY29yZEFycmF5W21dW2F0dHJOYW1lTWVyZ2VdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInNraXAiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGdlbmVyYXRlVVVJRGFuZFVwZGF0ZURhdGUodHlwZSwgcmVzdWx0LCBuKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghY2hlY2sgJiYgKHR5cGUgPT09ICJjaGlsZCIgfHwgdHlwZSA9PT0gInBldCIgfHwgdHlwZSA9PT0gImV4dGVybmFsQXBwbGljYXRpb24iKSkgewogICAgICAgICAgICAgICAgICAgIGdlbmVyYXRlVVVJRGFuZFVwZGF0ZURhdGUodHlwZSwgbmV3UmVjb3JkQXJyYXksIG0pOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5ld1JlY29yZEFycmF5W21dKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoZWNrID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gYFRoZSBleHRlcm5hbEFwcGxpY2F0aW9uLCBjaGlsZCBhbmQvb3IgcGV0IGlzIG5vdCBhbiBhcnJheS5gOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7Cn0K",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["9B bis. Perform Merge Area Of Interest Logic"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "10C. Remove Fields",
          "type": "field.remove",
          "params": {
            "fields": [
              "_identities",
              "password",
              "_response",
              "query",
              "data._areaOfInterest",
              "data._child",
              "data._pet",
              "data._externalApplication",
              "_lastUpdated",
              "data._initialAppSourceCode",
              "_subscriptions"
            ]
          },
          "next": ["11D. Import Full Account Upsert"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "8C. New Accounts",
          "type": "datasource.lookup.gigya.account",
          "params": {
            "select": "UID",
            "handleFieldConflicts": "take_lookup",
            "mismatchBehavior": "process",
            "lookupFields": [
              {
                "sourceField": "profile.email",
                "gigyaField": "loginIDs.emails"
              },
              {
                "sourceField": "profile.email",
                "gigyaField": "loginIDs.unverifiedEmails"
              }
            ],
            "lookupFieldsOperator": "OR",
            "matchBehavior": "remove",
            "isCaseSensitive": false,
            "from": "accounts",
            "batchSize": 200,
            "maxConcurrency": 1,
            "multiMatchBehavior": "error"
          },
          "next": ["Process new email account error"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "Process new email account error",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgew0KICAgIHJlY29yZC5fZXJyb3JEZXRhaWxzID0gJ1RoaXMgcmVjb3JkIGRvZXMgbm90IGV4aXN0IG9uIHRoZSByZXBvc2l0b3J5IG9yIHlvdSBhcmUgdHJ5aW5nIHRvIHVwZGF0ZSBhIExpdGUgQWNjb3VudCB3aXRoIHRoZSBGdWxsIEFjY291bnQgZGF0YWZsb3cuIFlvdSBtdXN0IHJ1biBpdCB3aXRoIHRoZSBpbXBvcnQgd2l0aCBhbGwgdGhlIHJlcXVpcmVkIGZpZWxkcy4nOw0KICAgIGVycm9yLmFjY2VwdChyZWNvcmQsIHJlY29yZCk7DQogICAgcmV0dXJuOw0KfQ==",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": [],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "7A. Rename Fields To Merge",
          "type": "field.rename",
          "params": {
            "fields": [
              {
                "sourceField": "data.areaOfInterest",
                "targetField": "data._areaOfInterest"
              },
              {
                "sourceField": "data.pet",
                "targetField": "data._pet"
              },
              {
                "sourceField": "data.child",
                "targetField": "data._child"
              },
              {
                "sourceField": "data.externalApplication",
                "targetField": "data._externalApplication"
              },
              {
                "sourceField": "lastUpdated",
                "targetField": "_lastUpdated"
              },
              {
                "sourceField": "data.initialAppSourceCode",
                "targetField": "data._initialAppSourceCode"
              },
              {
                "sourceField": "profile.email",
                "targetField": "profile._email"
              },
              {
                "sourceField": "phoneNumber",
                "targetField": "_phoneNumber"
              },
              {
                "sourceField": "loginIDs",
                "targetField": "_loginIDs"
              },
              {
                "sourceField": "emails",
                "targetField": "_emails"
              },
              {
                "sourceField": "identities",
                "targetField": "_identities"
              },
              {
                "sourceField": "subscriptions",
                "targetField": "_subscriptions"
              }
            ]
          },
          "next": ["8A. New Accounts", "6A. Existing Accounts"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "12C. Set Account Info Webhook",
          "type": "datasource.write.gigya.generic",
          "params": {
            "apiMethod": "accounts.setAccountInfo",
            "maxConnections": 10,
            "apiParams": [
              {
                "sourceField": "UID",
                "paramName": "UID",
                "value": ""
              }
            ],
            "addResponse": false
          },
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "Generate file",
          "type": "file.format.json",
          "params": {
            "fileName": "{{AZURE_ERRORS_FILENAME}}_${now:yyMMddHHmm}.json",
            "maxFileSize": 5000,
            "createEmptyFile": false
          },
          "next": ["Encrypt file"]
        },
        {
          "id": "Prepare fields to extract phone as ID",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgdmFyIHJlY29yZFRvRXh0cmFjdCA9IHt9Ow0KICAgIHJlY29yZFRvRXh0cmFjdC5waG9uZU51bWJlciA9IHJlY29yZC5waG9uZU51bWJlcjsNCiAgICAgICAgaWYgKHJlY29yZC5VSUQgJiYgcmVjb3JkLlVJRC5sZW5ndGgpIHsNCiAgICAgICAgcmVjb3JkVG9FeHRyYWN0LlVJRCA9IHJlY29yZC5VSUQ7DQogICAgfQ0KICAgIA0KICAgIHJlY29yZFRvRXh0cmFjdC5lcnJvckRldGFpbHMgPSByZWNvcmQuX2Vycm9yRGV0YWlsczsNCiAgICANCiAgICBpZiAocmVjb3JkVG9FeHRyYWN0LmVycm9yRGV0YWlscy5lcnJvck1lc3NhZ2UgIT09ICJJZ25vcmVkIFBhcmFtczogW3twYXJhbU5hbWUgPSBwaG9uZU51bWJlciwgd2FybmluZ0NvZGUgPSA0MDMwMDcsIG1lc3NhZ2UgPSBUaGlzIHBhcmFtZXRlciB3YXMgbm90IHJlY29nbml6ZWQgYXMgdmFsaWQgZm9yIHRoaXMgQVBJIG1ldGhvZCB3aXRoIHlvdXIgc2VjdXJpdHkgY3JlZGVudGlhbHMgbm9yIHdhcyBpdCByZWNvZ25pemVkIGFzIGEgc3RhbmRhcmQgR2lneWEgY29udHJvbCBwYXJhbWV0ZXIufV0iKSB7DQogICAgICAgIHJldHVybiByZWNvcmRUb0V4dHJhY3Q7DQogICAgfQ0KfQ==",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["Generate file"]
        },
        {
          "id": "Prepare fields to extract email",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgdmFyIHJlY29yZFRvRXh0cmFjdCA9IHt9Ow0KICAgIHJlY29yZFRvRXh0cmFjdC5lbWFpbCA9IHJlY29yZC5wcm9maWxlLmVtYWlsOw0KICAgIGlmIChyZWNvcmQuVUlEICYmIHJlY29yZC5VSUQubGVuZ3RoKSB7DQogICAgICAgIHJlY29yZFRvRXh0cmFjdC5VSUQgPSByZWNvcmQuVUlEOw0KICAgIH0NCiAgICANCiAgICByZWNvcmRUb0V4dHJhY3QuZXJyb3JEZXRhaWxzID0gcmVjb3JkLl9lcnJvckRldGFpbHM7DQoNCiAgICByZXR1cm4gcmVjb3JkVG9FeHRyYWN0Ow0KfQ==",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["Generate file"]
        },
        {
          "id": "Encrypt file",
          "type": "file.encrypt.pgp",
          "params": {
            "publicKey": "{{PGP_Public_Key_Base64_Encoded}}",
            "asciiArmor": true
          },
          "next": ["Upload to Blob Storage"]
        },
        {
          "id": "Generate Existent Accounts File",
          "type": "file.format.json",
          "params": {
            "fileName": "{{AZURE_EXISTENT_ACCOUNTS_FILENAME}}_${now:yyMMddHHmm}.json",
            "maxFileSize": 5000,
            "createEmptyFile": false
          },
          "next": ["Encrypt file"]
        },
        {
          "id": "Prepare existent accounts to extract",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgdmFyIG5ld1JlY29yZCA9IHsNCiAgICAgICAgIlVJRCI6IHJlY29yZC5VSUQsDQogICAgICAgICJlbWFpbCI6IHJlY29yZC5wcm9maWxlLmVtYWlsLA0KICAgICAgICAiaW5pdGlhbEFwcFNvdXJjZUNvZGUiOiByZWNvcmQuZGF0YS5pbml0aWFsQXBwU291cmNlQ29kZQ0KICAgIH0NCiAgICANCiAgICBpZiAocmVjb3JkLnBob25lTnVtYmVyKSB7DQogICAgICAgIG5ld1JlY29yZC5waG9uZU51bWJlciA9IHJlY29yZC5waG9uZU51bWJlcjsNCiAgICB9DQogICAgDQogICAgcmV0dXJuIG5ld1JlY29yZDsNCn0=",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["Generate Existent Accounts File"]
        },
        {
          "id": "4. Add data.idxImportJobId",
          "type": "field.add",
          "params": {
            "fields": [
              {
                "field": "data.idxImportJobId",
                "value": "${jobId}"
              },
              {
                "field": "isRegistered",
                "value": "true"
              }
            ]
          },
          "next": ["5. Generate UID and check lang"]
        },
        {
          "id": "9B bis. Perform Merge Area Of Interest Logic",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgewogICAgLy8gSWYgc2V0IHRvIHRydWUgdGhlIHJlY29yZCB3aWxsIGJlIHByb2Nlc3NlZCBvbmx5IGlmIHRoZSBsYXN0VXBkYXRlIGluIHRoZSBmaWxlIGlzID4gbGFzdHVwZGF0ZSBpbiBTQVAtQ0RDLiBJZiBzZXQgdG8gZmFsc2UgdGhlIHJlY29yZCB3aWxsIGJlIGFsd2F5cyBwcm9jZXNzZWQuCiAgICB2YXIgY2hlY2tMYXN0VXBkYXRlZCA9IGZhbHNlOwogICAgLy8gSWYgc2V0IHRvIHRydWUgd2Ugd2lsbCBhcHBseSB0aGUgbWVyZ2UgbG9naWMgZm9yIHRoZSBjYXRlZ29yeS4gSWYgc2V0IHRvIGZhbHNlIHdlIHdpbGwgbm90IGFwcGx5IHRoZSBtZXJnaW5nIGxvZ2ljLgogICAgdmFyIG1lcmdlQXJlYU9mSW50ZXJlc3QgPSB0cnVlOwoKICAgIGlmKCBjaGVja0xhc3RVcGRhdGVkICYmIHJlY29yZC5sYXN0VXBkYXRlZCA+IHJlY29yZC5fbGFzdFVwZGF0ZWQgKSByZXR1cm47CiAgICAKICAgIHZhciBtYXRjaGluZ0NvbmRpdGlvbkFyZWFPZkludGVyZXN0ID0gWyJpbnRlcmVzdENvZGUiXTsKICAgIHZhciBzdHJhdGVneUNob29zZW4gPSAie3tNRVJHRV9TVFJBVEVHWX19IjsKCiAgICBpZiAoIG1lcmdlQXJlYU9mSW50ZXJlc3QgKSBjYWxsTWVyZ2VMb2dpYyggcmVjb3JkLCAiYXJlYU9mSW50ZXJlc3QiLCBzdHJhdGVneUNob29zZW4sIGxvZ2dlciwgZXJyb3IpOwogICAgCiAgICBpZiAocmVjb3JkLl9lcnJvckRldGFpbHMgJiYgcmVjb3JkLl9lcnJvckRldGFpbHMubGVuZ3RoKSB7CiAgICAgICAgZXJyb3IuYWNjZXB0KHJlY29yZCwgcmVjb3JkKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgIH0KfQoKZnVuY3Rpb24gY2FsbE1lcmdlTG9naWMoIHJlY29yZCwgcHJvcGVydHlOYW1lLCBzdHJhdGVneUNob29zZW4sIGxvZ2dlciwgZXJyb3IpIHsKICAgIHZhciBfcHJvcGVydHlOYW1lID0gIl8iICsgcHJvcGVydHlOYW1lOwogICAgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdICYmICFyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdKSB7CiAgICAgICAgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gZGVsZXRlUmVwZWF0ZWRzKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdKTsKICAgICAgICB9CiAgICB9IGVsc2UgaWYgKHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0pIHsKICAgICAgICBpZiAocmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXS5sZW5ndGggPT09IDAgJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0ubGVuZ3RoICE9PSAwKSByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gZGVsZXRlUmVwZWF0ZWRzKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdKTsgIAogICAgICAgIGVsc2UgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICBjb25zdCBtZXJnZVJlc3VsdCA9IHByb2Nlc3NNZXJnZShyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdLCByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXSwgc3RyYXRlZ3lDaG9vc2VuKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXJnZVJlc3VsdCA9PT0gJ3N0cmluZycpIHJlY29yZC5fZXJyb3JEZXRhaWxzID0gbWVyZ2VSZXN1bHQ7CiAgICAgICAgICAgIGVsc2UgcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXSA9IG1lcmdlUmVzdWx0OwogICAgICAgIH0KICAgIH0KfQoKCmZ1bmN0aW9uIHByb2Nlc3NNZXJnZShleGlzdGluZ1JlY29yZEFycmF5LCBuZXdSZWNvcmRBcnJheSwgc3RyYXRlZ3kpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIHZhciBjaGVjayA9IGZhbHNlOwogICAgaWYgKCBzdHJhdGVneSA9PT0gImZ1bGxSZXBsYWNlIikgewogICAgICAgIHJlc3VsdCA9IG5ld1JlY29yZEFycmF5OwogICAgICAgIHJldHVybiBkZWxldGVSZXBlYXRlZHMocmVzdWx0KTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXhpc3RpbmdSZWNvcmRBcnJheSkpIHsKICAgICAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAicmVwbGFjZVBhcnRpYWxseSIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5ld0ludGVyZXN0Q29kZXMgPSBuZXdSZWNvcmRBcnJheS5tYXAocmVjb3JkID0+IHJlY29yZC5pbnRlcmVzdENvZGUpOwogICAgCiAgICAgICAgICAgICAgICBleGlzdGluZ1JlY29yZEFycmF5ID0gWy4uLmV4aXN0aW5nUmVjb3JkQXJyYXkuZmlsdGVyKHJlY29yZCA9PiAhISFuZXdJbnRlcmVzdENvZGVzLmZpbmQoaW50ZXJlc3RDb2RlID0+IGludGVyZXN0Q29kZSA9PT0gcmVjb3JkLmludGVyZXN0Q29kZSkpXTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAibWVyZ2UiKSB7CiAgICAgICAgICAgICAgICBjb25zdCBleGlzdGluZ1JlY29yZEFycmF5V291dFJlcGVhdGVkID0gZXhpc3RpbmdSZWNvcmRBcnJheS5maWx0ZXIocmVjb3JkID0+ICFuZXdSZWNvcmRBcnJheS5maW5kKF9yZWNvcmQgPT4gX3JlY29yZC5pbnRlcmVzdENvZGUgPT09IHJlY29yZC5pbnRlcmVzdENvZGUgJiYgX3JlY29yZC5hbnN3ZXJEZXRhaWxzID09PSByZWNvcmQuYW5zd2VyRGV0YWlscykpOwogICAgICAgICAgICAgICAgcmVzdWx0ID0gWy4uLmV4aXN0aW5nUmVjb3JkQXJyYXlXb3V0UmVwZWF0ZWQsIC4uLm5ld1JlY29yZEFycmF5XTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGV4aXN0aW5nUmVjb3JkQXJyYXkgJiYgZXhpc3RpbmdSZWNvcmRBcnJheS5sZW5ndGggPyBbLi4uZXhpc3RpbmdSZWNvcmRBcnJheV0gOiBbXTsKICAgIAogICAgICAgICAgICAgICAgZm9yICh2YXIgbSBpbiBuZXdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG4gaW4gZXhpc3RpbmdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3UmVjb3JkQXJyYXlbbV0gJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXSAmJiBuZXdSZWNvcmRBcnJheVttXS5pbnRlcmVzdENvZGUgJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXS5pbnRlcmVzdENvZGUgJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXS5pbnRlcmVzdENvZGUgPT09IG5ld1JlY29yZEFycmF5W21dLmludGVyZXN0Q29kZSApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIWNoZWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5ld1JlY29yZEFycmF5W21dKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2hlY2sgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZVJlcGVhdGVkcyhyZXN1bHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiVGhlIGFyZWEgb2YgaW50ZXJlc3QgaXMgbm90IGFuIGFycmF5LiI7CiAgICAgICAgfQogICAgfQp9CgpmdW5jdGlvbiBkZWxldGVSZXBlYXRlZHMocmVzdWx0KSB7CiAgICBjb25zdCBlcnJvcnMgPSBuZXcgU2V0KCk7CiAgICBjb25zdCBfcmVzdWx0ID0gWy4uLnJlc3VsdC5maWx0ZXIoKHZhbHVlLCBpbmRleCkgPT4gewogICAgICAgIGlmICghdmFsdWUuaW50ZXJlc3RDb2RlIHx8ICF2YWx1ZS5hbnN3ZXJEZXRhaWxzKSB7CiAgICAgICAgICAgIGVycm9ycy5hZGQoYFRoZSByZWNvcmQgaGFzIGFuIGludGVyZXN0IGluIHRoZSByZXBvIHdpdGhvdXQgaW50ZXJlc3RDb2RlIG9yIHdpdGhvdXQgYW5zd2VyRGV0YWlscy5gKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbnRlcmVzdENvZGVWYWx1ZSA9IHR5cGVvZiB2YWx1ZS5pbnRlcmVzdENvZGUgPT09ICJzdHJpbmciID8gdmFsdWUuaW50ZXJlc3RDb2RlLnRvTG93ZXJDYXNlKCkgOiBgJHt2YWx1ZS5pbnRlcmVzdENvZGV9YC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBjb25zdCBhbnN3ZXJEZXRhaWxzVmFsdWUgPSB0eXBlb2YgdmFsdWUuYW5zd2VyRGV0YWlscyA9PT0gInN0cmluZyIgPyB2YWx1ZS5hbnN3ZXJEZXRhaWxzLnRvTG93ZXJDYXNlKCkgOiBgJHt2YWx1ZS5hbnN3ZXJEZXRhaWxzfWAudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgY29uc3QgX3ZhbHVlID0gYCR7IGludGVyZXN0Q29kZVZhbHVlIH0gLSAkeyBhbnN3ZXJEZXRhaWxzVmFsdWUgfWA7CiAgICAgICAgICAgIHJldHVybiBpbmRleCA9PT0gcmVzdWx0LmZpbmRJbmRleChvYmogPT4gewogICAgICAgICAgICAgICAgaWYgKCFvYmouaW50ZXJlc3RDb2RlIHx8ICFvYmouYW5zd2VyRGV0YWlscykgewogICAgICAgICAgICAgICAgICAgIGVycm9ycy5hZGQoYFRoZSByZWNvcmQgaGFzIGFuIGludGVyZXN0IGluIHRoZSByZXBvIHdpdGhvdXQgaW50ZXJlc3RDb2RlIG9yIHdpdGhvdXQgYW5zd2VyRGV0YWlscy5gKQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnRlcmVzdENvZGVPYmogPSB0eXBlb2Ygb2JqLmludGVyZXN0Q29kZSA9PT0gInN0cmluZyIgPyBvYmouaW50ZXJlc3RDb2RlLnRvTG93ZXJDYXNlKCkgOiBgJHtvYmouaW50ZXJlc3RDb2RlfWAudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbnN3ZXJEZXRhaWxzT2JqID0gdHlwZW9mIG9iai5hbnN3ZXJEZXRhaWxzID09PSAic3RyaW5nIiA/IG9iai5hbnN3ZXJEZXRhaWxzLnRvTG93ZXJDYXNlKCkgOiBgJHtvYmouYW5zd2VyRGV0YWlsc31gLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGAkeyBpbnRlcmVzdENvZGVPYmogfSAtICR7IGFuc3dlckRldGFpbHNPYmogfWAgPT0gX3ZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KV07CiAgICAKICAgIGlmIChlcnJvcnMuc2l6ZSkgewogICAgICAgIGxldCBlcnJvck1lc3NhZ2UgPSAiIjsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgZXJyb3JzKSB7CiAgICAgICAgICAgIGlmIChlcnJvck1lc3NhZ2UgJiYgZXJyb3JNZXNzYWdlLmxlbmd0aCkgZXJyb3JNZXNzYWdlICs9IGAsICR7aXRlbX1gOwogICAgICAgICAgICBlbHNlIGVycm9yTWVzc2FnZSA9IGl0ZW07CiAgICAgICAgfQogICAgICAgIHJldHVybiBlcnJvck1lc3NhZ2U7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBfcmVzdWx0OwogICAgfQp9",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["10C. Remove Fields"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "7A bis. Perform Merge Logic Area of Interest",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgewogICAgLy8gSWYgc2V0IHRvIHRydWUgdGhlIHJlY29yZCB3aWxsIGJlIHByb2Nlc3NlZCBvbmx5IGlmIHRoZSBsYXN0VXBkYXRlIGluIHRoZSBmaWxlIGlzID4gbGFzdHVwZGF0ZSBpbiBTQVAtQ0RDLiBJZiBzZXQgdG8gZmFsc2UgdGhlIHJlY29yZCB3aWxsIGJlIGFsd2F5cyBwcm9jZXNzZWQuCiAgICB2YXIgY2hlY2tMYXN0VXBkYXRlZCA9IGZhbHNlOwogICAgLy8gSWYgc2V0IHRvIHRydWUgd2Ugd2lsbCBhcHBseSB0aGUgbWVyZ2UgbG9naWMgZm9yIHRoZSBjYXRlZ29yeS4gSWYgc2V0IHRvIGZhbHNlIHdlIHdpbGwgbm90IGFwcGx5IHRoZSBtZXJnaW5nIGxvZ2ljLgogICAgdmFyIG1lcmdlQXJlYU9mSW50ZXJlc3QgPSB0cnVlOwoKICAgIGlmKCBjaGVja0xhc3RVcGRhdGVkICYmIHJlY29yZC5sYXN0VXBkYXRlZCA+IHJlY29yZC5fbGFzdFVwZGF0ZWQgKSByZXR1cm47CiAgICAKICAgIHZhciBtYXRjaGluZ0NvbmRpdGlvbkFyZWFPZkludGVyZXN0ID0gWyJpbnRlcmVzdENvZGUiXTsKICAgIHZhciBzdHJhdGVneUNob29zZW4gPSAie3tNRVJHRV9TVFJBVEVHWX19IjsKCiAgICBpZiAoIG1lcmdlQXJlYU9mSW50ZXJlc3QgKSBjYWxsTWVyZ2VMb2dpYyggcmVjb3JkLCAiYXJlYU9mSW50ZXJlc3QiLCBzdHJhdGVneUNob29zZW4sIGxvZ2dlciwgZXJyb3IpOwogICAgCiAgICBpZiAocmVjb3JkLl9lcnJvckRldGFpbHMgJiYgcmVjb3JkLl9lcnJvckRldGFpbHMubGVuZ3RoKSB7CiAgICAgICAgZXJyb3IuYWNjZXB0KHJlY29yZCwgcmVjb3JkKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgIH0KfQoKZnVuY3Rpb24gY2FsbE1lcmdlTG9naWMoIHJlY29yZCwgcHJvcGVydHlOYW1lLCBzdHJhdGVneUNob29zZW4sIGxvZ2dlciwgZXJyb3IpIHsKICAgIHZhciBfcHJvcGVydHlOYW1lID0gIl8iICsgcHJvcGVydHlOYW1lOwogICAgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdICYmICFyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdKSB7CiAgICAgICAgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gZGVsZXRlUmVwZWF0ZWRzKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdKTsKICAgICAgICB9CiAgICB9IGVsc2UgaWYgKHJlY29yZC5kYXRhW3Byb3BlcnR5TmFtZV0gJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0pIHsKICAgICAgICBpZiAocmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXS5sZW5ndGggPT09IDAgJiYgcmVjb3JkLmRhdGFbX3Byb3BlcnR5TmFtZV0ubGVuZ3RoICE9PSAwKSByZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdID0gZGVsZXRlUmVwZWF0ZWRzKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdKTsgIAogICAgICAgIGVsc2UgaWYgKHJlY29yZC5kYXRhW19wcm9wZXJ0eU5hbWVdLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICBjb25zdCBtZXJnZVJlc3VsdCA9IHByb2Nlc3NNZXJnZShyZWNvcmQuZGF0YVtwcm9wZXJ0eU5hbWVdLCByZWNvcmQuZGF0YVtfcHJvcGVydHlOYW1lXSwgc3RyYXRlZ3lDaG9vc2VuKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXJnZVJlc3VsdCA9PT0gJ3N0cmluZycpIHJlY29yZC5fZXJyb3JEZXRhaWxzID0gbWVyZ2VSZXN1bHQ7CiAgICAgICAgICAgIGVsc2UgcmVjb3JkLmRhdGFbcHJvcGVydHlOYW1lXSA9IG1lcmdlUmVzdWx0OwogICAgICAgIH0KICAgIH0KfQoKCmZ1bmN0aW9uIHByb2Nlc3NNZXJnZShleGlzdGluZ1JlY29yZEFycmF5LCBuZXdSZWNvcmRBcnJheSwgc3RyYXRlZ3kpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIHZhciBjaGVjayA9IGZhbHNlOwogICAgaWYgKCBzdHJhdGVneSA9PT0gImZ1bGxSZXBsYWNlIikgewogICAgICAgIHJlc3VsdCA9IG5ld1JlY29yZEFycmF5OwogICAgICAgIHJldHVybiBkZWxldGVSZXBlYXRlZHMocmVzdWx0KTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXhpc3RpbmdSZWNvcmRBcnJheSkpIHsKICAgICAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAicmVwbGFjZVBhcnRpYWxseSIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5ld0ludGVyZXN0Q29kZXMgPSBuZXdSZWNvcmRBcnJheS5tYXAocmVjb3JkID0+IHJlY29yZC5pbnRlcmVzdENvZGUpOwogICAgCiAgICAgICAgICAgICAgICBleGlzdGluZ1JlY29yZEFycmF5ID0gWy4uLmV4aXN0aW5nUmVjb3JkQXJyYXkuZmlsdGVyKHJlY29yZCA9PiAhISFuZXdJbnRlcmVzdENvZGVzLmZpbmQoaW50ZXJlc3RDb2RlID0+IGludGVyZXN0Q29kZSA9PT0gcmVjb3JkLmludGVyZXN0Q29kZSkpXTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHN0cmF0ZWd5ID09PSAibWVyZ2UiKSB7CiAgICAgICAgICAgICAgICBjb25zdCBleGlzdGluZ1JlY29yZEFycmF5V291dFJlcGVhdGVkID0gZXhpc3RpbmdSZWNvcmRBcnJheS5maWx0ZXIocmVjb3JkID0+ICFuZXdSZWNvcmRBcnJheS5maW5kKF9yZWNvcmQgPT4gX3JlY29yZC5pbnRlcmVzdENvZGUgPT09IHJlY29yZC5pbnRlcmVzdENvZGUgJiYgX3JlY29yZC5hbnN3ZXJEZXRhaWxzID09PSByZWNvcmQuYW5zd2VyRGV0YWlscykpOwogICAgICAgICAgICAgICAgcmVzdWx0ID0gWy4uLmV4aXN0aW5nUmVjb3JkQXJyYXlXb3V0UmVwZWF0ZWQsIC4uLm5ld1JlY29yZEFycmF5XTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGV4aXN0aW5nUmVjb3JkQXJyYXkgJiYgZXhpc3RpbmdSZWNvcmRBcnJheS5sZW5ndGggPyBbLi4uZXhpc3RpbmdSZWNvcmRBcnJheV0gOiBbXTsKICAgIAogICAgICAgICAgICAgICAgZm9yICh2YXIgbSBpbiBuZXdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG4gaW4gZXhpc3RpbmdSZWNvcmRBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3UmVjb3JkQXJyYXlbbV0gJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXSAmJiBuZXdSZWNvcmRBcnJheVttXS5pbnRlcmVzdENvZGUgJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXS5pbnRlcmVzdENvZGUgJiYgZXhpc3RpbmdSZWNvcmRBcnJheVtuXS5pbnRlcmVzdENvZGUgPT09IG5ld1JlY29yZEFycmF5W21dLmludGVyZXN0Q29kZSApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIWNoZWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5ld1JlY29yZEFycmF5W21dKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2hlY2sgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZVJlcGVhdGVkcyhyZXN1bHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiVGhlIGFyZWEgb2YgaW50ZXJlc3QgaXMgbm90IGFuIGFycmF5LiI7CiAgICAgICAgfQogICAgfQp9CgpmdW5jdGlvbiBkZWxldGVSZXBlYXRlZHMocmVzdWx0KSB7CiAgICBjb25zdCBlcnJvcnMgPSBuZXcgU2V0KCk7CiAgICBjb25zdCBfcmVzdWx0ID0gWy4uLnJlc3VsdC5maWx0ZXIoKHZhbHVlLCBpbmRleCkgPT4gewogICAgICAgIGlmICghdmFsdWUuaW50ZXJlc3RDb2RlIHx8ICF2YWx1ZS5hbnN3ZXJEZXRhaWxzKSB7CiAgICAgICAgICAgIGVycm9ycy5hZGQoYFRoZSByZWNvcmQgaGFzIGFuIGludGVyZXN0IGluIHRoZSByZXBvIHdpdGhvdXQgaW50ZXJlc3RDb2RlIG9yIHdpdGhvdXQgYW5zd2VyRGV0YWlscy5gKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbnRlcmVzdENvZGVWYWx1ZSA9IHR5cGVvZiB2YWx1ZS5pbnRlcmVzdENvZGUgPT09ICJzdHJpbmciID8gdmFsdWUuaW50ZXJlc3RDb2RlLnRvTG93ZXJDYXNlKCkgOiBgJHt2YWx1ZS5pbnRlcmVzdENvZGV9YC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBjb25zdCBhbnN3ZXJEZXRhaWxzVmFsdWUgPSB0eXBlb2YgdmFsdWUuYW5zd2VyRGV0YWlscyA9PT0gInN0cmluZyIgPyB2YWx1ZS5hbnN3ZXJEZXRhaWxzLnRvTG93ZXJDYXNlKCkgOiBgJHt2YWx1ZS5hbnN3ZXJEZXRhaWxzfWAudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgY29uc3QgX3ZhbHVlID0gYCR7IGludGVyZXN0Q29kZVZhbHVlIH0gLSAkeyBhbnN3ZXJEZXRhaWxzVmFsdWUgfWA7CiAgICAgICAgICAgIHJldHVybiBpbmRleCA9PT0gcmVzdWx0LmZpbmRJbmRleChvYmogPT4gewogICAgICAgICAgICAgICAgaWYgKCFvYmouaW50ZXJlc3RDb2RlIHx8ICFvYmouYW5zd2VyRGV0YWlscykgewogICAgICAgICAgICAgICAgICAgIGVycm9ycy5hZGQoYFRoZSByZWNvcmQgaGFzIGFuIGludGVyZXN0IGluIHRoZSByZXBvIHdpdGhvdXQgaW50ZXJlc3RDb2RlIG9yIHdpdGhvdXQgYW5zd2VyRGV0YWlscy5gKQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnRlcmVzdENvZGVPYmogPSB0eXBlb2Ygb2JqLmludGVyZXN0Q29kZSA9PT0gInN0cmluZyIgPyBvYmouaW50ZXJlc3RDb2RlLnRvTG93ZXJDYXNlKCkgOiBgJHtvYmouaW50ZXJlc3RDb2RlfWAudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbnN3ZXJEZXRhaWxzT2JqID0gdHlwZW9mIG9iai5hbnN3ZXJEZXRhaWxzID09PSAic3RyaW5nIiA/IG9iai5hbnN3ZXJEZXRhaWxzLnRvTG93ZXJDYXNlKCkgOiBgJHtvYmouYW5zd2VyRGV0YWlsc31gLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGAkeyBpbnRlcmVzdENvZGVPYmogfSAtICR7IGFuc3dlckRldGFpbHNPYmogfWAgPT0gX3ZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KV07CiAgICAKICAgIGlmIChlcnJvcnMuc2l6ZSkgewogICAgICAgIGxldCBlcnJvck1lc3NhZ2UgPSAiIjsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgZXJyb3JzKSB7CiAgICAgICAgICAgIGlmIChlcnJvck1lc3NhZ2UgJiYgZXJyb3JNZXNzYWdlLmxlbmd0aCkgZXJyb3JNZXNzYWdlICs9IGAsICR7aXRlbX1gOwogICAgICAgICAgICBlbHNlIGVycm9yTWVzc2FnZSA9IGl0ZW07CiAgICAgICAgfQogICAgICAgIHJldHVybiBlcnJvck1lc3NhZ2U7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBfcmVzdWx0OwogICAgfQp9",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["10B. Remove Fields"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "Upload to Blob Storage",
          "type": "datasource.write.azure.blob_token",
          "params": {
            "baseUri": "https://ciamprblobdataplatform.blob.core.windows.net",
            "accessToken": "********",
            "container": "{{AZURE_CONTAINER_IMPORT_ERROR}}"
          }
        },
        {
          "id": "11C. Update Account",
          "type": "datasource.write.gigya.importaccount",
          "params": {
            "importPolicy": "upsert",
            "maxConnections": 20,
            "addResponse": false
          },
          "next": ["12A. Rename Fields To Register"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "12A. Rename Fields To Register",
          "type": "field.rename",
          "params": {
            "fields": [
              {
                "sourceField": "profile.email",
                "targetField": "profile._email"
              },
              {
                "sourceField": "phoneNumber",
                "targetField": "_phoneNumber"
              },
              {
                "sourceField": "loginIDs",
                "targetField": "_loginIDs"
              },
              {
                "sourceField": "emails",
                "targetField": "_emails"
              }
            ]
          },
          "next": ["13A. Existing Account to Register"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "13A. Existing Account to Register",
          "type": "datasource.lookup.gigya.account",
          "params": {
            "select": "UID,phoneNumber,profile.email,isRegistered",
            "handleFieldConflicts": "take_lookup",
            "mismatchBehavior": "remove",
            "lookupFields": [
              {
                "sourceField": "_phoneNumber",
                "gigyaField": "phoneNumber"
              },
              {
                "sourceField": "profile._email",
                "gigyaField": "loginIDs.unverifiedEmails"
              },
              {
                "sourceField": "profile._email",
                "gigyaField": "loginIDs.emails"
              }
            ],
            "lookupFieldsOperator": "OR",
            "matchBehavior": "process",
            "isCaseSensitive": true,
            "maxConcurrency": 1,
            "from": "accounts",
            "batchSize": 200,
            "multiMatchBehavior": "error"
          },
          "next": ["14A. Check isRegistered"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "14A. Check isRegistered",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0KSB7DQogICAgaWYgKCFyZWNvcmQuaXNSZWdpc3RlcmVkKSB7DQogICAgICAgIHJldHVybiByZWNvcmQ7DQogICAgfQ0KfQ==",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "next": ["15. Notify Login"],
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "15. Notify Login",
          "type": "datasource.write.gigya.generic",
          "params": {
            "apiMethod": "accounts.notifyLogin",
            "maxConnections": 10,
            "apiParams": [
              {
                "sourceField": "UID",
                "paramName": "siteUID",
                "value": ""
              }
            ],
            "addResponse": false
          },
          "error": ["Prepare fields to extract phone as ID"]
        },
        {
          "id": "11D. Import Full Account Upsert",
          "type": "datasource.write.gigya.importaccount",
          "params": {
            "importPolicy": "upsert",
            "maxConnections": 20,
            "addResponse": false
          },
          "next": ["12C. Set Account Info Webhook"],
          "error": ["Prepare fields to extract email"]
        },
        {
          "id": "Process new phone account error",
          "type": "record.evaluate",
          "params": {
            "script": "ZnVuY3Rpb24gcHJvY2VzcyhyZWNvcmQsIGN0eCwgbG9nZ2VyLCBuZXh0LCBlcnJvcikgew0KICAgIHJlY29yZC5fZXJyb3JEZXRhaWxzID0gJ1RoaXMgcmVjb3JkIGRvZXMgbm90IGV4aXN0IG9uIHRoZSByZXBvc2l0b3J5IG9yIHlvdSBhcmUgdHJ5aW5nIHRvIHVwZGF0ZSBhIExpdGUgQWNjb3VudCB3aXRoIHRoZSBGdWxsIEFjY291bnQgZGF0YWZsb3cuIFlvdSBtdXN0IHJ1biBpdCB3aXRoIHRoZSBpbXBvcnQgd2l0aCBhbGwgdGhlIHJlcXVpcmVkIGZpZWxkcy4nOw0KICAgIHJlY29yZC5waG9uZU51bWJlciA9IHJlY29yZC5fcGhvbmVOdW1iZXI7DQogICAgZXJyb3IuYWNjZXB0KHJlY29yZCwgcmVjb3JkKTsNCiAgICByZXR1cm47DQp9",
            "ECMAScriptVersion": "12",
            "notifyLastRecord": false
          },
          "error": ["Prepare fields to extract phone as ID"]
        }
      ],
      "version": 1,
      "createTime": "2024-10-15T09:59:15.824Z",
      "updateTime": "2024-10-15T09:59:15.824Z",
      "updatedByEmail": "l.marques@sap.com"
    },
    {
      "apiKey": "4_6Tv6z8O6NmUO_BZoHcXIRw",
      "siteId": 435061734600,
      "id": "83ec0f85760141e8944bfa74966f786d",
      "name": "Krux_Dataflow",
      "status": "draft",
      "description": "account > rename > krux > lzo > s3",
      "steps": [
        {
          "id": "account",
          "type": "datasource.read.gigya.account",
          "params": {
            "select": "UID,profile.gender,profile.age",
            "from": "accounts",
            "deltaField": "lastUpdatedTimestamp",
            "keepFieldNamesWithDotAsIs": false,
            "batchSize": 300,
            "maxConcurrency": 1
          },
          "next": ["rename"]
        },
        {
          "id": "rename",
          "type": "field.rename",
          "params": {
            "fields": [
              {
                "sourceField": "UID",
                "targetField": "id"
              },
              {
                "sourceField": "profile.gender",
                "targetField": "g_gender"
              },
              {
                "sourceField": "profile.age",
                "targetField": "g_age"
              },
              {
                "sourceField": "profile.likes",
                "targetField": "likes"
              }
            ]
          },
          "next": ["krux"]
        },
        {
          "id": "krux",
          "type": "file.format.krux",
          "params": {
            "fileName": "Gigya_Krux_M6.csv",
            "createEmptyFile": true,
            "quoteFields": false,
            "separator": ";"
          },
          "next": ["lzo"]
        },
        {
          "id": "lzo",
          "type": "file.compress.lzo",
          "params": {
            "createIndexFile": true
          },
          "next": ["s3"]
        },
        {
          "id": "s3",
          "type": "datasource.write.amazon.s3",
          "params": {
            "bucketName": "...",
            "accessKey": "...",
            "secretKey": "********",
            "objectKeyPrefix": "...",
            "region": "not specified"
          }
        }
      ],
      "version": 1,
      "createTime": "2023-04-21T10:28:35.98Z",
      "updateTime": "2023-04-21T10:28:35.98Z",
      "updatedByEmail": "g.lopes@sap.com"
    },
    {
      "apiKey": "4_6Tv6z8O6NmUO_BZoHcXIRw",
      "siteId": 435061734600,
      "id": "5e14ee0b96264f2c812e0c255c7f4e55",
      "name": "Import Lite Accounts from SFTP",
      "status": "draft",
      "description": "sftp > parse > injectJobId > importLiteAccount > format > sftp",
      "steps": [
        {
          "id": "Read files from SFTP",
          "type": "datasource.read.sftp",
          "params": {
            "host": "...",
            "username": "...",
            "password": "********",
            "fileNameRegex": ".*.json",
            "port": 22,
            "sortOrder": "ASC",
            "sortBy": "time",
            "timeout": 60
          },
          "next": ["parse JSON"]
        },
        {
          "id": "parse JSON",
          "type": "file.parse.json",
          "params": {
            "addFilename": false
          },
          "next": ["sharedvariable"]
        },
        {
          "id": "Import Lite Account",
          "type": "datasource.write.gigya.generic",
          "params": {
            "apiMethod": "accounts.importLiteAccount",
            "maxConnections": 20,
            "apiParams": [
              {
                "sourceField": "profile",
                "paramName": "profile",
                "value": ""
              },
              {
                "sourceField": "data",
                "paramName": "data",
                "value": ""
              },
              {
                "sourceField": "email",
                "paramName": "email",
                "value": ""
              }
            ],
            "addResponse": false
          },
          "next": [],
          "error": ["Format Error File"]
        },
        {
          "id": "Format Error File",
          "type": "file.format.json",
          "params": {
            "fileName": "import_lite_accounts_errors_${now}.json",
            "maxFileSize": 5000,
            "createEmptyFile": false
          },
          "next": ["Save errors to SFTP"]
        },
        {
          "id": "Save errors to SFTP",
          "type": "datasource.write.sftp",
          "params": {
            "host": "...",
            "username": "...",
            "password": "********",
            "port": 22,
            "remotePath": "errors",
            "temporaryUploadExtension": true,
            "timeout": 60
          }
        },
        {
          "id": "sharedvariable",
          "type": "datasource.read.sharedvariable",
          "next": ["Import Lite Account"]
        }
      ],
      "version": 1,
      "createTime": "2023-05-30T16:16:09.439Z",
      "updateTime": "2023-05-30T16:16:09.439Z",
      "updatedByEmail": "g.lopes@sap.com"
    }
  ]
}
